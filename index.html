<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>yume播放器</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzg4OCIgc3Ryb2tlLXdpZHRoPSIyIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCI+PC9jaXJjbGU+PHBhdGggZD0ibTE2IDgtOCAzIDggMyB6IiAvPjwvc3ZnPg==">
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-secondary: linear-gradient(135deg, #1f1f2e 0%, #252540 100%);
            --bg-tertiary: rgba(40, 40, 60, 0.8);
            --bg-app: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: rgba(255, 255, 255, 0.15);
            --global-font: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            --lyric-color: #ffffff;
            --global-font-size: 16px;
            --glass-blur: 20px;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-bg-hover: rgba(255, 255, 255, 0.12);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --glass-blur-amount: 15px;
            --glass-opacity: 0.15;
            --glass-saturation: 180%;
            --bg-blur: 20px;
            --bg-opacity: 0.15;
            --card-blur: 15px;
            --card-opacity: 0.2;
            --btn-blur: 10px;
            --btn-opacity: 0.25;
            --bg-color-rgb: 30, 30, 50;
            --card-color-rgb: 60, 60, 80;
            --btn-color-rgb: 99, 102, 241;
            --text-color-rgb: 255, 255, 255;
            --simple-lyric-width: 90%;
            --cloud-lyric-width: 100%;
            --simple-lyric-box-bg: rgba(255, 255, 255, 0.15);
            --cloud-lyric-box-bg: rgba(255, 255, 255, 0.1);
            --simple-lyric-font-size: 16px;
            --simple-cover-size: 220px;
            --primary-rgb: 99, 102, 241;
            --smart-button-bg: rgba(var(--primary-rgb), 0.15);
            --smart-button-border: rgba(var(--primary-rgb), 0.3);
            --smart-button-hover: rgba(var(--primary-rgb), 0.25);
            --smart-button-text: #ffffff;
            --smart-icon-bg: rgba(var(--primary-rgb), 0.12);
            --smart-card-bg: rgba(var(--primary-rgb), 0.08);
            --smart-bg-overlay: linear-gradient(135deg, rgba(var(--primary-rgb), 0.1), rgba(var(--primary-rgb), 0.05));
            --accent-color: #1DB954;
            --transition-duration: 0.3s;
            --transition-easing: cubic-bezier(0.4, 0, 0.2, 1);
            --global-border-radius: 16px;
            --card-spacing: 15px;
            --card-padding: 20px;
            --hover-lift: translateY(-2px);
            --hover-scale: scale(1.02);
        }
        body.light-mode {
            --bg-app: rgba(0, 0, 0, 0.05);
            --glass-bg-hover: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --smart-button-text: #333333;
        }
        body.reduce-motion {
            --transition-duration: 0.01ms;
        }
        body.reduce-motion *, body.reduce-motion *::before, body.reduce-motion *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
        
        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes gradientRotate {
            0% { background-position: 0% 0%; }
            25% { background-position: 100% 0%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
            100% { background-position: 0% 0%; }
        }
        
        @keyframes gradientPulse {
            0%, 100% { background-size: 100% 100%; }
            50% { background-size: 200% 200%; }
        }
        
        @keyframes gradientWave {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }
        
        .dynamic-gradient-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
            pointer-events: none;
        }
        
        .dynamic-gradient-bg.paused {
            animation-play-state: paused;
        }
        
        .dynamic-gradient-bg.rotate {
            animation: gradientRotate 20s ease infinite;
        }
        
        .dynamic-gradient-bg.pulse {
            animation: gradientPulse 8s ease infinite;
        }
        
        .dynamic-gradient-bg.wave {
            background-size: 200% 100%;
            animation: gradientWave 10s linear infinite;
        }
        
        .gradient-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            pointer-events: none;
        }
        
        .gradient-noise {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2;
            opacity: 0.03;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }
        
        #desktop-view, .app-page, .view {
            position: relative;
            z-index: 10;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: var(--global-font); color: var(--text-primary); background-color: #121212; background-size: cover; background-position: center; background-attachment: fixed; transition: background-color 0.3s, color 0.3s; font-size: var(--global-font-size); }
        button, input[type="file"], select { cursor: pointer; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-sizing: border-box; transition: opacity 0.4s ease, transform 0.4s ease; opacity: 0; transform: scale(1.05); pointer-events: none; background-color: var(--bg-primary); }
        .view.active { opacity: 1; transform: scale(1); pointer-events: auto; }
        .glass-card { background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); backdrop-filter: blur(var(--glass-blur)) saturate(180%); -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(180%); border: 1px solid rgba(255,255,255,0.18); border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-card:hover { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); border-color: rgba(255, 255, 255, 0.3); transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.15); }
        .glass-button { padding: 12px 24px; background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); backdrop-filter: blur(var(--btn-blur)); -webkit-backdrop-filter: blur(var(--btn-blur)); border: 1px solid rgba(255,255,255,0.18); border-radius: 12px; color: var(--text-primary); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
        .glass-button:hover { background: linear-gradient(135deg, rgba(255,255,255,0.18), rgba(255,255,255,0.1)); border-color: rgba(255, 255, 255, 0.35); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .glass-button:active { transform: scale(0.97); }
        .glass-button.primary { background: linear-gradient(135deg, rgba(29, 185, 84, 0.4), rgba(29, 185, 84, 0.25)); border-color: rgba(29, 185, 84, 0.5); }
        .glass-button.danger { background: linear-gradient(135deg, rgba(255, 80, 80, 0.3), rgba(255, 80, 80, 0.15)); border-color: rgba(255, 80, 80, 0.4); }
        .glass-modal { background: linear-gradient(135deg, rgba(40,40,60,0.95), rgba(30,30,50,0.95)); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255,255,255,0.1); }
        #desktop-view { background-size: cover; background-position: center; display: flex; flex-direction: column; padding: 20px; }
        .desktop-header { text-align: center; text-shadow: 0 0 10px rgba(0,0,0,0.7); margin-top: 20px; }
        .desktop-time { font-size: 72px; font-weight: 600; }
        .desktop-date { font-size: 22px; opacity: 0.9; margin-top: 4px; }
        .desktop-search-container { position: relative; margin-top: 15px; }
        #global-search-input { width: 280px; padding: 10px 15px; background: rgba(var(--card-color-rgb, 255, 255, 255), calc(var(--card-opacity, 0.2) * 0.75)); backdrop-filter: blur(var(--card-blur, 15px)); -webkit-backdrop-filter: blur(var(--card-blur, 15px)); border: 1px solid rgba(255,255,255,0.2); border-radius: 25px; color: white; font-size: 14px; outline: none; transition: all 0.3s; }
        #global-search-input::placeholder { color: rgba(255,255,255,0.6); }
        #global-search-input:focus { background: rgba(var(--card-color-rgb, 255, 255, 255), calc(var(--card-opacity, 0.2) * 1.25)); border-color: rgba(255,255,255,0.4); width: 320px; }
        .search-results-dropdown { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); width: 320px; max-height: 400px; overflow-y: auto; background: rgba(var(--card-color-rgb, 40, 40, 60), 0.95); backdrop-filter: blur(var(--card-blur, 15px)); -webkit-backdrop-filter: blur(var(--card-blur, 15px)); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; margin-top: 8px; display: none; z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .search-results-dropdown.visible { display: block; }
        .search-history-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); font-size: 12px; }
        .clear-history-btn { background: none; border: none; color: var(--text-secondary); font-size: 12px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
        .clear-history-btn:hover { background: rgba(255,255,255,0.1); color: #ff6b6b; }
        .search-history-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s; }
        .search-history-item:hover { background: rgba(255,255,255,0.1); }
        .history-icon { margin-right: 10px; font-size: 14px; opacity: 0.6; }
        .history-text { color: var(--text-primary); font-size: 13px; }
        .search-result-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); transition: background 0.2s; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: rgba(255,255,255,0.1); }
        .search-result-item .result-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 18px; background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 99, 102, 241), 0.2), rgba(var(--btn-color-rgb, 99, 102, 241), 0.1)); border-radius: 8px; margin-right: 12px; flex-shrink: 0; }
        .search-result-item .result-info { flex: 1; min-width: 0; }
        .search-result-item .result-title { color: white; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .search-result-item .result-subtitle { color: rgba(255,255,255,0.6); font-size: 12px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .search-result-item .result-type-badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; background: rgba(var(--btn-color-rgb, 99, 102, 241), 0.2); color: var(--text-primary); flex-shrink: 0; }
        .search-empty { padding: 20px; text-align: center; color: rgba(255,255,255,0.5); font-size: 13px; }
        .desktop-main { display: flex; flex: 1; justify-content: center; align-items: center; gap: 30px; padding: 20px; }
        .desktop-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .sidebar { position: fixed; right: 15px; top: 15px; width: 50px; height: 50px; background: linear-gradient(135deg, rgba(var(--card-color-rgb, 40, 40, 60), 0.9), rgba(var(--card-color-rgb, 25, 25, 40), 0.95)); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 100; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 20px rgba(0,0,0,0.3); cursor: pointer; overflow: hidden; }
        .sidebar.open { width: 220px; height: auto; max-height: 80vh; border-radius: 16px; cursor: default; flex-direction: column; padding: 15px 0; }
        .sidebar-toggle { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: all 0.3s; }
        .sidebar.open .sidebar-toggle { display: none; }
        .sidebar-header { display: none; padding: 10px 15px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); width: 100%; }
        .sidebar.open .sidebar-header { display: flex; justify-content: space-between; align-items: center; }
        .sidebar-logo { font-size: 20px; }
        .sidebar-close { font-size: 18px; cursor: pointer; padding: 5px; border-radius: 50%; transition: all 0.2s; }
        .sidebar-close:hover { background: rgba(255,255,255,0.1); }
        .sidebar-nav { display: none; flex-direction: column; gap: 6px; width: 100%; padding: 0 10px; flex: 1; overflow-y: auto; }
        .sidebar.open .sidebar-nav { display: flex; }
        .sidebar-item { display: flex; align-items: center; padding: 10px 12px; border-radius: 10px; cursor: pointer; transition: all 0.2s; color: var(--text-primary); text-decoration: none; position: relative; overflow: hidden; }
        .sidebar-item:hover { background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); transform: translateX(-2px); }
        .sidebar-item.active { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 29, 185, 84), 0.3), rgba(var(--btn-color-rgb, 29, 185, 84), 0.15)); }
        .sidebar-item-icon { width: 36px; height: 36px; min-width: 36px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 99, 102, 241), 0.25), rgba(var(--btn-color-rgb, 99, 102, 241), 0.12)); border-radius: 8px; transition: all 0.3s; }
        .sidebar-item:hover .sidebar-item-icon { transform: scale(1.05); }
        .sidebar-item-text { margin-left: 10px; font-size: 13px; font-weight: 500; white-space: nowrap; }
        .sidebar-footer { display: none; padding: 10px; border-top: 1px solid rgba(255,255,255,0.1); width: 100%; margin-top: 10px; }
        .sidebar.open .sidebar-footer { display: block; }
        .sidebar-settings-btn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 10px; border-radius: 10px; background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: all 0.2s; color: var(--text-primary); }
        .sidebar-settings-btn:hover { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); }
        
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 99; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .sidebar-overlay.visible { opacity: 1; visibility: visible; }
        
        .app-dock { display: none; }
        
        .quick-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 30px; width: 100%; max-width: 400px; }
        .quick-action-card { background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), calc(var(--card-opacity, 0.2) * 0.6)), rgba(var(--card-color-rgb, 255, 255, 255), calc(var(--card-opacity, 0.2) * 0.3))); backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur)); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 16px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .quick-action-card:hover { transform: translateY(-4px); background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), calc(var(--card-opacity, 0.2) * 0.9)), rgba(var(--card-color-rgb, 255, 255, 255), calc(var(--card-opacity, 0.2) * 0.5))); box-shadow: 0 12px 30px rgba(0,0,0,0.25); }
        .quick-action-icon { font-size: 32px; margin-bottom: 8px; }
        .quick-action-title { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .quick-action-desc { font-size: 11px; color: var(--text-secondary); }
        
        .stats-card { background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), calc(var(--card-opacity, 0.2) * 0.5)), rgba(var(--card-color-rgb, 255, 255, 255), calc(var(--card-opacity, 0.2) * 0.25))); backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur)); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; margin-top: 20px; width: 100%; max-width: 400px; }
        .stats-header { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px; }
        .stat-label { font-size: 11px; color: var(--text-secondary); }
        .app-page { background: rgba(30, 30, 40, var(--bg-opacity)); backdrop-filter: blur(var(--bg-blur)); -webkit-backdrop-filter: blur(var(--bg-blur)); display: flex; flex-direction: column; }
        body.light-mode .app-page { background: rgba(255, 255, 255, calc(var(--bg-opacity) * 1.5)); }
        body.light-mode .album-item { background: rgba(255, 255, 255, calc(var(--card-opacity) * 1.2)); }
        body.light-mode .album-item:hover { background: rgba(255, 255, 255, calc(var(--card-opacity) * 1.5)); }
        body.light-mode .disc-item { background: rgba(255, 255, 255, calc(var(--card-opacity) * 1.2)); }
        body.light-mode .audio-item { background: rgba(255, 255, 255, calc(var(--card-opacity) * 1.2)); }
        body.light-mode .beautify-section { background: rgba(255, 255, 255, calc(var(--card-opacity) * 1.2)); }
        body.light-mode .app-icon .icon-bg { background: rgba(255, 255, 255, var(--btn-opacity)); }
        .app-header { padding: 15px 20px; background: transparent; display: flex; align-items: center; z-index: 10; }
        .app-header .back-btn { font-size: 36px; background: none; border: none; margin-right: 15px; color: var(--text-primary); cursor: pointer; transition: transform 0.2s; padding: 5px 12px; border-radius: 8px; }
        .app-header .back-btn:hover { transform: translateX(-3px); background: rgba(255,255,255,0.1); }
        .app-header h1 { font-size: calc(var(--global-font-size) + 4px); margin: 0; flex: 1; }
        .app-header .header-action { background: none; border: none; font-size: 24px; color: var(--text-primary); margin-left: 10px; cursor: pointer; }
        .app-content { padding: 20px; overflow-y: auto; flex-grow: 1; padding-bottom: 100px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 15px; background: linear-gradient(135deg, rgba(var(--card-color-rgb, 60, 60, 80), 0.25), rgba(var(--card-color-rgb, 60, 60, 80), 0.15)); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.12); color: var(--text-primary); border-radius: 12px; font-size: inherit; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--accent-color); background: linear-gradient(135deg, rgba(var(--card-color-rgb, 60, 60, 80), 0.35), rgba(var(--card-color-rgb, 60, 60, 80), 0.2)); box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 0 3px rgba(29, 185, 84, 0.2); }
        body.light-mode .form-group input, body.light-mode .form-group textarea, body.light-mode .form-group select { background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.85), rgba(var(--card-color-rgb, 250, 250, 255), 0.7)); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(0,0,0,0.08); box-shadow: inset 0 1px 2px rgba(0,0,0,0.04), 0 2px 8px rgba(0,0,0,0.02); }
        body.light-mode .form-group input:focus, body.light-mode .form-group textarea:focus, body.light-mode .form-group select:focus { background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.92), rgba(var(--card-color-rgb, 252, 252, 255), 0.8)); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-color: var(--accent-color); box-shadow: inset 0 1px 2px rgba(0,0,0,0.04), 0 0 0 3px rgba(29, 185, 84, 0.12); }
        body.light-mode .glass-card { background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.85), rgba(var(--card-color-rgb, 250, 250, 255), 0.7)); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 8px 32px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.9); }
        body.light-mode .glass-card:hover { background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.92), rgba(var(--card-color-rgb, 252, 252, 255), 0.8)); box-shadow: 0 12px 40px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.95); }
        body.light-mode .glass-button { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 100, 100, 120), 0.15), rgba(var(--btn-color-rgb, 100, 100, 120), 0.08)); border: 1px solid rgba(0,0,0,0.1); }
        body.light-mode .glass-button:hover { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 100, 100, 120), 0.22), rgba(var(--btn-color-rgb, 100, 100, 120), 0.12)); }
        .action-button { width: 100%; padding: 15px; background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 29, 185, 84), 0.85), rgba(var(--btn-color-rgb, 29, 185, 84), 0.65)); color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 10px; font-size: var(--global-font-size); transition: all 0.2s; backdrop-filter: blur(10px); }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(var(--btn-color-rgb, 29, 185, 84), 0.4); }
        .action-button.danger { background: linear-gradient(135deg, rgba(244, 67, 54, 0.8), rgba(244, 67, 54, 0.6)); }
        .action-button.warning { background: linear-gradient(135deg, rgba(255, 152, 0, 0.8), rgba(255, 152, 0, 0.6)); }
        .album-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .media-type-tabs { display: flex; gap: 10px; margin-bottom: 20px; padding: 0 5px; }
        .media-tab { padding: 8px 16px; background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; font-size: 13px; }
        .media-tab:hover { background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); color: var(--text-primary); }
        .media-tab.active { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 99, 102, 241), 0.3), rgba(var(--btn-color-rgb, 99, 102, 241), 0.15)); border-color: rgba(var(--btn-color-rgb, 99, 102, 241), 0.6); color: var(--text-primary); }
        .album-item { background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.08), rgba(var(--card-color-rgb, 255, 255, 255), 0.04)); backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur)); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 20px 15px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; min-height: 150px; box-shadow: 0 4px 15px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.08); }
        .album-item-media-type { position: absolute; top: 8px; right: 8px; padding: 3px 8px; border-radius: 6px; font-size: 10px; background: rgba(0,0,0,0.5); color: white; backdrop-filter: blur(5px); }
        .album-item-media-type.audio { background: rgba(99, 102, 241, 0.7); }
        .album-item-media-type.video { background: rgba(239, 68, 68, 0.7); }
        .album-item:hover { background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.12), rgba(var(--card-color-rgb, 255, 255, 255), 0.06)); transform: translateY(-4px); box-shadow: 0 12px 35px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.12); }
        .album-item:active { transform: scale(0.98); }
        .album-icon { font-size: 48px; margin-bottom: 10px; width: 70px; height: 70px; background-size: cover; background-position: center; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .album-name { font-size: 14px; font-weight: 600; text-align: center; word-break: break-word; width: 100%; padding: 0 5px; }
        .album-count { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .album-actions { position: absolute; top: 8px; right: 8px; display: none; gap: 6px; }
        .album-item:hover .album-actions { display: flex; }
        .album-action-btn { background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.15), rgba(var(--card-color-rgb, 255, 255, 255), 0.08)); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; width: 30px; height: 30px; font-size: 14px; cursor: pointer; color: var(--text-primary); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .album-action-btn:hover { transform: scale(1.15); background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.22), rgba(var(--card-color-rgb, 255, 255, 255), 0.12)); }
        .album-delete-btn { color: #ff6b6b; }
        .album-edit-btn { color: #4fc3f7; }
        .view-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .mode-switch { display: flex; gap: 5px; }
        .mode-btn { padding: 8px 16px; background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); border: 1px solid rgba(255,255,255,0.12); border-radius: 20px; color: var(--text-primary); font-size: 13px; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .mode-btn:hover { background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); transform: translateY(-1px); }
        .mode-btn.active { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 29, 185, 84), 0.5), rgba(var(--btn-color-rgb, 29, 185, 84), 0.3)); border-color: rgba(var(--btn-color-rgb, 29, 185, 84), 0.6); color: white; }
        .sort-control { display: flex; align-items: center; gap: 8px; }
        .sort-control label { font-size: 13px; color: var(--text-secondary); }
        .sort-control select { padding: 6px 12px; background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; color: var(--text-primary); font-size: 13px; cursor: pointer; }
        .sort-order-btn { width: 32px; height: 32px; padding: 0; background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; color: var(--text-primary); font-size: 16px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .sort-order-btn:hover { background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); }
        .sort-order-btn.desc { transform: rotate(180deg); }
        .disc-list { display: flex; gap: 12px; overflow-x: auto; padding: 10px 0; margin-bottom: 20px; scrollbar-width: none; }
        .disc-list::-webkit-scrollbar { display: none; }
        .disc-item { flex-shrink: 0; background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur)); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); min-width: 100px; position: relative; }
        .disc-item:hover { background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); transform: translateY(-2px); }
        .disc-item.selected { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color), 0 4px 15px rgba(29, 185, 84, 0.3); }
        .disc-item.dragging { opacity: 0.5; transform: scale(0.95); }
        .disc-item.drag-over { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.5); }
        .disc-icon { font-size: 36px; margin-bottom: 8px; width: 60px; height: 60px; background-size: cover; background-position: center; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .disc-name { font-size: 13px; font-weight: 600; text-align: center; }
        .disc-actions { position: absolute; top: 4px; right: 4px; display: none; gap: 4px; }
        .disc-item:hover .disc-actions { display: flex; }
        .audio-list { display: flex; flex-direction: column; gap: 10px; }
        .audio-item { display: flex; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur)); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .audio-item:hover { background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); transform: translateX(4px); }
        .audio-item.selected { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color), 0 4px 15px rgba(29, 185, 84, 0.2); }
        .audio-checkbox { width: 24px; height: 24px; margin-right: 12px; accent-color: var(--accent-color); }
        .audio-cover { width: 50px; height: 50px; border-radius: 8px; margin-right: 12px; object-fit: cover; background: var(--bg-tertiary); }
        .audio-info { flex: 1; min-width: 0; cursor: pointer; }
        .audio-title { font-weight: 600; color: var(--text-primary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .audio-meta { font-size: 12px; color: var(--text-secondary); }
        .audio-actions { display: flex; gap: 6px; }
        .audio-action-btn { background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); border: 1px solid rgba(255,255,255,0.15); border-radius: 50%; width: 32px; height: 32px; font-size: 14px; cursor: pointer; color: var(--text-primary); display: flex; align-items: center; justify-content: center; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .audio-action-btn:hover { transform: scale(1.15); background: linear-gradient(135deg, rgba(255,255,255,0.18), rgba(255,255,255,0.1)); }
        .audio-action-btn:active { transform: scale(0.95); }
        .audio-action-btn.favorite { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .audio-action-btn.favorite:hover { background: linear-gradient(135deg, rgba(255,107,107,0.3), rgba(255,107,107,0.15)); border-color: rgba(255,107,107,0.5); }
        .audio-action-btn.favorite.active { 
            background: linear-gradient(135deg, rgba(255,107,107,0.5), rgba(255,107,107,0.3)); 
            border-color: rgba(255,107,107,0.7); 
            color: #ff6b6b;
            box-shadow: 0 0 12px rgba(255,107,107,0.4);
            animation: heartPulse 1s ease infinite;
        }
        @keyframes heartPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .audio-action-btn.play-btn { background: linear-gradient(135deg, rgba(29, 185, 84, 0.6), rgba(29, 185, 84, 0.4)); color: white; border-color: rgba(29, 185, 84, 0.5); }
        .batch-toolbar { display: none; position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); border-radius: 16px; padding: 12px 20px; gap: 15px; z-index: 100; box-shadow: 0 8px 30px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1); }
        .batch-toolbar.active { display: flex; }
        .batch-toolbar button { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .batch-toolbar .batch-delete { background: linear-gradient(135deg, rgba(244, 67, 54, 0.8), rgba(244, 67, 54, 0.6)); color: white; }
        .batch-toolbar .batch-cancel { background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); color: var(--text-primary); border: 1px solid rgba(255,255,255,0.15); }
        .batch-toolbar .selected-count { color: var(--text-primary); font-weight: bold; }
        #player-view { background-color: #000; background-size: cover; background-position: center; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .player-top-bar { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .player-top-bar button { color: white; text-shadow: 0 0 5px black; background: none; border: none; font-size: 24px; }
        .player-top-bar .back-btn { font-size: 36px; padding: 8px 16px; border-radius: 12px; background: transparent; border: none; color: rgba(255,255,255,0.85); transition: all 0.2s; }
        .player-top-bar .back-btn:hover { transform: translateX(-3px) scale(1.05); color: rgba(255,255,255,1); }
        .player-top-bar .right-controls { display: flex; align-items: center; gap: 10px; position: relative; }
        .player-top-bar .right-controls button { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)) !important; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2) !important; border-radius: 12px; width: 40px; height: 40px; font-size: 18px; display: flex; align-items: center; justify-content: center; text-shadow: none; color: #fff; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .player-top-bar .right-controls button:hover { background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15)) !important; transform: scale(1.05); }
        #player-content-wrapper { position: relative; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; transition: all 0.3s ease; }
        #player-view.style-simple #player-content-wrapper { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #player-view.style-simple .lyric-bubble { padding: 10px 15px; }
        #player-view.style-cloud { background-size: cover; background-position: center; background-repeat: no-repeat; }
        #player-view.style-cloud #player-content-wrapper { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0 20px; gap: 20px; }
        #player-view.style-cloud .lyric-scroll-container { width: var(--cloud-lyric-width, 100%); height: var(--lyric-box-height, 60vh); max-height: var(--lyric-box-height, 60vh); overflow-y: auto; padding: 20px; background: var(--cloud-lyric-box-bg, rgba(255, 255, 255, 0.1)); backdrop-filter: blur(var(--glass-blur-amount, 15px)); -webkit-backdrop-filter: blur(var(--glass-blur-amount, 15px)); border-radius: 12px; border: 1px solid var(--glass-border); }
        #player-view.style-cloud .lyric-scroll-line { padding: 10px 15px; margin: 5px 0; color: color-mix(in srgb, var(--lyric-color) calc(60% * var(--lyric-color-opacity, 1)), transparent); font-size: 16px; text-align: center; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; white-space: normal; word-break: break-word; }
        #player-view.style-cloud .lyric-scroll-line.active { color: color-mix(in srgb, var(--lyric-color) calc(100% * var(--lyric-color-opacity, 1)), transparent); font-size: 18px; font-weight: bold; background: var(--glass-bg-hover); transform: translateX(10px); }
        @media (min-width: 768px) {
            #player-view.style-cloud #player-content-wrapper { flex-direction: row; gap: 30px; }
        }
        #player-view.style-cloud .lyric-scroll-container { position: relative; cursor: move; }
        #player-view.style-cloud .lyric-scroll-container:hover::before { content: '⋮⋮'; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); font-size: 12px; color: rgba(255,255,255,0.4); letter-spacing: 2px; z-index: 10; }
        #player-view.style-cloud #album-art { cursor: move; position: relative; }
        #style-switch-menu, #player-settings-menu, #image-settings-menu { display: none; position: absolute; top: 110%; right: 0; background: linear-gradient(135deg, rgba(40,40,60,0.95), rgba(30,30,50,0.95)); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; box-shadow: 0 12px 40px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1); padding: 8px; min-width: 140px; z-index: 20; }
        #image-settings-menu { min-width: 120px; }
        #style-switch-menu.visible, #player-settings-menu.visible, #image-settings-menu.visible { display: block; }
        .style-menu-item { display: flex; align-items: center; justify-content: space-between; border-radius: 8px; }
        .style-menu-item a { flex: 1; padding: 10px 12px; color: var(--text-primary); text-decoration: none; border-radius: 8px; transition: all 0.2s ease; cursor: pointer; }
        .style-menu-item a:hover { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); transform: translateX(2px); }
        .style-menu-item a.active { background: var(--accent-color); color: white; }
        .style-settings-btn { background: transparent; border: none; color: var(--text-secondary); font-size: 14px; cursor: pointer; padding: 8px; opacity: 0.6; transition: opacity 0.2s; }
        .style-settings-btn:hover { opacity: 1; }
        .mode-display-settings { display: none; position: absolute; top: 110%; right: 0; background: var(--bg-tertiary); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); padding: 15px; min-width: 220px; z-index: 25; }
        .mode-display-settings.visible { display: block; }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        .settings-header span { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .close-settings-btn { background: transparent; border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer; padding: 0 4px; }
        .close-settings-btn:hover { color: var(--text-primary); }
        .menu-section { padding-top: 8px; margin-top: 8px; border-top: 1px solid var(--border-color); }
        .menu-section-title { font-size: 12px; color: var(--text-secondary); padding: 0 12px 4px; }
        .speed-control { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; }
        #playback-speed { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 5px 10px; }
        #video-settings-menu { position: absolute; top: 50px; right: 10px; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 12px; padding: 10px; min-width: 150px; display: none; z-index: 100; }
        #video-settings-menu.visible { display: block; }
        #video-settings-menu .speed-control { color: white; }
        #video-settings-menu select { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 5px 10px; }
        #video-progress-bar { flex-grow: 1; -webkit-appearance: none; appearance: none; width: 100%; height: 5px; background: rgba(255,255,255,0.3); border-radius: 5px; outline: none; }
        #video-progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .slider-control { margin-bottom: 15px; }
        .slider-control:last-child { margin-bottom: 0; }
        .slider-control label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px; }
        .slider-control input[type="range"] { width: 100%; height: 5px; -webkit-appearance: none; appearance: none; background: var(--border-color); border-radius: 5px; outline: none; }
        .slider-control input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: rgb(var(--btn-color-rgb)); border-radius: 50%; cursor: pointer; }
        .slider-value { font-size: 12px; color: var(--text-primary); float: right; }
        #album-art { object-fit: cover; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.5); cursor: grab; touch-action: none; transition: transform 0.1s; }
        #album-art.dragging { cursor: grabbing; box-shadow: 0 12px 35px rgba(0,0,0,0.7); transition: none; }
        .lyric-bubble { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: var(--simple-lyric-width, 90%); background: var(--simple-lyric-box-bg); backdrop-filter: blur(var(--glass-blur-amount, 15px)); -webkit-backdrop-filter: blur(var(--glass-blur-amount, 15px)); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px 20px; cursor: grab; z-index: 10; touch-action: none; text-align: center; transition: transform 0.1s; }
        .lyric-bubble.dragging { cursor: grabbing; transition: none; }
        .lyric-bubble p { margin: 0; color: color-mix(in srgb, var(--lyric-color) var(--lyric-color-opacity, 1), transparent); font-size: var(--simple-lyric-font-size, 16px); }
        #song-title-box { background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 8px; padding: 8px 15px; color: white; font-size: 14px; white-space: nowrap; overflow: hidden; }
        .simple-title-box { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); cursor: grab; z-index: 9; touch-action: none; transition: transform 0.1s; white-space: nowrap; }
        .simple-title-box.dragging { cursor: grabbing; transition: none; }
        .cloud-title-box { cursor: grab; touch-action: none; transition: transform 0.1s; display: inline-block; margin-bottom: 20px; white-space: nowrap; }
        .cloud-title-box.dragging { cursor: grabbing; transition: none; }
        #player-view.style-simple #album-art { width: var(--simple-cover-size, 220px); height: var(--simple-cover-size, 220px); position: relative; }
        #player-view.style-cloud #album-art { width: 220px; height: 220px; flex-shrink: 0; position: relative; }
        .player-controls { width: 100%; padding: 15px 0; color: white; flex-shrink: 0; }
        .progress-bar-container { display: flex; align-items: center; gap: 10px; width: 100%; font-size: 12px; }
        #progress-bar { flex-grow: 1; -webkit-appearance: none; appearance: none; width: 100%; height: 5px; background: rgba(255,255,255,0.3); border-radius: 5px; outline: none; transition: opacity .2s; }
        #progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .main-controls { display: flex; justify-content: center; align-items: center; margin-top: 15px; gap: 25px; }
        .main-controls button { background: none; border: none; display: flex; align-items: center; justify-content: center; padding: 0; color: white; text-shadow: 0 0 5px rgba(0,0,0,0.5); transition: all 0.2s; }
        .main-controls button:hover { transform: scale(1.1); }
        #play-pause-btn { background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border); color: #fff; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-shadow: none; }
        #prev-btn, #next-btn { font-size: 32px; opacity: 0.9; }
        .extra-controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 10px; }
        .extra-controls button { background: var(--glass-bg); border: 1px solid var(--glass-border); color: white; font-size: 18px; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .extra-controls button:hover { background: var(--glass-bg-hover); transform: scale(1.05); }
        .volume-control { display: flex; align-items: center; gap: 8px; }
        #volume-slider { width: 80px; height: 4px; -webkit-appearance: none; appearance: none; background: rgba(255,255,255,0.3); border-radius: 2px; outline: none; }
        #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: #fff; border-radius: 50%; cursor: pointer; }
        #volume-slider { opacity: 0.7; transition: opacity 0.2s; }
        .volume-control:hover #volume-slider { opacity: 1; }
        #color-picker { display: none; position: absolute; top: 60px; right: 20px; background: var(--bg-tertiary); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); padding: 12px; border-radius: 12px; grid-template-columns: repeat(4, 1fr); gap: 10px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); z-index: 20; border: 1px solid var(--border-color); }
        #color-picker.visible { display: grid; }
        .color-swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .color-swatch:hover { border-color: white; transform: scale(1.1); }
        .beautify-section { background: rgba(60, 60, 80, var(--card-opacity)); backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur)); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .beautify-section h2 { font-size: 16px; margin-bottom: 15px; color: var(--text-primary); }
        
        .theme-presets { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .theme-preset { cursor: pointer; text-align: center; transition: all 0.2s; }
        .theme-preset:hover { transform: translateY(-3px); }
        .theme-preset.active .theme-preview { box-shadow: 0 0 0 3px var(--accent-color); }
        .theme-preview { width: 100%; aspect-ratio: 1; border-radius: 12px; margin-bottom: 8px; transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .theme-preset span { font-size: 12px; color: var(--text-secondary); }
        
        .smart-preview-btn { padding: 10px 20px; background: rgba(var(--btn-color-rgb, 99, 102, 241), 0.15); border: 1px solid rgba(var(--btn-color-rgb, 99, 102, 241), 0.3); border-radius: 8px; color: var(--text-primary); cursor: pointer; transition: all 0.2s; }
        .smart-preview-btn:hover { background: rgba(var(--btn-color-rgb, 99, 102, 241), 0.25); }
        
        .color-swatch { width: 40px; height: 40px; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .color-swatch:hover { transform: scale(1.1); }
        
        .color-use-menu { position: fixed; background: rgba(40, 40, 50, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 8px 0; z-index: 10000; }
        .color-menu-item { padding: 10px 20px; cursor: pointer; font-size: 13px; color: var(--text-primary); transition: background 0.2s; }
        .color-menu-item:hover { background: rgba(255,255,255,0.1); }
        
        .extract-btn { display: flex; align-items: center; justify-content: center; padding: 12px 15px; background: linear-gradient(135deg, rgba(29, 185, 84, 0.2), rgba(29, 185, 84, 0.1)); border: 1px solid rgba(29, 185, 84, 0.3); border-radius: 12px; color: var(--text-primary); cursor: pointer; transition: all 0.2s; }
        .extract-btn:hover { background: linear-gradient(135deg, rgba(29, 185, 84, 0.3), rgba(29, 185, 84, 0.15)); transform: translateY(-2px); }
        .color-swatch { width: 40px; height: 40px; border-radius: 8px; border: 2px solid var(--glass-border); cursor: pointer; transition: all 0.2s; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected { border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-color); }
        .smart-preview-btn { padding: 10px 20px; border-radius: 12px; border: 1px solid var(--smart-button-border); background: var(--smart-button-bg); color: var(--smart-button-text); font-size: 14px; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .smart-preview-btn:hover { background: var(--smart-button-hover); transform: translateY(-2px); }
        .extract-btn { padding: 14px 20px; border-radius: 12px; border: 1px solid rgba(var(--primary-rgb), 0.3); background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.2), rgba(var(--primary-rgb), 0.1)); color: var(--text-primary); font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .extract-btn:hover { background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.3), rgba(var(--primary-rgb), 0.2)); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(var(--primary-rgb), 0.3); }
        body.smart-color-enabled .app-page { background: rgba(var(--bg-color-rgb), var(--bg-opacity)) !important; }
        body.smart-color-enabled .album-item { background: rgba(var(--card-color-rgb), var(--card-opacity)) !important; border-color: rgba(var(--card-color-rgb), 0.3) !important; }
        body.smart-color-enabled .album-item:hover { background: rgba(var(--card-color-rgb), calc(var(--card-opacity) * 1.2)) !important; }
        body.smart-color-enabled .disc-item { background: rgba(var(--card-color-rgb), var(--card-opacity)) !important; border-color: rgba(var(--card-color-rgb), 0.3) !important; }
        body.smart-color-enabled .disc-item.selected { border-color: rgba(var(--btn-color-rgb), 0.4); box-shadow: 0 0 0 2px rgba(var(--btn-color-rgb), 0.3); }
        body.smart-color-enabled .audio-item { background: rgba(var(--card-color-rgb), var(--card-opacity)) !important; border-color: rgba(var(--card-color-rgb), 0.3) !important; }
        body.smart-color-enabled .audio-item:hover { background: rgba(var(--card-color-rgb), calc(var(--card-opacity) * 1.2)) !important; }
        body.smart-color-enabled .beautify-section { background: rgba(var(--card-color-rgb), var(--card-opacity)) !important; border-color: rgba(var(--card-color-rgb), 0.3) !important; }
        body.smart-color-enabled .app-icon .icon-bg { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border: 1px solid rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .app-icon .icon-bg:hover { background: rgba(var(--btn-color-rgb), calc(var(--btn-opacity) * 1.3)) !important; transform: scale(1.1); }
        body.smart-color-enabled .glass-button { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; color: var(--smart-button-text) !important; }
        body.smart-color-enabled .glass-button:hover { background: rgba(var(--btn-color-rgb), calc(var(--btn-opacity) * 1.3)) !important; }
        body.smart-color-enabled .bottom-control-btn { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .modal-confirm-btn { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .modal-cancel-btn { background: rgba(var(--card-color-rgb), var(--card-opacity)) !important; border-color: rgba(var(--card-color-rgb), 0.3) !important; }
        body.smart-color-enabled .action-button { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .batch-mode-btn { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .extract-btn { background: linear-gradient(135deg, rgba(var(--btn-color-rgb), 0.3), rgba(var(--btn-color-rgb), 0.15)) !important; border-color: rgba(var(--btn-color-rgb), 0.4) !important; }
        body.smart-color-enabled .album-action-btn { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .audio-action-btn { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .header-action { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border: 1px solid rgba(var(--btn-color-rgb), 0.3) !important; border-radius: 50%; }
        body.smart-color-enabled .app-header .back-btn { color: var(--btn-color-rgb) !important; }
        body.smart-color-enabled .player-top-bar .back-btn { color: rgba(255,255,255,0.85) !important; }
        body.smart-color-enabled .player-top-bar .right-controls button { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .player-top-bar .right-controls button:hover { background: rgba(var(--btn-color-rgb), calc(var(--btn-opacity) * 1.3)) !important; }
        body.smart-color-enabled { --text-primary: rgb(var(--text-color-rgb)); --text-secondary: rgba(var(--text-color-rgb), 0.7); }
        body.smart-color-enabled .album-name,
        body.smart-color-enabled .disc-name,
        body.smart-color-enabled .audio-title,
        body.smart-color-enabled .audio-meta,
        body.smart-color-enabled .form-group label,
        body.smart-color-enabled .form-group input,
        body.smart-color-enabled .modal-content h3,
        body.smart-color-enabled .beautify-section h2,
        body.smart-color-enabled .app-icon span,
        body.smart-color-enabled .empty-tip,
        body.smart-color-enabled .glass-settings-title,
        body.smart-color-enabled .glass-section-title { color: rgb(var(--text-color-rgb)) !important; }
        body.smart-color-enabled .form-group input,
        body.smart-color-enabled .form-group textarea,
        body.smart-color-enabled .form-group select { background: linear-gradient(135deg, rgba(var(--card-color-rgb), 0.3), rgba(var(--card-color-rgb), 0.2)) !important; border-color: rgba(var(--card-color-rgb), 0.4) !important; backdrop-filter: blur(15px) !important; -webkit-backdrop-filter: blur(15px) !important; }
        body.smart-color-enabled .form-group input:focus,
        body.smart-color-enabled .form-group textarea:focus,
        body.smart-color-enabled .form-group select:focus { background: linear-gradient(135deg, rgba(var(--card-color-rgb), 0.4), rgba(var(--card-color-rgb), 0.25)) !important; border-color: rgba(var(--btn-color-rgb), 0.5) !important; box-shadow: 0 0 0 3px rgba(var(--btn-color-rgb), 0.2) !important; }
        body.smart-color-enabled .modal-content { background: linear-gradient(135deg, rgba(var(--card-color-rgb), 0.95), rgba(var(--bg-color-rgb), 0.95)) !important; border-color: rgba(var(--card-color-rgb), 0.3) !important; }
        body.smart-color-enabled #player-view,
        body.smart-color-enabled .lyric-bubble { color: var(--lyric-color) !important; }
        body.smart-color-enabled .full-lyric-line.active { color: var(--lyric-color) !important; }
        .app-customize-row { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
        .app-customize-row .preview-icon { width: 50px; height: 50px; border-radius: 12px; object-fit: cover; background: var(--bg-tertiary); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .app-customize-row .app-name-input { flex-grow: 1; padding: 10px 12px; background: var(--glass-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; }
        .app-customize-row .select-file-btn { padding: 8px 12px; font-size: 13px; background: linear-gradient(135deg, rgba(3, 169, 244, 0.8), rgba(3, 169, 244, 0.6)); color: white; border: none; border-radius: 8px; cursor: pointer; }
        .input-with-button { display: flex; gap: 10px; }
        .input-with-button input { flex-grow: 1; }
        .input-with-button button { padding: 10px 15px; background: linear-gradient(135deg, rgba(29, 185, 84, 0.8), rgba(29, 185, 84, 0.6)); color: white; border: none; border-radius: 8px; }
        .font-size-control { display: flex; align-items: center; gap: 15px; }
        .font-size-control input[type="range"] { flex-grow: 1; }
        .font-size-control span { font-weight: bold; min-width: 40px; text-align: right; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--bg-secondary); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 25px; border-radius: 16px; max-width: 90%; width: 380px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid var(--border-color); -webkit-overflow-scrolling: touch; }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; color: var(--text-primary); font-size: 18px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { flex: 1; padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 500; transition: all 0.2s; min-height: 48px; font-size: 15px; }
        .modal-cancel-btn { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .modal-confirm-btn { background: linear-gradient(135deg, rgba(29, 185, 84, 0.8), rgba(29, 185, 84, 0.6)); color: white; border: none; }
        .modal-confirm-btn.danger { background: linear-gradient(135deg, rgba(244, 67, 54, 0.8), rgba(244, 67, 54, 0.6)); }
        @media (max-width: 480px) {
            .modal-overlay { align-items: flex-end; }
            .modal-overlay.active { align-items: flex-end; }
            .modal-content { 
                width: 100%; 
                max-width: 100%; 
                border-radius: 20px 20px 0 0; 
                padding: 20px 16px 24px;
                max-height: 90vh;
                animation: slideUp 0.3s ease;
            }
            .modal-content::before {
                content: '';
                display: block;
                width: 40px;
                height: 4px;
                background: rgba(255,255,255,0.3);
                border-radius: 2px;
                margin: 0 auto 16px;
            }
            @keyframes slideUp {
                from { transform: translateY(100%); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .modal-buttons { flex-direction: column-reverse; gap: 8px; }
            .modal-buttons button { width: 100%; }
        }
        .image-preview { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; margin-left: 10px; background-color: var(--bg-tertiary); }
        .hidden-input { display: none; }
        .source-switcher { display: flex; gap: 20px; margin-bottom: 10px; }
        .source-switcher label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .import-vtt-btn { margin-bottom: 5px; font-size: 12px; background: var(--glass-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 6px 12px; border-radius: 8px; cursor: pointer; }
        #full-lyrics-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 2000; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        #full-lyrics-modal.active { transform: translateY(0); }
        .full-lyrics-header { padding: 20px; display: flex; justify-content: flex-end; }
        .close-lyrics-btn { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 24px; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .close-lyrics-btn:hover { transform: scale(1.1); background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)); }
        .full-lyrics-container { flex-grow: 1; overflow-y: auto; padding: 20px; text-align: center; -webkit-mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent); mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent); }
        .full-lyric-line { padding: 12px 5px; color: #666; font-size: 18px; transition: all 0.3s; cursor: pointer; }
        .full-lyric-line.active { color: var(--lyric-color); font-size: 24px; font-weight: bold; text-shadow: 0 0 10px rgba(255,255,255,0.3); transform: scale(1.05); }
        #bottom-player { position: fixed; bottom: 0; left: 0; width: 100%; background: linear-gradient(180deg, rgba(var(--card-color-rgb, 25, 25, 35), 0.95), rgba(var(--card-color-rgb, 15, 15, 25), 0.98)); backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%); border-top: 1px solid rgba(255,255,255,0.08); box-shadow: 0 -10px 50px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.06); z-index: 1000; transform: translateY(0); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding-bottom: env(safe-area-inset-bottom, 0px); }
        #bottom-player.hidden-player { transform: translateY(100%); }
        .bottom-player-content { display: flex; align-items: center; padding: 8px 12px; max-width: 768px; margin: 0 auto; gap: 10px; height: auto; min-height: 60px; box-sizing: border-box; flex-wrap: wrap; }
        .bottom-player-info { display: flex; align-items: center; gap: 10px; flex: 0 0 auto; min-width: 0; cursor: pointer; padding: 5px; border-radius: 12px; transition: all 0.2s; }
        .bottom-player-info:hover { background: rgba(255,255,255,0.08); }
        .bottom-player-info:active { background: rgba(255,255,255,0.12); }
        #bottom-player-art { width: 44px; height: 44px; border-radius: 10px; object-fit: cover; background: linear-gradient(135deg, rgba(var(--card-color-rgb, 60, 60, 80), 0.8), rgba(var(--card-color-rgb, 40, 40, 60), 0.8)); box-shadow: 0 2px 10px rgba(0,0,0,0.3); flex-shrink: 0; }
        .bottom-player-text { display: flex; flex-direction: column; justify-content: center; min-width: 0; max-width: 120px; }
        #bottom-player-title { font-size: 13px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
        #bottom-player-subtitle { font-size: 11px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #bottom-player-lyric { width: 100%; text-align: center; font-size: calc(var(--global-font-size, 16px) * 0.75); color: var(--lyric-color, rgba(255,255,255,0.7)); padding: 4px 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; order: 10; flex: 1 1 100%; min-height: 20px; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        body.smart-color-enabled #bottom-player-lyric { color: var(--lyric-color) !important; }
        .bottom-player-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .bottom-control-btn { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 100, 100, 120), 0.2), rgba(var(--btn-color-rgb, 100, 100, 120), 0.1)); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(var(--btn-color-rgb, 100, 100, 120), 0.3); color: var(--text-primary); font-size: 16px; cursor: pointer; padding: 0; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 8px rgba(var(--btn-color-rgb, 100, 100, 120), 0.2); }
        .bottom-control-btn:hover { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 100, 100, 120), 0.3), rgba(var(--btn-color-rgb, 100, 100, 120), 0.15)); border-color: rgba(var(--btn-color-rgb, 100, 100, 120), 0.45); transform: scale(1.08); box-shadow: 0 4px 12px rgba(var(--btn-color-rgb, 100, 100, 120), 0.3); }
        .bottom-control-btn:active { transform: scale(0.95); }
        .bottom-control-btn.play-btn { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 29, 185, 84), 0.9), rgba(var(--btn-color-rgb, 29, 185, 84), 0.7)); color: white; font-size: 14px; border: none; width: 42px; height: 42px; box-shadow: 0 4px 15px rgba(var(--btn-color-rgb, 29, 185, 84), 0.4); }
        .bottom-control-btn.play-btn:hover { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 29, 185, 84), 1), rgba(var(--btn-color-rgb, 29, 185, 84), 0.8)); box-shadow: 0 6px 20px rgba(var(--btn-color-rgb, 29, 185, 84), 0.5); }
        .bottom-player-progress-area { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 3px; min-width: 100px; background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.08), rgba(var(--card-color-rgb, 255, 255, 255), 0.04)); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 10px; padding: 6px 10px; border: 1px solid rgba(255,255,255,0.06); }
        #bottom-progress { width: 100%; height: 4px; -webkit-appearance: none; appearance: none; background: linear-gradient(90deg, rgba(var(--btn-color-rgb, 29, 185, 84), 0.3), rgba(255,255,255,0.15)); border-radius: 4px; outline: none; cursor: pointer; }
        #bottom-progress::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; background: rgb(var(--btn-color-rgb, 29, 185, 84)); border-radius: 50%; cursor: pointer; transition: all 0.15s; box-shadow: 0 2px 6px rgba(var(--btn-color-rgb, 29, 185, 84), 0.5); }
        #bottom-progress::-webkit-slider-thumb:hover { transform: scale(1.2); box-shadow: 0 3px 10px rgba(var(--btn-color-rgb, 29, 185, 84), 0.6); }
        .bottom-time { display: flex; justify-content: space-between; font-size: 10px; color: rgba(255,255,255,0.6); font-variant-numeric: tabular-nums; }
        .bottom-time span { min-width: 32px; }
        .bottom-time span:last-child { text-align: right; }
        .bottom-player-handle { position: absolute; top: 5px; left: 50%; transform: translateX(-50%); width: 32px; height: 3px; background: rgba(255,255,255,0.25); border-radius: 2px; }
        body.light-mode #bottom-player { background: linear-gradient(180deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.95), rgba(var(--card-color-rgb, 248, 248, 252), 0.98)); border-top: 1px solid rgba(0,0,0,0.06); box-shadow: 0 -10px 50px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.8); }
        body.light-mode .bottom-control-btn { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 0, 0, 0), 0.08), rgba(var(--btn-color-rgb, 0, 0, 0), 0.04)); border: 1px solid rgba(var(--btn-color-rgb, 0, 0, 0), 0.1); color: #333; }
        body.light-mode .bottom-control-btn:hover { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 0, 0, 0), 0.12), rgba(var(--btn-color-rgb, 0, 0, 0), 0.06)); border-color: rgba(var(--btn-color-rgb, 0, 0, 0), 0.15); }
        body.light-mode .bottom-control-btn.play-btn { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 29, 185, 84), 0.9), rgba(var(--btn-color-rgb, 29, 185, 84), 0.7)); color: white; border: none; }
        body.light-mode .bottom-player-progress-area { background: linear-gradient(135deg, rgba(var(--card-color-rgb, 0, 0, 0), 0.04), rgba(var(--card-color-rgb, 0, 0, 0), 0.02)); border: 1px solid rgba(var(--card-color-rgb, 0, 0, 0), 0.05); }
        body.light-mode #bottom-progress { background: linear-gradient(90deg, rgba(var(--btn-color-rgb, 29, 185, 84), 0.4), rgba(var(--card-color-rgb, 0, 0, 0), 0.1)); }
        body.light-mode #bottom-player-lyric { color: var(--lyric-color) !important; text-shadow: none; }
        body.light-mode .bottom-time { color: rgba(0,0,0,0.5); }
        body.no-active-song #bottom-player { transform: translateY(calc(100% + 20px)); }
        #player-view.active ~ #bottom-player { transform: translateY(100%); transition-delay: 0.1s; }
        #video-player-view.active ~ #bottom-player { transform: translateY(100%); transition-delay: 0.1s; }
        
        .video-container { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; max-width: 900px; margin: 0 auto; width: 100%; }
        .video-player { max-width: 100%; max-height: 70vh; border-radius: 12px; background: #000; }
        .video-player-title { flex: 1; text-align: center; font-size: 14px; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 15px; }
        
        .video-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; background: transparent; transition: background 0.3s; }
        .video-overlay.visible { background: rgba(0,0,0,0.3); }
        .video-center-controls { display: flex; gap: 30px; opacity: 0; transition: opacity 0.3s; }
        .video-overlay.visible .video-center-controls { opacity: 1; }
        .video-center-btn { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; cursor: pointer; transition: all 0.2s; backdrop-filter: blur(10px); }
        .video-center-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .video-center-btn.play-btn { width: 70px; height: 70px; font-size: 28px; }
        .video-gesture-hint { position: absolute; font-size: 24px; color: white; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 8px; opacity: 0; transition: opacity 0.2s; }
        .video-gesture-hint.visible { opacity: 1; }
        
        .video-bottom-controls { padding: 15px 20px; background: linear-gradient(transparent, rgba(0,0,0,0.8)); }
        .video-progress-container { margin-bottom: 15px; }
        .video-progress-bar { height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; position: relative; cursor: pointer; transition: height 0.2s; }
        .video-progress-bar:hover { height: 6px; }
        .video-progress-buffered { position: absolute; top: 0; left: 0; height: 100%; background: rgba(255,255,255,0.3); border-radius: 2px; }
        .video-progress-current { position: absolute; top: 0; left: 0; height: 100%; background: var(--accent-color); border-radius: 2px; }
        .video-progress-thumb { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 14px; height: 14px; background: white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.2s; }
        .video-progress-bar:hover .video-progress-thumb { opacity: 1; }
        .video-time-display { display: flex; justify-content: center; gap: 5px; margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.8); }
        
        .video-control-buttons { display: flex; align-items: center; justify-content: center; gap: 15px; }
        .video-control-buttons button { background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: all 0.2s; font-size: 16px; }
        .video-control-buttons button:hover { background: rgba(255,255,255,0.2); }
        .video-control-buttons .main-play-btn { width: 50px; height: 50px; font-size: 20px; background: var(--accent-color); }
        .video-control-buttons .main-play-btn:hover { background: #1ed760; transform: scale(1.05); }
        
        .speed-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .speed-buttons button { padding: 6px 12px; background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .speed-buttons button:hover { background: rgba(255,255,255,0.2); }
        .speed-buttons button.active { background: var(--accent-color); }
        
        .empty-tip { text-align: center; color: var(--text-secondary); margin-top: 50px; padding: 40px 20px; }
        .empty-tip .empty-icon { font-size: 64px; margin-bottom: 15px; opacity: 0.5; }
        .empty-tip p { font-size: 14px; }
        .dialog-warning { color: #ff9800; font-size: 12px; margin-top: 5px; display: none; }
        .dialog-warning.visible { display: block; }
        .toast-with-undo { display: flex; align-items: center; gap: 15px; }
        .toast-undo-btn { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 29, 185, 84), 0.85), rgba(var(--btn-color-rgb, 29, 185, 84), 0.65)); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: transform 0.2s; }
        .toast-undo-btn:hover { transform: scale(1.05); }
        .batch-mode-btn { background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.08), rgba(var(--card-color-rgb, 255, 255, 255), 0.04)); border: 1px solid rgba(255,255,255,0.12); color: var(--text-primary); padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; margin-bottom: 15px; transition: all 0.2s; }
        .batch-mode-btn:hover { background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.12), rgba(var(--card-color-rgb, 255, 255, 255), 0.06)); }
        .batch-mode-btn.active { background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 29, 185, 84), 0.5), rgba(var(--btn-color-rgb, 29, 185, 84), 0.3)); border-color: rgba(var(--btn-color-rgb, 29, 185, 84), 0.5); color: white; }
        .glass-settings-btn { display: none; }
        .glass-settings-panel { position: fixed; top: 80px; right: 80px; background: linear-gradient(135deg, rgba(var(--card-color-rgb, 40, 40, 60), 0.95), rgba(var(--card-color-rgb, 30, 30, 50), 0.95)); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; padding: 15px; min-width: 200px; display: none; z-index: 101; box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1); }
        .glass-settings-panel.visible { display: block; }
        .glass-settings-title { font-size: 14px; font-weight: bold; margin-bottom: 12px; color: var(--text-primary); text-align: center; }
        .glass-settings-section { margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--glass-border); }
        .glass-settings-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .glass-section-title { font-size: 12px; color: rgb(var(--btn-color-rgb, 29, 185, 84)); margin-bottom: 8px; font-weight: bold; }
        .glass-setting-item { margin-bottom: 8px; }
        .glass-setting-item:last-child { margin-bottom: 0; }
        .glass-setting-item label { display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .glass-slider-row { display: flex; align-items: center; gap: 8px; }
        .glass-slider-row input[type="range"] { flex: 1; height: 4px; -webkit-appearance: none; appearance: none; background: linear-gradient(90deg, rgba(var(--btn-color-rgb, 29, 185, 84), 0.3), var(--glass-border)); border-radius: 2px; outline: none; }
        .glass-slider-row input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; background: rgb(var(--btn-color-rgb, 29, 185, 84)); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 6px rgba(var(--btn-color-rgb, 29, 185, 84), 0.4); }
        .glass-slider-row input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); box-shadow: 0 3px 10px rgba(var(--btn-color-rgb, 29, 185, 84), 0.5); }
        .glass-slider-row span { font-size: 11px; color: var(--text-primary); min-width: 35px; text-align: right; }
        
        .play-queue-panel { position: fixed; top: 0; right: -320px; width: 320px; height: 100%; background: linear-gradient(135deg, rgba(var(--card-color-rgb, 40, 40, 60), 0.98), rgba(var(--card-color-rgb, 25, 25, 40), 0.98)); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-left: 1px solid rgba(255,255,255,0.15); z-index: 2000; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; box-shadow: -10px 0 40px rgba(0,0,0,0.5); }
        .play-queue-panel.open { right: 0; }
        .queue-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .queue-header h3 { margin: 0; font-size: 18px; color: var(--text-primary); }
        .queue-actions { display: flex; gap: 10px; }
        .queue-action-btn { background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.15); border-radius: 50%; width: 36px; height: 36px; font-size: 16px; cursor: pointer; color: var(--text-primary); transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .queue-action-btn:hover { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); transform: scale(1.05); }
        .queue-list { flex: 1; overflow-y: auto; padding: 10px; }
        .queue-item { display: flex; align-items: center; padding: 12px; background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .queue-item:hover { background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); transform: translateX(-4px); }
        .queue-item.playing { border-color: var(--accent-color); background: linear-gradient(135deg, rgba(29, 185, 84, 0.15), rgba(29, 185, 84, 0.08)); }
        .queue-item-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 12px; background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 99, 102, 241), 0.3), rgba(var(--btn-color-rgb, 99, 102, 241), 0.15)); flex-shrink: 0; }
        .queue-item-info { flex: 1; min-width: 0; }
        .queue-item-title { font-size: 14px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .queue-item-meta { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        .queue-item-remove { background: none; border: none; color: var(--text-secondary); font-size: 16px; cursor: pointer; padding: 4px; opacity: 0.6; transition: all 0.2s; }
        .queue-item-remove:hover { opacity: 1; color: #ff6b6b; transform: scale(1.1); }
        .queue-empty-tip { display: none; text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .queue-empty-tip.visible { display: block; }
        .queue-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .queue-overlay.visible { opacity: 1; visibility: visible; }
        
        .sleep-timer-bar {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(var(--card-color-rgb, 40, 40, 60), 0.95), rgba(var(--card-color-rgb, 25, 25, 40), 0.95));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 10px 20px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease;
        }
        .sleep-timer-bar.visible { display: flex; }
        .sleep-timer-icon { font-size: 18px; }
        .sleep-timer-text { color: var(--text-primary); font-size: 14px; }
        .sleep-timer-countdown { 
            font-family: monospace; 
            font-size: 16px; 
            font-weight: 600;
            color: var(--accent-color);
            min-width: 60px;
        }
        .sleep-timer-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .sleep-timer-close:hover {
            background: rgba(255,100,100,0.2);
            color: #ff6b6b;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        .recent-play-section { margin-top: 30px; padding: 0 20px; width: 100%; max-width: 600px; }
        .recent-play-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .recent-play-header h3 { font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0; }
        .view-all-btn { background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.15); color: var(--text-secondary); padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .view-all-btn:hover { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); color: var(--text-primary); }
        .recent-play-list { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; -ms-overflow-style: none; }
        .recent-play-list::-webkit-scrollbar { display: none; }
        .recent-item { flex: 0 0 auto; width: 120px; background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.12), rgba(var(--card-color-rgb, 255, 255, 255), 0.06)); backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur)); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; cursor: pointer; transition: all 0.2s; }
        .recent-item:hover { transform: translateY(-4px); background: linear-gradient(135deg, rgba(var(--card-color-rgb, 255, 255, 255), 0.18), rgba(var(--card-color-rgb, 255, 255, 255), 0.1)); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .recent-item-cover { width: 100%; aspect-ratio: 1; border-radius: 8px; object-fit: cover; margin-bottom: 8px; background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 99, 102, 241), 0.3), rgba(var(--btn-color-rgb, 99, 102, 241), 0.15)); }
        .recent-item-title { font-size: 12px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
        .recent-item-meta { font-size: 10px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .recent-item-type { display: inline-block; font-size: 9px; padding: 2px 5px; border-radius: 4px; background: rgba(var(--btn-color-rgb, 99, 102, 241), 0.2); color: var(--text-primary); margin-top: 4px; }
        
        @keyframes ripple {
            to { transform: scale(4); opacity: 0; }
        }
        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideOutDown {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .ripple-container { position: relative; overflow: hidden; }
        .ripple { position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.4); transform: scale(0); animation: ripple 0.6s linear; pointer-events: none; }
        
        .toast-animate { animation: slideInUp 0.3s ease-out; }
        .toast-animate-out { animation: slideOutDown 0.3s ease-in forwards; }
        
        .glass-enhanced { 
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }
        .glass-enhanced:hover {
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }
        
        .btn-press:active { transform: scale(0.96) !important; }
        
        .card-3d { transform-style: preserve-3d; perspective: 1000px; }
        .card-3d:hover { transform: translateY(-4px) rotateX(2deg) rotateY(-2deg); }
        
        .skeleton {
            background: linear-gradient(90deg, var(--glass-bg) 25%, var(--glass-bg-hover) 50%, var(--glass-bg) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--glass-border);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .smooth-scroll { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        
        html.touch-device .glass-card:hover,
        html.touch-device .glass-button:hover,
        html.touch-device .album-item:hover,
        html.touch-device .disc-item:hover,
        html.touch-device .audio-item:hover,
        html.touch-device .sidebar-item:hover,
        html.touch-device .quick-action-card:hover,
        html.touch-device .theme-preset:hover,
        html.touch-device .recent-item:hover {
            transform: none !important;
            box-shadow: inherit !important;
        }
        html.touch-device .glass-card:active,
        html.touch-device .glass-button:active,
        html.touch-device .album-item:active,
        html.touch-device .disc-item:active,
        html.touch-device .audio-item:active,
        html.touch-device .sidebar-item:active,
        html.touch-device .quick-action-card:active {
            transform: scale(0.98) !important;
            opacity: 0.9;
        }
        html.touch-device .audio-action-btn:active,
        html.touch-device .bottom-control-btn:active,
        html.touch-device .album-action-btn:active {
            transform: scale(0.95) !important;
        }
        @media (max-width: 480px) {
            .album-grid { grid-template-columns: 1fr; }
            .desktop-time { font-size: 56px; }
            .desktop-date { font-size: 18px; }
            .app-dock { gap: 15px; }
            .bottom-player-text { max-width: 80px; }
            .glass-button { padding: 12px 20px; font-size: 14px; min-height: 44px; }
            .album-item { min-height: 120px; padding: 15px 10px; }
            .form-group input, .form-group textarea { padding: 12px 14px; font-size: 16px; }
            #player-view { padding: 10px; }
            #player-view.style-simple #album-art { width: 180px !important; height: 180px !important; }
            #player-view.style-cloud #album-art { width: 140px !important; height: 140px !important; }
            .player-top-bar .right-controls { gap: 8px; }
            .player-top-bar .right-controls button { width: 44px; height: 44px; font-size: 18px; }
            .main-controls { gap: 20px; }
            #play-pause-btn { width: 56px; height: 56px; font-size: 22px; }
            #prev-btn, #next-btn { font-size: 32px; padding: 8px; }
            .extra-controls { gap: 12px; }
            .extra-controls button { font-size: 18px; padding: 10px 14px; min-width: 44px; min-height: 44px; }
            .volume-control { flex-wrap: wrap; justify-content: center; }
            #volume-slider { width: 80px; height: 6px; }
            .lyric-bubble { padding: 12px 15px; width: 95% !important; }
            .lyric-bubble p { font-size: 14px !important; }
            .simple-title-box { top: 8%; }
            #song-title-box { font-size: 12px; padding: 8px 14px; }
            #player-view.style-cloud .lyric-scroll-container { height: 45vh !important; max-height: 45vh !important; padding: 15px; }
            #player-view.style-cloud .lyric-scroll-line { padding: 10px 14px; font-size: 15px; }
            #player-view.style-cloud .lyric-scroll-line.active { font-size: 17px; }
            .cloud-title-box { margin-bottom: 12px; }
            .cloud-title-box #song-title-box { font-size: 14px; }
            #style-switch-menu, #player-settings-menu, #image-settings-menu { min-width: 140px; right: -5px; }
            .style-menu-item a { padding: 12px 14px; font-size: 14px; }
            .mode-display-settings { min-width: 220px; right: -10px; }
            .slider-control { margin-bottom: 12px; }
            .slider-control label { font-size: 13px; }
            .progress-bar-container { gap: 10px; font-size: 12px; }
            #progress-bar { height: 6px; }
            #progress-bar::-webkit-slider-thumb { width: 18px; height: 18px; }
            .full-lyric-line { padding: 12px 8px; font-size: 17px; }
            .full-lyric-line.active { font-size: 21px; }
            .close-lyrics-btn { width: 44px; height: 44px; font-size: 22px; }
            .bottom-player-content { padding: 8px 12px; gap: 10px; min-height: 64px; }
            #bottom-player-art { width: 44px; height: 44px; }
            #bottom-player-title { font-size: 13px; }
            #bottom-player-subtitle { font-size: 11px; }
            .bottom-control-btn { width: 40px; height: 40px; font-size: 16px; }
            .bottom-control-btn.play-btn { width: 48px; height: 48px; font-size: 14px; }
            #bottom-player-lyric { font-size: 12px; padding: 4px 10px; }
            .bottom-player-progress-area { padding: 6px 10px; }
            #bottom-progress { height: 5px; }
            #bottom-progress::-webkit-slider-thumb { width: 16px; height: 16px; }
            .bottom-time { font-size: 10px; }
            .audio-action-btn { width: 36px; height: 36px; font-size: 14px; margin: 2px; }
            .audio-cover { width: 48px; height: 48px; }
            .audio-item { padding: 12px 14px; }
            .audio-title { font-size: 14px; }
            .audio-meta { font-size: 12px; }
            .modal-content { padding: 20px; width: 95% !important; max-height: 85vh; }
            .modal-content h3 { font-size: 17px; }
            .modal-buttons button { padding: 12px; font-size: 15px; min-height: 44px; }
            .app-header { padding: 12px 15px; }
            .app-header h1 { font-size: calc(var(--global-font-size) + 2px); }
            .app-header .back-btn { font-size: 36px; padding: 6px 12px; min-width: 44px; min-height: 44px; }
            .app-header .header-action { font-size: 22px; min-width: 44px; min-height: 44px; }
            .beautify-section { padding: 15px; }
            .beautify-section h2 { font-size: 15px; }
            .view-controls { flex-direction: column; align-items: stretch; gap: 10px; }
            .mode-switch { justify-content: center; }
            .mode-btn { padding: 10px 16px; font-size: 14px; min-height: 44px; }
            .sort-control { justify-content: center; }
            .sort-control label { font-size: 13px; }
            .sort-control select { padding: 10px 14px; font-size: 14px; min-height: 44px; }
            .sort-order-btn { width: 36px; height: 36px; font-size: 16px; }
            .disc-item { min-width: 90px; padding: 14px; }
            .disc-icon { width: 55px; height: 55px; font-size: 30px; }
            .disc-name { font-size: 13px; }
            .batch-toolbar { padding: 12px 16px; gap: 12px; bottom: 80px; }
            .batch-toolbar button { padding: 10px 16px; font-size: 14px; min-height: 44px; }
            .glass-settings-panel { min-width: 200px; right: 10px; }
            .glass-settings-title { font-size: 14px; }
            .glass-setting-item label { font-size: 12px; }
            .glass-slider-row span { font-size: 12px; min-width: 35px; }
            #color-picker { top: 55px; right: 10px; padding: 12px; gap: 10px; }
            .color-swatch { width: 36px; height: 36px; }
            .color-menu-item { padding: 12px 16px; font-size: 14px; }
            .menu-section-title { font-size: 12px; }
            .speed-control { padding: 8px 12px; }
            .speed-control select { padding: 8px 12px; font-size: 14px; min-height: 44px; }
            #global-search-input { width: 220px; font-size: 16px; padding: 12px 14px; min-height: 44px; }
            #global-search-input:focus { width: 260px; }
            .search-results-dropdown { width: 260px; max-height: 280px; }
            .search-result-item { padding: 12px 14px; }
            .search-result-item .result-title { font-size: 14px; }
            .search-result-item .result-subtitle { font-size: 12px; }
            .form-group select { font-size: 16px; padding: 12px 14px; min-height: 44px; }
        }
        @media (min-width: 481px) and (max-width: 1024px) {
            .album-grid { grid-template-columns: repeat(2, 1fr); }
            .desktop-time { font-size: 64px; }
            .app-dock { grid-template-columns: repeat(3, 1fr); gap: 18px; }
            .bottom-player-text { max-width: 120px; }
            #player-view { padding: 15px; }
            #player-view.style-simple #album-art { width: 200px !important; height: 200px !important; }
            #player-view.style-cloud #album-art { width: 180px !important; height: 180px !important; }
            .player-top-bar .right-controls { gap: 10px; }
            .player-top-bar .right-controls button { width: 42px; height: 42px; font-size: 18px; }
            .main-controls { gap: 22px; }
            #play-pause-btn { width: 60px; height: 60px; font-size: 24px; }
            #prev-btn, #next-btn { font-size: 32px; padding: 8px; }
            .extra-controls { gap: 15px; }
            .extra-controls button { min-width: 44px; min-height: 44px; }
            .lyric-bubble { padding: 12px 18px; }
            .lyric-bubble p { font-size: 15px !important; }
            #song-title-box { font-size: 14px; padding: 8px 14px; }
            #player-view.style-cloud .lyric-scroll-container { height: 55vh !important; max-height: 55vh !important; }
            #player-view.style-cloud .lyric-scroll-line { padding: 10px 14px; font-size: 16px; }
            #player-view.style-cloud .lyric-scroll-line.active { font-size: 18px; }
            .full-lyric-line { font-size: 18px; }
            .full-lyric-line.active { font-size: 23px; }
            .bottom-player-content { padding: 8px 14px; gap: 12px; }
            #bottom-player-art { width: 46px; height: 46px; }
            .bottom-control-btn { width: 38px; height: 38px; font-size: 16px; }
            .bottom-control-btn.play-btn { width: 46px; height: 46px; font-size: 14px; }
            .audio-action-btn { width: 34px; height: 34px; font-size: 14px; }
            .audio-cover { width: 50px; height: 50px; }
            .modal-content { padding: 24px; max-height: 85vh; }
            .modal-buttons button { min-height: 44px; }
            .app-header { padding: 14px 18px; }
            .app-header .back-btn { min-width: 44px; min-height: 44px; }
            .beautify-section { padding: 18px; }
            .view-controls { flex-wrap: wrap; }
            .mode-btn { min-height: 40px; }
            .disc-item { min-width: 100px; padding: 14px; }
            .disc-icon { width: 58px; height: 58px; }
            .glass-settings-panel { min-width: 220px; }
            #color-picker { padding: 14px; gap: 12px; }
            .color-swatch { width: 34px; height: 34px; }
            #global-search-input { width: 260px; min-height: 44px; }
            #global-search-input:focus { width: 300px; }
            .search-results-dropdown { width: 300px; }
            .form-group input, .form-group textarea, .form-group select { font-size: 16px; min-height: 44px; }
        }
        @media (min-width: 481px) and (max-width: 1024px) and (orientation: landscape) {
            .album-grid { grid-template-columns: repeat(3, 1fr); }
            .desktop-time { font-size: 48px; }
            .desktop-date { font-size: 16px; }
            #player-view.style-simple #album-art { width: 160px !important; height: 160px !important; }
            #player-view.style-cloud #album-art { width: 140px !important; height: 140px !important; }
            #player-view.style-cloud .lyric-scroll-container { height: 50vh !important; max-height: 50vh !important; }
            .bottom-player-content { padding: 6px 12px; min-height: 56px; }
            #bottom-player-art { width: 40px; height: 40px; }
            .bottom-control-btn { width: 36px; height: 36px; font-size: 14px; }
            .bottom-control-btn.play-btn { width: 42px; height: 42px; font-size: 12px; }
            .modal-content { max-height: 80vh; }
        }
        @media (min-width: 481px) and (max-width: 1024px) and (orientation: portrait) {
            .album-grid { grid-template-columns: repeat(2, 1fr); }
            .quick-actions { grid-template-columns: repeat(2, 1fr); }
        }
        @media (min-width: 1025px) {
            .album-grid { grid-template-columns: repeat(3, 1fr); }
            .desktop-time { font-size: 72px; }
            .app-dock { grid-template-columns: repeat(2, 1fr); gap: 25px; }
            .bottom-player-text { max-width: 150px; }
            .app-content { max-width: 900px; margin: 0 auto; }
        }
        
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div id="desktop-view" class="view active">
        <div class="desktop-header">
            <div id="desktop-time">12:00</div>
            <div id="desktop-date">1月1日</div>
            <div class="desktop-search-container">
                <input type="text" id="global-search-input" placeholder="🔍 搜索歌曲、专辑、艺术家...">
                <div id="search-results-dropdown" class="search-results-dropdown"></div>
            </div>
            <button id="desktop-glass-settings-btn" class="glass-settings-btn" title="毛玻璃设置">⚙️</button>
        </div>
        <div id="glass-settings-panel" class="glass-settings-panel">
            <div class="glass-settings-title">毛玻璃设置</div>
            <div class="glass-settings-section">
                <div class="glass-section-title">背景</div>
                <div class="glass-setting-item">
                    <label>模糊强度</label>
                    <div class="glass-slider-row">
                        <input type="range" id="bg-blur-slider" min="0" max="30" value="20">
                        <span id="bg-blur-value">20px</span>
                    </div>
                </div>
                <div class="glass-setting-item">
                    <label>透明度</label>
                    <div class="glass-slider-row">
                        <input type="range" id="bg-opacity-slider" min="0" max="100" value="15">
                        <span id="bg-opacity-value">15%</span>
                    </div>
                </div>
            </div>
            <div class="glass-settings-section">
                <div class="glass-section-title">卡片</div>
                <div class="glass-setting-item">
                    <label>模糊强度</label>
                    <div class="glass-slider-row">
                        <input type="range" id="card-blur-slider" min="0" max="30" value="15">
                        <span id="card-blur-value">15px</span>
                    </div>
                </div>
                <div class="glass-setting-item">
                    <label>透明度</label>
                    <div class="glass-slider-row">
                        <input type="range" id="card-opacity-slider" min="0" max="100" value="20">
                        <span id="card-opacity-value">20%</span>
                    </div>
                </div>
            </div>
            <div class="glass-settings-section">
                <div class="glass-section-title">按钮</div>
                <div class="glass-setting-item">
                    <label>模糊强度</label>
                    <div class="glass-slider-row">
                        <input type="range" id="btn-blur-slider" min="0" max="30" value="10">
                        <span id="btn-blur-value">10px</span>
                    </div>
                </div>
                <div class="glass-setting-item">
                    <label>透明度</label>
                    <div class="glass-slider-row">
                        <input type="range" id="btn-opacity-slider" min="0" max="100" value="25">
                        <span id="btn-opacity-value">25%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="desktop-main">
            <div class="desktop-content">
                <div id="recent-play-section" class="recent-play-section">
                    <div class="recent-play-header">
                        <h3>最近播放</h3>
                        <button id="view-all-history-btn" class="view-all-btn">查看全部</button>
                    </div>
                    <div id="recent-play-list" class="recent-play-list"></div>
                </div>
                <div class="quick-actions" id="quick-actions">
                    <div class="quick-action-card" data-action="random-play">
                        <div class="quick-action-icon">🎲</div>
                        <div class="quick-action-title">随机播放</div>
                        <div class="quick-action-desc">随机播放一首歌曲</div>
                    </div>
                    <div class="quick-action-card" data-action="add-media">
                        <div class="quick-action-icon">➕</div>
                        <div class="quick-action-title">添加媒体</div>
                        <div class="quick-action-desc">上传音频或视频</div>
                    </div>
                    <div class="quick-action-card" data-action="favorites">
                        <div class="quick-action-icon">❤️</div>
                        <div class="quick-action-title">我的收藏</div>
                        <div class="quick-action-desc">查看喜欢的音乐</div>
                    </div>
                    <div class="quick-action-card" data-action="sleep-timer">
                        <div class="quick-action-icon">⏰</div>
                        <div class="quick-action-title">睡眠定时</div>
                        <div class="quick-action-desc">设置自动停止</div>
                    </div>
                </div>
                <div class="stats-card" id="stats-card">
                    <div class="stats-header">📊 媒体库统计</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="stat-audios">0</div>
                            <div class="stat-label">音频</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-videos">0</div>
                            <div class="stat-label">视频</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-plays">0</div>
                            <div class="stat-label">播放次数</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <div class="sidebar" id="main-sidebar">
        <div class="sidebar-toggle" id="sidebar-toggle">☰</div>
        <div class="sidebar-header">
            <div class="sidebar-logo">🎵 菜单</div>
            <div class="sidebar-close" id="sidebar-close">✕</div>
        </div>
        <nav class="sidebar-nav" id="sidebar-nav"></nav>
        <div class="sidebar-footer">
            <button class="sidebar-settings-btn" id="sidebar-settings-btn">
                <span style="font-size: 18px;">⚙️</span>
                <span class="sidebar-item-text">设置</span>
            </button>
        </div>
    </div>

    <div id="albums-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="desktop-view">‹</button>
            <h1>媒体库</h1>
            <button id="create-album-btn" class="header-action" title="创建新专辑">+</button>
        </div>
        <div class="app-content">
            <div class="media-type-tabs">
                <button class="media-tab active" data-type="all">全部</button>
                <button class="media-tab" data-type="audio">🎵 音频</button>
                <button class="media-tab" data-type="video">🎬 视频</button>
            </div>
            <div id="albums-grid" class="album-grid"></div>
            <div id="album-empty-tip" class="empty-tip" style="display: none;">
                <div class="empty-icon">💿</div>
                <p>暂无专辑，点击右上角"+"创建</p>
            </div>
        </div>
    </div>

    <div id="disc-detail-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" id="disc-back-btn" data-target="albums-view">‹</button>
            <h1 id="disc-album-title">专辑详情</h1>
            <button id="create-disc-btn" class="header-action" title="添加Disc">+</button>
        </div>
        <div class="app-content" id="disc-content">
            <div id="disc-empty-tip" class="empty-tip" style="display: none;">
                <div class="empty-icon">📀</div>
                <p>此专辑暂无Disc，点击右上角"+"创建</p>
            </div>
            <div class="view-controls">
                <div class="mode-switch">
                    <button id="disc-mode-btn" class="mode-btn active" title="Disc模式">Disc模式</button>
                    <button id="list-mode-btn" class="mode-btn" title="列表模式">列表模式</button>
                </div>
                <div class="sort-control">
                    <label>排序：</label>
                    <select id="audio-sort-select">
                        <option value="default">默认顺序</option>
                        <option value="track">音轨号</option>
                        <option value="title">标题</option>
                        <option value="duration">时长</option>
                        <option value="artist">声优</option>
                        <option value="createdAt">添加时间</option>
                    </select>
                    <button id="sort-order-btn" class="sort-order-btn" title="正序">↑</button>
                </div>
            </div>
            <div id="disc-list" class="disc-list"></div>
            <button id="batch-mode-btn" class="batch-mode-btn" style="display: none;">批量管理</button>
            <div id="audio-list" class="audio-list"></div>
        </div>
    </div>

    <div id="player-view" class="view style-simple">
        <div class="player-top-bar">
            <button class="back-btn" id="player-back-btn" data-target="desktop-view">‹</button>
            <div class="right-controls">
                <button id="style-switch-btn" title="切换样式">🎭</button>
                <button id="image-settings-btn" title="图片设置">🖼️</button>
                <div id="image-settings-menu">
                    <div class="style-menu-item"><a id="set-cover-option">修改封面</a></div>
                    <div class="style-menu-item"><a id="set-bg-option">设置背景</a></div>
                </div>
                <button id="toggle-color-picker-btn" title="歌词颜色">🎨</button>
                <button id="player-settings-btn" title="更多设置">⋮</button>
                <div id="player-settings-menu">
                    <a id="download-song-link" download>下载音频</a>
                    <div class="speed-control">
                        <span>速度:</span>
                        <select id="playback-speed">
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1.0x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2.0">2.0x</option>
                        </select>
                    </div>
                    <div class="menu-section">
                        <div class="menu-section-title">睡眠定时器</div>
                        <div class="style-menu-item"><a href="#" data-time="0">关闭</a></div>
                        <div class="style-menu-item"><a href="#" data-time="15">15 分钟后</a></div>
                        <div class="style-menu-item"><a href="#" data-time="30">30 分钟后</a></div>
                        <div class="style-menu-item"><a href="#" data-time="60">60 分钟后</a></div>
                        <div class="style-menu-item"><a href="#" data-time="-1">当前歌曲播放完后</a></div>
                    </div>
                    <div class="menu-section">
                        <div class="style-menu-item"><a href="#" id="toggle-continuous-play">连续播放: 关闭</a></div>
                    </div>
                </div>
                <div id="style-switch-menu">
                    <div class="style-menu-item" data-style="simple">
                        <a href="#" data-style="simple" class="active">简约模式</a>
                        <button class="style-settings-btn" data-style="simple" title="简约模式设置">⚙</button>
                    </div>
                    <div class="style-menu-item" data-style="cloud">
                        <a href="#" data-style="cloud">歌词模式</a>
                        <button class="style-settings-btn" data-style="cloud" title="歌词模式设置">⚙</button>
                    </div>
                </div>
                <div id="simple-display-settings" class="mode-display-settings">
                    <div class="settings-header"><span>简约模式设置</span><button class="close-settings-btn">×</button></div>
                    <div class="slider-control">
                        <label>歌词框宽度 <span class="slider-value" id="simple-lyric-width-value">90%</span></label>
                        <input type="range" id="simple-lyric-width-slider" min="50" max="100" value="90">
                    </div>
                    <div class="slider-control">
                        <label>歌词框透明度 <span class="slider-value" id="simple-lyric-box-opacity-value">0.15</span></label>
                        <input type="range" id="simple-lyric-box-opacity-slider" min="0" max="100" value="15">
                    </div>
                    <div class="slider-control">
                        <label>毛玻璃程度 <span class="slider-value" id="simple-glass-blur-value">10px</span></label>
                        <input type="range" id="simple-glass-blur-slider" min="0" max="30" value="10">
                    </div>
                    <div class="slider-control">
                        <label>歌词透明度 <span class="slider-value" id="simple-lyric-opacity-value">1.0</span></label>
                        <input type="range" id="simple-lyric-opacity-slider" min="30" max="100" value="100">
                    </div>
                    <div class="slider-control">
                        <label>歌词字体大小 <span class="slider-value" id="simple-lyric-font-size-value">16px</span></label>
                        <input type="range" id="simple-lyric-font-size-slider" min="12" max="28" value="16">
                    </div>
                    <div class="slider-control">
                        <label>封面大小 <span class="slider-value" id="simple-cover-size-value">220px</span></label>
                        <input type="range" id="simple-cover-size-slider" min="120" max="300" value="220">
                    </div>
                </div>
                <div id="cloud-display-settings" class="mode-display-settings">
                    <div class="settings-header"><span>歌词模式设置</span><button class="close-settings-btn">×</button></div>
                    <div class="slider-control">
                        <label>歌词框宽度 <span class="slider-value" id="cloud-lyric-width-value">100%</span></label>
                        <input type="range" id="cloud-lyric-width-slider" min="50" max="100" value="100">
                    </div>
                    <div class="slider-control">
                        <label>歌词框高度 <span class="slider-value" id="cloud-lyric-height-value">60%</span></label>
                        <input type="range" id="cloud-lyric-height-slider" min="30" max="100" value="60">
                    </div>
                    <div class="slider-control">
                        <label>毛玻璃程度 <span class="slider-value" id="cloud-glass-blur-value">15px</span></label>
                        <input type="range" id="cloud-glass-blur-slider" min="5" max="30" value="15">
                    </div>
                    <div class="slider-control">
                        <label>歌词框透明度 <span class="slider-value" id="cloud-lyric-box-opacity-value">0.1</span></label>
                        <input type="range" id="cloud-lyric-box-opacity-slider" min="0" max="100" value="10">
                    </div>
                    <div class="slider-control">
                        <label>歌词透明度 <span class="slider-value" id="cloud-lyric-opacity-value">1.0</span></label>
                        <input type="range" id="cloud-lyric-opacity-slider" min="30" max="100" value="100">
                    </div>
                </div>
            </div>
        </div>
        <div id="color-picker"></div>
        <div id="player-content-wrapper">
            <div id="song-title-box">Unknown Song</div>
            <img id="album-art" alt="Art">
            <div class="lyric-bubble">
                <p id="lyric-display">...</p>
            </div>
        </div>
        <div class="player-controls">
            <div class="progress-bar-container">
                <span id="current-time">00:00</span>
                <input type="range" id="progress-bar" value="0" step="1">
                <span id="duration-time">00:00</span>
            </div>
            <div class="main-controls">
                <button id="prev-btn">⏮</button>
                <button id="play-pause-btn">▶</button>
                <button id="next-btn">⏭</button>
            </div>
            <div class="extra-controls">
                <button id="play-mode-btn" title="播放模式">🔁</button>
                <div class="volume-control">
                    <button id="volume-btn" title="音量">🔊</button>
                    <input type="range" id="volume-slider" min="0" max="100" value="100">
                </div>
            </div>
        </div>
        <audio id="audio-player" style="display: none;"></audio>
        <input type="file" id="song-bg-input" accept="image/*" style="display:none;">
        <input type="file" id="cover-input" accept="image/*" style="display:none;">
        <input type="file" id="vtt-import-input" accept=".vtt,.srt,.lrc" style="display:none;">
    </div>

    <div id="beautify-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="desktop-view">‹</button>
            <h1>美化设置</h1>
            <button id="reset-all-theme-btn" class="header-action" title="重置所有设置">↺</button>
        </div>
        <div class="app-content">
            <div class="beautify-section">
                <h2>🎨 预设主题</h2>
                <p style="color:var(--text-secondary);font-size:13px;margin-bottom:15px;">选择预设主题快速美化播放器（包含完整配色方案）</p>
                <div class="theme-presets" id="theme-presets">
                    <div class="theme-preset" data-theme="default">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #1a1a2e, #16213e); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(60,60,80,0.8); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(99,102,241,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>默认深色</span>
                    </div>
                    <div class="theme-preset" data-theme="ocean">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #0c2461, #1e3799); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(20,50,100,0.8); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(52,152,219,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>海洋蓝</span>
                    </div>
                    <div class="theme-preset" data-theme="sunset">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #ff6b6b, #feca57); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(255,180,120,0.8); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(255,107,107,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>日落橙</span>
                    </div>
                    <div class="theme-preset" data-theme="forest">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #1e5f3f, #2ecc71); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(30,100,60,0.8); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(46,204,113,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>森林绿</span>
                    </div>
                    <div class="theme-preset" data-theme="purple">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #4a0e4e, #8e44ad); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(100,50,120,0.8); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(155,89,182,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>梦幻紫</span>
                    </div>
                    <div class="theme-preset" data-theme="sakura">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #ffecd2, #fcb69f); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(255,220,210,0.8); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(255,150,170,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>樱花粉</span>
                    </div>
                    <div class="theme-preset" data-theme="night">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #0f0f23, #1a1a3e); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(25,25,40,0.8); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(80,80,120,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>深夜黑</span>
                    </div>
                    <div class="theme-preset" data-theme="mint">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #a8e6cf, #88d8b0); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(180,230,200,0.8); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(0,180,130,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>薄荷绿</span>
                    </div>
                    <div class="theme-preset" data-theme="coffee">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #3e2723, #5d4037); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(80,50,40,0.8); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(161,136,127,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>咖啡棕</span>
                    </div>
                    <div class="theme-preset" data-theme="aurora">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #667eea, #764ba2); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(118,75,162,0.8); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(102,126,234,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>极光紫</span>
                    </div>
                    <div class="theme-preset" data-theme="cyber">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #0a0a0a, #1a1a2e); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(0,255,136,0.8); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(255,0,128,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>赛博朋克</span>
                    </div>
                    <div class="theme-preset" data-theme="lightBlue">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #74b9ff, #0984e3); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(240,248,255,0.9); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(9,132,227,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>天空蓝</span>
                    </div>
                    <div class="theme-preset" data-theme="cream">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #ffeaa7, #fdcb6e); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(255,252,245,0.9); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(253,203,110,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>奶油白</span>
                    </div>
                    <div class="theme-preset" data-theme="lavender">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #dda0dd, #9b59b6); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(250,245,255,0.9); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(155,89,182,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>薰衣草</span>
                    </div>
                    <div class="theme-preset" data-theme="custom" id="custom-theme-preset" style="display:none;">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #333, #666); position: relative;">
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; display: flex; gap: 2px;">
                                <div style="flex:1; height: 8px; background: rgba(100,100,100,0.8); border-radius: 2px;"></div>
                                <div style="flex:1; height: 8px; background: rgba(150,150,150,0.8); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <span>自定义</span>
                    </div>
                </div>
            </div>
            <div class="beautify-section">
                <h2>🌓 主题模式</h2>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span>夜间模式</span>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <span>日间模式</span>
                </div>
            </div>
            <div class="beautify-section">
                <h2>🖼️ 背景设置</h2>
                <div class="form-group">
                    <label>桌面背景图片</label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="file" id="bg-file-input" accept="image/*" style="flex:1;">
                        <button id="clear-desktop-bg-btn" class="glass-button" style="padding:8px 12px;font-size:12px;">清空</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>动态渐变背景</label>
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                        <label class="switch" style="transform:scale(0.8);">
                            <input type="checkbox" id="gradient-bg-switch">
                            <span class="slider"></span>
                        </label>
                        <span style="font-size:13px;color:var(--text-secondary);">启用动态渐变</span>
                    </div>
                    <div id="gradient-settings" style="display:none;">
                        <div class="form-group" style="margin-bottom:15px;">
                            <label>渐变动画效果</label>
                            <select id="gradient-animation" style="width:100%;padding:10px;border-radius:8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);color:var(--text-primary);">
                                <option value="flow">流动渐变 (推荐)</option>
                                <option value="rotate">旋转渐变</option>
                                <option value="pulse">脉冲渐变</option>
                                <option value="wave">波浪渐变</option>
                                <option value="static">静态渐变</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom:15px;">
                            <label>渐变配色方案</label>
                            <select id="gradient-preset" style="width:100%;padding:10px;border-radius:8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);color:var(--text-primary);">
                                <option value="custom">自定义颜色</option>
                                <option value="sunset">日落黄昏</option>
                                <option value="ocean">深海蓝调</option>
                                <option value="aurora">极光紫韵</option>
                                <option value="forest">森林绿意</option>
                                <option value="sakura">樱花粉黛</option>
                                <option value="night">深夜星空</option>
                                <option value="fire">烈焰红霞</option>
                                <option value="mint">薄荷清新</option>
                                <option value="cyber">赛博霓虹</option>
                            </select>
                        </div>
                        <div style="display:flex;gap:10px;margin-bottom:10px;">
                            <div style="flex:1;">
                                <label style="font-size:12px;color:var(--text-secondary);">起始颜色</label>
                                <input type="color" id="gradient-start" value="#1a1a2e" style="width:100%;height:40px;border:none;border-radius:8px;cursor:pointer;">
                            </div>
                            <div style="flex:1;">
                                <label style="font-size:12px;color:var(--text-secondary);">中间颜色</label>
                                <input type="color" id="gradient-mid" value="#16213e" style="width:100%;height:40px;border:none;border-radius:8px;cursor:pointer;">
                            </div>
                            <div style="flex:1;">
                                <label style="font-size:12px;color:var(--text-secondary);">结束颜色</label>
                                <input type="color" id="gradient-end" value="#0f3460" style="width:100%;height:40px;border:none;border-radius:8px;cursor:pointer;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>动画速度</label>
                            <div class="font-size-control">
                                <input type="range" id="gradient-speed" min="5" max="30" value="15" style="width:100%;">
                                <span id="gradient-speed-value">15秒</span>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                            <span style="font-size:13px;color:var(--text-secondary);">添加噪点纹理</span>
                            <label class="switch" style="transform:scale(0.8);">
                                <input type="checkbox" id="gradient-noise-switch">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                            <span style="font-size:13px;color:var(--text-secondary);">添加光晕叠加</span>
                            <label class="switch" style="transform:scale(0.8);">
                                <input type="checkbox" id="gradient-glow-switch" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <button id="apply-gradient-btn" class="glass-button" style="width:100%;background:linear-gradient(135deg, rgba(99,102,241,0.3), rgba(139,92,246,0.3));">✨ 应用渐变背景</button>
                    </div>
                </div>
            </div>
            <div class="beautify-section">
                <h2>🪟 毛玻璃效果</h2>
                <p style="color:var(--text-secondary);font-size:13px;margin-bottom:15px;">调整全局毛玻璃效果的模糊度和透明度</p>
                <div class="form-group">
                    <label>背景模糊强度</label>
                    <div class="font-size-control">
                        <input type="range" id="glass-bg-blur-slider" min="0" max="50" value="20">
                        <span id="glass-bg-blur-value">20px</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>背景透明度</label>
                    <div class="font-size-control">
                        <input type="range" id="glass-bg-opacity-slider" min="0" max="100" value="15">
                        <span id="glass-bg-opacity-value">15%</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>卡片模糊强度</label>
                    <div class="font-size-control">
                        <input type="range" id="glass-card-blur-slider" min="0" max="50" value="15">
                        <span id="glass-card-blur-value">15px</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>卡片透明度</label>
                    <div class="font-size-control">
                        <input type="range" id="glass-card-opacity-slider" min="0" max="100" value="20">
                        <span id="glass-card-opacity-value">20%</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>按钮模糊强度</label>
                    <div class="font-size-control">
                        <input type="range" id="glass-btn-blur-slider" min="0" max="50" value="10">
                        <span id="glass-btn-blur-value">10px</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>按钮透明度</label>
                    <div class="font-size-control">
                        <input type="range" id="glass-btn-opacity-slider" min="0" max="100" value="25">
                        <span id="glass-btn-opacity-value">25%</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>饱和度增强</label>
                    <div class="font-size-control">
                        <input type="range" id="glass-saturation-slider" min="100" max="300" value="180">
                        <span id="glass-saturation-value">180%</span>
                    </div>
                </div>
            </div>
            <div class="beautify-section">
                <h2>📐 布局与圆角</h2>
                <div class="form-group">
                    <label>全局圆角大小</label>
                    <div class="font-size-control">
                        <input type="range" id="border-radius-slider" min="0" max="30" step="1" value="16">
                        <span id="border-radius-value">16px</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>卡片间距</label>
                    <div class="font-size-control">
                        <input type="range" id="card-spacing-slider" min="5" max="30" step="1" value="15">
                        <span id="card-spacing-value">15px</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>卡片内边距</label>
                    <div class="font-size-control">
                        <input type="range" id="card-padding-slider" min="10" max="40" step="1" value="20">
                        <span id="card-padding-value">20px</span>
                    </div>
                </div>
            </div>
            <div class="beautify-section">
                <h2>✨ 动画设置</h2>
                <div class="form-group">
                    <label>过渡动画时长</label>
                    <div class="font-size-control">
                        <input type="range" id="transition-duration-slider" min="0" max="100" step="5" value="30">
                        <span id="transition-duration-value">0.3s</span>
                    </div>
                </div>
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                    <span style="font-size:13px;color:var(--text-secondary);">禁用所有动画</span>
                    <label class="switch" style="transform:scale(0.8);">
                        <input type="checkbox" id="disable-animation-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span style="font-size:13px;color:var(--text-secondary);">悬停提升效果</span>
                    <label class="switch" style="transform:scale(0.8);">
                        <input type="checkbox" id="hover-lift-switch" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="beautify-section">
                <h2>🔤 字体设置</h2>
                <div class="form-group">
                    <label>预设字体</label>
                    <select id="font-preset-select" style="width:100%;padding:10px;background:var(--glass-bg);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text-primary);">
                        <option value="default">默认字体</option>
                        <option value="noto-sans">思源黑体</option>
                        <option value="noto-serif">思源宋体</option>
                        <option value="zcool">站酷快乐体</option>
                        <option value="ma-shan">马善政毛笔体</option>
                        <option value="custom">自定义字体...</option>
                    </select>
                </div>
                <div class="form-group" id="custom-font-group" style="display:none;">
                    <label>自定义字体URL</label>
                    <div class="input-with-button">
                        <input type="text" id="font-url-input" placeholder="https://.../font.woff">
                        <button id="save-font-btn">保存</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>全局字体大小</label>
                    <div class="font-size-control">
                        <input type="range" id="font-size-slider" min="12" max="22" step="1" value="16">
                        <span id="font-size-value">16px</span>
                    </div>
                </div>
            </div>
            <div class="beautify-section">
                <h2>🎵 播放器界面</h2>
                <div class="form-group">
                    <label>播放器背景</label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="file" id="player-bg-input" accept="image/*" style="flex:1;">
                        <button id="clear-player-bg-btn" class="glass-button" style="padding:8px 12px;font-size:12px;">清空</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>封面尺寸 (px)</label>
                    <div class="input-with-button">
                        <input type="number" id="cover-width-input" placeholder="宽度" value="300">
                        <input type="number" id="cover-height-input" placeholder="高度" value="300">
                        <button id="save-cover-size-btn">保存</button>
                    </div>
                </div>
            </div>
            <div class="beautify-section">
                <h2>🎯 智能色彩适配</h2>
                <p style="color:var(--text-secondary);font-size:13px;margin-bottom:15px;">从壁纸提取主色调，自动生成配色方案</p>
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                    <span>关闭</span>
                    <label class="switch">
                        <input type="checkbox" id="smart-color-switch">
                        <span class="slider"></span>
                    </label>
                    <span>开启</span>
                </div>
                <div id="color-palette-preview" style="display:none;">
                    <div style="margin-bottom:10px;">
                        <span style="font-size:13px;color:var(--text-secondary);">提取的主色调（点击选择用途）：</span>
                    </div>
                    <div id="extracted-colors" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;"></div>
                    <div style="margin-bottom:10px;">
                        <span style="font-size:13px;color:var(--text-secondary);">按钮样式预览：</span>
                    </div>
                    <div id="button-preview-container" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;">
                        <button class="smart-preview-btn" id="preview-btn-1">普通按钮</button>
                        <button class="smart-preview-btn" id="preview-btn-2">悬停效果</button>
                        <button class="smart-preview-btn" id="preview-btn-3">毛玻璃按钮</button>
                    </div>
                </div>
                <div style="display:flex;gap:10px;margin-bottom:15px;">
                    <button id="extract-colors-btn" class="extract-btn" style="flex:1;">
                        <span style="font-size:18px;margin-right:8px;">🎨</span>
                        从壁纸提取颜色
                    </button>
                    <button id="manual-color-btn" class="extract-btn" style="flex:1;background:linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(99, 102, 241, 0.1));border:1px dashed rgba(99, 102, 241, 0.5);">
                        <span style="font-size:18px;margin-right:8px;">➕</span>
                        手动选色
                    </button>
                </div>
                <div id="manual-color-panel" style="display:none;padding:15px;background:var(--glass-bg);border-radius:12px;margin-bottom:15px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                        <input type="color" id="manual-color-input" value="#6366f1" style="width:50px;height:36px;border:none;border-radius:8px;cursor:pointer;">
                        <span id="manual-color-hex" style="font-family:monospace;color:var(--text-secondary);">#6366f1</span>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="manual-color-assign" data-use="background" style="padding:6px 12px;border-radius:6px;background:rgba(var(--btn-color-rgb,99,102,241),0.2);border:none;color:var(--text-primary);cursor:pointer;font-size:12px;">背景</button>
                        <button class="manual-color-assign" data-use="card" style="padding:6px 12px;border-radius:6px;background:rgba(var(--btn-color-rgb,99,102,241),0.2);border:none;color:var(--text-primary);cursor:pointer;font-size:12px;">卡片</button>
                        <button class="manual-color-assign" data-use="button" style="padding:6px 12px;border-radius:6px;background:rgba(var(--btn-color-rgb,99,102,241),0.2);border:none;color:var(--text-primary);cursor:pointer;font-size:12px;">按钮</button>
                        <button class="manual-color-assign" data-use="text" style="padding:6px 12px;border-radius:6px;background:rgba(var(--btn-color-rgb,99,102,241),0.2);border:none;color:var(--text-primary);cursor:pointer;font-size:12px;">字体</button>
                        <button id="close-manual-color" style="padding:6px 12px;border-radius:6px;background:rgba(255,255,255,0.1);border:none;color:var(--text-secondary);cursor:pointer;font-size:12px;margin-left:auto;">✕ 关闭</button>
                    </div>
                </div>
            </div>
            <div class="beautify-section">
                <h2>📱 应用定制</h2>
                <div id="app-customize-container"></div>
                <button id="save-app-config-btn" class="glass-button primary" style="width:100%;margin-top:15px;">保存应用配置</button>
            </div>
            <div class="beautify-section">
                <h2>💾 主题管理</h2>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button id="export-theme-btn" class="glass-button" style="flex:1;min-width:120px;">
                        <span style="margin-right:8px;">📤</span>导出主题
                    </button>
                    <button id="import-theme-btn" class="glass-button" style="flex:1;min-width:120px;">
                        <span style="margin-right:8px;">📥</span>导入主题
                    </button>
                    <input type="file" id="import-theme-file" accept=".json" style="display:none;">
                </div>
            </div>
        </div>
    </div>

    <div id="data-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="desktop-view">‹</button>
            <h1>数据管理</h1>
        </div>
        <div class="app-content">
            <p style="color: var(--text-secondary); line-height: 1.6; margin-top: 0; margin-bottom: 20px;">这里是您的数据中心。您可以导出/导入所有数据。</p>
            <div class="form-group">
                <label>导出</label>
                <button id="export-btn" class="action-button">选择性导出</button>
            </div>
            <div class="form-group">
                <label>导入</label>
                <button id="import-btn" class="action-button danger">覆盖导入 (清空现有)</button>
                <button id="import-merge-btn" class="action-button" style="margin-top: 10px; background: linear-gradient(135deg, rgba(33, 150, 243, 0.8), rgba(33, 150, 243, 0.6));">追加导入 (保留现有)</button>
                <input type="file" id="import-file-input" accept=".zip" style="display:none;">
            </div>
            <div class="form-group">
                <label>数据管理</label>
                <button id="clear-data-btn" class="action-button danger">清空所有数据</button>
                <button id="clean-cache-btn" class="action-button warning" style="margin-top: 10px;">清理缓存</button>
            </div>
        </div>
    </div>

    <div id="export-dialog" class="modal-overlay">
        <div class="modal-content" style="width: 90%; max-width: 400px;">
            <h3>选择导出内容</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="export-albums" checked style="width: 18px; height: 18px;">
                    <span>📁 专辑数据</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="export-discs" checked style="width: 18px; height: 18px;">
                    <span>💿 碟片数据</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="export-audios" checked style="width: 18px; height: 18px;">
                    <span>🎵 音频文件</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="export-images" checked style="width: 18px; height: 18px;">
                    <span>🖼️ 图片资源 (封面、背景等)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="export-playlists" checked style="width: 18px; height: 18px;">
                    <span>📋 播放列表</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="export-settings" checked style="width: 18px; height: 18px;">
                    <span>⚙️ 设置项</span>
                </label>
            </div>
            <div class="modal-buttons">
                <button id="export-cancel-btn" class="modal-cancel-btn">取消</button>
                <button id="export-confirm-btn" class="modal-confirm-btn">导出</button>
            </div>
        </div>
    </div>

    <div id="import-dialog" class="modal-overlay">
        <div class="modal-content" style="width: 90%; max-width: 400px;">
            <h3>选择导入内容</h3>
            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;">请先选择备份文件，然后选择要导入的内容</p>
            <div style="margin-bottom: 15px;">
                <button id="select-backup-file-btn" class="action-button" style="width: 100%; margin-bottom: 15px;">选择备份文件</button>
                <input type="file" id="import-select-file-input" accept=".zip" style="display:none;">
                <div id="selected-file-name" style="color: var(--text-secondary); font-size: 12px; margin-bottom: 10px; display: none;"></div>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="import-albums" checked style="width: 18px; height: 18px;">
                    <span>📁 专辑数据</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="import-discs" checked style="width: 18px; height: 18px;">
                    <span>💿 碟片数据</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="import-audios" checked style="width: 18px; height: 18px;">
                    <span>🎵 音频文件</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="import-images" checked style="width: 18px; height: 18px;">
                    <span>🖼️ 图片资源 (封面、背景等)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="import-playlists" checked style="width: 18px; height: 18px;">
                    <span>📋 播放列表</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" id="import-settings" checked style="width: 18px; height: 18px;">
                    <span>⚙️ 设置项</span>
                </label>
            </div>
            <div class="modal-buttons">
                <button id="import-cancel-btn" class="modal-cancel-btn">取消</button>
                <button id="import-confirm-btn" class="modal-confirm-btn">导入</button>
            </div>
        </div>
    </div>

    <div id="playlists-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="desktop-view">‹</button>
            <h1>播放列表</h1>
        </div>
        <div class="app-content">
            <div class="media-type-tabs">
                <button class="playlist-tab active" data-type="all">全部</button>
                <button class="playlist-tab" data-type="audio">🎵 音频</button>
                <button class="playlist-tab" data-type="video">🎬 视频</button>
            </div>
            <div class="beautify-section" style="cursor: pointer;" id="favorites-section">
                <h2>❤️ 我喜欢</h2>
                <p style="color: var(--text-secondary); font-size: 13px;">点击心形按钮收藏的媒体会出现在这里</p>
                <div style="display: flex; gap: 15px; margin-top: 8px;">
                    <span id="favorites-count" style="font-size: 12px; color: var(--text-secondary);">0 首音频</span>
                    <span id="video-favorites-count-inline" style="font-size: 12px; color: var(--text-secondary);">0 个视频</span>
                </div>
            </div>
            <div id="playlists-list" class="audio-list" style="margin-top: 20px;"></div>
            <button id="create-playlist-btn" class="glass-button primary" style="width:100%;margin-top:15px;">+ 创建播放列表</button>
        </div>
    </div>

    <div id="favorites-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="playlists-view">‹</button>
            <h1>❤️ 我喜欢</h1>
        </div>
        <div class="app-content">
            <div class="media-type-tabs">
                <button class="fav-tab active" data-type="all">全部</button>
                <button class="fav-tab" data-type="audio">🎵 音频</button>
                <button class="fav-tab" data-type="video">🎬 视频</button>
            </div>
            <div id="favorites-audio-list" class="audio-list"></div>
            <div id="favorites-empty-tip" class="empty-tip" style="display: none;">
                <div class="empty-icon">💔</div>
                <p>还没有收藏的内容</p>
                <p style="font-size:12px;margin-top:10px;opacity:0.7;">点击媒体后面的心形按钮添加收藏</p>
            </div>
        </div>
    </div>

    <div id="playlist-detail-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="playlists-view">‹</button>
            <h1 id="playlist-detail-title">播放列表</h1>
            <button id="playlist-edit-btn" class="header-action" title="编辑">✏️</button>
        </div>
        <div class="app-content">
            <div id="playlist-audio-list" class="audio-list"></div>
            <div id="playlist-empty-tip" class="empty-tip" style="display: none;">
                <div class="empty-icon">🎵</div>
                <p>播放列表为空</p>
            </div>
        </div>
    </div>

    <div id="artists-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="desktop-view">‹</button>
            <h1>声优</h1>
        </div>
        <div class="app-content">
            <div class="form-group" style="margin-bottom: 15px;">
                <input type="text" id="artist-search-input" placeholder="🔍 搜索声优...">
            </div>
            <div id="artists-list" class="album-grid"></div>
            <div id="artists-empty-tip" class="empty-tip" style="display: none;">
                <div class="empty-icon">🎤</div>
                <p>暂无声优数据</p>
                <p style="font-size:12px;margin-top:10px;opacity:0.7;">添加音频时填写声优信息即可在此查看</p>
            </div>
        </div>
    </div>

    <div id="artist-detail-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="artists-view">‹</button>
            <h1 id="artist-detail-title">声优</h1>
        </div>
        <div class="app-content">
            <div id="artist-audio-list" class="audio-list"></div>
            <div id="artist-empty-tip" class="empty-tip" style="display: none;">
                <div class="empty-icon">🎵</div>
                <p>该声优暂无歌曲</p>
            </div>
        </div>
    </div>

    <div id="video-albums-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="desktop-view">‹</button>
            <h1>视频专辑</h1>
            <button id="create-video-album-btn" class="header-action" title="创建新专辑">+</button>
        </div>
        <div class="app-content">
            <div id="video-albums-grid" class="album-grid"></div>
            <div id="video-album-empty-tip" class="empty-tip" style="display: none;">
                <div class="empty-icon">🎬</div>
                <p>暂无视频专辑，点击右上角"+"创建</p>
            </div>
        </div>
    </div>

    <div id="video-disc-detail-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" id="video-disc-back-btn" data-target="video-albums-view">‹</button>
            <h1 id="video-disc-album-title">视频专辑详情</h1>
            <button id="create-video-disc-btn" class="header-action" title="添加Disc">+</button>
        </div>
        <div class="app-content" id="video-disc-content">
            <div id="video-disc-empty-tip" class="empty-tip" style="display: none;">
                <div class="empty-icon">📀</div>
                <p>此专辑暂无Disc，点击右上角"+"创建</p>
            </div>
            <div class="view-controls">
                <div class="mode-switch">
                    <button id="video-disc-mode-btn" class="mode-btn active" title="Disc模式">Disc模式</button>
                    <button id="video-list-mode-btn" class="mode-btn" title="列表模式">列表模式</button>
                </div>
                <div class="sort-control">
                    <label>排序：</label>
                    <select id="video-sort-select">
                        <option value="default">默认顺序</option>
                        <option value="track">音轨号</option>
                        <option value="title">标题</option>
                        <option value="duration">时长</option>
                        <option value="createdAt">添加时间</option>
                    </select>
                    <button id="video-sort-order-btn" class="sort-order-btn" title="正序">↑</button>
                </div>
            </div>
            <div id="video-disc-list" class="disc-list"></div>
            <button id="video-batch-mode-btn" class="batch-mode-btn" style="display: none;">批量管理</button>
            <div id="video-list" class="audio-list"></div>
        </div>
    </div>

    <div id="video-player-view" class="view" style="background-color: rgba(0,0,0,0.85);">
        <div class="player-top-bar">
            <button class="back-btn" id="video-player-back-btn" data-target="desktop-view">‹</button>
            <div class="video-player-title" id="video-title-display">未知视频</div>
            <div class="right-controls">
                <button id="video-pip-btn" title="画中画">🖼️</button>
                <button id="video-fullscreen-btn" title="全屏">⛶</button>
                <button id="video-settings-btn" title="设置">⋮</button>
                <div id="video-settings-menu">
                    <div class="speed-control">
                        <span>速度:</span>
                        <div class="speed-buttons" id="speed-buttons">
                            <button data-speed="0.5">0.5x</button>
                            <button data-speed="0.75">0.75x</button>
                            <button data-speed="1" class="active">1x</button>
                            <button data-speed="1.25">1.25x</button>
                            <button data-speed="1.5">1.5x</button>
                            <button data-speed="2">2x</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="video-container" class="video-container">
            <video id="video-player" class="video-player"></video>
            <div class="video-overlay" id="video-overlay">
                <div class="video-center-controls">
                    <button class="video-center-btn" id="video-rewind-btn" title="长按快退">⏪</button>
                    <button class="video-center-btn play-btn" id="video-center-play-btn">▶</button>
                    <button class="video-center-btn" id="video-forward-btn" title="长按快进">⏩</button>
                </div>
                <div class="video-gesture-hint" id="video-gesture-hint"></div>
            </div>
        </div>
        <div class="video-bottom-controls">
            <div class="video-progress-container">
                <div class="video-progress-bar" id="video-progress-bar">
                    <div class="video-progress-buffered" id="video-progress-buffered"></div>
                    <div class="video-progress-current" id="video-progress-current"></div>
                    <div class="video-progress-thumb" id="video-progress-thumb"></div>
                </div>
                <div class="video-time-display">
                    <span id="video-current-time">00:00</span>
                    <span>/</span>
                    <span id="video-duration-time">00:00</span>
                </div>
            </div>
            <div class="video-control-buttons">
                <button id="video-prev-btn" title="上一个">⏮</button>
                <button id="video-play-pause-btn" class="main-play-btn">▶</button>
                <button id="video-next-btn" title="下一个">⏭</button>
                <div class="volume-control">
                    <button id="video-volume-btn" title="音量">🔊</button>
                    <input type="range" id="video-volume-slider" min="0" max="100" value="100">
                </div>
                <button id="video-play-mode-btn" title="播放模式">🔁</button>
            </div>
        </div>
    </div>

    <div id="video-playlists-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="desktop-view">‹</button>
            <h1>视频播放列表</h1>
        </div>
        <div class="app-content">
            <div class="beautify-section" style="cursor: pointer;" id="video-favorites-section">
                <h2>❤️ 我喜欢</h2>
                <p style="color: var(--text-secondary); font-size: 13px;">点击心形按钮收藏的视频会出现在这里</p>
                <div id="video-favorites-count" style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">0 个视频</div>
            </div>
            <div id="video-playlists-list" class="audio-list" style="margin-top: 20px;"></div>
            <button id="create-video-playlist-btn" class="glass-button primary" style="width:100%;margin-top:15px;">+ 创建视频播放列表</button>
        </div>
    </div>

    <div id="video-favorites-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="video-playlists-view">‹</button>
            <h1>❤️ 我喜欢的视频</h1>
        </div>
        <div class="app-content">
            <div id="video-favorites-list" class="audio-list"></div>
            <div id="video-favorites-empty-tip" class="empty-tip" style="display: none;">
                <div class="empty-icon">💔</div>
                <p>还没有收藏的视频</p>
                <p style="font-size:12px;margin-top:10px;opacity:0.7;">点击视频后面的心形按钮添加收藏</p>
            </div>
        </div>
    </div>

    <div id="video-playlist-detail-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="video-playlists-view">‹</button>
            <h1 id="video-playlist-detail-title">视频播放列表</h1>
            <button id="video-playlist-edit-btn" class="header-action" title="编辑">✏️</button>
        </div>
        <div class="app-content">
            <div id="video-playlist-video-list" class="audio-list"></div>
            <div id="video-playlist-empty-tip" class="empty-tip" style="display: none;">
                <div class="empty-icon">🎬</div>
                <p>播放列表为空</p>
            </div>
        </div>
    </div>

    <div id="full-lyrics-modal">
        <div class="full-lyrics-header">
            <button class="close-lyrics-btn">×</button>
        </div>
        <div class="full-lyrics-container" id="full-lyrics-list"></div>
    </div>

    <div id="entity-dialog" class="modal-overlay">
        <div class="modal-content" style="width: 90%; max-width: 450px; max-height: 80vh; overflow-y: auto;">
            <h3 id="dialog-title">创建专辑</h3>
            <div id="dialog-form">
                <div class="form-group">
                    <label>名称 <span style="color: #ff4444;">*</span></label>
                    <input type="text" id="entity-name-input" placeholder="输入名称">
                    <div id="name-warning" class="dialog-warning">名称不能为空</div>
                </div>
                <div class="form-group" id="entity-cover-group">
                    <label>封面（可选）</label>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="file" id="entity-cover-input" accept="image/*" style="flex:1;">
                        <button id="clear-entity-cover-btn" class="glass-button" style="padding:6px 10px;font-size:12px;display:none;">清空</button>
                    </div>
                    <img id="entity-cover-preview" class="image-preview" style="display:none; margin-top: 10px; width: 100%; height: 100px; object-fit: cover; border-radius: 8px;">
                </div>
                <div class="form-group album-only-field">
                    <label>专辑编号</label>
                    <input type="text" id="entity-number-input" placeholder="如：ABC-001">
                </div>
                <div class="form-group album-only-field">
                    <label>艺术家/社团</label>
                    <input type="text" id="entity-artist-input" placeholder="输入艺术家或社团名称">
                </div>
                <div class="form-group album-only-field">
                    <label>发行日期</label>
                    <input type="date" id="entity-release-date-input">
                </div>
                <div class="form-group album-only-field">
                    <label>专辑描述</label>
                    <textarea id="entity-description-input" rows="2" placeholder="输入专辑描述"></textarea>
                </div>
                <div class="form-group disc-only-field" style="display:none;">
                    <label>Disc编号</label>
                    <input type="number" id="entity-disc-number-input" placeholder="如：1" min="1">
                </div>
                <div class="form-group disc-only-field" style="display:none;">
                    <label>Disc描述</label>
                    <textarea id="entity-disc-description-input" rows="2" placeholder="输入Disc描述"></textarea>
                </div>
            </div>
            <div id="dialog-warning" class="dialog-warning" style="margin-top: 10px;">有未保存的更改，确定要放弃吗？</div>
            <div class="modal-buttons">
                <button id="entity-cancel-btn" class="modal-cancel-btn">取消</button>
                <button id="entity-confirm-btn" class="modal-confirm-btn">创建</button>
            </div>
        </div>
    </div>

    <div id="audio-dialog" class="modal-overlay">
        <div class="modal-content" style="width: 90%; max-width: 450px; max-height: 80vh; overflow-y: auto;">
            <h3 id="audio-dialog-title">添加音频</h3>
            <div id="audio-form">
                <div class="form-group">
                    <label>音频标题 <span style="color: #ff4444;">*</span></label>
                    <input type="text" id="audio-title-input" placeholder="输入音频标题">
                    <div id="audio-title-warning" class="dialog-warning">标题不能为空</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>音轨号</label>
                        <input type="number" id="audio-track-input" placeholder="如：1" min="1">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>时长</label>
                        <input type="text" id="audio-duration-input" placeholder="自动获取" disabled>
                    </div>
                </div>
                <div class="form-group">
                    <label>声优/演唱者</label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <input type="text" id="audio-artist-input" placeholder="输入声优或演唱者" style="flex:1;">
                        <input type="file" id="audio-artist-image-input" accept="image/*" style="display:none;">
                        <button type="button" id="audio-artist-image-btn" style="padding:8px 12px;border-radius:8px;background:var(--glass-bg);border:1px solid var(--border-color);color:var(--text-primary);cursor:pointer;font-size:12px;">📷</button>
                        <img id="audio-artist-image-preview" class="image-preview" style="display:none;width:36px;height:36px;">
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>作曲</label>
                        <input type="text" id="audio-composer-input" placeholder="输入作曲者">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>作词</label>
                        <input type="text" id="audio-lyricist-input" placeholder="输入作词者">
                    </div>
                </div>
                <div class="form-group">
                    <label>社团</label>
                    <input type="text" id="audio-circle-input" placeholder="输入社团名称">
                </div>
                <div class="form-group">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <label>字幕/歌词</label>
                        <button type="button" class="import-vtt-btn" id="import-vtt-btn">导入VTT/LRC</button>
                    </div>
                    <textarea id="audio-lyric-input" rows="3" placeholder="格式:&#10;00:00:01.000 --> 00:00:04.000&#10;歌词..."></textarea>
                    <input type="file" id="vtt-dialog-input" accept=".vtt,.srt,.lrc" style="display:none;">
                </div>
                <div class="form-group">
                    <label>音频来源</label>
                    <div class="source-switcher">
                        <label><input type="radio" name="audio-dialog-source" value="file" checked> 上传文件</label>
                        <label><input type="radio" name="audio-dialog-source" value="url"> 使用URL</label>
                    </div>
                    <div id="audio-dialog-file-group">
                        <input type="file" id="audio-dialog-file-input" accept=".mp3,.wav,.m4a,audio/*" style="width: 100%; margin-top: 8px;">
                    </div>
                    <div id="audio-dialog-url-group" class="hidden-input">
                        <input type="text" id="audio-dialog-url-input" placeholder="输入 .mp3 或 .wav 链接" style="width: 100%; margin-top: 8px;">
                    </div>
                </div>
                <div class="form-group">
                    <label>封面图片 (可选)</label>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="file" id="audio-image-input" accept="image/*" style="flex-grow:1">
                        <img id="audio-image-preview" class="image-preview" style="display:none">
                        <button id="clear-audio-image-btn" class="glass-button" style="padding:6px 10px;font-size:12px;display:none;">清空</button>
                    </div>
                </div>
            </div>
            <div id="audio-dialog-warning" class="dialog-warning" style="margin-top: 10px;">有未保存的更改，确定要放弃吗？</div>
            <div class="modal-buttons">
                <button id="audio-cancel-btn" class="modal-cancel-btn">取消</button>
                <button id="audio-confirm-btn" class="modal-confirm-btn">添加</button>
            </div>
        </div>
    </div>

    <div id="video-dialog" class="modal-overlay">
        <div class="modal-content" style="width: 90%; max-width: 450px; max-height: 80vh; overflow-y: auto;">
            <h3 id="video-dialog-title">添加视频</h3>
            <div id="video-form">
                <div class="form-group">
                    <label>视频标题 <span style="color: #ff4444;">*</span></label>
                    <input type="text" id="video-title-input" placeholder="输入视频标题">
                    <div id="video-title-warning" class="dialog-warning">标题不能为空</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>音轨号</label>
                        <input type="number" id="video-track-input" placeholder="如：1" min="1">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>时长</label>
                        <input type="text" id="video-duration-input" placeholder="自动获取" disabled>
                    </div>
                </div>
                <div class="form-group">
                    <label>演员/导演</label>
                    <input type="text" id="video-artist-input" placeholder="输入演员或导演">
                </div>
                <div class="form-group">
                    <label>视频来源</label>
                    <div class="source-switcher">
                        <label><input type="radio" name="video-dialog-source" value="file" checked> 上传文件</label>
                        <label><input type="radio" name="video-dialog-source" value="url"> 使用URL</label>
                    </div>
                    <div id="video-dialog-file-group">
                        <input type="file" id="video-dialog-file-input" accept="video/*,.mp4,.avi,.mkv,.mov,.wmv,.flv,.webm" style="width: 100%; margin-top: 8px;">
                    </div>
                    <div id="video-dialog-url-group" class="hidden-input">
                        <input type="text" id="video-dialog-url-input" placeholder="输入视频链接" style="width: 100%; margin-top: 8px;">
                    </div>
                </div>
                <div class="form-group">
                    <label>封面图片 (可选)</label>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="file" id="video-image-input" accept="image/*" style="flex-grow:1">
                        <img id="video-image-preview" class="image-preview" style="display:none">
                        <button id="clear-video-image-btn" class="glass-button" style="padding:6px 10px;font-size:12px;display:none;">清空</button>
                    </div>
                </div>
            </div>
            <div id="video-dialog-warning" class="dialog-warning" style="margin-top: 10px;">有未保存的更改，确定要放弃吗？</div>
            <div class="modal-buttons">
                <button id="video-cancel-btn" class="modal-cancel-btn">取消</button>
                <button id="video-confirm-btn" class="modal-confirm-btn">添加</button>
            </div>
        </div>
    </div>

    <div id="confirm-dialog" class="modal-overlay">
        <div class="modal-content" style="max-width: 350px;">
            <h3 id="confirm-title">确认</h3>
            <p id="confirm-message" style="color: var(--text-secondary); margin: 15px 0;"></p>
            <div class="modal-buttons">
                <button id="confirm-cancel-btn" class="modal-cancel-btn">取消</button>
                <button id="confirm-ok-btn" class="modal-confirm-btn danger">确认</button>
            </div>
        </div>
    </div>

    <div id="crop-modal-overlay" class="modal-overlay">
        <div class="modal-content" style="width: 90vw; max-width: 500px;">
            <div id="cropper-container" style="width: 100%; height: 60vh; max-height: 400px;">
                <img id="cropper-image">
            </div>
            <div class="modal-buttons" style="margin-top: 15px;">
                <button id="cancel-crop-btn" class="modal-cancel-btn">取消</button>
                <button id="confirm-crop-btn" class="modal-confirm-btn">裁剪</button>
            </div>
        </div>
    </div>

    <div id="bottom-player">
        <div class="bottom-player-content">
            <div class="bottom-player-info" id="bottom-player-info">
                <img id="bottom-player-art" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM4ODgiIHN0cm9rZS13aWR0aD0iMiI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiPjwvY2lyY2xlPjxwYXRoIGQ9Im0xNiA4LTggMyA4IDMgeiIgLz48L3N2Zz4=" alt="cover">
                <div class="bottom-player-text">
                    <div id="bottom-player-title">未在播放</div>
                    <div id="bottom-player-subtitle">选择一首歌曲</div>
                </div>
            </div>
            <div class="bottom-player-controls">
                <button id="bottom-prev-btn" class="bottom-control-btn">⏮</button>
                <button id="bottom-play-btn" class="bottom-control-btn play-btn">▶</button>
                <button id="bottom-next-btn" class="bottom-control-btn">⏭</button>
            </div>
            <div class="bottom-player-progress-area">
                <input type="range" id="bottom-progress" value="0" step="1" min="0" max="100">
                <div class="bottom-time">
                    <span id="bottom-current-time">00:00</span>
                    <span id="bottom-duration">00:00</span>
                </div>
            </div>
            <div id="bottom-player-lyric">♪ 暂无歌词</div>
            <button id="open-queue-btn" class="bottom-control-btn" title="播放队列" style="margin-left: 10px;">📋</button>
        </div>
        <div class="bottom-player-handle"></div>
    </div>

    <div id="batch-toolbar" class="batch-toolbar">
        <span class="selected-count">已选择 0 项</span>
        <button class="batch-add-playlist" id="batch-add-playlist-btn" style="background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 99, 102, 241), 0.8), rgba(var(--btn-color-rgb, 99, 102, 241), 0.6)); color: white;">添加到播放列表</button>
        <button class="batch-delete" id="batch-delete-btn">删除选中</button>
        <button class="batch-cancel" id="batch-cancel-btn">取消</button>
    </div>

    <div id="play-queue-panel" class="play-queue-panel">
        <div class="queue-header">
            <h3>播放队列</h3>
            <div class="queue-actions">
                <button id="clear-queue-btn" class="queue-action-btn" title="清空队列">🗑️</button>
                <button id="close-queue-btn" class="queue-action-btn" title="关闭">✕</button>
            </div>
        </div>
        <div id="queue-list" class="queue-list"></div>
        <div id="queue-empty-tip" class="queue-empty-tip">
            <div style="font-size: 48px; margin-bottom: 15px;">🎵</div>
            <p>播放队列为空</p>
            <p style="font-size: 12px; margin-top: 10px; opacity: 0.7;">点击歌曲或视频的播放按钮添加到队列</p>
        </div>
    </div>

    <div id="queue-overlay" class="queue-overlay"></div>
    
    <div id="sleep-timer-bar" class="sleep-timer-bar">
        <span class="sleep-timer-icon">⏰</span>
        <span class="sleep-timer-text">睡眠定时</span>
        <span id="sleep-timer-countdown" class="sleep-timer-countdown">00:00</span>
        <button id="sleep-timer-close" class="sleep-timer-close" title="取消定时">✕</button>
    </div>

    <script>
    (function() {
        'use strict';

        (function detectTouchDevice() {
            const isTouchDevice = ('ontouchstart' in window) || 
                (navigator.maxTouchPoints > 0) || 
                (navigator.msMaxTouchPoints > 0);
            if (isTouchDevice) {
                document.documentElement.classList.add('touch-device');
            }
            let lastTouchTime = 0;
            document.addEventListener('touchstart', () => {
                lastTouchTime = Date.now();
                document.documentElement.classList.add('touch-device');
            }, { passive: true });
            document.addEventListener('mousemove', (e) => {
                if (Date.now() - lastTouchTime > 500) {
                    document.documentElement.classList.remove('touch-device');
                }
            }, { passive: true });
        })();

        const db = new Dexie('YumePlayerDB');
        db.version(6).stores({
            albums: '++id, name, createdAt',
            discs: '++id, albumId, name, createdAt',
            audios: '++id, discId, albumId, title, isFavorite, artist, createdAt',
            playlists: '++id, name, createdAt',
            playlistItems: '++id, playlistId, audioId, createdAt',
            settings: 'key',
            videoAlbums: '++id, name, createdAt',
            videoDiscs: '++id, videoAlbumId, name, createdAt',
            videos: '++id, videoDiscId, videoAlbumId, title, isFavorite, artist, createdAt',
            videoPlaylists: '++id, name, createdAt',
            videoPlaylistItems: '++id, videoPlaylistId, videoId, createdAt',
            playHistory: '++id, mediaType, mediaId, playedAt',
            mediaAlbums: '++id, name, mediaType, createdAt',
            mediaDiscs: '++id, mediaAlbumId, name, createdAt',
            mediaItems: '++id, mediaDiscId, mediaAlbumId, title, mediaType, isFavorite, artist, createdAt',
            unifiedPlaylists: '++id, name, createdAt',
            unifiedPlaylistItems: '++id, unifiedPlaylistId, mediaItemId, mediaType, createdAt',
            playQueue: '++id, mediaItemId, mediaType, order, createdAt'
        }).upgrade(tx => {
            return tx.table('settings').put({ key: 'dbVersion', value: 6 });
        });

        db.albums.hook('deleting', async (primKey, album, transaction) => {
            const discs = await db.discs.where('albumId').equals(primKey).toArray();
            const discIds = discs.map(d => d.id);
            if (discIds.length > 0) {
                await db.audios.where('discId').anyOf(discIds).delete();
            }
            await db.discs.where('albumId').equals(primKey).delete();
        });

        db.discs.hook('deleting', async (primKey, disc, transaction) => {
            await db.audios.where('discId').equals(primKey).delete();
        });

        db.videoAlbums.hook('deleting', async (primKey, videoAlbum, transaction) => {
            const videoDiscs = await db.videoDiscs.where('videoAlbumId').equals(primKey).toArray();
            const videoDiscIds = videoDiscs.map(d => d.id);
            if (videoDiscIds.length > 0) {
                await db.videos.where('videoDiscId').anyOf(videoDiscIds).delete();
            }
            await db.videoDiscs.where('videoAlbumId').equals(primKey).delete();
        });

        db.videoDiscs.hook('deleting', async (primKey, videoDisc, transaction) => {
            await db.videos.where('videoDiscId').equals(primKey).delete();
        });

        db.mediaAlbums.hook('deleting', async (primKey, mediaAlbum, transaction) => {
            const mediaDiscs = await db.mediaDiscs.where('mediaAlbumId').equals(primKey).toArray();
            const mediaDiscIds = mediaDiscs.map(d => d.id);
            if (mediaDiscIds.length > 0) {
                await db.mediaItems.where('mediaDiscId').anyOf(mediaDiscIds).delete();
            }
            await db.mediaDiscs.where('mediaAlbumId').equals(primKey).delete();
        });

        db.mediaDiscs.hook('deleting', async (primKey, mediaDisc, transaction) => {
            await db.mediaItems.where('mediaDiscId').equals(primKey).delete();
        });

        class MediaManager {
            constructor() {
                this.currentMedia = null;
                this.currentMediaType = null;
                this.playQueue = [];
                this.currentIndex = -1;
            }
            
            async addToQueue(mediaId, mediaType) {
                const maxOrder = await db.playQueue.max('order') || 0;
                await db.playQueue.add({
                    mediaItemId: mediaId,
                    mediaType: mediaType,
                    order: maxOrder + 1,
                    createdAt: Date.now()
                });
                await this.loadQueue();
            }
            
            async loadQueue() {
                this.playQueue = await db.playQueue.orderBy('order').toArray();
            }
            
            async clearQueue() {
                await db.playQueue.clear();
                this.playQueue = [];
                this.currentIndex = -1;
            }
            
            async removeFromQueue(queueId) {
                await db.playQueue.delete(queueId);
                await this.loadQueue();
            }
            
            async playNext() {
                if (this.playQueue.length === 0) return;
                this.currentIndex = (this.currentIndex + 1) % this.playQueue.length;
                const item = this.playQueue[this.currentIndex];
                if (item) {
                    if (item.mediaType === 'audio') {
                        await playAudio(item.mediaItemId);
                    } else if (item.mediaType === 'video') {
                        await playVideo(item.mediaItemId);
                    }
                }
            }
            
            async playPrevious() {
                if (this.playQueue.length === 0) return;
                this.currentIndex = (this.currentIndex - 1 + this.playQueue.length) % this.playQueue.length;
                const item = this.playQueue[this.currentIndex];
                if (item) {
                    if (item.mediaType === 'audio') {
                        await playAudio(item.mediaItemId);
                    } else if (item.mediaType === 'video') {
                        await playVideo(item.mediaItemId);
                    }
                }
            }
            
            getMediaTypeIcon(mediaType) {
                switch(mediaType) {
                    case 'audio': return '🎵';
                    case 'video': return '🎬';
                    default: return '📁';
                }
            }
        }

        const mediaManager = new MediaManager();

        class EventBinder {
            constructor() { this.bindings = new Map(); }
            _getKey(element, event) {
                const id = element.id || element.tagName + '_' + Math.random().toString(36).substr(2, 9);
                if (!element.id) element.id = id;
                return `${element.id}_${event}`;
            }
            bind(element, event, handler) {
                const key = this._getKey(element, event);
                if (this.bindings.has(key)) this.unbind(element, event);
                element.addEventListener(event, handler);
                this.bindings.set(key, handler);
            }
            unbind(element, event) {
                const key = this._getKey(element, event);
                const handler = this.bindings.get(key);
                if (handler) {
                    element.removeEventListener(event, handler);
                    this.bindings.delete(key);
                }
            }
            unbindAll() {
                this.bindings.forEach((handler, key) => {
                    const [id, event] = key.split('_');
                    const element = document.getElementById(id);
                    if (element) element.removeEventListener(event, handler);
                });
                this.bindings.clear();
            }
        }

        const eventBinder = new EventBinder();
        const defaultCover = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzg4OCIgc3Ryb2tlLXdpZHRoPSIyIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCI+PC9jaXJjbGU+PHBhdGggZD0ibTE2IDgtOCAzIDggMyB6IiAvPjwvc3ZnPg==';

        let currentAlbumId = null;
        let currentDiscId = null;
        let currentLyrics = [];
        let currentPlayerStyle = 'simple';
        let playerPreviousView = 'desktop-view';
        let sleepTimerId = null;
        let sleepCountdownId = null;
        let sleepEndTime = null;
        let stopAtSongEnd = false;
        let isContinuousPlay = false;
        let isSubmitting = false;
        let dialogOriginalData = null;
        let isDialogDirty = false;
        let isCoverCleared = false;
        let currentDialogMode = 'create-album';
        let editingEntityId = null;
        let editingAudioId = null;
        let audioDialogOriginalData = null;
        let audioDialogDirty = false;
        let cropper = null;
        let croppedImageBlob = null;
        let tempObjectURLs = [];
        let batchMode = false;
        let selectedAudios = new Set();
        let undoStack = [];
        let audioDialogOriginalFile = null;
        let audioDialogOriginalImage = null;
        let customCoverUrl = null;
        let currentAudioCover = null;
        let currentAudioTitle = 'Unknown Song';
        let currentViewMode = 'disc';
        let currentSortBy = 'default';
        let currentSortOrder = 'asc';

        let currentVideoAlbumId = null;
        let currentVideoDiscId = null;
        let currentVideoViewMode = 'disc';
        let currentVideoSortBy = 'default';
        let currentVideoSortOrder = 'asc';
        let videoPlayerPreviousView = 'desktop-view';
        let videoBatchMode = false;
        let selectedVideos = new Set();
        let editingVideoId = null;
        let videoDialogOriginalData = null;
        let videoDialogOriginalFile = null;
        let videoDialogOriginalImage = null;
        let isVideoDialogSubmitting = false;

        const defaultAppConfig = [
            { id: 'player', name: '播放器', icon: '▶️', target: 'player-view' },
            { id: 'albums', name: '媒体库', icon: '💿', target: 'albums-view' },
            { id: 'playlists', name: '播放列表', icon: '📋', target: 'playlists-view' },
            { id: 'favorites', name: '我的收藏', icon: '❤️', target: 'favorites-view' },
            { id: 'beautify', name: '美化', icon: '🎨', target: 'beautify-view' },
            { id: 'data', name: '数据管理', icon: '💾', target: 'data-view' }
        ];

        function revokeURLs() {
            tempObjectURLs.forEach(url => URL.revokeObjectURL(url));
            tempObjectURLs = [];
        }

        function openSidebar() {
            document.getElementById('main-sidebar')?.classList.add('open');
            document.getElementById('sidebar-overlay')?.classList.add('visible');
        }

        function closeSidebar() {
            document.getElementById('main-sidebar')?.classList.remove('open');
            document.getElementById('sidebar-overlay')?.classList.remove('visible');
        }

        let urlUsageMap = new Map();
        const MAX_URLS = 200;
        
        function trackURL(url, context = '') {
            if (!url || !url.startsWith('blob:')) return url;
            tempObjectURLs.push(url);
            urlUsageMap.set(url, { context, timestamp: Date.now() });
            if (tempObjectURLs.length > MAX_URLS) {
                const oldURLs = tempObjectURLs.splice(0, 50);
                oldURLs.forEach(url => {
                    URL.revokeObjectURL(url);
                    urlUsageMap.delete(url);
                });
            }
            return url;
        }
        
        setInterval(() => {
            const now = Date.now();
            const maxAge = 30 * 60 * 1000;
            tempObjectURLs = tempObjectURLs.filter(url => {
                const info = urlUsageMap.get(url);
                if (info && now - info.timestamp > maxAge) {
                    URL.revokeObjectURL(url);
                    urlUsageMap.delete(url);
                    return false;
                }
                return true;
            });
        }, 5 * 60 * 1000);

        function navigateTo(viewId) {
            const currentView = document.querySelector('.view.active');
            const targetView = document.getElementById(viewId);
            if (currentView && targetView && currentView !== targetView) {
                currentView.style.transform = 'scale(0.95)';
                currentView.style.opacity = '0';
                setTimeout(() => {
                    currentView.classList.remove('active');
                    currentView.style.transform = '';
                    currentView.style.opacity = '';
                    targetView.classList.add('active');
                }, 200);
            } else if (targetView) {
                targetView.classList.add('active');
            }
            closeAllDialogs();
        }

        function addRippleEffect(element) {
            if (!element) return;
            element.classList.add('ripple-container');
            element.addEventListener('click', function(e) {
                const rect = element.getBoundingClientRect();
                const ripple = document.createElement('span');
                ripple.className = 'ripple';
                ripple.style.left = (e.clientX - rect.left) + 'px';
                ripple.style.top = (e.clientY - rect.top) + 'px';
                element.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
            });
        }

        function addRippleToAllButtons() {
            document.querySelectorAll('.glass-button, .action-button, .bottom-control-btn, .audio-action-btn, .album-action-btn').forEach(btn => {
                addRippleEffect(btn);
            });
        }

        function closeAllDialogs() {
            document.getElementById('entity-dialog').classList.remove('active');
            document.getElementById('audio-dialog').classList.remove('active');
            document.getElementById('video-dialog').classList.remove('active');
            document.getElementById('crop-modal-overlay').classList.remove('active');
            document.getElementById('confirm-dialog').classList.remove('active');
        }

        async function recordPlayHistory(mediaType, mediaId) {
            await db.playHistory.add({
                mediaType,
                mediaId,
                playedAt: Date.now()
            });
            await renderRecentPlay();
        }

        async function getPlayCount(mediaType, mediaId) {
            const records = await db.playHistory.where({ mediaType, mediaId }).toArray();
            return records.length;
        }

        async function renderVideoAlbums() {
            const albumsGrid = document.getElementById('video-albums-grid');
            const emptyTip = document.getElementById('video-album-empty-tip');
            const albums = await db.videoAlbums.toArray();
            albumsGrid.innerHTML = '';
            if (albums.length === 0) {
                emptyTip.style.display = 'block';
                return;
            }
            emptyTip.style.display = 'none';
            for (const album of albums) {
                const discCount = await db.videoDiscs.where('videoAlbumId').equals(album.id).count();
                const item = document.createElement('div');
                item.className = 'album-item';
                item.dataset.id = album.id;
                let coverStyle = '';
                if (album.cover) {
                    const url = URL.createObjectURL(album.cover);
                    tempObjectURLs.push(url);
                    coverStyle = `background-image: url(${url});`;
                }
                item.innerHTML = `
                    <div class="album-actions">
                        <button class="album-action-btn album-edit-btn" data-action="edit" title="编辑">✏️</button>
                        <button class="album-action-btn album-delete-btn" data-action="delete" title="删除">🗑️</button>
                    </div>
                    <div class="album-icon" style="${coverStyle}">${album.cover ? '' : '🎬'}</div>
                    <div class="album-name">${album.name}</div>
                    <div class="album-count">${discCount} 个Disc</div>
                `;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.album-actions')) {
                        const action = e.target.closest('.album-action-btn').dataset.action;
                        if (action === 'edit') openEditVideoAlbumDialog(album);
                        else if (action === 'delete') deleteVideoAlbum(album.id, album.name);
                    } else {
                        currentVideoAlbumId = album.id;
                        renderVideoDiscDetail(album.id, album.name);
                    }
                });
                albumsGrid.appendChild(item);
            }
        }

        async function renderVideoDiscDetail(albumId, albumName) {
            document.getElementById('video-disc-album-title').textContent = albumName;
            const discList = document.getElementById('video-disc-list');
            const videoList = document.getElementById('video-list');
            const emptyTip = document.getElementById('video-disc-empty-tip');
            const batchBtn = document.getElementById('video-batch-mode-btn');
            const viewControls = document.querySelector('#video-disc-detail-view .view-controls');
            const discs = (await db.videoDiscs.where('videoAlbumId').equals(albumId).toArray()).sort((a, b) => (a.order || 0) - (b.order || 0));
            discList.innerHTML = '';
            videoList.innerHTML = '';
            
            if (discs.length === 0) {
                emptyTip.style.display = 'block';
                viewControls.style.display = 'none';
                currentVideoDiscId = null;
                batchBtn.style.display = 'none';
                videoList.innerHTML = `
                    <div style="text-align:center;color:var(--text-secondary);padding:40px 20px;">
                        <div style="font-size:48px;margin-bottom:15px;">📀</div>
                        <p>请先创建Disc后再添加视频</p>
                        <p style="font-size:12px;margin-top:10px;opacity:0.7;">点击右上角"+"按钮创建Disc</p>
                    </div>
                `;
                navigateTo('video-disc-detail-view');
                return;
            }
            
            emptyTip.style.display = 'none';
            viewControls.style.display = 'flex';
            batchBtn.style.display = currentVideoViewMode === 'disc' ? 'block' : 'none';
            
            if (currentVideoViewMode === 'disc') {
                discList.style.display = 'flex';
                if (!currentVideoDiscId || !discs.find(d => d.id === currentVideoDiscId)) {
                    currentVideoDiscId = discs[0].id;
                }
            } else {
                discList.style.display = 'none';
            }
            
            for (const disc of discs) {
                const item = document.createElement('div');
                item.className = 'disc-item' + (disc.id === currentVideoDiscId ? ' selected' : '');
                item.dataset.id = disc.id;
                item.draggable = true;
                let coverStyle = '';
                if (disc.cover) {
                    const url = URL.createObjectURL(disc.cover);
                    tempObjectURLs.push(url);
                    coverStyle = `background-image: url(${url}); background-size: cover;`;
                }
                item.innerHTML = `
                    <div class="disc-actions">
                        <button class="album-action-btn album-edit-btn" data-action="edit" title="编辑">✏️</button>
                        <button class="album-action-btn album-delete-btn" data-action="delete" title="删除">🗑️</button>
                    </div>
                    <div class="disc-icon" style="${coverStyle}">${disc.cover ? '' : '📀'}</div>
                    <div class="disc-name">${disc.name}</div>
                `;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.disc-actions')) {
                        const action = e.target.closest('.album-action-btn').dataset.action;
                        if (action === 'edit') openEditVideoDiscDialog(disc);
                        else if (action === 'delete') deleteVideoDisc(disc.id, disc.name);
                    } else {
                        currentVideoDiscId = disc.id;
                        videoBatchMode = false;
                        selectedVideos.clear();
                        updateVideoBatchToolbar();
                        renderVideoDiscDetail(albumId, albumName);
                    }
                });
                discList.appendChild(item);
            }
            
            if (currentVideoViewMode === 'disc') {
                await renderVideos(currentVideoDiscId);
            } else {
                await renderAllVideos(albumId, discs);
            }
            navigateTo('video-disc-detail-view');
        }

        async function renderVideos(discId) {
            const videoList = document.getElementById('video-list');
            videoList.innerHTML = '';
            if (!discId) return;
            
            const videos = await db.videos.where('videoDiscId').equals(discId).toArray();
            
            if (videos.length === 0) {
                videoList.innerHTML = `
                    <div style="text-align:center;color:var(--text-secondary);padding:40px 20px;">
                        <div style="font-size:48px;margin-bottom:15px;">🎬</div>
                        <p>暂无视频</p>
                        <p style="font-size:12px;margin-top:10px;opacity:0.7;">点击下方按钮添加视频</p>
                    </div>
                `;
            } else {
                for (const video of videos) {
                    const item = document.createElement('div');
                    item.className = 'audio-item' + (selectedVideos.has(video.id) ? ' selected' : '');
                    item.dataset.id = video.id;
                    let coverUrl = defaultCover;
                    if (video.imageFile) {
                        coverUrl = URL.createObjectURL(video.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                    
                    const playCount = await getPlayCount('video', video.id);
                    const checkboxHtml = videoBatchMode ? `<input type="checkbox" class="audio-checkbox" ${selectedVideos.has(video.id) ? 'checked' : ''}>` : '';
                    const trackInfo = video.trackNumber ? `${video.trackNumber}. ` : '';
                    const artistInfo = video.artist ? ` - ${video.artist}` : '';
                    
                    item.innerHTML = `
                        ${checkboxHtml}
                        <img class="audio-cover" src="${coverUrl}" alt="cover">
                        <div class="audio-info">
                            <div class="audio-title">${trackInfo}${video.title}</div>
                            <div class="audio-meta">${video.duration ? formatTime(video.duration) : '未知时长'}${artistInfo} | 播放${playCount}次</div>
                        </div>
                        <div class="audio-actions">
                            <button class="audio-action-btn play-btn" data-action="play" title="播放">▶</button>
                            <button class="audio-action-btn" data-action="addQueue" title="添加到播放队列">📋</button>
                            <button class="audio-action-btn favorite ${video.isFavorite ? 'active' : ''}" data-action="favorite" title="${video.isFavorite ? '取消收藏' : '添加收藏'}">${video.isFavorite ? '❤️' : '🤍'}</button>
                            <button class="audio-action-btn" data-action="addPlaylist" title="添加到播放列表">➕</button>
                            <button class="audio-action-btn" data-action="edit" title="编辑">✏️</button>
                            <button class="audio-action-btn" data-action="delete" title="删除" style="color:#ff4444;">🗑️</button>
                        </div>
                    `;
                    
                    if (videoBatchMode) {
                        const checkbox = item.querySelector('.audio-checkbox');
                        checkbox.addEventListener('change', (e) => {
                            if (e.target.checked) {
                                selectedVideos.add(video.id);
                            } else {
                                selectedVideos.delete(video.id);
                            }
                            item.classList.toggle('selected', selectedVideos.has(video.id));
                            updateVideoBatchToolbar();
                        });
                        item.querySelector('.audio-info').addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (selectedVideos.has(video.id)) {
                                selectedVideos.delete(video.id);
                            } else {
                                selectedVideos.add(video.id);
                            }
                            renderVideos(discId);
                            updateVideoBatchToolbar();
                        });
                    } else {
                        item.querySelector('.audio-info').addEventListener('click', () => playVideo(video.id));
                    }
                    
                    item.querySelectorAll('.audio-action-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const action = btn.dataset.action;
                            if (action === 'play') playVideo(video.id);
                            else if (action === 'addQueue') await addToPlayQueue(video.id, 'video');
                            else if (action === 'favorite') await toggleVideoFavorite(video.id);
                            else if (action === 'addPlaylist') await addVideoToPlaylist(video.id);
                            else if (action === 'edit') openEditVideoDialog(video);
                            else if (action === 'delete') deleteVideoWithUndo(video.id, video.title);
                        });
                    });
                    videoList.appendChild(item);
                }
            }
            
            const addBtn = document.createElement('button');
            addBtn.className = 'glass-button primary';
            addBtn.style.cssText = 'width:100%;margin-top:15px;';
            addBtn.textContent = '+ 添加视频';
            addBtn.addEventListener('click', () => openAddVideoDialog());
            videoList.appendChild(addBtn);
        }

        async function renderAllVideos(albumId, discs) {
            const videoList = document.getElementById('video-list');
            videoList.innerHTML = '';
            
            let allVideos = [];
            for (const disc of discs) {
                const videos = await db.videos.where('videoDiscId').equals(disc.id).toArray();
                videos.forEach(v => v.discName = disc.name);
                allVideos = allVideos.concat(videos);
            }
            
            allVideos = sortVideos(allVideos);
            
            if (allVideos.length === 0) {
                videoList.innerHTML = `
                    <div style="text-align:center;color:var(--text-secondary);padding:40px 20px;">
                        <div style="font-size:48px;margin-bottom:15px;">🎬</div>
                        <p>暂无视频</p>
                    </div>
                `;
                return;
            }
            
            for (const video of allVideos) {
                const item = document.createElement('div');
                item.className = 'audio-item';
                item.dataset.id = video.id;
                let coverUrl = defaultCover;
                if (video.imageFile) {
                    coverUrl = URL.createObjectURL(video.imageFile);
                    tempObjectURLs.push(coverUrl);
                }
                
                const playCount = await getPlayCount('video', video.id);
                const trackInfo = video.trackNumber ? `${video.trackNumber}. ` : '';
                const artistInfo = video.artist ? ` - ${video.artist}` : '';
                const discInfo = video.discName ? `[${video.discName}]` : '';
                
                item.innerHTML = `
                    <img class="audio-cover" src="${coverUrl}" alt="cover">
                    <div class="audio-info">
                        <div class="audio-title">${trackInfo}${video.title}</div>
                        <div class="audio-meta">${discInfo} ${video.duration ? formatTime(video.duration) : '未知时长'}${artistInfo} | 播放${playCount}次</div>
                    </div>
                    <div class="audio-actions">
                        <button class="audio-action-btn play-btn" data-action="play" title="播放">▶</button>
                        <button class="audio-action-btn" data-action="addQueue" title="添加到播放队列">📋</button>
                        <button class="audio-action-btn favorite ${video.isFavorite ? 'active' : ''}" data-action="favorite" title="${video.isFavorite ? '取消收藏' : '添加收藏'}">${video.isFavorite ? '❤️' : '🤍'}</button>
                        <button class="audio-action-btn" data-action="addPlaylist" title="添加到播放列表">➕</button>
                        <button class="audio-action-btn" data-action="edit" title="编辑">✏️</button>
                        <button class="audio-action-btn" data-action="delete" title="删除" style="color:#ff4444;">🗑️</button>
                    </div>
                `;
                
                item.querySelector('.audio-info').addEventListener('click', () => playVideo(video.id));
                
                item.querySelectorAll('.audio-action-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const action = btn.dataset.action;
                        if (action === 'play') playVideo(video.id);
                        else if (action === 'addQueue') await addToPlayQueue(video.id, 'video');
                        else if (action === 'favorite') await toggleVideoFavorite(video.id);
                        else if (action === 'addPlaylist') await addVideoToPlaylist(video.id);
                        else if (action === 'edit') openEditVideoDialog(video);
                        else if (action === 'delete') deleteVideoWithUndo(video.id, video.title);
                    });
                });
                videoList.appendChild(item);
            }
        }

        function sortVideos(videos) {
            const sorted = [...videos];
            switch (currentVideoSortBy) {
                case 'track':
                    sorted.sort((a, b) => (a.trackNumber || 999) - (b.trackNumber || 999));
                    break;
                case 'title':
                    sorted.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                    break;
                case 'duration':
                    sorted.sort((a, b) => (a.duration || 0) - (b.duration || 0));
                    break;
                case 'createdAt':
                    sorted.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                    break;
                default:
                    break;
            }
            if (currentVideoSortOrder === 'desc') {
                sorted.reverse();
            }
            return sorted;
        }

        function updateVideoBatchToolbar() {
            const toolbar = document.getElementById('batch-toolbar');
            const countSpan = toolbar.querySelector('.selected-count');
            const batchBtn = document.getElementById('video-batch-mode-btn');
            
            if (videoBatchMode && selectedVideos.size > 0) {
                toolbar.classList.add('active');
                countSpan.textContent = `已选择 ${selectedVideos.size} 项`;
            } else {
                toolbar.classList.remove('active');
            }
            
            if (batchBtn) {
                batchBtn.textContent = videoBatchMode ? '退出批量' : '批量管理';
                batchBtn.classList.toggle('active', videoBatchMode);
            }
        }

        function openCreateVideoAlbumDialog() {
            currentDialogMode = 'create-video-album';
            editingEntityId = null;
            document.getElementById('dialog-title').textContent = '创建视频专辑';
            document.getElementById('entity-name-input').value = '';
            document.getElementById('entity-cover-input').value = '';
            document.getElementById('entity-cover-preview').style.display = 'none';
            document.getElementById('clear-entity-cover-btn').style.display = 'none';
            document.getElementById('entity-number-input').value = '';
            document.getElementById('entity-artist-input').value = '';
            document.getElementById('entity-release-date-input').value = '';
            document.getElementById('entity-description-input').value = '';
            document.querySelectorAll('.album-only-field').forEach(el => el.style.display = 'block');
            document.querySelectorAll('.disc-only-field').forEach(el => el.style.display = 'none');
            document.getElementById('entity-confirm-btn').textContent = '创建';
            document.getElementById('name-warning').classList.remove('visible');
            dialogOriginalData = { name: '', cover: null };
            isDialogDirty = false;
            isCoverCleared = false;
            document.getElementById('entity-dialog').classList.add('active');
        }

        function openEditVideoAlbumDialog(album) {
            currentDialogMode = 'edit-video-album';
            editingEntityId = album.id;
            document.getElementById('dialog-title').textContent = '编辑视频专辑';
            document.getElementById('entity-name-input').value = album.name;
            document.getElementById('entity-cover-input').value = '';
            document.getElementById('entity-number-input').value = album.albumNumber || '';
            document.getElementById('entity-artist-input').value = album.artist || '';
            document.getElementById('entity-release-date-input').value = album.releaseDate || '';
            document.getElementById('entity-description-input').value = album.description || '';
            document.querySelectorAll('.album-only-field').forEach(el => el.style.display = 'block');
            document.querySelectorAll('.disc-only-field').forEach(el => el.style.display = 'none');
            const preview = document.getElementById('entity-cover-preview');
            const clearBtn = document.getElementById('clear-entity-cover-btn');
            if (album.cover) {
                const url = URL.createObjectURL(album.cover);
                preview.src = url;
                preview.style.display = 'block';
                if (clearBtn) clearBtn.style.display = 'block';
            } else {
                preview.style.display = 'none';
                if (clearBtn) clearBtn.style.display = 'none';
            }
            document.getElementById('entity-confirm-btn').textContent = '保存';
            document.getElementById('name-warning').classList.remove('visible');
            dialogOriginalData = { name: album.name, cover: album.cover };
            isDialogDirty = false;
            isCoverCleared = false;
            document.getElementById('entity-dialog').classList.add('active');
        }

        function openCreateVideoDiscDialog() {
            if (!currentVideoAlbumId) {
                showToast('请先选择一个视频专辑');
                return;
            }
            currentDialogMode = 'create-video-disc';
            editingEntityId = null;
            document.getElementById('dialog-title').textContent = '创建视频Disc';
            document.getElementById('entity-name-input').value = '';
            document.getElementById('entity-cover-input').value = '';
            document.getElementById('entity-cover-preview').style.display = 'none';
            document.getElementById('clear-entity-cover-btn').style.display = 'none';
            document.getElementById('entity-disc-number-input').value = '';
            document.getElementById('entity-disc-description-input').value = '';
            document.querySelectorAll('.album-only-field').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.disc-only-field').forEach(el => el.style.display = 'block');
            document.getElementById('entity-confirm-btn').textContent = '创建';
            document.getElementById('name-warning').classList.remove('visible');
            dialogOriginalData = { name: '', cover: null };
            isDialogDirty = false;
            isCoverCleared = false;
            document.getElementById('entity-dialog').classList.add('active');
        }

        function openEditVideoDiscDialog(disc) {
            currentDialogMode = 'edit-video-disc';
            editingEntityId = disc.id;
            document.getElementById('dialog-title').textContent = '编辑视频Disc';
            document.getElementById('entity-name-input').value = disc.name;
            document.getElementById('entity-cover-input').value = '';
            document.getElementById('entity-disc-number-input').value = disc.discNumber || '';
            document.getElementById('entity-disc-description-input').value = disc.description || '';
            document.querySelectorAll('.album-only-field').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.disc-only-field').forEach(el => el.style.display = 'block');
            const preview = document.getElementById('entity-cover-preview');
            const clearBtn = document.getElementById('clear-entity-cover-btn');
            if (disc.cover) {
                const url = URL.createObjectURL(disc.cover);
                preview.src = url;
                preview.style.display = 'block';
                if (clearBtn) clearBtn.style.display = 'block';
            } else {
                preview.style.display = 'none';
                if (clearBtn) clearBtn.style.display = 'none';
            }
            document.getElementById('entity-confirm-btn').textContent = '保存';
            document.getElementById('name-warning').classList.remove('visible');
            dialogOriginalData = { name: disc.name, cover: disc.cover };
            isDialogDirty = false;
            isCoverCleared = false;
            document.getElementById('entity-dialog').classList.add('active');
        }

        async function deleteVideoAlbum(id, name) {
            const confirmed = await showConfirm('删除视频专辑', `确定删除视频专辑"${name}"吗？\n这将同时删除所有Disc和视频文件！`);
            if (confirmed) {
                await db.videoAlbums.delete(id);
                showToast('视频专辑已删除');
                renderVideoAlbums();
            }
        }

        async function deleteVideoDisc(id, name) {
            const confirmed = await showConfirm('删除视频Disc', `确定删除Disc"${name}"吗？\n这将同时删除所有视频文件！`);
            if (confirmed) {
                await db.videoDiscs.delete(id);
                if (currentVideoDiscId === id) currentVideoDiscId = null;
                showToast('视频Disc已删除');
                const album = await db.videoAlbums.get(currentVideoAlbumId);
                renderVideoDiscDetail(currentVideoAlbumId, album.name);
            }
        }

        function openAddVideoDialog() {
            if (!currentVideoDiscId) {
                showToast('请先选择或创建一个Disc');
                return;
            }
            editingVideoId = null;
            document.getElementById('video-dialog-title').textContent = '添加视频';
            document.getElementById('video-title-input').value = '';
            document.getElementById('video-track-input').value = '';
            document.getElementById('video-duration-input').value = '';
            document.getElementById('video-artist-input').value = '';
            document.getElementById('video-dialog-file-input').value = '';
            document.getElementById('video-dialog-url-input').value = '';
            document.getElementById('video-image-input').value = '';
            document.getElementById('video-image-preview').style.display = 'none';
            document.getElementById('video-confirm-btn').textContent = '添加';
            document.getElementById('video-title-warning').classList.remove('visible');
            videoDialogOriginalData = { title: '', videoFile: null, imageFile: null };
            videoDialogOriginalFile = null;
            videoDialogOriginalImage = null;
            document.getElementById('video-dialog').classList.add('active');
        }

        function openEditVideoDialog(video) {
            editingVideoId = video.id;
            document.getElementById('video-dialog-title').textContent = '编辑视频';
            document.getElementById('video-title-input').value = video.title;
            document.getElementById('video-track-input').value = video.trackNumber || '';
            document.getElementById('video-duration-input').value = video.duration ? formatTime(video.duration) : '';
            document.getElementById('video-artist-input').value = video.artist || '';
            document.getElementById('video-dialog-file-input').value = '';
            document.getElementById('video-dialog-url-input').value = video.videoType === 'url' ? video.videoSource : '';
            const preview = document.getElementById('video-image-preview');
            const clearBtn = document.getElementById('clear-video-image-btn');
            if (video.imageFile) {
                const url = URL.createObjectURL(video.imageFile);
                preview.src = url;
                preview.style.display = 'block';
                if (clearBtn) clearBtn.style.display = 'block';
            } else {
                preview.style.display = 'none';
                if (clearBtn) clearBtn.style.display = 'none';
            }
            document.getElementById('video-confirm-btn').textContent = '保存';
            document.getElementById('video-title-warning').classList.remove('visible');
            videoDialogOriginalData = { title: video.title };
            videoDialogOriginalFile = video.videoFile || null;
            videoDialogOriginalImage = video.imageFile || null;
            document.getElementById('video-dialog').classList.add('active');
        }

        async function handleVideoConfirm() {
            if (isVideoDialogSubmitting) return;
            const title = document.getElementById('video-title-input').value.trim();
            if (!title) {
                document.getElementById('video-title-warning').classList.add('visible');
                return;
            }
            isVideoDialogSubmitting = true;
            const trackNumber = parseInt(document.getElementById('video-track-input').value) || null;
            const artist = document.getElementById('video-artist-input').value.trim();
            const fileInput = document.getElementById('video-dialog-file-input');
            const urlInput = document.getElementById('video-dialog-url-input');
            const imageInput = document.getElementById('video-image-input');
            const isUrlMode = document.querySelector('input[name="video-dialog-source"]:checked').value === 'url';
            try {
                const videoData = {
                    title,
                    trackNumber,
                    artist,
                    videoDiscId: currentVideoDiscId,
                    videoAlbumId: currentVideoAlbumId,
                    isFavorite: false,
                    createdAt: Date.now()
                };
                if (isUrlMode && urlInput.value) {
                    videoData.videoType = 'url';
                    videoData.videoSource = urlInput.value;
                } else if (fileInput.files[0]) {
                    videoData.videoType = 'file';
                    videoData.videoFile = fileInput.files[0];
                } else if (editingVideoId && videoDialogOriginalFile) {
                    videoData.videoType = 'file';
                    videoData.videoFile = videoDialogOriginalFile;
                }
                if (imageInput.files[0]) {
                    videoData.imageFile = imageInput.files[0];
                } else if (editingVideoId && videoDialogOriginalImage) {
                    videoData.imageFile = videoDialogOriginalImage;
                }
                if (editingVideoId) {
                    const updateData = { title, trackNumber, artist, updatedAt: Date.now() };
                    if (videoData.videoFile) updateData.videoFile = videoData.videoFile;
                    if (videoData.videoSource) {
                        updateData.videoType = videoData.videoType;
                        updateData.videoSource = videoData.videoSource;
                    }
                    if (videoData.imageFile) updateData.imageFile = videoData.imageFile;
                    await db.videos.update(editingVideoId, updateData);
                    showToast('视频更新成功');
                } else {
                    await db.videos.add(videoData);
                    showToast('视频添加成功');
                }
                closeAllDialogs();
                renderVideos(currentVideoDiscId);
            } catch (error) {
                console.error('保存失败:', error);
                showToast('保存失败: ' + error.message);
            }
            isVideoDialogSubmitting = false;
        }

        async function toggleVideoFavorite(videoId) {
            const video = await db.videos.get(videoId);
            const newFavoriteState = !video.isFavorite;
            await db.videos.update(videoId, { isFavorite: newFavoriteState ? 1 : 0 });
            showToast(newFavoriteState ? '已添加到我喜欢' : '已取消收藏');
            renderVideos(currentVideoDiscId);
            updateVideoFavoritesCount();
        }

        async function addVideoToPlaylist(videoId) {
            const playlists = await db.videoPlaylists.toArray();
            if (playlists.length === 0) {
                if (await showConfirm('创建播放列表', '还没有视频播放列表，是否创建一个新的？')) {
                    const name = prompt('请输入播放列表名称：');
                    if (name && name.trim()) {
                        const playlistId = await db.videoPlaylists.add({ name: name.trim(), createdAt: Date.now() });
                        await db.videoPlaylistItems.add({ videoPlaylistId: playlistId, videoId, createdAt: Date.now() });
                        showToast('已添加到播放列表');
                    }
                }
                return;
            }
            const choice = prompt(`选择播放列表（输入序号）：\n${playlists.map((p, i) => `${i + 1}. ${p.name}`).join('\n')}`);
            if (choice) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < playlists.length) {
                    const existing = await db.videoPlaylistItems.where({ videoPlaylistId: playlists[index].id, videoId }).first();
                    if (existing) {
                        showToast('该视频已在播放列表中');
                        return;
                    }
                    await db.videoPlaylistItems.add({ videoPlaylistId: playlists[index].id, videoId, createdAt: Date.now() });
                    showToast(`已添加到"${playlists[index].name}"`);
                }
            }
        }

        async function deleteVideoWithUndo(id, title) {
            const videoPlayer = document.getElementById('video-player');
            const videoPlayerView = document.getElementById('video-player-view');
            const currentPlayingId = parseInt(videoPlayerView?.dataset?.currentVideoId);
            
            if (currentPlayingId === id && videoPlayer) {
                videoPlayer.pause();
            }
            
            const video = await db.videos.get(id);
            if (!video) return;
            
            await db.videos.delete(id);
            showToastWithUndo(`已删除"${title}"`, async () => {
                await db.videos.add(video);
                renderVideos(currentVideoDiscId);
                showToast('已恢复删除的视频');
            });
            renderVideos(currentVideoDiscId);
        }

        async function playVideo(videoId) {
            try {
                const video = await db.videos.get(videoId);
                if (!video) {
                    showToast('视频不存在');
                    return;
                }
                const videoPlayerView = document.getElementById('video-player-view');
                const videoPlayer = document.getElementById('video-player');
                
                videoPlayerView.dataset.currentVideoId = videoId;
                localStorage.setItem('lastPlayedVideoId', videoId);
                if (video.videoAlbumId) localStorage.setItem('lastPlayedVideoAlbumId', video.videoAlbumId);
                if (video.videoDiscId) localStorage.setItem('lastPlayedVideoDiscId', video.videoDiscId);
                
                if (video.videoType === 'url' && video.videoSource) {
                    videoPlayer.src = video.videoSource;
                } else if (video.videoFile) {
                    const url = URL.createObjectURL(video.videoFile);
                    tempObjectURLs.push(url);
                    videoPlayer.src = url;
                } else {
                    showToast('视频源不存在');
                    return;
                }
                
                document.getElementById('video-title-display').textContent = video.title;
                videoPlayerPreviousView = 'video-disc-detail-view';
                
                await recordPlayHistory('video', videoId);
                
                navigateTo('video-player-view');
                await videoPlayer.play();
                initVideoPlayerControls();
            } catch (err) {
                console.error('播放失败:', err);
                showToast('播放失败: ' + err.message);
            }
        }

        let videoPlayerControlsInitialized = false;
        
        function initVideoPlayerControls() {
            if (videoPlayerControlsInitialized) return;
            videoPlayerControlsInitialized = true;
            
            const videoPlayer = document.getElementById('video-player');
            const overlay = document.getElementById('video-overlay');
            const progressBar = document.getElementById('video-progress-bar');
            const progressCurrent = document.getElementById('video-progress-current');
            const progressBuffered = document.getElementById('video-progress-buffered');
            const progressThumb = document.getElementById('video-progress-thumb');
            const currentTimeEl = document.getElementById('video-current-time');
            const durationTimeEl = document.getElementById('video-duration-time');
            const playPauseBtn = document.getElementById('video-play-pause-btn');
            const centerPlayBtn = document.getElementById('video-center-play-btn');
            const rewindBtn = document.getElementById('video-rewind-btn');
            const forwardBtn = document.getElementById('video-forward-btn');
            const gestureHint = document.getElementById('video-gesture-hint');
            const speedButtons = document.querySelectorAll('#speed-buttons button');
            const pipBtn = document.getElementById('video-pip-btn');
            const fullscreenBtn = document.getElementById('video-fullscreen-btn');
            const videoContainer = document.getElementById('video-container');
            
            let hideOverlayTimeout;
            let longPressInterval;
            let isLongPress = false;
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTime = 0;
            let isSeeking = false;
            let isVolumeAdjusting = false;
            let initialVolume = 0;
            
            function showOverlay() {
                overlay.classList.add('visible');
                clearTimeout(hideOverlayTimeout);
                hideOverlayTimeout = setTimeout(() => {
                    if (!videoPlayer.paused) {
                        overlay.classList.remove('visible');
                    }
                }, 3000);
            }
            
            function updateProgress() {
                const percent = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                progressCurrent.style.width = percent + '%';
                progressThumb.style.left = percent + '%';
                currentTimeEl.textContent = formatTime(videoPlayer.currentTime);
            }
            
            function updateBuffered() {
                if (videoPlayer.buffered.length > 0) {
                    const bufferedEnd = videoPlayer.buffered.end(videoPlayer.buffered.length - 1);
                    const percent = (bufferedEnd / videoPlayer.duration) * 100;
                    progressBuffered.style.width = percent + '%';
                }
            }
            
            function togglePlay() {
                if (videoPlayer.paused) {
                    videoPlayer.play();
                    playPauseBtn.textContent = '⏸';
                    centerPlayBtn.textContent = '⏸';
                } else {
                    videoPlayer.pause();
                    playPauseBtn.textContent = '▶';
                    centerPlayBtn.textContent = '▶';
                }
            }
            
            function showGestureHint(text) {
                gestureHint.textContent = text;
                gestureHint.classList.add('visible');
            }
            
            function hideGestureHint() {
                gestureHint.classList.remove('visible');
            }
            
            videoPlayer.addEventListener('timeupdate', updateProgress);
            videoPlayer.addEventListener('progress', updateBuffered);
            videoPlayer.addEventListener('loadedmetadata', () => {
                durationTimeEl.textContent = formatTime(videoPlayer.duration);
            });
            videoPlayer.addEventListener('ended', () => {
                playPauseBtn.textContent = '▶';
                centerPlayBtn.textContent = '▶';
            });
            
            overlay.addEventListener('click', (e) => {
                if (e.target.closest('.video-center-btn')) {
                    return;
                }
                if (e.target === overlay) {
                    if (!isLongPress) {
                        showOverlay();
                    }
                }
            });
            
            playPauseBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                togglePlay();
            });
            centerPlayBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                togglePlay();
            });
            
            function startFastForward(direction) {
                isLongPress = true;
                const speed = direction === 'forward' ? 5 : -5;
                longPressInterval = setInterval(() => {
                    videoPlayer.currentTime = Math.max(0, Math.min(videoPlayer.duration, videoPlayer.currentTime + speed));
                    const hint = direction === 'forward' ? `⏩ +5s (${formatTime(videoPlayer.currentTime)})` : `⏪ -5s (${formatTime(videoPlayer.currentTime)})`;
                    showGestureHint(hint);
                }, 200);
            }
            
            function stopFastForward() {
                isLongPress = false;
                clearInterval(longPressInterval);
                hideGestureHint();
            }
            
            rewindBtn.addEventListener('mousedown', () => startFastForward('rewind'));
            rewindBtn.addEventListener('mouseup', stopFastForward);
            rewindBtn.addEventListener('mouseleave', stopFastForward);
            rewindBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startFastForward('rewind'); });
            rewindBtn.addEventListener('touchend', stopFastForward);
            
            forwardBtn.addEventListener('mousedown', () => startFastForward('forward'));
            forwardBtn.addEventListener('mouseup', stopFastForward);
            forwardBtn.addEventListener('mouseleave', stopFastForward);
            forwardBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startFastForward('forward'); });
            forwardBtn.addEventListener('touchend', stopFastForward);
            
            progressBar.addEventListener('click', (e) => {
                const rect = progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                videoPlayer.currentTime = percent * videoPlayer.duration;
            });
            
            speedButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const speed = parseFloat(btn.dataset.speed);
                    videoPlayer.playbackRate = speed;
                    speedButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    showToast(`播放速度: ${speed}x`);
                });
            });
            
            pipBtn?.addEventListener('click', async () => {
                try {
                    if (document.pictureInPictureElement) {
                        await document.exitPictureInPicture();
                    } else if (document.pictureInPictureEnabled) {
                        await videoPlayer.requestPictureInPicture();
                    }
                } catch (err) {
                    showToast('画中画不可用');
                }
            });
            
            fullscreenBtn?.addEventListener('click', () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    document.getElementById('video-player-view').requestFullscreen();
                }
            });
            
            videoContainer?.addEventListener('touchstart', (e) => {
                if (e.target.closest('.video-center-controls, .video-bottom-controls')) return;
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchStartTime = videoPlayer.currentTime;
                initialVolume = videoPlayer.volume;
                isSeeking = false;
                isVolumeAdjusting = false;
            }, { passive: true });
            
            videoContainer?.addEventListener('touchmove', (e) => {
                if (e.target.closest('.video-center-controls, .video-bottom-controls')) return;
                
                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;
                const deltaX = touchX - touchStartX;
                const deltaY = touchY - touchStartY;
                
                if (Math.abs(deltaX) > 20 && Math.abs(deltaX) > Math.abs(deltaY)) {
                    isSeeking = true;
                    const containerRect = videoContainer.getBoundingClientRect();
                    const seekAmount = (deltaX / containerRect.width) * 60;
                    const newTime = Math.max(0, Math.min(videoPlayer.duration || 0, touchStartTime + seekAmount));
                    showGestureHint(`⏩ ${seekAmount > 0 ? '+' : ''}${Math.round(seekAmount)}s`);
                } else if (Math.abs(deltaY) > 20 && Math.abs(deltaY) > Math.abs(deltaX)) {
                    isVolumeAdjusting = true;
                    const containerRect = videoContainer.getBoundingClientRect();
                    const volumeChange = -deltaY / containerRect.height;
                    const newVolume = Math.max(0, Math.min(1, initialVolume + volumeChange));
                    videoPlayer.volume = newVolume;
                    showGestureHint(`🔊 ${Math.round(newVolume * 100)}%`);
                }
            }, { passive: true });
            
            videoContainer?.addEventListener('touchend', (e) => {
                if (isSeeking) {
                    const touch = e.changedTouches[0];
                    const deltaX = touch.clientX - touchStartX;
                    const containerRect = videoContainer.getBoundingClientRect();
                    const seekAmount = (deltaX / containerRect.width) * 60;
                    const newTime = Math.max(0, Math.min(videoPlayer.duration || 0, touchStartTime + seekAmount));
                    videoPlayer.currentTime = newTime;
                    hideGestureHint();
                }
                isSeeking = false;
                isVolumeAdjusting = false;
            }, { passive: true });
            
            let lastTapTime = 0;
            videoContainer?.addEventListener('click', (e) => {
                if (e.target.closest('.video-center-controls, .video-bottom-controls')) return;
                
                const currentTime = Date.now();
                const tapLength = currentTime - lastTapTime;
                
                if (tapLength < 300 && tapLength > 0) {
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        document.getElementById('video-player-view').requestFullscreen();
                    }
                    lastTapTime = 0;
                } else {
                    lastTapTime = currentTime;
                    setTimeout(() => {
                        if (Date.now() - lastTapTime >= 300) {
                            togglePlay();
                        }
                    }, 300);
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (document.getElementById('video-player-view').classList.contains('active')) {
                    switch(e.code) {
                        case 'Space':
                            e.preventDefault();
                            togglePlay();
                            break;
                        case 'ArrowLeft':
                            videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 10);
                            showGestureHint('⏪ -10s');
                            setTimeout(hideGestureHint, 500);
                            break;
                        case 'ArrowRight':
                            videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 10);
                            showGestureHint('⏩ +10s');
                            setTimeout(hideGestureHint, 500);
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            videoPlayer.volume = Math.min(1, videoPlayer.volume + 0.1);
                            showGestureHint(`🔊 ${Math.round(videoPlayer.volume * 100)}%`);
                            setTimeout(hideGestureHint, 500);
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            videoPlayer.volume = Math.max(0, videoPlayer.volume - 0.1);
                            showGestureHint(`🔊 ${Math.round(videoPlayer.volume * 100)}%`);
                            setTimeout(hideGestureHint, 500);
                            break;
                        case 'KeyF':
                            e.preventDefault();
                            if (document.fullscreenElement) {
                                document.exitFullscreen();
                            } else {
                                document.getElementById('video-player-view').requestFullscreen();
                            }
                            break;
                        case 'KeyM':
                            e.preventDefault();
                            videoPlayer.muted = !videoPlayer.muted;
                            showGestureHint(videoPlayer.muted ? '🔇 已静音' : '🔊 已取消静音');
                            setTimeout(hideGestureHint, 500);
                            break;
                        case 'Escape':
                            if (document.fullscreenElement) {
                                document.exitFullscreen();
                            }
                            break;
                    }
                }
            });
        }

        function setupAudioKeyboardControls() {
            const audioPlayer = document.getElementById('audio-player');
            
            document.addEventListener('keydown', (e) => {
                const playerView = document.getElementById('player-view');
                if (!playerView?.classList.contains('active')) return;
                
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    return;
                }
                
                switch(e.code) {
                    case 'Space':
                        e.preventDefault();
                        if (audioPlayer.paused) {
                            audioPlayer.play();
                            showToast('▶ 播放');
                        } else {
                            audioPlayer.pause();
                            showToast('⏸ 暂停');
                        }
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                        showToast(`⏪ -5s`);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        audioPlayer.currentTime = Math.min(audioPlayer.duration || 0, audioPlayer.currentTime + 5);
                        showToast(`⏩ +5s`);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        audioPlayer.volume = Math.min(1, audioPlayer.volume + 0.1);
                        showToast(`🔊 ${Math.round(audioPlayer.volume * 100)}%`);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        audioPlayer.volume = Math.max(0, audioPlayer.volume - 0.1);
                        showToast(`🔊 ${Math.round(audioPlayer.volume * 100)}%`);
                        break;
                    case 'KeyM':
                        e.preventDefault();
                        audioPlayer.muted = !audioPlayer.muted;
                        showToast(audioPlayer.muted ? '🔇 已静音' : '🔊 已取消静音');
                        break;
                    case 'KeyP':
                    case 'MediaTrackPrevious':
                        e.preventDefault();
                        document.getElementById('prev-btn')?.click();
                        break;
                    case 'KeyN':
                    case 'MediaTrackNext':
                        e.preventDefault();
                        document.getElementById('next-btn')?.click();
                        break;
                    case 'KeyR':
                        e.preventDefault();
                        const playModeBtn = document.getElementById('play-mode-btn');
                        playModeBtn?.click();
                        break;
                    case 'KeyL':
                        e.preventDefault();
                        openFullLyricsModal();
                        break;
                }
            });
            
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', () => {
                    audioPlayer.play();
                });
                navigator.mediaSession.setActionHandler('pause', () => {
                    audioPlayer.pause();
                });
                navigator.mediaSession.setActionHandler('previoustrack', () => {
                    document.getElementById('prev-btn')?.click();
                });
                navigator.mediaSession.setActionHandler('nexttrack', () => {
                    document.getElementById('next-btn')?.click();
                });
                navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                    audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - (details.seekOffset || 10));
                });
                navigator.mediaSession.setActionHandler('seekforward', (details) => {
                    audioPlayer.currentTime = Math.min(audioPlayer.duration || 0, audioPlayer.currentTime + (details.seekOffset || 10));
                });
            }
        }

        async function getSiblingVideoId(currentId, direction) {
            const video = await db.videos.get(currentId);
            if (!video) return null;
            const videos = await db.videos.where('videoDiscId').equals(video.videoDiscId).toArray();
            const currentIndex = videos.findIndex(v => v.id === currentId);
            if (currentIndex === -1) return null;
            if (direction === 'next') return videos[(currentIndex + 1) % videos.length]?.id;
            else return videos[(currentIndex - 1 + videos.length) % videos.length]?.id;
        }

        async function updateVideoFavoritesCount() {
            const allVideos = await db.videos.toArray();
            const count = allVideos.filter(v => v.isFavorite).length;
            const countEl = document.getElementById('video-favorites-count');
            if (countEl) countEl.textContent = `${count} 个视频`;
        }

        async function renderVideoPlaylists() {
            const playlistsList = document.getElementById('video-playlists-list');
            const playlists = await db.videoPlaylists.toArray();
            playlistsList.innerHTML = '';
            
            const allVideos = await db.videos.toArray();
            const favCount = allVideos.filter(v => v.isFavorite).length;
            const favCountEl = document.getElementById('video-favorites-count');
            if (favCountEl) favCountEl.textContent = `${favCount} 个视频`;
            
            for (const playlist of playlists) {
                const itemCount = await db.videoPlaylistItems.where('videoPlaylistId').equals(playlist.id).count();
                const item = document.createElement('div');
                item.className = 'audio-item';
                item.dataset.id = playlist.id;
                item.innerHTML = `
                    <div class="audio-cover" style="background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 99, 102, 241), 0.3), rgba(var(--btn-color-rgb, 99, 102, 241), 0.1)); display: flex; align-items: center; justify-content: center; font-size: 24px;">🎞️</div>
                    <div class="audio-info">
                        <div class="audio-title">${playlist.name}</div>
                        <div class="audio-meta">${itemCount} 个视频</div>
                    </div>
                    <div class="audio-actions">
                        <button class="audio-action-btn" data-action="delete" title="删除" style="color:#ff4444;">🗑️</button>
                    </div>
                `;
                item.querySelector('.audio-info').addEventListener('click', () => openVideoPlaylistDetail(playlist.id, playlist.name));
                item.querySelector('[data-action="delete"]').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (await showConfirm('删除播放列表', `确定删除播放列表"${playlist.name}"吗？`)) {
                        await db.videoPlaylistItems.where('videoPlaylistId').equals(playlist.id).delete();
                        await db.videoPlaylists.delete(playlist.id);
                        showToast('播放列表已删除');
                        renderVideoPlaylists();
                    }
                });
                playlistsList.appendChild(item);
            }
        }

        async function openVideoPlaylistDetail(playlistId, playlistName) {
            document.getElementById('video-playlist-detail-title').textContent = playlistName;
            const videoList = document.getElementById('video-playlist-video-list');
            const emptyTip = document.getElementById('video-playlist-empty-tip');
            
            const items = await db.videoPlaylistItems.where('videoPlaylistId').equals(playlistId).toArray();
            videoList.innerHTML = '';
            
            if (items.length === 0) {
                emptyTip.style.display = 'block';
            } else {
                emptyTip.style.display = 'none';
                for (const item of items) {
                    const video = await db.videos.get(item.videoId);
                    if (!video) continue;
                    
                    const videoItem = document.createElement('div');
                    videoItem.className = 'audio-item';
                    videoItem.dataset.id = video.id;
                    let coverUrl = defaultCover;
                    if (video.imageFile) {
                        coverUrl = URL.createObjectURL(video.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                    
                    videoItem.innerHTML = `
                        <img class="audio-cover" src="${coverUrl}" alt="cover">
                        <div class="audio-info">
                            <div class="audio-title">${video.title}</div>
                            <div class="audio-meta">${video.duration ? formatTime(video.duration) : '未知时长'}${video.artist ? ' - ' + video.artist : ''}</div>
                        </div>
                        <div class="audio-actions">
                            <button class="audio-action-btn play-btn" data-action="play" title="播放">▶</button>
                            <button class="audio-action-btn" data-action="remove" title="从列表移除" style="color:#ff9800;">✕</button>
                        </div>
                    `;
                    
                    videoItem.querySelector('.audio-info').addEventListener('click', () => playVideo(video.id));
                    videoItem.querySelector('[data-action="play"]').addEventListener('click', () => playVideo(video.id));
                    videoItem.querySelector('[data-action="remove"]').addEventListener('click', async () => {
                        await db.videoPlaylistItems.delete(item.id);
                        showToast('已从播放列表移除');
                        openVideoPlaylistDetail(playlistId, playlistName);
                    });
                    videoList.appendChild(videoItem);
                }
            }
            navigateTo('video-playlist-detail-view');
        }

        async function renderVideoFavorites() {
            const videoList = document.getElementById('video-favorites-list');
            const emptyTip = document.getElementById('video-favorites-empty-tip');
            
            const allVideos = await db.videos.toArray();
            const favorites = allVideos.filter(v => v.isFavorite);
            videoList.innerHTML = '';
            
            if (favorites.length === 0) {
                emptyTip.style.display = 'block';
            } else {
                emptyTip.style.display = 'none';
                for (const video of favorites) {
                    const item = document.createElement('div');
                    item.className = 'audio-item';
                    item.dataset.id = video.id;
                    let coverUrl = defaultCover;
                    if (video.imageFile) {
                        coverUrl = URL.createObjectURL(video.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                    
                    item.innerHTML = `
                        <img class="audio-cover" src="${coverUrl}" alt="cover">
                        <div class="audio-info">
                            <div class="audio-title">${video.title}</div>
                            <div class="audio-meta">${video.duration ? formatTime(video.duration) : '未知时长'}${video.artist ? ' - ' + video.artist : ''}</div>
                        </div>
                        <div class="audio-actions">
                            <button class="audio-action-btn play-btn" data-action="play" title="播放">▶</button>
                            <button class="audio-action-btn favorite active" data-action="favorite" title="取消收藏">❤️</button>
                        </div>
                    `;
                    
                    item.querySelector('.audio-info').addEventListener('click', () => playVideo(video.id));
                    item.querySelector('[data-action="play"]').addEventListener('click', () => playVideo(video.id));
                    item.querySelector('[data-action="favorite"]').addEventListener('click', async () => {
                        await db.videos.update(video.id, { isFavorite: 0 });
                        showToast('已取消收藏');
                        renderVideoFavorites();
                        updateVideoFavoritesCount();
                    });
                    videoList.appendChild(item);
                }
            }
        }

        async function createVideoPlaylist() {
            const name = prompt('请输入视频播放列表名称：');
            if (name && name.trim()) {
                await db.videoPlaylists.add({ name: name.trim(), createdAt: Date.now() });
                showToast('视频播放列表创建成功');
                renderVideoPlaylists();
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || !isFinite(seconds)) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function showToast(message, duration = 2000) {
            const toast = document.createElement('div');
            toast.className = 'toast-animate';
            toast.style.cssText = `position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.2);border-radius:16px;padding:14px 28px;color:var(--text-primary);z-index:9999;font-size:14px;box-shadow:0 8px 32px rgba(0,0,0,0.3),inset 0 1px 0 rgba(255,255,255,0.1);`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { 
                toast.classList.remove('toast-animate');
                toast.classList.add('toast-animate-out');
                setTimeout(() => toast.remove(), 300); 
            }, duration);
        }

        function showToastWithUndo(message, undoCallback, duration = 5000) {
            const toast = document.createElement('div');
            toast.className = 'toast-animate';
            toast.style.cssText = `position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.2);border-radius:16px;padding:14px 28px;color:var(--text-primary);z-index:9999;font-size:14px;box-shadow:0 8px 32px rgba(0,0,0,0.3),inset 0 1px 0 rgba(255,255,255,0.1);`;
            toast.innerHTML = `<span>${message}</span><button class="toast-undo-btn" style="margin-left:15px;background:var(--accent-color);color:white;border:none;padding:6px 14px;border-radius:8px;cursor:pointer;font-size:12px;transition:transform 0.2s;">撤销</button>`;
            const undoBtn = toast.querySelector('.toast-undo-btn');
            undoBtn.addEventListener('click', () => {
                undoCallback();
                toast.remove();
            });
            document.body.appendChild(toast);
            setTimeout(() => { 
                toast.classList.remove('toast-animate');
                toast.classList.add('toast-animate-out');
                setTimeout(() => toast.remove(), 300); 
            }, duration);
        }

        function showConfirm(title, message) {
            return new Promise((resolve) => {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                document.getElementById('confirm-dialog').classList.add('active');
                
                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                
                const handleOk = () => {
                    document.getElementById('confirm-dialog').classList.remove('active');
                    resolve(true);
                    cleanup();
                };
                
                const handleCancel = () => {
                    document.getElementById('confirm-dialog').classList.remove('active');
                    resolve(false);
                    cleanup();
                };
                
                const cleanup = () => {
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                };
                
                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('desktop-time').textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('desktop-date').textContent = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });
        }

        async function renderUI() {
            const sidebarNav = document.getElementById('sidebar-nav');
            let appConfig = await db.settings.get('appConfig');
            let config = appConfig?.value || defaultAppConfig;
            
            const defaultIds = defaultAppConfig.map(a => a.id);
            const existingIds = config.map(a => a.id);
            
            const validConfig = config.filter(app => defaultIds.includes(app.id));
            const missingApps = defaultAppConfig.filter(a => !existingIds.includes(a.id));
            
            if (missingApps.length > 0 || validConfig.length !== config.length) {
                config = [...validConfig, ...missingApps];
                await db.settings.put({ key: 'appConfig', value: config });
            }
            
            sidebarNav.innerHTML = '';
            config.forEach(app => {
                const item = document.createElement('div');
                item.className = 'sidebar-item';
                item.dataset.target = app.target;
                
                let iconContent = app.icon || '📁';
                if (app.icon && app.icon.startsWith('data:')) {
                    iconContent = '';
                }
                
                item.innerHTML = `
                    <div class="sidebar-item-icon" style="${app.icon && app.icon.startsWith('data:') ? `background-image: url(${app.icon}); background-size: cover;` : ''}">${iconContent}</div>
                    <span class="sidebar-item-text">${app.name}</span>
                `;
                
                item.addEventListener('click', () => {
                    document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    navigateTo(app.target);
                    closeSidebar();
                });
                
                sidebarNav.appendChild(item);
            });
            
            await renderRecentPlay();
            await renderStats();
            initQuickActions();
        }

        async function renderStats() {
            const audioCount = await db.audios.count();
            const videoCount = await db.videos.count();
            const playCount = await db.playHistory.count();
            
            document.getElementById('stat-audios').textContent = audioCount;
            document.getElementById('stat-videos').textContent = videoCount;
            document.getElementById('stat-plays').textContent = playCount;
        }

        function initQuickActions() {
            document.querySelectorAll('.quick-action-card').forEach(card => {
                card.addEventListener('click', async () => {
                    const action = card.dataset.action;
                    switch(action) {
                        case 'random-play':
                            await randomPlay();
                            break;
                        case 'add-media':
                            navigateTo('albums-view');
                            break;
                        case 'favorites':
                            navigateTo('favorites-view');
                            break;
                        case 'sleep-timer':
                            showSleepTimerDialog();
                            break;
                    }
                });
            });
        }

        async function randomPlay() {
            const audios = await db.audios.toArray();
            if (audios.length === 0) {
                showToast('没有可播放的音频');
                return;
            }
            const randomAudio = audios[Math.floor(Math.random() * audios.length)];
            await playAudio(randomAudio.id);
            showToast(`正在播放: ${randomAudio.title}`);
        }

        function showSleepTimerDialog() {
            const minutes = prompt('请输入睡眠定时时间（分钟）：', '30');
            if (minutes && !isNaN(minutes) && parseInt(minutes) > 0) {
                setSleepTimer(parseInt(minutes));
            }
        }
        
        function setSleepTimer(minutes) {
            clearSleepTimer();
            
            const ms = minutes * 60 * 1000;
            sleepEndTime = Date.now() + ms;
            
            sleepTimerId = setTimeout(() => {
                executeSleepTimer();
            }, ms);
            
            startSleepCountdown();
            showSleepTimerBar();
            showToast(`已设置 ${minutes} 分钟后自动停止`);
        }
        
        function startSleepCountdown() {
            const countdownEl = document.getElementById('sleep-timer-countdown');
            
            sleepCountdownId = setInterval(() => {
                if (!sleepEndTime) {
                    clearSleepTimer();
                    return;
                }
                
                const remaining = sleepEndTime - Date.now();
                if (remaining <= 0) {
                    clearSleepTimer();
                    return;
                }
                
                const mins = Math.floor(remaining / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);
                countdownEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function showSleepTimerBar() {
            const bar = document.getElementById('sleep-timer-bar');
            bar.classList.add('visible');
        }
        
        function hideSleepTimerBar() {
            const bar = document.getElementById('sleep-timer-bar');
            bar.classList.remove('visible');
        }
        
        function clearSleepTimer() {
            if (sleepTimerId) {
                clearTimeout(sleepTimerId);
                sleepTimerId = null;
            }
            if (sleepCountdownId) {
                clearInterval(sleepCountdownId);
                sleepCountdownId = null;
            }
            sleepEndTime = null;
            stopAtSongEnd = false;
            hideSleepTimerBar();
        }
        
        function executeSleepTimer() {
            if (audioPlayer) {
                audioPlayer.pause();
            }
            if (videoPlayer) {
                videoPlayer.pause();
            }
            clearSleepTimer();
            showToast('睡眠定时已到，播放已停止');
        }

        async function renderRecentPlay() {
            const recentList = document.getElementById('recent-play-list');
            const recentSection = document.getElementById('recent-play-section');
            if (!recentList) return;
            
            recentList.innerHTML = '';
            
            const history = await db.playHistory.orderBy('playedAt').reverse().limit(10).toArray();
            
            if (history.length === 0) {
                recentSection.style.display = 'none';
                return;
            }
            
            recentSection.style.display = 'block';
            
            const seen = new Set();
            for (const item of history) {
                if (seen.has(`${item.mediaType}-${item.mediaId}`)) continue;
                seen.add(`${item.mediaType}-${item.mediaId}`);
                
                let mediaData = null;
                let coverUrl = defaultCover;
                
                if (item.mediaType === 'audio') {
                    mediaData = await db.audios.get(item.mediaId);
                    if (mediaData?.imageFile) {
                        coverUrl = URL.createObjectURL(mediaData.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                } else if (item.mediaType === 'video') {
                    mediaData = await db.videos.get(item.mediaId);
                    if (mediaData?.imageFile) {
                        coverUrl = URL.createObjectURL(mediaData.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                }
                
                if (!mediaData) continue;
                
                const recentItem = document.createElement('div');
                recentItem.className = 'recent-item';
                recentItem.innerHTML = `
                    <img class="recent-item-cover" src="${coverUrl}" alt="${mediaData.title}">
                    <div class="recent-item-title">${mediaData.title}</div>
                    <div class="recent-item-meta">${mediaData.artist || '未知艺术家'}</div>
                    <span class="recent-item-type">${item.mediaType === 'audio' ? '🎵 音频' : '🎬 视频'}</span>
                `;
                
                recentItem.addEventListener('click', async () => {
                    if (item.mediaType === 'audio') {
                        await playAudio(item.mediaId);
                    } else if (item.mediaType === 'video') {
                        await playVideo(item.mediaId);
                    }
                });
                
                recentList.appendChild(recentItem);
                
                if (recentList.children.length >= 6) break;
            }
            
            if (recentList.children.length === 0) {
                recentSection.style.display = 'none';
            }
        }

        let currentMediaFilter = 'all';
        
        async function renderAlbums() {
            const albumsGrid = document.getElementById('albums-grid');
            const emptyTip = document.getElementById('album-empty-tip');
            
            const audioAlbums = await db.albums.toArray();
            const videoAlbums = await db.videoAlbums.toArray();
            
            const allAlbums = [
                ...audioAlbums.map(a => ({ ...a, mediaType: 'audio' })),
                ...videoAlbums.map(a => ({ ...a, mediaType: 'video' }))
            ].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            
            const filteredAlbums = currentMediaFilter === 'all' 
                ? allAlbums 
                : allAlbums.filter(a => a.mediaType === currentMediaFilter);
            
            albumsGrid.innerHTML = '';
            
            if (filteredAlbums.length === 0) {
                emptyTip.style.display = 'block';
                return;
            }
            emptyTip.style.display = 'none';
            
            for (const album of filteredAlbums) {
                let discCount = 0;
                if (album.mediaType === 'audio') {
                    discCount = await db.discs.where('albumId').equals(album.id).count();
                } else {
                    discCount = await db.videoDiscs.where('videoAlbumId').equals(album.id).count();
                }
                
                const item = document.createElement('div');
                item.className = 'album-item';
                item.dataset.id = album.id;
                item.dataset.type = album.mediaType;
                
                let coverStyle = '';
                if (album.cover) {
                    const url = URL.createObjectURL(album.cover);
                    tempObjectURLs.push(url);
                    coverStyle = `background-image: url(${url});`;
                }
                
                item.innerHTML = `
                    <span class="album-item-media-type ${album.mediaType}">${album.mediaType === 'audio' ? '🎵' : '🎬'}</span>
                    <div class="album-actions">
                        <button class="album-action-btn album-edit-btn" data-action="edit" title="编辑">✏️</button>
                        <button class="album-action-btn album-delete-btn" data-action="delete" title="删除">🗑️</button>
                    </div>
                    <div class="album-icon" style="${coverStyle}">${album.cover ? '' : (album.mediaType === 'audio' ? '💿' : '📀')}</div>
                    <div class="album-name">${album.name}</div>
                    <div class="album-count">${discCount} 个${album.mediaType === 'audio' ? 'Disc' : '视频盘'}</div>
                `;
                
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.album-actions')) {
                        const action = e.target.closest('.album-action-btn').dataset.action;
                        if (action === 'edit') {
                            if (album.mediaType === 'audio') {
                                openEditAlbumDialog(album);
                            } else {
                                openEditVideoAlbumDialog(album);
                            }
                        } else if (action === 'delete') {
                            if (album.mediaType === 'audio') {
                                deleteAlbum(album.id, album.name);
                            } else {
                                deleteVideoAlbum(album.id, album.name);
                            }
                        }
                    } else {
                        if (album.mediaType === 'audio') {
                            currentAlbumId = album.id;
                            renderDiscDetail(album.id, album.name);
                        } else {
                            currentVideoAlbumId = album.id;
                            renderVideoDiscDetail(album.id, album.name);
                        }
                    }
                });
                
                albumsGrid.appendChild(item);
            }
        }

        function initMediaTabs() {
            document.querySelectorAll('.media-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.media-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentMediaFilter = tab.dataset.type;
                    renderAlbums();
                });
            });
        }

        async function deleteVideoAlbum(albumId, albumName) {
            if (await showConfirm('删除视频专辑', `确定要删除"${albumName}"吗？此操作不可恢复。`)) {
                await db.videoAlbums.delete(albumId);
                showToast(`已删除"${albumName}"`);
                renderAlbums();
            }
        }

        async function openEditVideoAlbumDialog(album) {
            const result = await showInputDialog('编辑视频专辑', '输入新名称', album.name);
            if (result && result.trim()) {
                await db.videoAlbums.update(album.id, { name: result.trim() });
                showToast('专辑名称已更新');
                renderAlbums();
            }
        }

        async function renderDiscDetail(albumId, albumName) {
            document.getElementById('disc-album-title').textContent = albumName;
            const discList = document.getElementById('disc-list');
            const audioList = document.getElementById('audio-list');
            const emptyTip = document.getElementById('disc-empty-tip');
            const batchBtn = document.getElementById('batch-mode-btn');
            const viewControls = document.querySelector('.view-controls');
            const discs = (await db.discs.where('albumId').equals(albumId).toArray()).sort((a, b) => (a.order || 0) - (b.order || 0));
            discList.innerHTML = '';
            audioList.innerHTML = '';
            
            if (discs.length === 0) {
                emptyTip.style.display = 'block';
                viewControls.style.display = 'none';
                currentDiscId = null;
                batchBtn.style.display = 'none';
                audioList.innerHTML = `
                    <div style="text-align:center;color:var(--text-secondary);padding:40px 20px;">
                        <div style="font-size:48px;margin-bottom:15px;">📀</div>
                        <p>请先创建Disc后再添加音频</p>
                        <p style="font-size:12px;margin-top:10px;opacity:0.7;">点击右上角"+"按钮创建Disc</p>
                    </div>
                `;
                navigateTo('disc-detail-view');
                return;
            }
            
            emptyTip.style.display = 'none';
            viewControls.style.display = 'flex';
            batchBtn.style.display = currentViewMode === 'disc' ? 'block' : 'none';
            
            if (currentViewMode === 'disc') {
                discList.style.display = 'flex';
                if (!currentDiscId || !discs.find(d => d.id === currentDiscId)) {
                    currentDiscId = discs[0].id;
                }
            } else {
                discList.style.display = 'none';
            }
            
            for (const disc of discs) {
                const item = document.createElement('div');
                item.className = 'disc-item' + (disc.id === currentDiscId ? ' selected' : '');
                item.dataset.id = disc.id;
                item.draggable = true;
                let coverStyle = '';
                if (disc.cover) {
                    const url = URL.createObjectURL(disc.cover);
                    tempObjectURLs.push(url);
                    coverStyle = `background-image: url(${url}); background-size: cover;`;
                }
                item.innerHTML = `
                    <div class="disc-actions">
                        <button class="album-action-btn album-edit-btn" data-action="edit" title="编辑">✏️</button>
                        <button class="album-action-btn album-delete-btn" data-action="delete" title="删除">🗑️</button>
                    </div>
                    <div class="disc-icon" style="${coverStyle}">${disc.cover ? '' : '📀'}</div>
                    <div class="disc-name">${disc.name}</div>
                `;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.disc-actions')) {
                        const action = e.target.closest('.album-action-btn').dataset.action;
                        if (action === 'edit') openEditDiscDialog(disc);
                        else if (action === 'delete') deleteDisc(disc.id, disc.name);
                    } else {
                        currentDiscId = disc.id;
                        batchMode = false;
                        selectedAudios.clear();
                        updateBatchToolbar();
                        renderDiscDetail(albumId, albumName);
                    }
                });
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', disc.id);
                    e.dataTransfer.effectAllowed = 'move';
                });
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    document.querySelectorAll('.disc-item').forEach(el => el.classList.remove('drag-over'));
                });
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    item.classList.add('drag-over');
                });
                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                });
                item.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    const draggedId = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetId = disc.id;
                    if (draggedId !== targetId) {
                        const draggedIndex = discs.findIndex(d => d.id === draggedId);
                        const targetIndex = discs.findIndex(d => d.id === targetId);
                        const [removed] = discs.splice(draggedIndex, 1);
                        discs.splice(targetIndex, 0, removed);
                        for (let i = 0; i < discs.length; i++) {
                            await db.discs.update(discs[i].id, { order: i });
                        }
                        renderDiscDetail(albumId, albumName);
                    }
                });
                discList.appendChild(item);
            }
            
            if (currentViewMode === 'disc') {
                await renderAudios(currentDiscId);
            } else {
                await renderAllAudios(albumId, discs);
            }
            navigateTo('disc-detail-view');
        }

        async function renderAudios(discId) {
            const audioList = document.getElementById('audio-list');
            audioList.innerHTML = '';
            if (!discId) return;
            
            const audios = await db.audios.where('discId').equals(discId).toArray();
            
            if (audios.length === 0) {
                audioList.innerHTML = `
                    <div style="text-align:center;color:var(--text-secondary);padding:40px 20px;">
                        <div style="font-size:48px;margin-bottom:15px;">🎵</div>
                        <p>暂无音频</p>
                        <p style="font-size:12px;margin-top:10px;opacity:0.7;">点击下方按钮添加音频</p>
                    </div>
                `;
            } else {
                for (const audio of audios) {
                    const item = document.createElement('div');
                    item.className = 'audio-item' + (selectedAudios.has(audio.id) ? ' selected' : '');
                    item.dataset.id = audio.id;
                    let coverUrl = defaultCover;
                    if (audio.imageFile) {
                        coverUrl = URL.createObjectURL(audio.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                    
                    const checkboxHtml = batchMode ? `<input type="checkbox" class="audio-checkbox" ${selectedAudios.has(audio.id) ? 'checked' : ''}>` : '';
                    const trackInfo = audio.trackNumber ? `${audio.trackNumber}. ` : '';
                    const artistInfo = audio.artist ? ` - ${audio.artist}` : '';
                    
                    item.innerHTML = `
                        ${checkboxHtml}
                        <img class="audio-cover" src="${coverUrl}" alt="cover">
                        <div class="audio-info">
                            <div class="audio-title">${trackInfo}${audio.title}</div>
                            <div class="audio-meta">${audio.duration ? formatTime(audio.duration) : '未知时长'}${artistInfo}</div>
                        </div>
                        <div class="audio-actions">
                            <button class="audio-action-btn play-btn" data-action="play" title="播放">▶</button>
                            <button class="audio-action-btn" data-action="addQueue" title="添加到播放队列">📋</button>
                            <button class="audio-action-btn favorite ${audio.isFavorite ? 'active' : ''}" data-action="favorite" title="${audio.isFavorite ? '取消收藏' : '添加收藏'}">${audio.isFavorite ? '❤️' : '🤍'}</button>
                            <button class="audio-action-btn" data-action="addPlaylist" title="添加到播放列表">➕</button>
                            <button class="audio-action-btn" data-action="edit" title="编辑">✏️</button>
                            <button class="audio-action-btn" data-action="delete" title="删除" style="color:#ff4444;">🗑️</button>
                        </div>
                    `;
                    
                    if (batchMode) {
                        const checkbox = item.querySelector('.audio-checkbox');
                        checkbox.addEventListener('change', (e) => {
                            if (e.target.checked) {
                                selectedAudios.add(audio.id);
                            } else {
                                selectedAudios.delete(audio.id);
                            }
                            item.classList.toggle('selected', selectedAudios.has(audio.id));
                            updateBatchToolbar();
                        });
                        item.querySelector('.audio-info').addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (selectedAudios.has(audio.id)) {
                                selectedAudios.delete(audio.id);
                            } else {
                                selectedAudios.add(audio.id);
                            }
                            renderAudios(discId);
                            updateBatchToolbar();
                        });
                    } else {
                        item.querySelector('.audio-info').addEventListener('click', () => playAudio(audio.id));
                    }
                    
                    item.querySelectorAll('.audio-action-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const action = btn.dataset.action;
                            if (action === 'play') playAudio(audio.id);
                            else if (action === 'addQueue') await addToPlayQueue(audio.id, 'audio');
                            else if (action === 'favorite') await toggleFavorite(audio.id);
                            else if (action === 'addPlaylist') await addToPlaylist(audio.id);
                            else if (action === 'edit') openEditAudioDialog(audio);
                            else if (action === 'delete') deleteAudioWithUndo(audio.id, audio.title);
                        });
                    });
                    audioList.appendChild(item);
                }
            }
            
            const addBtn = document.createElement('button');
            addBtn.className = 'glass-button primary';
            addBtn.style.cssText = 'width:100%;margin-top:15px;';
            addBtn.textContent = '+ 添加音频';
            addBtn.addEventListener('click', () => openAddAudioDialog());
            audioList.appendChild(addBtn);
        }

        async function renderAllAudios(albumId, discs) {
            const audioList = document.getElementById('audio-list');
            audioList.innerHTML = '';
            
            let allAudios = [];
            for (const disc of discs) {
                const audios = await db.audios.where('discId').equals(disc.id).toArray();
                audios.forEach(a => a.discName = disc.name);
                allAudios = allAudios.concat(audios);
            }
            
            allAudios = sortAudios(allAudios);
            
            if (allAudios.length === 0) {
                audioList.innerHTML = `
                    <div style="text-align:center;color:var(--text-secondary);padding:40px 20px;">
                        <div style="font-size:48px;margin-bottom:15px;">🎵</div>
                        <p>暂无音频</p>
                    </div>
                `;
                return;
            }
            
            for (const audio of allAudios) {
                const item = document.createElement('div');
                item.className = 'audio-item';
                item.dataset.id = audio.id;
                let coverUrl = defaultCover;
                if (audio.imageFile) {
                    coverUrl = URL.createObjectURL(audio.imageFile);
                    tempObjectURLs.push(coverUrl);
                }
                
                const trackInfo = audio.trackNumber ? `${audio.trackNumber}. ` : '';
                const artistInfo = audio.artist ? ` - ${audio.artist}` : '';
                const discInfo = audio.discName ? `[${audio.discName}]` : '';
                
                item.innerHTML = `
                    <img class="audio-cover" src="${coverUrl}" alt="cover">
                    <div class="audio-info">
                        <div class="audio-title">${trackInfo}${audio.title}</div>
                        <div class="audio-meta">${discInfo} ${audio.duration ? formatTime(audio.duration) : '未知时长'}${artistInfo}</div>
                    </div>
                    <div class="audio-actions">
                        <button class="audio-action-btn play-btn" data-action="play" title="播放">▶</button>
                        <button class="audio-action-btn favorite ${audio.isFavorite ? 'active' : ''}" data-action="favorite" title="${audio.isFavorite ? '取消收藏' : '添加收藏'}">${audio.isFavorite ? '❤️' : '🤍'}</button>
                        <button class="audio-action-btn" data-action="addPlaylist" title="添加到播放列表">➕</button>
                        <button class="audio-action-btn" data-action="edit" title="编辑">✏️</button>
                        <button class="audio-action-btn" data-action="delete" title="删除" style="color:#ff4444;">🗑️</button>
                    </div>
                `;
                
                item.querySelector('.audio-info').addEventListener('click', () => playAudio(audio.id));
                
                item.querySelectorAll('.audio-action-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const action = btn.dataset.action;
                        if (action === 'play') playAudio(audio.id);
                        else if (action === 'favorite') await toggleFavorite(audio.id);
                        else if (action === 'addPlaylist') await addToPlaylist(audio.id);
                        else if (action === 'edit') openEditAudioDialog(audio);
                        else if (action === 'delete') deleteAudioWithUndo(audio.id, audio.title);
                    });
                });
                audioList.appendChild(item);
            }
        }

        function sortAudios(audios) {
            const sorted = [...audios];
            switch (currentSortBy) {
                case 'track':
                    sorted.sort((a, b) => (a.trackNumber || 999) - (b.trackNumber || 999));
                    break;
                case 'title':
                    sorted.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                    break;
                case 'duration':
                    sorted.sort((a, b) => (a.duration || 0) - (b.duration || 0));
                    break;
                case 'artist':
                    sorted.sort((a, b) => (a.artist || '').localeCompare(b.artist || ''));
                    break;
                case 'createdAt':
                    sorted.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                    break;
                default:
                    break;
            }
            if (currentSortOrder === 'desc') {
                sorted.reverse();
            }
            return sorted;
        }

        function updateBatchToolbar() {
            const toolbar = document.getElementById('batch-toolbar');
            const countSpan = toolbar.querySelector('.selected-count');
            const batchBtn = document.getElementById('batch-mode-btn');
            
            if (batchMode && selectedAudios.size > 0) {
                toolbar.classList.add('active');
                countSpan.textContent = `已选择 ${selectedAudios.size} 项`;
            } else {
                toolbar.classList.remove('active');
            }
            
            batchBtn.textContent = batchMode ? '退出批量' : '批量管理';
            batchBtn.classList.toggle('active', batchMode);
        }

        function toggleBatchMode() {
            batchMode = !batchMode;
            selectedAudios.clear();
            updateBatchToolbar();
            renderAudios(currentDiscId);
        }

        async function deleteSelectedAudios() {
            if (selectedAudios.size === 0) return;
            
            const confirmed = await showConfirm('批量删除', `确定删除选中的 ${selectedAudios.size} 个音频吗？`);
            if (!confirmed) return;
            
            const deletedAudios = [];
            for (const id of selectedAudios) {
                const audio = await db.audios.get(id);
                if (audio) deletedAudios.push(audio);
                await db.audios.delete(id);
            }
            
            showToastWithUndo(`已删除 ${deletedAudios.length} 个音频`, async () => {
                for (const audio of deletedAudios) {
                    await db.audios.add(audio);
                }
                renderAudios(currentDiscId);
                showToast('已恢复删除的音频');
            });
            
            selectedAudios.clear();
            batchMode = false;
            updateBatchToolbar();
            renderAudios(currentDiscId);
        }

        function openCreateAlbumDialog() {
            currentDialogMode = 'create-album';
            editingEntityId = null;
            document.getElementById('dialog-title').textContent = '创建专辑';
            document.getElementById('entity-name-input').value = '';
            document.getElementById('entity-cover-input').value = '';
            document.getElementById('entity-cover-preview').style.display = 'none';
            document.getElementById('clear-entity-cover-btn').style.display = 'none';
            document.getElementById('entity-number-input').value = '';
            document.getElementById('entity-artist-input').value = '';
            document.getElementById('entity-release-date-input').value = '';
            document.getElementById('entity-description-input').value = '';
            document.querySelectorAll('.album-only-field').forEach(el => el.style.display = 'block');
            document.querySelectorAll('.disc-only-field').forEach(el => el.style.display = 'none');
            document.getElementById('entity-confirm-btn').textContent = '创建';
            document.getElementById('name-warning').classList.remove('visible');
            dialogOriginalData = { name: '', cover: null };
            isDialogDirty = false;
            isCoverCleared = false;
            document.getElementById('entity-dialog').classList.add('active');
        }

        function openEditAlbumDialog(album) {
            currentDialogMode = 'edit-album';
            editingEntityId = album.id;
            document.getElementById('dialog-title').textContent = '编辑专辑';
            document.getElementById('entity-name-input').value = album.name;
            document.getElementById('entity-cover-input').value = '';
            document.getElementById('entity-number-input').value = album.albumNumber || '';
            document.getElementById('entity-artist-input').value = album.artist || '';
            document.getElementById('entity-release-date-input').value = album.releaseDate || '';
            document.getElementById('entity-description-input').value = album.description || '';
            document.querySelectorAll('.album-only-field').forEach(el => el.style.display = 'block');
            document.querySelectorAll('.disc-only-field').forEach(el => el.style.display = 'none');
            const preview = document.getElementById('entity-cover-preview');
            const clearBtn = document.getElementById('clear-entity-cover-btn');
            if (album.cover) {
                const url = URL.createObjectURL(album.cover);
                preview.src = url;
                preview.style.display = 'block';
                if (clearBtn) clearBtn.style.display = 'block';
            } else {
                preview.style.display = 'none';
                if (clearBtn) clearBtn.style.display = 'none';
            }
            document.getElementById('entity-confirm-btn').textContent = '保存';
            document.getElementById('name-warning').classList.remove('visible');
            dialogOriginalData = { name: album.name, cover: album.cover };
            isDialogDirty = false;
            isCoverCleared = false;
            document.getElementById('entity-dialog').classList.add('active');
        }

        function openCreateDiscDialog() {
            currentDialogMode = 'create-disc';
            editingEntityId = null;
            document.getElementById('dialog-title').textContent = '创建Disc';
            document.getElementById('entity-name-input').value = '';
            document.getElementById('entity-cover-input').value = '';
            document.getElementById('entity-cover-preview').style.display = 'none';
            document.getElementById('clear-entity-cover-btn').style.display = 'none';
            document.getElementById('entity-disc-number-input').value = '';
            document.getElementById('entity-disc-description-input').value = '';
            document.querySelectorAll('.album-only-field').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.disc-only-field').forEach(el => el.style.display = 'block');
            document.getElementById('entity-confirm-btn').textContent = '创建';
            document.getElementById('name-warning').classList.remove('visible');
            dialogOriginalData = { name: '', cover: null };
            isDialogDirty = false;
            isCoverCleared = false;
            document.getElementById('entity-dialog').classList.add('active');
        }

        function openEditDiscDialog(disc) {
            currentDialogMode = 'edit-disc';
            editingEntityId = disc.id;
            document.getElementById('dialog-title').textContent = '编辑Disc';
            document.getElementById('entity-name-input').value = disc.name;
            document.getElementById('entity-cover-input').value = '';
            document.getElementById('entity-disc-number-input').value = disc.discNumber || '';
            document.getElementById('entity-disc-description-input').value = disc.description || '';
            document.querySelectorAll('.album-only-field').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.disc-only-field').forEach(el => el.style.display = 'block');
            const preview = document.getElementById('entity-cover-preview');
            const clearBtn = document.getElementById('clear-entity-cover-btn');
            if (disc.cover) {
                const url = URL.createObjectURL(disc.cover);
                preview.src = url;
                preview.style.display = 'block';
                if (clearBtn) clearBtn.style.display = 'block';
            } else {
                preview.style.display = 'none';
                if (clearBtn) clearBtn.style.display = 'none';
            }
            document.getElementById('entity-confirm-btn').textContent = '保存';
            document.getElementById('name-warning').classList.remove('visible');
            dialogOriginalData = { name: disc.name, cover: disc.cover };
            isDialogDirty = false;
            isCoverCleared = false;
            document.getElementById('entity-dialog').classList.add('active');
        }

        async function handleEntityConfirm() {
            if (isSubmitting) return;
            const name = document.getElementById('entity-name-input').value.trim();
            if (!name) {
                document.getElementById('name-warning').classList.add('visible');
                return;
            }
            isSubmitting = true;
            const coverInput = document.getElementById('entity-cover-input');
            let coverBlob = null;
            if (coverInput.files[0]) {
                coverBlob = coverInput.files[0];
            }
            try {
                if (currentDialogMode === 'create-album') {
                    const albumNumber = document.getElementById('entity-number-input').value.trim();
                    const artist = document.getElementById('entity-artist-input').value.trim();
                    const releaseDate = document.getElementById('entity-release-date-input').value;
                    const description = document.getElementById('entity-description-input').value.trim();
                    await db.albums.add({ 
                        name, 
                        cover: coverBlob, 
                        albumNumber, 
                        artist, 
                        releaseDate, 
                        description,
                        createdAt: Date.now() 
                    });
                    showToast('专辑创建成功');
                } else if (currentDialogMode === 'edit-album') {
                    const albumNumber = document.getElementById('entity-number-input').value.trim();
                    const artist = document.getElementById('entity-artist-input').value.trim();
                    const releaseDate = document.getElementById('entity-release-date-input').value;
                    const description = document.getElementById('entity-description-input').value.trim();
                    const updateData = { name, albumNumber, artist, releaseDate, description, updatedAt: Date.now() };
                    if (coverBlob) updateData.cover = coverBlob;
                    else if (isCoverCleared) updateData.cover = null;
                    await db.albums.update(editingEntityId, updateData);
                    showToast('专辑更新成功');
                } else if (currentDialogMode === 'create-disc') {
                    const discNumber = parseInt(document.getElementById('entity-disc-number-input').value) || null;
                    const discDescription = document.getElementById('entity-disc-description-input').value.trim();
                    await db.discs.add({ 
                        albumId: currentAlbumId, 
                        name, 
                        cover: coverBlob, 
                        discNumber,
                        description: discDescription,
                        createdAt: Date.now() 
                    });
                    showToast('Disc创建成功');
                } else if (currentDialogMode === 'edit-disc') {
                    const discNumber = parseInt(document.getElementById('entity-disc-number-input').value) || null;
                    const discDescription = document.getElementById('entity-disc-description-input').value.trim();
                    const updateData = { name, discNumber, description: discDescription, updatedAt: Date.now() };
                    if (coverBlob) updateData.cover = coverBlob;
                    else if (isCoverCleared) updateData.cover = null;
                    await db.discs.update(editingEntityId, updateData);
                    showToast('Disc更新成功');
                } else if (currentDialogMode === 'create-video-album') {
                    const albumNumber = document.getElementById('entity-number-input').value.trim();
                    const artist = document.getElementById('entity-artist-input').value.trim();
                    const releaseDate = document.getElementById('entity-release-date-input').value;
                    const description = document.getElementById('entity-description-input').value.trim();
                    await db.videoAlbums.add({ 
                        name, 
                        cover: coverBlob, 
                        albumNumber, 
                        artist, 
                        releaseDate, 
                        description,
                        createdAt: Date.now() 
                    });
                    showToast('视频专辑创建成功');
                } else if (currentDialogMode === 'edit-video-album') {
                    const albumNumber = document.getElementById('entity-number-input').value.trim();
                    const artist = document.getElementById('entity-artist-input').value.trim();
                    const releaseDate = document.getElementById('entity-release-date-input').value;
                    const description = document.getElementById('entity-description-input').value.trim();
                    const updateData = { name, albumNumber, artist, releaseDate, description, updatedAt: Date.now() };
                    if (coverBlob) updateData.cover = coverBlob;
                    else if (isCoverCleared) updateData.cover = null;
                    await db.videoAlbums.update(editingEntityId, updateData);
                    showToast('视频专辑更新成功');
                } else if (currentDialogMode === 'create-video-disc') {
                    const discNumber = parseInt(document.getElementById('entity-disc-number-input').value) || null;
                    const discDescription = document.getElementById('entity-disc-description-input').value.trim();
                    await db.videoDiscs.add({ 
                        videoAlbumId: currentVideoAlbumId, 
                        name, 
                        cover: coverBlob, 
                        discNumber,
                        description: discDescription,
                        createdAt: Date.now() 
                    });
                    showToast('视频Disc创建成功');
                } else if (currentDialogMode === 'edit-video-disc') {
                    const discNumber = parseInt(document.getElementById('entity-disc-number-input').value) || null;
                    const discDescription = document.getElementById('entity-disc-description-input').value.trim();
                    const updateData = { name, discNumber, description: discDescription, updatedAt: Date.now() };
                    if (coverBlob) updateData.cover = coverBlob;
                    else if (isCoverCleared) updateData.cover = null;
                    await db.videoDiscs.update(editingEntityId, updateData);
                    showToast('视频Disc更新成功');
                }
                closeAllDialogs();
                if (currentDialogMode === 'create-album' || currentDialogMode === 'edit-album') renderAlbums();
                else if (currentDialogMode === 'create-video-album' || currentDialogMode === 'edit-video-album') renderVideoAlbums();
                else if (currentDialogMode.includes('video-disc')) {
                    const album = await db.videoAlbums.get(currentVideoAlbumId);
                    renderVideoDiscDetail(currentVideoAlbumId, album.name);
                }
                else {
                    const album = await db.albums.get(currentAlbumId);
                    renderDiscDetail(currentAlbumId, album.name);
                }
            } catch (error) {
                console.error('保存失败:', error);
                showToast('保存失败: ' + error.message);
            }
            isSubmitting = false;
        }

        async function deleteAlbum(id, name) {
            const confirmed = await showConfirm('删除专辑', `确定删除专辑"${name}"吗？\n这将同时删除所有Disc和音频文件！`);
            if (confirmed) {
                await db.albums.delete(id);
                showToast('专辑已删除');
                renderAlbums();
            }
        }

        async function deleteDisc(id, name) {
            const confirmed = await showConfirm('删除Disc', `确定删除Disc"${name}"吗？\n这将同时删除所有音频文件！`);
            if (confirmed) {
                await db.discs.delete(id);
                if (currentDiscId === id) currentDiscId = null;
                showToast('Disc已删除');
                const album = await db.albums.get(currentAlbumId);
                renderDiscDetail(currentAlbumId, album.name);
            }
        }

        function openAddAudioDialog() {
            if (!currentDiscId) {
                showToast('请先选择或创建一个Disc');
                return;
            }
            editingAudioId = null;
            document.getElementById('audio-dialog-title').textContent = '添加音频';
            document.getElementById('audio-title-input').value = '';
            document.getElementById('audio-track-input').value = '';
            document.getElementById('audio-duration-input').value = '';
            document.getElementById('audio-artist-input').value = '';
            document.getElementById('audio-composer-input').value = '';
            document.getElementById('audio-lyricist-input').value = '';
            document.getElementById('audio-circle-input').value = '';
            document.getElementById('audio-lyric-input').value = '';
            document.getElementById('audio-dialog-file-input').value = '';
            document.getElementById('audio-dialog-url-input').value = '';
            document.getElementById('audio-image-input').value = '';
            document.getElementById('audio-image-preview').style.display = 'none';
            document.getElementById('audio-confirm-btn').textContent = '添加';
            document.getElementById('audio-title-warning').classList.remove('visible');
            audioDialogOriginalData = { title: '', lyric: '', audioFile: null, imageFile: null };
            audioDialogOriginalFile = null;
            audioDialogOriginalImage = null;
            audioDialogDirty = false;
            document.getElementById('audio-dialog').classList.add('active');
        }

        function openEditAudioDialog(audio) {
            editingAudioId = audio.id;
            document.getElementById('audio-dialog-title').textContent = '编辑音频';
            document.getElementById('audio-title-input').value = audio.title;
            document.getElementById('audio-track-input').value = audio.trackNumber || '';
            document.getElementById('audio-duration-input').value = audio.duration ? formatTime(audio.duration) : '';
            document.getElementById('audio-artist-input').value = audio.artist || '';
            document.getElementById('audio-composer-input').value = audio.composer || '';
            document.getElementById('audio-lyricist-input').value = audio.lyricist || '';
            document.getElementById('audio-circle-input').value = audio.circle || '';
            document.getElementById('audio-lyric-input').value = audio.lyrics || '';
            document.getElementById('audio-dialog-file-input').value = '';
            document.getElementById('audio-dialog-url-input').value = audio.audioType === 'url' ? audio.audioSource : '';
            const preview = document.getElementById('audio-image-preview');
            const clearBtn = document.getElementById('clear-audio-image-btn');
            if (audio.imageFile) {
                const url = URL.createObjectURL(audio.imageFile);
                preview.src = url;
                preview.style.display = 'block';
                if (clearBtn) clearBtn.style.display = 'block';
            } else {
                preview.style.display = 'none';
                if (clearBtn) clearBtn.style.display = 'none';
            }
            document.getElementById('audio-confirm-btn').textContent = '保存';
            document.getElementById('audio-title-warning').classList.remove('visible');
            audioDialogOriginalData = { title: audio.title, lyric: audio.lyrics || '' };
            audioDialogOriginalFile = audio.audioFile || null;
            audioDialogOriginalImage = audio.imageFile || null;
            audioDialogDirty = false;
            document.getElementById('audio-dialog').classList.add('active');
        }

        async function handleAudioConfirm() {
            if (isSubmitting) return;
            const title = document.getElementById('audio-title-input').value.trim();
            if (!title) {
                document.getElementById('audio-title-warning').classList.add('visible');
                return;
            }
            isSubmitting = true;
            const lyrics = document.getElementById('audio-lyric-input').value;
            const trackNumber = parseInt(document.getElementById('audio-track-input').value) || null;
            const artist = document.getElementById('audio-artist-input').value.trim();
            const composer = document.getElementById('audio-composer-input').value.trim();
            const lyricist = document.getElementById('audio-lyricist-input').value.trim();
            const circle = document.getElementById('audio-circle-input').value.trim();
            const fileInput = document.getElementById('audio-dialog-file-input');
            const urlInput = document.getElementById('audio-dialog-url-input');
            const imageInput = document.getElementById('audio-image-input');
            const artistImageInput = document.getElementById('audio-artist-image-input');
            const isUrlMode = document.querySelector('input[name="audio-dialog-source"]:checked').value === 'url';
            try {
                const audioData = {
                    title,
                    lyrics,
                    trackNumber,
                    artist,
                    composer,
                    lyricist,
                    circle,
                    discId: currentDiscId,
                    albumId: currentAlbumId,
                    isFavorite: false,
                    createdAt: Date.now()
                };
                if (isUrlMode && urlInput.value) {
                    audioData.audioType = 'url';
                    audioData.audioSource = urlInput.value;
                } else if (fileInput.files[0]) {
                    audioData.audioType = 'file';
                    audioData.audioFile = fileInput.files[0];
                } else if (editingAudioId && audioDialogOriginalFile) {
                    audioData.audioType = 'file';
                    audioData.audioFile = audioDialogOriginalFile;
                }
                if (imageInput.files[0]) {
                    audioData.imageFile = imageInput.files[0];
                } else if (editingAudioId && audioDialogOriginalImage) {
                    audioData.imageFile = audioDialogOriginalImage;
                }
                if (artistImageInput.files[0]) {
                    audioData.artistImage = artistImageInput.files[0];
                }
                if (editingAudioId) {
                    const updateData = { title, lyrics, trackNumber, artist, composer, lyricist, circle, updatedAt: Date.now() };
                    if (audioData.audioFile) updateData.audioFile = audioData.audioFile;
                    if (audioData.audioSource) {
                        updateData.audioType = audioData.audioType;
                        updateData.audioSource = audioData.audioSource;
                    }
                    if (audioData.imageFile) updateData.imageFile = audioData.imageFile;
                    if (audioData.artistImage) updateData.artistImage = audioData.artistImage;
                    await db.audios.update(editingAudioId, updateData);
                    showToast('音频更新成功');
                } else {
                    await db.audios.add(audioData);
                    showToast('音频添加成功');
                }
                closeAllDialogs();
                renderAudios(currentDiscId);
            } catch (error) {
                console.error('保存失败:', error);
                showToast('保存失败: ' + error.message);
            }
            isSubmitting = false;
        }

        async function toggleFavorite(audioId) {
            const audio = await db.audios.get(audioId);
            const newFavoriteState = !audio.isFavorite;
            await db.audios.update(audioId, { isFavorite: newFavoriteState ? 1 : 0 });
            showToast(newFavoriteState ? '已添加到我喜欢' : '已取消收藏');
            renderAudios(currentDiscId);
            updateFavoritesCount();
        }

        async function addToPlaylist(audioId) {
            const playlists = await db.playlists.toArray();
            if (playlists.length === 0) {
                if (await showConfirm('创建播放列表', '还没有播放列表，是否创建一个新的？')) {
                    const name = prompt('请输入播放列表名称：');
                    if (name && name.trim()) {
                        const playlistId = await db.playlists.add({ name: name.trim(), createdAt: Date.now() });
                        await db.playlistItems.add({ playlistId, audioId, createdAt: Date.now() });
                        showToast('已添加到播放列表');
                    }
                }
                return;
            }
            const options = playlists.map(p => p.name).join('|');
            const choice = prompt(`选择播放列表（输入序号）：\n${playlists.map((p, i) => `${i + 1}. ${p.name}`).join('\n')}`);
            if (choice) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < playlists.length) {
                    const existing = await db.playlistItems.where({ playlistId: playlists[index].id, audioId }).first();
                    if (existing) {
                        showToast('该歌曲已在播放列表中');
                        return;
                    }
                    await db.playlistItems.add({ playlistId: playlists[index].id, audioId, createdAt: Date.now() });
                    showToast(`已添加到"${playlists[index].name}"`);
                }
            }
        }

        async function updateFavoritesCount() {
            const allAudios = await db.audios.toArray();
            const count = allAudios.filter(a => a.isFavorite).length;
            const countEl = document.getElementById('favorites-count');
            if (countEl) countEl.textContent = `${count} 首歌曲`;
        }

        let currentPlaylistFilter = 'all';
        
        async function renderPlaylists() {
            const playlistsList = document.getElementById('playlists-list');
            
            const audioPlaylists = await db.playlists.toArray();
            const videoPlaylists = await db.videoPlaylists.toArray();
            
            const allPlaylists = [
                ...audioPlaylists.map(p => ({ ...p, mediaType: 'audio' })),
                ...videoPlaylists.map(p => ({ ...p, mediaType: 'video' }))
            ].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            
            const filteredPlaylists = currentPlaylistFilter === 'all'
                ? allPlaylists
                : allPlaylists.filter(p => p.mediaType === currentPlaylistFilter);
            
            playlistsList.innerHTML = '';
            
            initPlaylistTabs();
            
            const allAudios = await db.audios.toArray();
            const allVideos = await db.videos.toArray();
            const audioFavCount = allAudios.filter(a => a.isFavorite).length;
            const videoFavCount = allVideos.filter(v => v.isFavorite).length;
            
            const favCountEl = document.getElementById('favorites-count');
            const videoFavCountEl = document.getElementById('video-favorites-count-inline');
            if (favCountEl) favCountEl.textContent = `${audioFavCount} 首音频`;
            if (videoFavCountEl) videoFavCountEl.textContent = `${videoFavCount} 个视频`;
            
            for (const playlist of filteredPlaylists) {
                let itemCount = 0;
                if (playlist.mediaType === 'audio') {
                    itemCount = await db.playlistItems.where('playlistId').equals(playlist.id).count();
                } else {
                    itemCount = await db.videoPlaylistItems.where('videoPlaylistId').equals(playlist.id).count();
                }
                
                const item = document.createElement('div');
                item.className = 'audio-item';
                item.dataset.id = playlist.id;
                item.dataset.type = playlist.mediaType;
                item.innerHTML = `
                    <div class="audio-cover" style="background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 99, 102, 241), 0.3), rgba(var(--btn-color-rgb, 99, 102, 241), 0.1)); display: flex; align-items: center; justify-content: center; font-size: 24px;">${playlist.mediaType === 'audio' ? '📋' : '🎬'}</div>
                    <div class="audio-info">
                        <div class="audio-title">${playlist.name}</div>
                        <div class="audio-meta">${itemCount} 个${playlist.mediaType === 'audio' ? '音频' : '视频'}</div>
                    </div>
                    <div class="audio-actions">
                        <button class="audio-action-btn" data-action="delete" title="删除" style="color:#ff4444;">🗑️</button>
                    </div>
                `;
                
                item.querySelector('.audio-info').addEventListener('click', () => {
                    if (playlist.mediaType === 'audio') {
                        openPlaylistDetail(playlist.id, playlist.name);
                    } else {
                        openVideoPlaylistDetail(playlist.id, playlist.name);
                    }
                });
                
                item.querySelector('[data-action="delete"]').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (await showConfirm('删除播放列表', `确定删除播放列表"${playlist.name}"吗？`)) {
                        if (playlist.mediaType === 'audio') {
                            await db.playlistItems.where('playlistId').equals(playlist.id).delete();
                            await db.playlists.delete(playlist.id);
                        } else {
                            await db.videoPlaylistItems.where('videoPlaylistId').equals(playlist.id).delete();
                            await db.videoPlaylists.delete(playlist.id);
                        }
                        showToast('播放列表已删除');
                        renderPlaylists();
                    }
                });
                
                playlistsList.appendChild(item);
            }
        }

        function initPlaylistTabs() {
            document.querySelectorAll('.playlist-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.playlist-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentPlaylistFilter = tab.dataset.type;
                    renderPlaylists();
                });
            });
        }

        async function openPlaylistDetail(playlistId, playlistName) {
            document.getElementById('playlist-detail-title').textContent = playlistName;
            const audioList = document.getElementById('playlist-audio-list');
            const emptyTip = document.getElementById('playlist-empty-tip');
            
            const items = await db.playlistItems.where('playlistId').equals(playlistId).toArray();
            audioList.innerHTML = '';
            
            if (items.length === 0) {
                emptyTip.style.display = 'block';
            } else {
                emptyTip.style.display = 'none';
                for (const item of items) {
                    const audio = await db.audios.get(item.audioId);
                    if (!audio) continue;
                    
                    const audioItem = document.createElement('div');
                    audioItem.className = 'audio-item';
                    audioItem.dataset.id = audio.id;
                    let coverUrl = defaultCover;
                    if (audio.imageFile) {
                        coverUrl = URL.createObjectURL(audio.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                    
                    audioItem.innerHTML = `
                        <img class="audio-cover" src="${coverUrl}" alt="cover">
                        <div class="audio-info">
                            <div class="audio-title">${audio.title}</div>
                            <div class="audio-meta">${audio.duration ? formatTime(audio.duration) : '未知时长'}${audio.artist ? ' - ' + audio.artist : ''}</div>
                        </div>
                        <div class="audio-actions">
                            <button class="audio-action-btn play-btn" data-action="play" title="播放">▶</button>
                            <button class="audio-action-btn" data-action="remove" title="从列表移除" style="color:#ff9800;">✕</button>
                        </div>
                    `;
                    
                    audioItem.querySelector('.audio-info').addEventListener('click', () => playAudio(audio.id));
                    audioItem.querySelector('[data-action="play"]').addEventListener('click', () => playAudio(audio.id));
                    audioItem.querySelector('[data-action="remove"]').addEventListener('click', async () => {
                        await db.playlistItems.delete(item.id);
                        showToast('已从播放列表移除');
                        openPlaylistDetail(playlistId, playlistName);
                    });
                    audioList.appendChild(audioItem);
                }
            }
            navigateTo('playlist-detail-view');
        }

        let currentFavFilter = 'all';
        
        async function renderFavorites() {
            const audioList = document.getElementById('favorites-audio-list');
            const emptyTip = document.getElementById('favorites-empty-tip');
            
            initFavTabs();
            
            const allAudios = await db.audios.toArray();
            const allVideos = await db.videos.toArray();
            const audioFavorites = allAudios.filter(a => a.isFavorite).map(a => ({ ...a, mediaType: 'audio' }));
            const videoFavorites = allVideos.filter(v => v.isFavorite).map(v => ({ ...v, mediaType: 'video' }));
            
            const allFavorites = [...audioFavorites, ...videoFavorites];
            
            const filteredFavorites = currentFavFilter === 'all'
                ? allFavorites
                : allFavorites.filter(f => f.mediaType === currentFavFilter);
            
            audioList.innerHTML = '';
            
            if (filteredFavorites.length === 0) {
                emptyTip.style.display = 'block';
            } else {
                emptyTip.style.display = 'none';
                for (const item of filteredFavorites) {
                    const el = document.createElement('div');
                    el.className = 'audio-item';
                    el.dataset.id = item.id;
                    el.dataset.type = item.mediaType;
                    
                    let coverUrl = defaultCover;
                    if (item.imageFile) {
                        coverUrl = URL.createObjectURL(item.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                    
                    el.innerHTML = `
                        <img class="audio-cover" src="${coverUrl}" alt="cover">
                        <div class="audio-info">
                            <div class="audio-title">${item.mediaType === 'audio' ? '🎵' : '🎬'} ${item.title}</div>
                            <div class="audio-meta">${item.duration ? formatTime(item.duration) : '未知时长'}${item.artist ? ' - ' + item.artist : ''}</div>
                        </div>
                        <div class="audio-actions">
                            <button class="audio-action-btn play-btn" data-action="play" title="播放">▶</button>
                            <button class="audio-action-btn favorite active" data-action="favorite" title="取消收藏">❤️</button>
                        </div>
                    `;
                    
                    el.querySelector('.audio-info').addEventListener('click', () => {
                        if (item.mediaType === 'audio') {
                            playAudio(item.id);
                        } else {
                            playVideo(item.id);
                        }
                    });
                    
                    el.querySelector('[data-action="play"]').addEventListener('click', () => {
                        if (item.mediaType === 'audio') {
                            playAudio(item.id);
                        } else {
                            playVideo(item.id);
                        }
                    });
                    
                    el.querySelector('[data-action="favorite"]').addEventListener('click', async () => {
                        if (item.mediaType === 'audio') {
                            await db.audios.update(item.id, { isFavorite: 0 });
                        } else {
                            await db.videos.update(item.id, { isFavorite: 0 });
                        }
                        showToast('已取消收藏');
                        renderFavorites();
                        updateFavoritesCount();
                    });
                    
                    audioList.appendChild(el);
                }
            }
        }

        function initFavTabs() {
            document.querySelectorAll('.fav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.fav-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentFavFilter = tab.dataset.type;
                    renderFavorites();
                });
            });
        }

        async function renderArtists(searchTerm = '') {
            const artistsList = document.getElementById('artists-list');
            const emptyTip = document.getElementById('artists-empty-tip');
            
            let audios = await db.audios.toArray();
            const artistMap = {};
            const artistImages = {};
            
            for (const audio of audios) {
                if (audio.artist && audio.artist.trim()) {
                    const artist = audio.artist.trim();
                    if (!artistMap[artist]) artistMap[artist] = [];
                    artistMap[artist].push(audio);
                    if (audio.artistImage && !artistImages[artist]) {
                        artistImages[artist] = audio.artistImage;
                    }
                }
            }
            
            let artists = Object.entries(artistMap);
            if (searchTerm) {
                artists = artists.filter(([name]) => name.toLowerCase().includes(searchTerm.toLowerCase()));
            }
            
            artistsList.innerHTML = '';
            
            if (artists.length === 0) {
                emptyTip.style.display = 'block';
            } else {
                emptyTip.style.display = 'none';
                for (const [artistName, artistAudios] of artists) {
                    const item = document.createElement('div');
                    item.className = 'album-item';
                    
                    let iconHtml = '';
                    if (artistImages[artistName]) {
                        const imgUrl = URL.createObjectURL(artistImages[artistName]);
                        tempObjectURLs.push(imgUrl);
                        iconHtml = `<img src="${imgUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`;
                    } else {
                        iconHtml = '🎤';
                    }
                    
                    item.innerHTML = `
                        <div class="album-icon" style="background: linear-gradient(135deg, rgba(var(--btn-color-rgb, 99, 102, 241), 0.3), rgba(var(--btn-color-rgb, 99, 102, 241), 0.1)); display: flex; align-items: center; justify-content: center; font-size: 32px; overflow: hidden;">${iconHtml}</div>
                        <div class="album-name">${artistName}</div>
                        <div class="album-count">${artistAudios.length} 首歌曲</div>
                    `;
                    item.addEventListener('click', () => openArtistDetail(artistName, artistAudios));
                    artistsList.appendChild(item);
                }
            }
        }

        async function openArtistDetail(artistName, audios) {
            document.getElementById('artist-detail-title').textContent = artistName;
            const audioList = document.getElementById('artist-audio-list');
            const emptyTip = document.getElementById('artist-empty-tip');
            
            audioList.innerHTML = '';
            
            if (audios.length === 0) {
                emptyTip.style.display = 'block';
            } else {
                emptyTip.style.display = 'none';
                for (const audio of audios) {
                    const item = document.createElement('div');
                    item.className = 'audio-item';
                    item.dataset.id = audio.id;
                    let coverUrl = defaultCover;
                    if (audio.imageFile) {
                        coverUrl = URL.createObjectURL(audio.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                    
                    item.innerHTML = `
                        <img class="audio-cover" src="${coverUrl}" alt="cover">
                        <div class="audio-info">
                            <div class="audio-title">${audio.title}</div>
                            <div class="audio-meta">${audio.duration ? formatTime(audio.duration) : '未知时长'}</div>
                        </div>
                        <div class="audio-actions">
                            <button class="audio-action-btn play-btn" data-action="play" title="播放">▶</button>
                            <button class="audio-action-btn favorite ${audio.isFavorite ? 'active' : ''}" data-action="favorite" title="${audio.isFavorite ? '取消收藏' : '添加收藏'}">${audio.isFavorite ? '❤️' : '🤍'}</button>
                        </div>
                    `;
                    
                    item.querySelector('.audio-info').addEventListener('click', () => playAudio(audio.id));
                    item.querySelector('[data-action="play"]').addEventListener('click', () => playAudio(audio.id));
                    item.querySelector('[data-action="favorite"]').addEventListener('click', async () => {
                        await toggleFavorite(audio.id);
                        const btn = item.querySelector('[data-action="favorite"]');
                        const audioData = await db.audios.get(audio.id);
                        btn.classList.toggle('active', !!audioData.isFavorite);
                        btn.textContent = audioData.isFavorite ? '❤️' : '🤍';
                        btn.title = audioData.isFavorite ? '取消收藏' : '添加收藏';
                    });
                    audioList.appendChild(item);
                }
            }
            navigateTo('artist-detail-view');
        }

        async function createPlaylist() {
            const name = prompt('请输入播放列表名称：');
            if (name && name.trim()) {
                await db.playlists.add({ name: name.trim(), createdAt: Date.now() });
                showToast('播放列表创建成功');
                renderPlaylists();
            }
        }

        async function deleteAudioWithUndo(id, title) {
            const audio = await db.audios.get(id);
            if (!audio) return;
            
            await db.audios.delete(id);
            showToastWithUndo(`已删除"${title}"`, async () => {
                await db.audios.add(audio);
                renderAudios(currentDiscId);
                showToast('已恢复删除的音频');
            });
            renderAudios(currentDiscId);
        }

        async function playAudio(audioId, resumePlay = false) {
            try {
                const audio = await db.audios.get(audioId);
                if (!audio) {
                    showToast('音频不存在');
                    return;
                }
                const playerView = document.getElementById('player-view');
                const audioPlayer = document.getElementById('audio-player');
                const currentAudioId = parseInt(playerView?.dataset?.currentAudioId);
                
                if (currentAudioId === audioId && audioPlayer.src && !audioPlayer.paused) {
                    playerPreviousView = 'disc-detail-view';
                    navigateTo('player-view');
                    return;
                }
                
                if (currentAudioId === audioId && audioPlayer.src && audioPlayer.paused) {
                    playerPreviousView = 'disc-detail-view';
                    navigateTo('player-view');
                    await audioPlayer.play();
                    return;
                }
                
                playerView.dataset.currentAudioId = audioId;
                localStorage.setItem('lastPlayedAudioId', audioId);
                if (audio.albumId) localStorage.setItem('lastPlayedAlbumId', audio.albumId);
                if (audio.discId) localStorage.setItem('lastPlayedDiscId', audio.discId);
                if (audio.audioType === 'url' && audio.audioSource) {
                    audioPlayer.src = audio.audioSource;
                } else if (audio.audioFile) {
                    const url = URL.createObjectURL(audio.audioFile);
                    tempObjectURLs.push(url);
                    audioPlayer.src = url;
                } else {
                    showToast('音频源不存在');
                    return;
                }
                customCoverUrl = null;
                let coverUrl = defaultCover;
                if (audio.imageFile) {
                    coverUrl = URL.createObjectURL(audio.imageFile);
                    tempObjectURLs.push(coverUrl);
                }
                currentAudioCover = coverUrl;
                currentAudioTitle = audio.title;
                if (audio.backgroundImage) {
                    const bgUrl = URL.createObjectURL(audio.backgroundImage);
                    tempObjectURLs.push(bgUrl);
                    playerView.style.backgroundImage = `url(${bgUrl})`;
                } else {
                    const playerBg = await db.settings.get('playerBg');
                    if (playerBg?.value) {
                        const globalBgUrl = URL.createObjectURL(playerBg.value);
                        tempObjectURLs.push(globalBgUrl);
                        playerView.style.backgroundImage = `url(${globalBgUrl})`;
                    } else {
                        playerView.style.backgroundImage = '';
                    }
                }
                if (audio.lyrics) {
                    currentLyrics = parseLyrics(audio.lyrics);
                } else {
                    currentLyrics = [];
                }
                const fullLyricsList = document.getElementById('full-lyrics-list');
                if (fullLyricsList && currentLyrics.length > 0) {
                    fullLyricsList.innerHTML = currentLyrics.map((line, i) => 
                        `<div class="full-lyric-line" data-index="${i}" data-start="${line.startTime}">${line.text}</div>`
                    ).join('');
                    fullLyricsList.querySelectorAll('.full-lyric-line').forEach(line => {
                        line.addEventListener('click', () => {
                            const start = parseFloat(line.dataset.start);
                            if (!isNaN(start)) {
                                document.getElementById('audio-player').currentTime = start;
                            }
                        });
                    });
                } else if (fullLyricsList) {
                    fullLyricsList.innerHTML = '<div class="full-lyric-line" style="color:#666;">暂无歌词</div>';
                }
                applyPlayerStyle(currentPlayerStyle);
                const songTitleBox = document.getElementById('song-title-box');
                if (songTitleBox) songTitleBox.textContent = audio.title;
                const albumArt = document.getElementById('album-art');
                if (albumArt) albumArt.src = coverUrl;
                // 启动歌曲标题滚动效果
                setTimeout(startTitleScroll, 500);
                playerPreviousView = 'disc-detail-view';
                navigateTo('player-view');
                bottomPlayer.updateSong(audio);
                if (resumePlay) {
                    const savedTime = parseFloat(localStorage.getItem('lastPlayedTime')) || 0;
                    audioPlayer.currentTime = savedTime;
                }
                await recordPlayHistory('audio', audioId);
                await audioPlayer.play();
            } catch (err) {
                console.error('播放失败:', err);
                showToast('播放失败: ' + err.message);
            }
        }

        function parseLyrics(lyricText) {
            const lines = lyricText.trim().split('\n');
            const lyrics = [];
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                if (trimmed === 'WEBVTT' || trimmed.startsWith('NOTE') || /^\d+$/.test(trimmed)) continue;
                const vttMatch = trimmed.match(/(\d{2}):(\d{2}):(\d{2})\.(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2})\.(\d{3})/);
                if (vttMatch) {
                    const startH = parseInt(vttMatch[1]), startM = parseInt(vttMatch[2]), startS = parseInt(vttMatch[3]), startMs = parseInt(vttMatch[4]);
                    const endH = parseInt(vttMatch[5]), endM = parseInt(vttMatch[6]), endS = parseInt(vttMatch[7]), endMs = parseInt(vttMatch[8]);
                    lyrics.push({
                        startTime: startH * 3600 + startM * 60 + startS + startMs / 1000,
                        endTime: endH * 3600 + endM * 60 + endS + endMs / 1000,
                        text: ''
                    });
                    continue;
                }
                const lrcMatch = trimmed.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
                if (lrcMatch) {
                    const m = parseInt(lrcMatch[1]), s = parseInt(lrcMatch[2]), ms = parseInt(lrcMatch[3].padEnd(3, '0'));
                    lyrics.push({
                        startTime: m * 60 + s + ms / 1000,
                        text: lrcMatch[4].trim()
                    });
                    continue;
                }
                if (lyrics.length > 0 && !lyrics[lyrics.length - 1].text) {
                    lyrics[lyrics.length - 1].text = trimmed;
                }
            }
            lyrics.sort((a, b) => a.startTime - b.startTime);
            for (let i = 0; i < lyrics.length - 1; i++) {
                if (!lyrics[i].endTime) lyrics[i].endTime = lyrics[i + 1].startTime;
            }
            return lyrics;
        }

        function applyPlayerStyle(style) {
            const playerView = document.getElementById('player-view');
            const contentWrapper = document.getElementById('player-content-wrapper');
            playerView.classList.remove('style-simple', 'style-cloud');
            playerView.classList.add(`style-${style}`);
            currentPlayerStyle = style;
            localStorage.setItem('playerStyle', style);
            const currentTitle = currentAudioTitle || 'Unknown Song';
            const currentCover = customCoverUrl || currentAudioCover || defaultCover;
            contentWrapper.innerHTML = '';
            if (style === 'simple') {
                contentWrapper.innerHTML = `
                    <div class="simple-title-box"><div id="song-title-box">${currentTitle}</div></div>
                    <img id="album-art" alt="Art" src="${currentCover}">
                    <div class="lyric-bubble" title="点击查看完整歌词"><p id="lyric-display">...</p></div>
                `;
                setupDragAndDrop();
                const lyricBubble = document.querySelector('.lyric-bubble');
                if (lyricBubble) {
                    lyricBubble.style.cursor = 'pointer';
                    lyricBubble.addEventListener('click', () => openFullLyricsModal());
                }
            } else if (style === 'cloud') {
                contentWrapper.innerHTML = `
                    <img id="album-art" alt="Art" src="${currentCover}">
                    <div class="lyric-scroll-container">
                        <div class="cloud-title-box"><div id="song-title-box">${currentTitle}</div></div>
                        <div id="lyric-scroll-content">
                            ${currentLyrics.map((line, i) => `<div class="lyric-scroll-line" data-index="${i}" data-start="${line.startTime}">${line.text}</div>`).join('')}
                        </div>
                    </div>
                `;
                setupDragAndDrop();
                bindLyricClicks();
            } else {
                contentWrapper.innerHTML = `
                    <div class="simple-title-box"><div id="song-title-box">${currentTitle}</div></div>
                    <img id="album-art" alt="Art" src="${currentCover}">
                    <div class="lyric-bubble" title="点击查看完整歌词"><p id="lyric-display">...</p></div>
                `;
                setupDragAndDrop();
                const lyricBubble = document.querySelector('.lyric-bubble');
                if (lyricBubble) {
                    lyricBubble.style.cursor = 'pointer';
                    lyricBubble.addEventListener('click', () => openFullLyricsModal());
                }
            }
            updateStyleMenuActive();
            applyDisplaySettings();
        }

        function applyDisplaySettings() {
            const mode = currentPlayerStyle;
            const storagePrefix = `${mode}_`;
            
            if (mode === 'cloud') {
                const width = localStorage.getItem(`${storagePrefix}lyricBoxWidth`) || '100';
                document.documentElement.style.setProperty('--cloud-lyric-width', `${width}%`);
                
                const height = localStorage.getItem(`${storagePrefix}lyricBoxHeight`) || '60';
                const blur = localStorage.getItem(`${storagePrefix}glassBlurAmount`) || '15';
                const boxOpacity = localStorage.getItem(`${storagePrefix}lyricBoxOpacity`) || '0.1';
                document.documentElement.style.setProperty('--lyric-box-height', `${height}vh`);
                document.documentElement.style.setProperty('--glass-blur-amount', `${blur}px`);
                document.documentElement.style.setProperty('--cloud-lyric-box-bg', `rgba(255, 255, 255, ${boxOpacity})`);
                
                const lyricOpacity = localStorage.getItem(`${storagePrefix}lyricOpacity`) || '1.0';
                document.documentElement.style.setProperty('--lyric-color-opacity', lyricOpacity);
            } else if (mode === 'simple') {
                const width = localStorage.getItem(`${storagePrefix}lyricBoxWidth`) || '90';
                document.documentElement.style.setProperty('--simple-lyric-width', `${width}%`);
                
                const boxOpacity = localStorage.getItem(`${storagePrefix}lyricBoxOpacity`) || '0.15';
                document.documentElement.style.setProperty('--simple-lyric-box-bg', `rgba(255, 255, 255, ${boxOpacity})`);
                
                const blur = localStorage.getItem(`${storagePrefix}glassBlurAmount`) || '10';
                document.documentElement.style.setProperty('--glass-blur-amount', `${blur}px`);
                
                const lyricOpacity = localStorage.getItem(`${storagePrefix}lyricOpacity`) || '1.0';
                document.documentElement.style.setProperty('--lyric-color-opacity', lyricOpacity);
            }
        }
        
        function loadModeSettings(mode) {
            const prefix = mode === 'simple' ? 'simple' : 'cloud';
            const storagePrefix = `${mode}_`;
            
            if (mode === 'simple') {
                const width = localStorage.getItem('simple_lyricBoxWidth') || '90';
                const widthSlider = document.getElementById('simple-lyric-width-slider');
                if (widthSlider) {
                    widthSlider.value = width;
                    document.getElementById('simple-lyric-width-value').textContent = `${width}%`;
                    document.documentElement.style.setProperty('--simple-lyric-width', `${width}%`);
                }
                
                const boxOpacity = localStorage.getItem('simple_lyricBoxOpacity') || '0.15';
                const boxOpacitySlider = document.getElementById('simple-lyric-box-opacity-slider');
                if (boxOpacitySlider) {
                    boxOpacitySlider.value = parseFloat(boxOpacity) * 100;
                    document.getElementById('simple-lyric-box-opacity-value').textContent = boxOpacity;
                    document.documentElement.style.setProperty('--simple-lyric-box-bg', `rgba(255, 255, 255, ${boxOpacity})`);
                }
                
                const blur = localStorage.getItem('simple_glassBlurAmount') || '10';
                const blurSlider = document.getElementById('simple-glass-blur-slider');
                if (blurSlider) {
                    blurSlider.value = blur;
                    document.getElementById('simple-glass-blur-value').textContent = `${blur}px`;
                    document.documentElement.style.setProperty('--glass-blur-amount', `${blur}px`);
                }
                
                const fontSize = localStorage.getItem('simple_lyricFontSize') || '16';
                const fontSizeSlider = document.getElementById('simple-lyric-font-size-slider');
                if (fontSizeSlider) {
                    fontSizeSlider.value = fontSize;
                    document.getElementById('simple-lyric-font-size-value').textContent = `${fontSize}px`;
                    document.documentElement.style.setProperty('--simple-lyric-font-size', `${fontSize}px`);
                }
                
                const coverSize = localStorage.getItem('simple_coverSize') || '220';
                const coverSizeSlider = document.getElementById('simple-cover-size-slider');
                if (coverSizeSlider) {
                    coverSizeSlider.value = coverSize;
                    document.getElementById('simple-cover-size-value').textContent = `${coverSize}px`;
                    document.documentElement.style.setProperty('--simple-cover-size', `${coverSize}px`);
                }
                
                const lyricOpacity = localStorage.getItem('simple_lyricOpacity') || '1.0';
                const lyricOpacitySlider = document.getElementById('simple-lyric-opacity-slider');
                if (lyricOpacitySlider) {
                    lyricOpacitySlider.value = parseFloat(lyricOpacity) * 100;
                    document.getElementById('simple-lyric-opacity-value').textContent = lyricOpacity;
                    document.documentElement.style.setProperty('--lyric-color-opacity', lyricOpacity);
                }
                return;
            }
            
            if (mode === 'cloud') {
                const width = localStorage.getItem(`${storagePrefix}lyricBoxWidth`) || '100';
                document.getElementById(`${prefix}-lyric-width-slider`).value = width;
                document.getElementById(`${prefix}-lyric-width-value`).textContent = `${width}%`;
                document.documentElement.style.setProperty('--cloud-lyric-width', `${width}%`);
                
                const height = localStorage.getItem(`${storagePrefix}lyricBoxHeight`) || '60';
                const blur = localStorage.getItem(`${storagePrefix}glassBlurAmount`) || '15';
                const boxOpacity = localStorage.getItem(`${storagePrefix}lyricBoxOpacity`) || '0.1';
                document.getElementById(`${prefix}-lyric-height-slider`).value = height;
                document.getElementById(`${prefix}-lyric-height-value`).textContent = `${height}%`;
                document.getElementById(`${prefix}-glass-blur-slider`).value = blur;
                document.getElementById(`${prefix}-glass-blur-value`).textContent = `${blur}px`;
                document.getElementById(`${prefix}-lyric-box-opacity-slider`).value = parseFloat(boxOpacity) * 100;
                document.getElementById(`${prefix}-lyric-box-opacity-value`).textContent = boxOpacity;
                document.documentElement.style.setProperty('--lyric-box-height', `${height}vh`);
                document.documentElement.style.setProperty('--glass-blur-amount', `${blur}px`);
                document.documentElement.style.setProperty('--cloud-lyric-box-bg', `rgba(255, 255, 255, ${boxOpacity})`);
                
                const lyricOpacity = localStorage.getItem(`${storagePrefix}lyricOpacity`) || '1.0';
                document.getElementById(`${prefix}-lyric-opacity-slider`).value = parseFloat(lyricOpacity) * 100;
                document.getElementById(`${prefix}-lyric-opacity-value`).textContent = lyricOpacity;
                document.documentElement.style.setProperty('--lyric-color-opacity', lyricOpacity);
            }
        }

        function bindLyricClicks() {
            document.querySelectorAll('.lyric-scroll-line').forEach(line => {
                line.addEventListener('click', () => {
                    const start = parseFloat(line.dataset.start);
                    if (!isNaN(start)) document.getElementById('audio-player').currentTime = start;
                });
            });
        }

        function openFullLyricsModal() {
            const fullLyricsList = document.getElementById('full-lyrics-list');
            if (fullLyricsList && currentLyrics.length > 0) {
                fullLyricsList.innerHTML = currentLyrics.map((line, i) => 
                    `<div class="full-lyric-line" data-index="${i}" data-start="${line.startTime}">${line.text}</div>`
                ).join('');
                fullLyricsList.querySelectorAll('.full-lyric-line').forEach(line => {
                    line.addEventListener('click', () => {
                        const start = parseFloat(line.dataset.start);
                        if (!isNaN(start)) {
                            document.getElementById('audio-player').currentTime = start;
                        }
                    });
                });
            } else if (fullLyricsList) {
                fullLyricsList.innerHTML = '<div class="full-lyric-line" style="color:#666;text-align:center;padding:40px;">暂无歌词</div>';
            }
            document.getElementById('full-lyrics-modal').classList.add('active');
            scrollToCurrentFullLyric();
        }

        function scrollToCurrentFullLyric() {
            const audioPlayer = document.getElementById('audio-player');
            const fullLyricsList = document.getElementById('full-lyrics-list');
            if (!audioPlayer || !fullLyricsList || currentLyrics.length === 0) return;
            const currentTime = audioPlayer.currentTime;
            let activeIndex = -1;
            for (let i = currentLyrics.length - 1; i >= 0; i--) {
                if (currentTime >= currentLyrics[i].startTime) {
                    activeIndex = i;
                    break;
                }
            }
            if (activeIndex >= 0) {
                const activeLine = fullLyricsList.querySelector(`.full-lyric-line[data-index="${activeIndex}"]`);
                if (activeLine) {
                    activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function updateStyleMenuActive() {
            document.querySelectorAll('#style-switch-menu a').forEach(a => {
                a.classList.toggle('active', a.dataset.style === currentPlayerStyle);
            });
        }

        // 歌曲标题滚动效果
        function startTitleScroll() {
            const titleBoxes = document.querySelectorAll('#song-title-box');
            titleBoxes.forEach(titleBox => {
                const titleText = titleBox.textContent;
                if (titleText && titleBox.scrollWidth > titleBox.clientWidth) {
                    let position = 0;
                    const scrollSpeed = 2;
                    const pauseDuration = 2000;
                    
                    function scroll() {
                        if (position >= titleBox.scrollWidth - titleBox.clientWidth) {
                            position = 0;
                            setTimeout(scroll, pauseDuration);
                        } else {
                            position += scrollSpeed;
                            titleBox.scrollLeft = position;
                            requestAnimationFrame(scroll);
                        }
                    }
                    
                    setTimeout(scroll, pauseDuration);
                }
            });
        }

        function setupDragAndDrop() {
            const albumArt = document.getElementById('album-art');
            const simpleTitleBox = document.querySelector('.simple-title-box');
            const cloudTitleBox = document.querySelector('.cloud-title-box');
            const lyricBubble = document.querySelector('.lyric-bubble');
            const lyricScrollContainer = document.querySelector('.lyric-scroll-container');
            
            const draggableElements = [albumArt, simpleTitleBox, cloudTitleBox, lyricBubble, lyricScrollContainer];
            
            draggableElements.forEach(el => {
                if (!el) return;
                let isDragging = false, startX, startY, startLeft, startTop, initialTouchTime;
                
                el.addEventListener('mousedown', e => {
                    if (e.target.closest('.lyric-scroll-line, #lyric-scroll-content')) return;
                    isDragging = true;
                    el.classList.add('dragging');
                    const rect = el.getBoundingClientRect();
                    startX = e.clientX;
                    startY = e.clientY;
                    startLeft = rect.left;
                    startTop = rect.top;
                    if (el.classList.contains('lyric-bubble')) {
                        el.style.bottom = 'auto';
                    }
                    e.preventDefault();
                });
                
                el.addEventListener('touchstart', e => {
                    if (e.target.closest('.lyric-scroll-line, #lyric-scroll-content')) return;
                    isDragging = true;
                    initialTouchTime = Date.now();
                    el.classList.add('dragging');
                    const rect = el.getBoundingClientRect();
                    const touch = e.touches[0];
                    startX = touch.clientX;
                    startY = touch.clientY;
                    startLeft = rect.left;
                    startTop = rect.top;
                    if (el.classList.contains('lyric-bubble')) {
                        el.style.bottom = 'auto';
                    }
                }, { passive: true });
                
                const doDrag = (clientX, clientY) => {
                    if (!isDragging) return;
                    const dx = clientX - startX;
                    const dy = clientY - startY;
                    el.style.left = (startLeft + dx) + 'px';
                    el.style.top = (startTop + dy) + 'px';
                    el.style.transform = 'none';
                };
                
                document.addEventListener('mousemove', e => doDrag(e.clientX, e.clientY));
                
                let touchMoveHandler = (e) => {
                    if (!isDragging) return;
                    const touch = e.touches[0];
                    const dx = Math.abs(touch.clientX - startX);
                    const dy = Math.abs(touch.clientY - startY);
                    if (dx > 10 || dy > 10) {
                        e.preventDefault();
                    }
                    doDrag(touch.clientX, touch.clientY);
                };
                
                document.addEventListener('touchmove', touchMoveHandler, { passive: false });
                
                const endDrag = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    el.classList.remove('dragging');
                };
                
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);
                document.addEventListener('touchcancel', endDrag);
            });
        }

        function setupDiscTouchDrag() {
            const discLists = document.querySelectorAll('.disc-list');
            
            discLists.forEach(discList => {
                let draggedItem = null;
                let draggedIndex = -1;
                let touchStartX = 0;
                let touchStartY = 0;
                let isDragging = false;
                
                discList.addEventListener('touchstart', (e) => {
                    const item = e.target.closest('.disc-item');
                    if (!item) return;
                    
                    draggedItem = item;
                    draggedIndex = Array.from(discList.children).indexOf(item);
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    isDragging = false;
                }, { passive: true });
                
                discList.addEventListener('touchmove', (e) => {
                    if (!draggedItem) return;
                    
                    const touch = e.touches[0];
                    const dx = Math.abs(touch.clientX - touchStartX);
                    const dy = Math.abs(touch.clientY - touchStartY);
                    
                    if (dx > 10 || dy > 10) {
                        isDragging = true;
                        draggedItem.style.opacity = '0.5';
                        draggedItem.style.transform = 'scale(0.95)';
                    }
                }, { passive: true });
                
                discList.addEventListener('touchend', (e) => {
                    if (!draggedItem) return;
                    
                    if (isDragging) {
                        const touch = e.changedTouches[0];
                        const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
                        const targetItem = dropTarget?.closest('.disc-item');
                        
                        if (targetItem && targetItem !== draggedItem) {
                            const targetIndex = Array.from(discList.children).indexOf(targetItem);
                            if (targetIndex > -1) {
                                if (draggedIndex < targetIndex) {
                                    targetItem.after(draggedItem);
                                } else {
                                    targetItem.before(draggedItem);
                                }
                                const items = discList.querySelectorAll('.disc-item');
                                items.forEach((item, index) => {
                                    item.dataset.order = index;
                                });
                            }
                        }
                    }
                    
                    if (draggedItem) {
                        draggedItem.style.opacity = '';
                        draggedItem.style.transform = '';
                    }
                    draggedItem = null;
                    isDragging = false;
                }, { passive: true });
            });
        }

        const bottomPlayer = {
            elements: {},
            currentSong: null,
            isInitialized: false,

            init() {
                this.elements = {
                    container: document.getElementById('bottom-player'),
                    art: document.getElementById('bottom-player-art'),
                    title: document.getElementById('bottom-player-title'),
                    subtitle: document.getElementById('bottom-player-subtitle'),
                    playBtn: document.getElementById('bottom-play-btn'),
                    prevBtn: document.getElementById('bottom-prev-btn'),
                    nextBtn: document.getElementById('bottom-next-btn'),
                    progress: document.getElementById('bottom-progress'),
                    currentTimeEl: document.getElementById('bottom-current-time'),
                    durationEl: document.getElementById('bottom-duration'),
                    infoArea: document.getElementById('bottom-player-info')
                };
                this.setupEvents();
                this.isInitialized = true;
            },

            setupEvents() {
                const el = this.elements;
                el.playBtn?.addEventListener('click', () => this.handlePlayPause());
                el.prevBtn?.addEventListener('click', () => this.handlePrevNext('prev'));
                el.nextBtn?.addEventListener('click', () => this.handlePrevNext('next'));
                el.progress?.addEventListener('input', (e) => this.handleProgress(e));
                el.infoArea?.addEventListener('click', () => this.handleInfoClick());
                el.art?.addEventListener('click', () => this.handleArtClick());
                const audioPlayer = document.getElementById('audio-player');
                audioPlayer?.addEventListener('play', () => this.handleAudioPlay());
                audioPlayer?.addEventListener('pause', () => this.handleAudioPause());
                audioPlayer?.addEventListener('timeupdate', () => this.handleTimeUpdate());
                audioPlayer?.addEventListener('loadedmetadata', () => this.handleLoadedMetadata());
            },

            handlePlayPause() {
                const audioPlayer = document.getElementById('audio-player');
                if (!audioPlayer?.src) {
                    const lastAudioId = localStorage.getItem('lastPlayedAudioId');
                    if (lastAudioId) {
                        playAudio(parseInt(lastAudioId), true);
                    }
                    return;
                }
                if (audioPlayer.paused) audioPlayer.play();
                else audioPlayer.pause();
            },

            async handlePrevNext(direction) {
                const playerView = document.getElementById('player-view');
                const currentId = parseInt(playerView?.dataset?.currentAudioId);
                if (!currentId) return;
                const siblingId = await getSiblingAudioId(currentId, direction);
                if (siblingId) playAudio(siblingId);
            },

            handleProgress(e) {
                const audioPlayer = document.getElementById('audio-player');
                if (audioPlayer && !isNaN(audioPlayer.duration)) {
                    audioPlayer.currentTime = parseFloat(e.target.value);
                }
            },

            handleInfoClick() {
                const playerView = document.getElementById('player-view');
                if (playerView?.dataset?.currentAudioId) navigateTo('player-view');
            },

            handleArtClick() {
                const lyricsList = document.getElementById('full-lyrics-list');
                if (lyricsList && lyricsList.children.length > 0) {
                    document.getElementById('full-lyrics-modal').classList.add('active');
                    scrollToCurrentFullLyric();
                } else {
                    navigateTo('player-view');
                }
            },

            handleAudioPlay() {
                this.elements.playBtn.textContent = '❚❚';
                document.body.classList.remove('no-active-song');
            },

            handleAudioPause() {
                this.elements.playBtn.textContent = '▶';
            },

            handleTimeUpdate() {
                const audioPlayer = document.getElementById('audio-player');
                if (!audioPlayer || isNaN(audioPlayer.duration)) return;
                this.elements.progress.value = audioPlayer.currentTime;
                this.elements.progress.max = audioPlayer.duration;
                this.elements.currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                const remaining = audioPlayer.duration - audioPlayer.currentTime;
                this.elements.durationEl.textContent = '-' + formatTime(remaining);
                const mainProgress = document.getElementById('progress-bar');
                const mainCurrentTime = document.getElementById('current-time');
                const mainDuration = document.getElementById('duration-time');
                if (mainProgress) { mainProgress.value = audioPlayer.currentTime; mainProgress.max = audioPlayer.duration; }
                if (mainCurrentTime) mainCurrentTime.textContent = formatTime(audioPlayer.currentTime);
                if (mainDuration) mainDuration.textContent = '-' + formatTime(remaining);
                this.updateLyricDisplay(audioPlayer.currentTime);
                if (Math.floor(audioPlayer.currentTime) % 5 === 0) {
                    localStorage.setItem('lastPlayedTime', audioPlayer.currentTime);
                }
            },

            handleLoadedMetadata() {
                const audioPlayer = document.getElementById('audio-player');
                if (!audioPlayer || isNaN(audioPlayer.duration)) return;
                this.elements.progress.max = audioPlayer.duration;
                this.elements.durationEl.textContent = formatTime(audioPlayer.duration);
                const mainProgress = document.getElementById('progress-bar');
                const mainDuration = document.getElementById('duration-time');
                if (mainProgress) mainProgress.max = audioPlayer.duration;
                if (mainDuration) mainDuration.textContent = formatTime(audioPlayer.duration);
                const playerView = document.getElementById('player-view');
                const currentAudioId = parseInt(playerView?.dataset?.currentAudioId);
                if (currentAudioId && audioPlayer.duration > 0) {
                    db.audios.update(currentAudioId, { duration: Math.floor(audioPlayer.duration) }).catch(err => {
                        console.warn('保存时长失败:', err);
                    });
                }
            },

            updateLyricDisplay(currentTime) {
                let activeLine = null;
                for (let i = currentLyrics.length - 1; i >= 0; i--) {
                    if (currentTime >= currentLyrics[i].startTime) {
                        activeLine = currentLyrics[i];
                        break;
                    }
                }
                const lyricDisplay = document.getElementById('lyric-display');
                if (lyricDisplay && activeLine) lyricDisplay.textContent = activeLine.text;
                const bottomPlayerLyric = document.getElementById('bottom-player-lyric');
                if (bottomPlayerLyric) {
                    if (activeLine && activeLine.text) {
                        bottomPlayerLyric.textContent = '♪ ' + activeLine.text;
                    } else if (currentLyrics.length === 0) {
                        bottomPlayerLyric.textContent = '♪ 暂无歌词';
                    } else {
                        bottomPlayerLyric.textContent = '♪ ...';
                    }
                }
                document.querySelectorAll('.lyric-scroll-line, .full-lyric-line').forEach((line, i) => {
                    line.classList.toggle('active', currentLyrics[i] && currentTime >= currentLyrics[i].startTime && (!currentLyrics[i].endTime || currentTime < currentLyrics[i].endTime));
                });
            },

            async updateSong(song) {
                if (!song) return;
                this.currentSong = song;
                if (!this.isInitialized) this.init();
                this.elements.title.textContent = song.title;
                this.elements.subtitle.textContent = '正在播放';
                let coverUrl = defaultCover;
                if (song.imageFile) {
                    coverUrl = URL.createObjectURL(song.imageFile);
                    tempObjectURLs.push(coverUrl);
                }
                this.elements.art.src = coverUrl;
                document.body.classList.remove('no-active-song');
            }
        };

        async function getSiblingAudioId(currentId, direction) {
            const audio = await db.audios.get(currentId);
            if (!audio) return null;
            const audios = await db.audios.where('discId').equals(audio.discId).toArray();
            const currentIndex = audios.findIndex(a => a.id === currentId);
            if (currentIndex === -1) return null;
            if (direction === 'next') return audios[(currentIndex + 1) % audios.length]?.id;
            else return audios[(currentIndex - 1 + audios.length) % audios.length]?.id;
        }

        let beautifyInitialized = false;

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [
                parseInt(result[1], 16),
                parseInt(result[2], 16),
                parseInt(result[3], 16)
            ] : null;
        }

        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => {
                const hex = Math.round(Math.max(0, Math.min(255, x))).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function adjustBrightness(r, g, b, factor) {
            return [
                Math.max(0, Math.min(255, r * factor)),
                Math.max(0, Math.min(255, g * factor)),
                Math.max(0, Math.min(255, b * factor))
            ];
        }

        function getComplementaryColor(r, g, b) {
            return [
                255 - r,
                255 - g,
                255 - b
            ];
        }

        function calculateBrightness(r, g, b) {
            return (r * 299 + g * 587 + b * 114) / 1000;
        }

        function generateGradient(startColor, endColor, type = 'diagonal') {
            const startRgb = typeof startColor === 'string' ? hexToRgb(startColor) : startColor;
            let endRgb = typeof endColor === 'string' ? hexToRgb(endColor) : endColor;
            
            let angle = 135;
            let finalStart = startRgb;
            let finalEnd = endRgb;
            
            switch (type) {
                case 'vertical':
                    angle = 180;
                    finalEnd = adjustBrightness(startRgb[0], startRgb[1], startRgb[2], 1.2);
                    break;
                case 'diagonal':
                    angle = 135;
                    if (!endColor) {
                        finalEnd = getComplementaryColor(startRgb[0], startRgb[1], startRgb[2]);
                        finalEnd = adjustBrightness(finalEnd[0], finalEnd[1], finalEnd[2], 0.7);
                    }
                    break;
                case 'radial':
                    angle = 90;
                    finalEnd = adjustBrightness(startRgb[0], startRgb[1], startRgb[2], 0.7);
                    break;
                case 'reverse':
                    angle = 45;
                    finalStart = endRgb || adjustBrightness(startRgb[0], startRgb[1], startRgb[2], 1.3);
                    finalEnd = startRgb;
                    break;
            }
            
            return {
                start: rgbToHex(finalStart[0], finalStart[1], finalStart[2]),
                end: rgbToHex(finalEnd[0], finalEnd[1], finalEnd[2]),
                angle: angle
            };
        }

        const themePresets = {
            default: { 
                name: '默认深色',
                bg: ['#1a1a2e', '#16213e'], 
                bgRgb: [26, 26, 46],
                card: [60, 60, 80], 
                btn: [99, 102, 241],
                text: [255, 255, 255],
                glassOpacity: 0.15,
                borderOpacity: 0.15,
                isDark: true
            },
            ocean: { 
                name: '海洋蓝',
                bg: ['#0c2461', '#1e3799'], 
                bgRgb: [12, 36, 97],
                card: [20, 50, 100], 
                btn: [52, 152, 219],
                text: [255, 255, 255],
                glassOpacity: 0.2,
                borderOpacity: 0.15,
                isDark: true
            },
            sunset: { 
                name: '日落橙',
                bg: ['#ff6b6b', '#feca57'], 
                bgRgb: [255, 107, 107],
                card: [255, 245, 235], 
                btn: [255, 107, 107],
                text: [60, 40, 30],
                glassOpacity: 0.7,
                borderOpacity: 0.2,
                isDark: false
            },
            forest: { 
                name: '森林绿',
                bg: ['#1e5f3f', '#2ecc71'], 
                bgRgb: [30, 95, 63],
                card: [30, 100, 60], 
                btn: [46, 204, 113],
                text: [255, 255, 255],
                glassOpacity: 0.2,
                borderOpacity: 0.15,
                isDark: true
            },
            purple: { 
                name: '梦幻紫',
                bg: ['#4a0e4e', '#8e44ad'], 
                bgRgb: [74, 14, 78],
                card: [100, 50, 120], 
                btn: [155, 89, 182],
                text: [255, 255, 255],
                glassOpacity: 0.2,
                borderOpacity: 0.15,
                isDark: true
            },
            sakura: { 
                name: '樱花粉',
                bg: ['#ffecd2', '#fcb69f'], 
                bgRgb: [255, 236, 210],
                card: [255, 250, 248], 
                btn: [255, 120, 150],
                text: [80, 50, 60],
                glassOpacity: 0.75,
                borderOpacity: 0.2,
                isDark: false
            },
            night: { 
                name: '深夜黑',
                bg: ['#0f0f23', '#1a1a3e'], 
                bgRgb: [15, 15, 35],
                card: [25, 25, 40], 
                btn: [80, 80, 120],
                text: [220, 220, 240],
                glassOpacity: 0.15,
                borderOpacity: 0.15,
                isDark: true
            },
            mint: { 
                name: '薄荷绿',
                bg: ['#a8e6cf', '#88d8b0'], 
                bgRgb: [168, 230, 207],
                card: [245, 255, 250], 
                btn: [0, 180, 130],
                text: [20, 60, 50],
                glassOpacity: 0.8,
                borderOpacity: 0.2,
                isDark: false
            },
            coffee: { 
                name: '咖啡棕',
                bg: ['#3e2723', '#5d4037'], 
                bgRgb: [62, 39, 35],
                card: [80, 50, 40], 
                btn: [161, 136, 127],
                text: [255, 248, 240],
                glassOpacity: 0.2,
                borderOpacity: 0.15,
                isDark: true
            },
            aurora: { 
                name: '极光紫',
                bg: ['#667eea', '#764ba2'], 
                bgRgb: [102, 126, 234],
                card: [118, 75, 162], 
                btn: [102, 126, 234],
                text: [255, 255, 255],
                glassOpacity: 0.25,
                borderOpacity: 0.15,
                isDark: true
            },
            cyber: { 
                name: '赛博朋克',
                bg: ['#0a0a0a', '#1a1a2e'], 
                bgRgb: [10, 10, 10],
                card: [20, 20, 30], 
                btn: [0, 255, 136],
                text: [255, 0, 128],
                glassOpacity: 0.1,
                borderOpacity: 0.3,
                isDark: true
            },
            lightBlue: { 
                name: '天空蓝',
                bg: ['#74b9ff', '#0984e3'], 
                bgRgb: [116, 185, 255],
                card: [240, 248, 255], 
                btn: [9, 132, 227],
                text: [30, 50, 80],
                glassOpacity: 0.8,
                borderOpacity: 0.2,
                isDark: false
            },
            cream: { 
                name: '奶油白',
                bg: ['#ffeaa7', '#fdcb6e'], 
                bgRgb: [255, 234, 167],
                card: [255, 252, 245], 
                btn: [253, 203, 110],
                text: [60, 50, 30],
                glassOpacity: 0.85,
                borderOpacity: 0.2,
                isDark: false
            },
            lavender: { 
                name: '薰衣草',
                bg: ['#dda0dd', '#9b59b6'], 
                bgRgb: [221, 160, 221],
                card: [250, 245, 255], 
                btn: [155, 89, 182],
                text: [60, 40, 80],
                glassOpacity: 0.8,
                borderOpacity: 0.2,
                isDark: false
            }
        };

        const ThemeManager = {
            defaultConfig: {
                activeTheme: 'default',
                isDarkMode: true,
                glassEffect: { bgBlur: 20, bgOpacity: 15, cardBlur: 15, cardOpacity: 20, btnBlur: 10, btnOpacity: 25, saturation: 180 },
                layout: { borderRadius: 16, cardSpacing: 15, cardPadding: 20 },
                animation: { duration: 30, disabled: false, hoverLift: true },
                font: { preset: 'default', size: 16, customUrl: '' },
                gradient: { 
                    enabled: false, 
                    start: '#1a1a2e', 
                    mid: '#16213e',
                    end: '#0f3460', 
                    animation: 'flow',
                    speed: 15,
                    preset: 'custom',
                    noise: false,
                    glow: true
                },
                smartColor: { enabled: false, palette: [], colorScheme: { background: null, card: null, button: null, text: null } }
            },
            config: null,
            saveTimeout: null,
            eventsBound: false,
            gradientContainer: null,
            gradientOverlay: null,
            gradientNoise: null,
            
            async init() {
                await this.loadConfig();
                this.applyAllSettings();
                if (!this.eventsBound) {
                    this.bindEvents();
                    this.eventsBound = true;
                }
            },
            
            async loadConfig() {
                const savedConfig = await db.settings.get('themeConfig');
                this.config = JSON.parse(JSON.stringify(this.defaultConfig));
                if (savedConfig?.value) {
                    this.config = this.deepMerge(this.config, savedConfig.value);
                }
                
                const gradientBg = await db.settings.get('gradientBg');
                if (gradientBg?.value?.enabled) {
                    this.config.gradient.enabled = true;
                    this.config.gradient.start = gradientBg.value.start || this.config.gradient.start;
                    this.config.gradient.mid = gradientBg.value.mid || this.config.gradient.mid;
                    this.config.gradient.end = gradientBg.value.end || this.config.gradient.end;
                    this.config.gradient.animation = gradientBg.value.animation || this.config.gradient.animation;
                    this.config.gradient.speed = gradientBg.value.speed || this.config.gradient.speed;
                    this.config.gradient.noise = gradientBg.value.noise || false;
                    this.config.gradient.glow = gradientBg.value.glow !== false;
                }
            },
            
            async saveConfig() {
                if (this.saveTimeout) clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(async () => {
                    await db.settings.put({ key: 'themeConfig', value: this.config });
                }, 300);
            },
            
            deepMerge(target, source) {
                const result = { ...target };
                for (const key in source) {
                    if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                        result[key] = this.deepMerge(target[key] || {}, source[key]);
                    } else {
                        result[key] = source[key];
                    }
                }
                return result;
            },
            
            applyAllSettings() {
                this.applyTheme(this.config.activeTheme);
                this.applyGlassEffect();
                this.applyLayout();
                this.applyAnimation();
                this.applyFont();
                this.applyGradient();
                if (this.config.smartColor.enabled) this.applySmartColor();
            },
            
            applyTheme(themeName) {
                const theme = themePresets[themeName];
                if (!theme) return;
                this.config.activeTheme = themeName;
                const bgRgb = theme.bgRgb || theme.card;
                const cardRgb = theme.card;
                const btnRgb = theme.btn;
                const textRgb = theme.text;
                const glassOpacity = theme.glassOpacity || 0.15;
                const borderOpacity = theme.borderOpacity || 0.15;
                
                document.documentElement.style.setProperty('--bg-color-rgb', `${bgRgb[0]}, ${bgRgb[1]}, ${bgRgb[2]}`, 'important');
                document.documentElement.style.setProperty('--card-color-rgb', `${cardRgb[0]}, ${cardRgb[1]}, ${cardRgb[2]}`, 'important');
                document.documentElement.style.setProperty('--btn-color-rgb', `${btnRgb[0]}, ${btnRgb[1]}, ${btnRgb[2]}`, 'important');
                document.documentElement.style.setProperty('--text-color-rgb', `${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]}`, 'important');
                document.documentElement.style.setProperty('--primary-rgb', `${btnRgb[0]}, ${btnRgb[1]}, ${btnRgb[2]}`, 'important');
                
                if (theme.isDark) {
                    document.body.classList.remove('light-mode');
                    document.documentElement.style.setProperty('--text-primary', `rgb(${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]})`, 'important');
                    document.documentElement.style.setProperty('--text-secondary', `rgba(${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]}, 0.7)`, 'important');
                    document.documentElement.style.setProperty('--bg-primary', `rgba(${cardRgb[0]}, ${cardRgb[1]}, ${cardRgb[2]}, 0.3)`, 'important');
                    document.documentElement.style.setProperty('--bg-secondary', `rgba(${cardRgb[0]}, ${cardRgb[1]}, ${cardRgb[2]}, 0.2)`, 'important');
                    document.documentElement.style.setProperty('--bg-tertiary', `rgba(${cardRgb[0]}, ${cardRgb[1]}, ${cardRgb[2]}, 0.4)`, 'important');
                    document.documentElement.style.setProperty('--glass-bg', `rgba(${cardRgb[0]}, ${cardRgb[1]}, ${cardRgb[2]}, ${glassOpacity})`, 'important');
                    document.documentElement.style.setProperty('--border-color', `rgba(${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]}, ${borderOpacity})`, 'important');
                    document.documentElement.style.setProperty('--smart-button-text', `rgb(${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]})`, 'important');
                } else {
                    document.body.classList.add('light-mode');
                    document.documentElement.style.setProperty('--text-primary', `rgb(${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]})`, 'important');
                    document.documentElement.style.setProperty('--text-secondary', `rgba(${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]}, 0.6)`, 'important');
                    document.documentElement.style.setProperty('--bg-primary', `rgba(${cardRgb[0]}, ${cardRgb[1]}, ${cardRgb[2]}, 0.5)`, 'important');
                    document.documentElement.style.setProperty('--bg-secondary', `rgba(${cardRgb[0]}, ${cardRgb[1]}, ${cardRgb[2]}, 0.3)`, 'important');
                    document.documentElement.style.setProperty('--bg-tertiary', `rgba(${cardRgb[0]}, ${cardRgb[1]}, ${cardRgb[2]}, 0.6)`, 'important');
                    document.documentElement.style.setProperty('--glass-bg', `rgba(${cardRgb[0]}, ${cardRgb[1]}, ${cardRgb[2]}, ${glassOpacity})`, 'important');
                    document.documentElement.style.setProperty('--border-color', `rgba(${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]}, ${borderOpacity})`, 'important');
                    document.documentElement.style.setProperty('--smart-button-text', `rgb(${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]})`, 'important');
                }
                this.config.isDarkMode = theme.isDark;
                this.saveConfig();
                this.restoreLyricColor();
            },
            
            async restoreLyricColor() {
                const lyricColor = await db.settings.get('lyricColor');
                if (lyricColor?.value) {
                    document.documentElement.style.setProperty('--lyric-color', lyricColor.value, 'important');
                }
            },
            
            applyGlassEffect() {
                const { glassEffect } = this.config;
                const smoothOpacity = (value) => Math.pow(value / 100, 1.3) * 0.6;
                document.documentElement.style.setProperty('--bg-blur', glassEffect.bgBlur + 'px');
                document.documentElement.style.setProperty('--bg-opacity', smoothOpacity(glassEffect.bgOpacity));
                document.documentElement.style.setProperty('--card-blur', glassEffect.cardBlur + 'px');
                document.documentElement.style.setProperty('--card-opacity', smoothOpacity(glassEffect.cardOpacity));
                document.documentElement.style.setProperty('--btn-blur', glassEffect.btnBlur + 'px');
                document.documentElement.style.setProperty('--btn-opacity', smoothOpacity(glassEffect.btnOpacity));
                document.documentElement.style.setProperty('--glass-saturation', glassEffect.saturation + '%');
                this.updateGlassSliders();
            },
            
            updateGlassSliders() {
                const { glassEffect } = this.config;
                const updateSlider = (id, value, suffix) => {
                    const slider = document.getElementById(id);
                    const valueEl = document.getElementById(id.replace('-slider', '-value'));
                    if (slider) slider.value = value;
                    if (valueEl) valueEl.textContent = value + suffix;
                };
                updateSlider('glass-bg-blur-slider', glassEffect.bgBlur, 'px');
                updateSlider('glass-bg-opacity-slider', glassEffect.bgOpacity, '%');
                updateSlider('glass-card-blur-slider', glassEffect.cardBlur, 'px');
                updateSlider('glass-card-opacity-slider', glassEffect.cardOpacity, '%');
                updateSlider('glass-btn-blur-slider', glassEffect.btnBlur, 'px');
                updateSlider('glass-btn-opacity-slider', glassEffect.btnOpacity, '%');
                updateSlider('glass-saturation-slider', glassEffect.saturation, '%');
            },
            
            applyLayout() {
                const { layout } = this.config;
                document.documentElement.style.setProperty('--global-border-radius', layout.borderRadius + 'px');
                document.documentElement.style.setProperty('--card-spacing', layout.cardSpacing + 'px');
                document.documentElement.style.setProperty('--card-padding', layout.cardPadding + 'px');
                const radiusSlider = document.getElementById('border-radius-slider');
                const spacingSlider = document.getElementById('card-spacing-slider');
                const paddingSlider = document.getElementById('card-padding-slider');
                if (radiusSlider) {
                    radiusSlider.value = layout.borderRadius;
                    document.getElementById('border-radius-value').textContent = layout.borderRadius + 'px';
                }
                if (spacingSlider) {
                    spacingSlider.value = layout.cardSpacing;
                    document.getElementById('card-spacing-value').textContent = layout.cardSpacing + 'px';
                }
                if (paddingSlider) {
                    paddingSlider.value = layout.cardPadding;
                    document.getElementById('card-padding-value').textContent = layout.cardPadding + 'px';
                }
            },
            
            applyAnimation() {
                const { animation } = this.config;
                const duration = animation.duration / 100;
                document.documentElement.style.setProperty('--transition-duration', duration + 's');
                if (animation.disabled) {
                    document.body.classList.add('reduce-motion');
                } else {
                    document.body.classList.remove('reduce-motion');
                }
                const durationSlider = document.getElementById('transition-duration-slider');
                if (durationSlider) {
                    durationSlider.value = animation.duration;
                    document.getElementById('transition-duration-value').textContent = duration.toFixed(2) + 's';
                }
                const disableSwitch = document.getElementById('disable-animation-switch');
                if (disableSwitch) disableSwitch.checked = animation.disabled;
                const hoverLiftSwitch = document.getElementById('hover-lift-switch');
                if (hoverLiftSwitch) hoverLiftSwitch.checked = animation.hoverLift;
            },
            
            applyFont() {
                const { font } = this.config;
                document.documentElement.style.setProperty('--global-font-size', font.size + 'px');
                const fontSlider = document.getElementById('font-size-slider');
                if (fontSlider) {
                    fontSlider.value = font.size;
                    document.getElementById('font-size-value').textContent = font.size + 'px';
                }
                const fontSelect = document.getElementById('font-preset-select');
                if (fontSelect) fontSelect.value = font.preset;
            },
            
            applyGradient() {
                const { gradient } = this.config;
                const gradientSwitch = document.getElementById('gradient-bg-switch');
                const gradientSettings = document.getElementById('gradient-settings');
                if (gradientSwitch) gradientSwitch.checked = gradient.enabled;
                if (gradientSettings) gradientSettings.style.display = gradient.enabled ? 'block' : 'none';
                
                this.removeGradientElements();
                
                if (gradient.enabled) {
                    this.createGradientElements();
                }
                
                const startEl = document.getElementById('gradient-start');
                const midEl = document.getElementById('gradient-mid');
                const endEl = document.getElementById('gradient-end');
                const animEl = document.getElementById('gradient-animation');
                const speedEl = document.getElementById('gradient-speed');
                const presetEl = document.getElementById('gradient-preset');
                const noiseEl = document.getElementById('gradient-noise-switch');
                const glowEl = document.getElementById('gradient-glow-switch');
                
                if (startEl) startEl.value = gradient.start;
                if (midEl) midEl.value = gradient.mid;
                if (endEl) endEl.value = gradient.end;
                if (animEl) animEl.value = gradient.animation;
                if (presetEl) presetEl.value = gradient.preset;
                if (noiseEl) noiseEl.checked = gradient.noise;
                if (glowEl) glowEl.checked = gradient.glow;
                if (speedEl) {
                    speedEl.value = gradient.speed;
                    const speedValueEl = document.getElementById('gradient-speed-value');
                    if (speedValueEl) speedValueEl.textContent = gradient.speed + '秒';
                }
            },
            
            createGradientElements() {
                const { gradient } = this.config;
                
                this.gradientContainer = document.createElement('div');
                this.gradientContainer.className = 'dynamic-gradient-bg';
                const animation = gradient.animation || 'flow';
                if (animation === 'static') {
                    this.gradientContainer.classList.add('paused');
                } else if (animation !== 'flow') {
                    this.gradientContainer.classList.add(animation);
                }
                
                const gradientStr = this.buildGradientString();
                this.gradientContainer.style.background = gradientStr;
                this.gradientContainer.style.animationDuration = (gradient.speed || 15) + 's';
                document.body.insertBefore(this.gradientContainer, document.body.firstChild);
                
                if (gradient.glow !== false) {
                    this.gradientOverlay = document.createElement('div');
                    this.gradientOverlay.className = 'gradient-overlay';
                    this.gradientOverlay.style.background = `radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.1) 0%, transparent 50%), radial-gradient(ellipse at 70% 80%, rgba(255,255,255,0.05) 0%, transparent 40%)`;
                    document.body.insertBefore(this.gradientOverlay, document.body.firstChild);
                }
                
                if (gradient.noise) {
                    this.gradientNoise = document.createElement('div');
                    this.gradientNoise.className = 'gradient-noise';
                    document.body.insertBefore(this.gradientNoise, document.body.firstChild);
                }
            },
            
            removeGradientElements() {
                if (this.gradientContainer) {
                    this.gradientContainer.remove();
                    this.gradientContainer = null;
                }
                if (this.gradientOverlay) {
                    this.gradientOverlay.remove();
                    this.gradientOverlay = null;
                }
                if (this.gradientNoise) {
                    this.gradientNoise.remove();
                    this.gradientNoise = null;
                }
            },
            
            buildGradientString() {
                const { gradient } = this.config;
                const start = gradient.start || '#1a1a2e';
                const mid = gradient.mid || '#16213e';
                const end = gradient.end || '#0f3460';
                const animation = gradient.animation || 'flow';
                
                switch (animation) {
                    case 'wave':
                        return `linear-gradient(90deg, ${start}, ${mid}, ${end}, ${mid}, ${start})`;
                    case 'pulse':
                        return `radial-gradient(circle at center, ${start}, ${mid}, ${end})`;
                    case 'rotate':
                        return `linear-gradient(45deg, ${start}, ${mid}, ${end}, ${start})`;
                    case 'static':
                    case 'flow':
                    default:
                        return `linear-gradient(135deg, ${start} 0%, ${mid} 50%, ${end} 100%)`;
                }
            },
            
            applyGradientPreset(presetName) {
                const presets = {
                    sunset: { start: '#ff6b6b', mid: '#feca57', end: '#ff9f43' },
                    ocean: { start: '#0c2461', mid: '#1e3799', end: '#4a69bd' },
                    aurora: { start: '#667eea', mid: '#764ba2', end: '#f093fb' },
                    forest: { start: '#134e5e', mid: '#71b280', end: '#2ecc71' },
                    sakura: { start: '#ffecd2', mid: '#fcb69f', end: '#ff9a9e' },
                    night: { start: '#0f0c29', mid: '#302b63', end: '#24243e' },
                    fire: { start: '#f12711', mid: '#f5af19', end: '#ff6b35' },
                    mint: { start: '#00b09b', mid: '#96c93d', end: '#a8e6cf' },
                    cyber: { start: '#0a0a0a', mid: '#1a1a2e', end: '#00ff88' }
                };
                
                const preset = presets[presetName];
                if (preset) {
                    this.config.gradient.start = preset.start;
                    this.config.gradient.mid = preset.mid;
                    this.config.gradient.end = preset.end;
                    this.config.gradient.preset = presetName;
                    
                    document.getElementById('gradient-start').value = preset.start;
                    document.getElementById('gradient-mid').value = preset.mid;
                    document.getElementById('gradient-end').value = preset.end;
                }
            },
            
            applySmartColor() {
                const { smartColor } = this.config;
                if (!smartColor.enabled || !smartColor.colorScheme) return;
                document.body.classList.add('smart-color-enabled');
                const scheme = smartColor.colorScheme;
                if (scheme.background) document.documentElement.style.setProperty('--bg-color-rgb', `${scheme.background[0]}, ${scheme.background[1]}, ${scheme.background[2]}`);
                if (scheme.card) document.documentElement.style.setProperty('--card-color-rgb', `${scheme.card[0]}, ${scheme.card[1]}, ${scheme.card[2]}`);
                if (scheme.button) {
                    document.documentElement.style.setProperty('--btn-color-rgb', `${scheme.button[0]}, ${scheme.button[1]}, ${scheme.button[2]}`);
                    document.documentElement.style.setProperty('--primary-rgb', `${scheme.button[0]}, ${scheme.button[1]}, ${scheme.button[2]}`);
                }
                if (scheme.text) document.documentElement.style.setProperty('--text-color-rgb', `${scheme.text[0]}, ${scheme.text[1]}, ${scheme.text[2]}`);
            },
            
            bindEvents() {
                document.querySelectorAll('.theme-preset').forEach(preset => {
                    preset.addEventListener('click', async () => {
                        const themeName = preset.dataset.theme;
                        if (themeName === 'custom') return;
                        const theme = themePresets[themeName];
                        if (!theme) return;
                        document.querySelectorAll('.theme-preset').forEach(p => p.classList.remove('active'));
                        preset.classList.add('active');
                        
                        this.removeGradientElements();
                        
                        this.config.gradient.enabled = true;
                        this.config.gradient.start = theme.bg[0];
                        this.config.gradient.mid = theme.bg[0];
                        this.config.gradient.end = theme.bg[1];
                        this.config.gradient.animation = 'flow';
                        this.config.gradient.speed = this.config.gradient.speed || 15;
                        this.config.gradient.glow = this.config.gradient.glow !== false;
                        this.config.gradient.noise = this.config.gradient.noise || false;
                        
                        this.config.smartColor.enabled = false;
                        this.config.activeTheme = themeName;
                        document.body.classList.remove('smart-color-enabled');
                        const smartColorSwitch = document.getElementById('smart-color-switch');
                        if (smartColorSwitch) smartColorSwitch.checked = false;
                        
                        this.createGradientElements();
                        
                        document.getElementById('desktop-view').style.backgroundImage = 'none';
                        document.getElementById('player-view').style.backgroundImage = 'none';
                        this.applyTheme(themeName);
                        
                        await db.settings.delete('desktopBg');
                        await db.settings.delete('playerBg');
                        await db.settings.delete('smartColorEnabled');
                        await db.settings.delete('colorScheme');
                        await db.settings.delete('extractedPalette');
                        await db.settings.put({ key: 'selectedTheme', value: themeName });
                        await db.settings.put({ key: 'theme', value: theme.isDark ? 'dark' : 'light' });
                        const themeSwitch = document.getElementById('theme-switch');
                        if (themeSwitch) themeSwitch.checked = !theme.isDark;
                        this.saveConfig();
                        showToast(`已应用"${theme.name}"主题`);
                    });
                });
                
                const themeSwitch = document.getElementById('theme-switch');
                themeSwitch?.addEventListener('change', async (e) => {
                    const isLight = e.target.checked;
                    document.body.classList.toggle('light-mode', isLight);
                    this.config.isDarkMode = !isLight;
                    await db.settings.put({ key: 'theme', value: isLight ? 'light' : 'dark' });
                    this.saveConfig();
                });
                
                this.bindGlassSliders();
                this.bindLayoutSliders();
                this.bindAnimationControls();
                this.bindFontControls();
                this.bindGradientControls();
                this.bindResetButton();
                this.bindThemeExportImport();
            },
            
            bindGlassSliders() {
                const sliders = [
                    { id: 'glass-bg-blur-slider', key: 'bgBlur', prop: '--bg-blur', suffix: 'px' },
                    { id: 'glass-bg-opacity-slider', key: 'bgOpacity', prop: '--bg-opacity', suffix: '', transform: (v) => Math.pow(v / 100, 1.3) * 0.6 },
                    { id: 'glass-card-blur-slider', key: 'cardBlur', prop: '--card-blur', suffix: 'px' },
                    { id: 'glass-card-opacity-slider', key: 'cardOpacity', prop: '--card-opacity', suffix: '', transform: (v) => Math.pow(v / 100, 1.3) * 0.6 },
                    { id: 'glass-btn-blur-slider', key: 'btnBlur', prop: '--btn-blur', suffix: 'px' },
                    { id: 'glass-btn-opacity-slider', key: 'btnOpacity', prop: '--btn-opacity', suffix: '', transform: (v) => Math.pow(v / 100, 1.3) * 0.6 },
                    { id: 'glass-saturation-slider', key: 'saturation', prop: '--glass-saturation', suffix: '%' }
                ];
                sliders.forEach(({ id, key, prop, suffix, transform }) => {
                    const slider = document.getElementById(id);
                    slider?.addEventListener('input', (e) => {
                        const value = parseInt(e.target.value);
                        this.config.glassEffect[key] = value;
                        const displayValue = transform ? transform(value) : value;
                        document.documentElement.style.setProperty(prop, displayValue + suffix);
                        document.getElementById(id.replace('-slider', '-value')).textContent = value + (suffix || '%');
                        this.saveConfig();
                    });
                });
            },
            
            bindLayoutSliders() {
                const borderRadiusSlider = document.getElementById('border-radius-slider');
                borderRadiusSlider?.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    this.config.layout.borderRadius = value;
                    document.documentElement.style.setProperty('--global-border-radius', value + 'px');
                    document.getElementById('border-radius-value').textContent = value + 'px';
                    this.saveConfig();
                });
                const spacingSlider = document.getElementById('card-spacing-slider');
                spacingSlider?.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    this.config.layout.cardSpacing = value;
                    document.documentElement.style.setProperty('--card-spacing', value + 'px');
                    document.getElementById('card-spacing-value').textContent = value + 'px';
                    this.saveConfig();
                });
                const paddingSlider = document.getElementById('card-padding-slider');
                paddingSlider?.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    this.config.layout.cardPadding = value;
                    document.documentElement.style.setProperty('--card-padding', value + 'px');
                    document.getElementById('card-padding-value').textContent = value + 'px';
                    this.saveConfig();
                });
            },
            
            bindAnimationControls() {
                const durationSlider = document.getElementById('transition-duration-slider');
                durationSlider?.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    this.config.animation.duration = value;
                    const duration = value / 100;
                    document.documentElement.style.setProperty('--transition-duration', duration + 's');
                    document.getElementById('transition-duration-value').textContent = duration.toFixed(2) + 's';
                    this.saveConfig();
                });
                const disableSwitch = document.getElementById('disable-animation-switch');
                disableSwitch?.addEventListener('change', (e) => {
                    this.config.animation.disabled = e.target.checked;
                    document.body.classList.toggle('reduce-motion', e.target.checked);
                    this.saveConfig();
                });
                const hoverLiftSwitch = document.getElementById('hover-lift-switch');
                hoverLiftSwitch?.addEventListener('change', (e) => {
                    this.config.animation.hoverLift = e.target.checked;
                    this.saveConfig();
                });
            },
            
            bindFontControls() {
                const fontSelect = document.getElementById('font-preset-select');
                const customGroup = document.getElementById('custom-font-group');
                fontSelect?.addEventListener('change', async (e) => {
                    const value = e.target.value;
                    customGroup.style.display = value === 'custom' ? 'block' : 'none';
                    const fontUrls = {
                        'noto-sans': 'https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap',
                        'noto-serif': 'https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap',
                        'zcool': 'https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap',
                        'ma-shan': 'https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap'
                    };
                    if (value !== 'default' && value !== 'custom' && fontUrls[value]) {
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = fontUrls[value];
                        document.head.appendChild(link);
                        document.body.style.fontFamily = `'${value.replace('-', ' ')}', sans-serif`;
                    } else if (value === 'default') {
                        document.body.style.fontFamily = '';
                    }
                    this.config.font.preset = value;
                    this.saveConfig();
                    showToast('字体已更换');
                });
                const fontSlider = document.getElementById('font-size-slider');
                fontSlider?.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    this.config.font.size = value;
                    document.documentElement.style.setProperty('--global-font-size', value + 'px');
                    document.getElementById('font-size-value').textContent = value + 'px';
                    this.saveConfig();
                });
            },
            
            bindGradientControls() {
                const gradientSwitch = document.getElementById('gradient-bg-switch');
                const gradientSettings = document.getElementById('gradient-settings');
                
                gradientSwitch?.addEventListener('change', async (e) => {
                    gradientSettings.style.display = e.target.checked ? 'block' : 'none';
                    this.config.gradient.enabled = e.target.checked;
                    
                    if (!e.target.checked) {
                        this.removeGradientElements();
                        document.getElementById('desktop-view').style.backgroundImage = '';
                        await db.settings.delete('desktopBg');
                        await db.settings.delete('gradientBg');
                    } else {
                        this.removeGradientElements();
                        this.createGradientElements();
                    }
                    this.saveConfig();
                });
                
                document.getElementById('gradient-preset')?.addEventListener('change', (e) => {
                    const presetName = e.target.value;
                    if (presetName !== 'custom') {
                        this.applyGradientPreset(presetName);
                    }
                });
                
                document.getElementById('gradient-animation')?.addEventListener('change', (e) => {
                    this.config.gradient.animation = e.target.value;
                    if (this.gradientContainer) {
                        this.gradientContainer.className = 'dynamic-gradient-bg';
                        if (e.target.value === 'static') {
                            this.gradientContainer.classList.add('paused');
                        } else if (e.target.value !== 'flow') {
                            this.gradientContainer.classList.add(e.target.value);
                        }
                        this.gradientContainer.style.background = this.buildGradientString();
                    }
                    this.saveConfig();
                });
                
                document.getElementById('gradient-speed')?.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    this.config.gradient.speed = value;
                    document.getElementById('gradient-speed-value').textContent = value + '秒';
                    if (this.gradientContainer) {
                        this.gradientContainer.style.animationDuration = value + 's';
                    }
                    this.saveConfig();
                });
                
                document.getElementById('gradient-noise-switch')?.addEventListener('change', (e) => {
                    this.config.gradient.noise = e.target.checked;
                    if (e.target.checked && this.config.gradient.enabled && !this.gradientNoise) {
                        this.gradientNoise = document.createElement('div');
                        this.gradientNoise.className = 'gradient-noise';
                        document.body.insertBefore(this.gradientNoise, document.body.firstChild);
                    } else if (!e.target.checked && this.gradientNoise) {
                        this.gradientNoise.remove();
                        this.gradientNoise = null;
                    }
                    this.saveConfig();
                });
                
                document.getElementById('gradient-glow-switch')?.addEventListener('change', (e) => {
                    this.config.gradient.glow = e.target.checked;
                    if (e.target.checked && this.config.gradient.enabled && !this.gradientOverlay) {
                        this.gradientOverlay = document.createElement('div');
                        this.gradientOverlay.className = 'gradient-overlay';
                        this.gradientOverlay.style.background = `radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.1) 0%, transparent 50%), radial-gradient(ellipse at 70% 80%, rgba(255,255,255,0.05) 0%, transparent 40%)`;
                        document.body.insertBefore(this.gradientOverlay, document.body.firstChild);
                    } else if (!e.target.checked && this.gradientOverlay) {
                        this.gradientOverlay.remove();
                        this.gradientOverlay = null;
                    }
                    this.saveConfig();
                });
                
                document.getElementById('apply-gradient-btn')?.addEventListener('click', async () => {
                    this.config.gradient.start = document.getElementById('gradient-start').value;
                    this.config.gradient.mid = document.getElementById('gradient-mid').value;
                    this.config.gradient.end = document.getElementById('gradient-end').value;
                    this.config.gradient.preset = document.getElementById('gradient-preset').value;
                    
                    this.removeGradientElements();
                    this.createGradientElements();
                    
                    document.getElementById('desktop-view').style.backgroundImage = 'none';
                    await db.settings.delete('desktopBg');
                    await db.settings.put({ 
                        key: 'gradientBg', 
                        value: { 
                            enabled: true, 
                            start: this.config.gradient.start, 
                            mid: this.config.gradient.mid,
                            end: this.config.gradient.end, 
                            animation: this.config.gradient.animation,
                            speed: this.config.gradient.speed,
                            noise: this.config.gradient.noise,
                            glow: this.config.gradient.glow
                        } 
                    });
                    
                    document.getElementById('gradient-bg-switch').checked = true;
                    this.config.gradient.enabled = true;
                    this.saveConfig();
                    showToast('动态渐变背景已应用');
                });
            },
            
            bindResetButton() {
                document.getElementById('reset-all-theme-btn')?.addEventListener('click', async () => {
                    if (await showConfirm('重置美化设置', '确定要重置所有美化设置为默认值吗？')) {
                        this.config = JSON.parse(JSON.stringify(this.defaultConfig));
                        await db.settings.delete('themeConfig');
                        await db.settings.delete('selectedTheme');
                        await db.settings.delete('desktopBg');
                        await db.settings.delete('playerBg');
                        await db.settings.delete('gradientBg');
                        await db.settings.delete('smartColorEnabled');
                        await db.settings.delete('colorScheme');
                        await db.settings.delete('extractedPalette');
                        document.body.classList.remove('light-mode', 'smart-color-enabled', 'reduce-motion');
                        document.body.style.cssText = '';
                        document.getElementById('desktop-view').style.backgroundImage = '';
                        document.getElementById('player-view').style.backgroundImage = '';
                        document.querySelectorAll('.theme-preset').forEach(p => p.classList.remove('active'));
                        document.querySelector('.theme-preset[data-theme="default"]')?.classList.add('active');
                        this.applyAllSettings();
                        showToast('已重置为默认设置');
                    }
                });
            },
            
            bindThemeExportImport() {
                document.getElementById('export-theme-btn')?.addEventListener('click', () => {
                    const themeData = { version: 1, timestamp: Date.now(), config: this.config };
                    const blob = new Blob([JSON.stringify(themeData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `yume_theme_${new Date().toISOString().slice(0, 10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('主题已导出');
                });
                document.getElementById('import-theme-btn')?.addEventListener('click', () => {
                    document.getElementById('import-theme-file')?.click();
                });
                document.getElementById('import-theme-file')?.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                        const text = await file.text();
                        const themeData = JSON.parse(text);
                        if (themeData.version && themeData.config) {
                            this.config = this.deepMerge(this.defaultConfig, themeData.config);
                            await db.settings.put({ key: 'themeConfig', value: this.config });
                            this.applyAllSettings();
                            showToast('主题已导入');
                        } else {
                            showToast('无效的主题文件');
                        }
                    } catch (err) {
                        showToast('导入失败: ' + err.message);
                    }
                    e.target.value = '';
                });
            }
        };

        function applyThemeColors(theme) {
            ThemeManager.applyTheme(ThemeManager.config.activeTheme);
        }

        function initGradientControls() {
        }

        async function loadBeautifySettings() {
            if (!ThemeManager.config) {
                await ThemeManager.init();
            }
            const theme = await db.settings.get('theme');
            document.getElementById('theme-switch').checked = theme?.value === 'light';
            const fontSize = await db.settings.get('fontSize');
            const size = fontSize?.value || '16';
            document.getElementById('font-size-slider').value = size;
            document.getElementById('font-size-value').textContent = size + 'px';
            const savedTheme = await db.settings.get('selectedTheme');
            if (savedTheme?.value) {
                document.querySelectorAll('.theme-preset').forEach(p => {
                    p.classList.toggle('active', p.dataset.theme === savedTheme.value);
                });
            }
            if (!beautifyInitialized) {
                initFontPresetSelect();
                beautifyInitialized = true;
            }
            const appConfig = await db.settings.get('appConfig');
            let config = appConfig?.value || defaultAppConfig;
            const defaultIds = defaultAppConfig.map(a => a.id);
            const existingIds = config.map(a => a.id);
            const validConfig = config.filter(app => defaultIds.includes(app.id));
            const missingApps = defaultAppConfig.filter(a => !existingIds.includes(a.id));
            if (missingApps.length > 0 || validConfig.length !== config.length) {
                config = [...validConfig, ...missingApps];
                await db.settings.put({ key: 'appConfig', value: config });
            }
            const container = document.getElementById('app-customize-container');
            container.innerHTML = '';
            config.forEach((app, i) => {
                const row = document.createElement('div');
                row.className = 'app-customize-row';
                let previewStyle = '';
                if (app.icon && app.icon.startsWith('data:')) previewStyle = `background-image:url(${app.icon});background-size:cover;`;
                row.innerHTML = `
                    <div class="preview-icon" style="${previewStyle}">${app.icon && !app.icon.startsWith('data:') ? app.icon : ''}</div>
                    <input type="text" class="app-name-input" value="${app.name}" data-index="${i}">
                    <input type="file" class="app-icon-input" accept="image/*" data-index="${i}" style="display:none;">
                    <button class="select-file-btn" data-index="${i}">换图标</button>
                `;
                container.appendChild(row);
            });
            container.querySelectorAll('.select-file-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    container.querySelector(`.app-icon-input[data-index="${btn.dataset.index}"]`).click();
                });
            });
            container.querySelectorAll('.app-icon-input').forEach(input => {
                input.addEventListener('change', async (e) => {
                    const idx = parseInt(input.dataset.index);
                    const file = e.target.files[0];
                    if (file) {
                        const url = URL.createObjectURL(file);
                        container.querySelectorAll('.preview-icon')[idx].style.backgroundImage = `url(${url})`;
                        container.querySelectorAll('.preview-icon')[idx].textContent = '';
                    }
                });
            });
        }

        function initBorderRadiusControl() {
        }

        function initFontPresetSelect() {
            const select = document.getElementById('font-preset-select');
            const customGroup = document.getElementById('custom-font-group');
            select?.addEventListener('change', async (e) => {
                const value = e.target.value;
                customGroup.style.display = value === 'custom' ? 'block' : 'none';
                const fontUrls = {
                    'noto-sans': 'https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap',
                    'noto-serif': 'https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap',
                    'zcool': 'https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap',
                    'ma-shan': 'https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap'
                };
                if (value !== 'default' && value !== 'custom' && fontUrls[value]) {
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = fontUrls[value];
                    document.head.appendChild(link);
                    document.body.style.fontFamily = `'${value.replace('-', ' ')}', sans-serif`;
                    await db.settings.put({ key: 'fontPreset', value });
                    showToast('字体已更换');
                } else if (value === 'default') {
                    document.body.style.fontFamily = '';
                    await db.settings.put({ key: 'fontPreset', value: 'default' });
                }
            });
        }

        const smartColorSystem = {
            enabled: false,
            colorThief: null,
            palette: [],
            colorScheme: {
                background: null,
                card: null,
                button: null,
                text: null
            },
            init() {
                if (typeof ColorThief !== 'undefined') {
                    this.colorThief = new ColorThief();
                }
            },
            async extractPaletteFromImage(imageSource) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    img.onload = () => {
                        try {
                            if (this.colorThief) {
                                const palette = this.colorThief.getPalette(img, 8);
                                resolve(palette);
                            } else {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                canvas.width = 100;
                                canvas.height = 100;
                                ctx.drawImage(img, 0, 0, 100, 100);
                                const data = ctx.getImageData(0, 0, 100, 100).data;
                                const colorMap = {};
                                for (let i = 0; i < data.length; i += 4) {
                                    const r = Math.round(data[i] / 51) * 51;
                                    const g = Math.round(data[i + 1] / 51) * 51;
                                    const b = Math.round(data[i + 2] / 51) * 51;
                                    const key = `${r},${g},${b}`;
                                    colorMap[key] = (colorMap[key] || 0) + 1;
                                }
                                const sorted = Object.entries(colorMap)
                                    .sort((a, b) => b[1] - a[1])
                                    .slice(0, 8)
                                    .map(([key]) => key.split(',').map(Number));
                                resolve(sorted);
                            }
                        } catch (e) {
                            reject(e);
                        }
                    };
                    img.onerror = () => reject(new Error('图片加载失败'));
                    if (imageSource instanceof Blob) {
                        img.src = URL.createObjectURL(imageSource);
                    } else {
                        img.src = imageSource;
                    }
                });
            },
            calculateBrightness(r, g, b) {
                return (r * 299 + g * 587 + b * 114) / 1000;
            },
            autoAssignColors(palette) {
                if (palette.length < 4) return;
                const sortedByBrightness = [...palette].sort((a, b) => 
                    this.calculateBrightness(...b) - this.calculateBrightness(...a)
                );
                this.colorScheme.background = sortedByBrightness[sortedByBrightness.length - 1] || palette[0];
                this.colorScheme.card = palette[Math.min(1, palette.length - 1)];
                this.colorScheme.button = palette[0];
                this.colorScheme.text = sortedByBrightness[0];
            },
            applyColorScheme() {
                const isLightMode = document.body.classList.contains('light-mode');
                const bgRgb = this.colorScheme.background || [30, 30, 50];
                const cardRgb = this.colorScheme.card || [60, 60, 80];
                const btnRgb = this.colorScheme.button || [99, 102, 241];
                let textRgb = this.colorScheme.text || [255, 255, 255];
                const bgBrightness = this.calculateBrightness(...bgRgb);
                if (!this.colorScheme.text) {
                    textRgb = bgBrightness > 128 ? [51, 51, 51] : [255, 255, 255];
                }
                document.documentElement.style.setProperty('--bg-color-rgb', `${bgRgb[0]}, ${bgRgb[1]}, ${bgRgb[2]}`);
                document.documentElement.style.setProperty('--card-color-rgb', `${cardRgb[0]}, ${cardRgb[1]}, ${cardRgb[2]}`);
                document.documentElement.style.setProperty('--btn-color-rgb', `${btnRgb[0]}, ${btnRgb[1]}, ${btnRgb[2]}`);
                document.documentElement.style.setProperty('--text-color-rgb', `${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]}`);
                document.documentElement.style.setProperty('--primary-rgb', `${btnRgb[0]}, ${btnRgb[1]}, ${btnRgb[2]}`);
                const textColor = isLightMode ? '#333333' : '#ffffff';
                document.documentElement.style.setProperty('--smart-button-text', textColor);
                this.updateSchemePreview();
            },
            updateSchemePreview() {
                const paletteContainer = document.getElementById('extracted-colors');
                if (!paletteContainer) return;
                paletteContainer.innerHTML = '';
                const labels = { background: '背景', card: '卡片', button: '按钮', text: '字体' };
                this.palette.forEach((color, i) => {
                    const [r, g, b] = color;
                    const assigned = Object.entries(this.colorScheme).find(([key, val]) => 
                        val && val[0] === r && val[1] === g && val[2] === b
                    );
                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch';
                    swatch.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                    swatch.style.position = 'relative';
                    if (assigned) {
                        swatch.style.boxShadow = '0 0 0 3px var(--accent-color)';
                        const labelEl = document.createElement('span');
                        labelEl.textContent = labels[assigned[0]];
                        labelEl.style.cssText = `position:absolute;font-size:9px;color:${this.calculateBrightness(r,g,b) > 128 ? '#333' : '#fff'};font-weight:bold;`;
                        swatch.appendChild(labelEl);
                    }
                    swatch.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showColorMenu(color, swatch);
                    });
                    paletteContainer.appendChild(swatch);
                });
                const btnRgb = this.colorScheme.button || [99, 102, 241];
                const isLightMode = document.body.classList.contains('light-mode');
                const textColor = isLightMode ? '#333333' : '#ffffff';
                for (let i = 1; i <= 3; i++) {
                    const btn = document.getElementById(`preview-btn-${i}`);
                    if (btn) {
                        btn.style.background = `rgba(${btnRgb[0]}, ${btnRgb[1]}, ${btnRgb[2]}, 0.15)`;
                        btn.style.color = textColor;
                        btn.style.borderColor = `rgba(${btnRgb[0]}, ${btnRgb[1]}, ${btnRgb[2]}, 0.3)`;
                    }
                }
                const preview = document.getElementById('color-palette-preview');
                if (preview) preview.style.display = 'block';
            },
            showColorMenu(color, swatch) {
                const existingMenu = document.querySelector('.color-use-menu');
                if (existingMenu) existingMenu.remove();
                const menu = document.createElement('div');
                menu.className = 'color-use-menu';
                menu.innerHTML = `
                    <div class="color-menu-item" data-use="background">设为背景色</div>
                    <div class="color-menu-item" data-use="card">设为卡片色</div>
                    <div class="color-menu-item" data-use="button">设为按钮色</div>
                    <div class="color-menu-item" data-use="text">设为字体色</div>
                `;
                menu.style.cssText = `
                    position: fixed;
                    background: rgba(40, 40, 50, 0.95);
                    backdrop-filter: blur(15px);
                    -webkit-backdrop-filter: blur(15px);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 12px;
                    padding: 8px 0;
                    z-index: 10000;
                    min-width: 120px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                `;
                const rect = swatch.getBoundingClientRect();
                menu.style.left = Math.min(rect.left, window.innerWidth - 140) + 'px';
                menu.style.top = Math.min(rect.bottom + 5, window.innerHeight - 180) + 'px';
                document.body.appendChild(menu);
                menu.querySelectorAll('.color-menu-item').forEach(item => {
                    item.style.cssText = `
                        padding: 10px 16px;
                        cursor: pointer;
                        font-size: 13px;
                        color: #fff;
                        transition: background 0.2s;
                    `;
                    item.addEventListener('mouseenter', () => {
                        item.style.background = 'rgba(255,255,255,0.1)';
                    });
                    item.addEventListener('mouseleave', () => {
                        item.style.background = 'transparent';
                    });
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const use = item.dataset.use;
                        this.colorScheme[use] = color;
                        this.applyColorScheme();
                        db.settings.put({ key: 'colorScheme', value: this.colorScheme });
                        menu.remove();
                    });
                });
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                setTimeout(() => document.addEventListener('click', closeMenu), 10);
            },
            async enable() {
                this.enabled = true;
                document.body.classList.add('smart-color-enabled');
                await db.settings.put({ key: 'smartColorEnabled', value: true });
                await this.extractAndApply();
            },
            disable() {
                this.enabled = false;
                document.body.classList.remove('smart-color-enabled');
                document.documentElement.style.setProperty('--primary-rgb', '99, 102, 241');
                document.documentElement.style.setProperty('--smart-button-text', '#ffffff');
                db.settings.put({ key: 'smartColorEnabled', value: false });
            },
            async extractAndApply() {
                let bgFile = null;
                const desktopBg = await db.settings.get('desktopBg');
                const playerBg = await db.settings.get('playerBg');
                
                if (desktopBg?.value) {
                    bgFile = desktopBg.value;
                } else if (playerBg?.value) {
                    bgFile = playerBg.value;
                }
                
                if (!bgFile) {
                    showToast('请先设置桌面或播放器壁纸');
                    return;
                }
                
                try {
                    const palette = await this.extractPaletteFromImage(bgFile);
                    if (palette.length === 0) {
                        showToast('无法提取颜色');
                        return;
                    }
                    this.palette = palette;
                    this.autoAssignColors(palette);
                    this.applyColorScheme();
                    await db.settings.put({ key: 'extractedPalette', value: palette });
                    await db.settings.put({ key: 'colorScheme', value: this.colorScheme });
                    showToast(`成功提取 ${palette.length} 个主色调`);
                } catch (e) {
                    console.error('提取颜色失败:', e);
                    showToast('颜色提取失败');
                }
            }
        };

        async function saveAppConfig() {
            const container = document.getElementById('app-customize-container');
            const inputs = container.querySelectorAll('.app-name-input');
            const iconInputs = container.querySelectorAll('.app-icon-input');
            const config = [];
            for (let i = 0; i < inputs.length; i++) {
                const app = defaultAppConfig[i] ? { ...defaultAppConfig[i] } : { id: `custom_${i}`, icon: '📁', target: 'desktop-view' };
                app.name = inputs[i].value;
                const iconInput = iconInputs[i];
                if (iconInput.files[0]) {
                    app.icon = await fileToDataURL(iconInput.files[0]);
                }
                config.push(app);
            }
            await db.settings.put({ key: 'appConfig', value: config });
            showToast('应用配置已保存');
            renderUI();
        }

        function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        let selectedImportFile = null;
        let importMergeMode = false;

        async function exportAllData(options = {}) {
            const { includeAlbums, includeDiscs, includeAudios, includeImages, includePlaylists, includeSettings } = options;
            showToast('正在导出...');
            const zip = new JSZip();
            
            const albums = includeAlbums ? await db.albums.toArray() : [];
            const discs = includeDiscs ? await db.discs.toArray() : [];
            const audios = includeAudios ? await db.audios.toArray() : [];
            const settings = includeSettings ? await db.settings.toArray() : [];
            const playlists = includePlaylists ? await db.playlists.toArray() : [];
            const playlistItems = includePlaylists ? await db.playlistItems.toArray() : [];
            
            if (includeAlbums) {
                zip.file('albums.json', JSON.stringify(albums.map(a => ({ ...a, cover: a.cover && includeImages ? `albums/${a.id}_cover.jpg` : null }))));
                if (includeImages) {
                    for (const album of albums) {
                        if (album.cover) zip.file(`albums/${album.id}_cover.jpg`, album.cover);
                    }
                }
            }
            
            if (includeDiscs) {
                zip.file('discs.json', JSON.stringify(discs.map(d => ({ ...d, cover: d.cover && includeImages ? `discs/${d.id}_cover.jpg` : null }))));
                if (includeImages) {
                    for (const disc of discs) {
                        if (disc.cover) zip.file(`discs/${disc.id}_cover.jpg`, disc.cover);
                    }
                }
            }
            
            if (includeAudios) {
                zip.file('audios.json', JSON.stringify(audios.map(a => ({
                    ...a,
                    audioFile: a.audioFile ? `audios/${a.id}_audio.mp3` : null,
                    imageFile: a.imageFile && includeImages ? `audios/${a.id}_image.jpg` : null,
                    backgroundImage: a.backgroundImage && includeImages ? `audios/${a.id}_bg.jpg` : null,
                    artistImage: a.artistImage && includeImages ? `audios/${a.id}_artist.jpg` : null
                }))));
                for (const audio of audios) {
                    if (audio.audioFile) zip.file(`audios/${audio.id}_audio.mp3`, audio.audioFile);
                    if (includeImages) {
                        if (audio.imageFile) zip.file(`audios/${audio.id}_image.jpg`, audio.imageFile);
                        if (audio.backgroundImage) zip.file(`audios/${audio.id}_bg.jpg`, audio.backgroundImage);
                        if (audio.artistImage) zip.file(`audios/${audio.id}_artist.jpg`, audio.artistImage);
                    }
                }
            }
            
            if (includeSettings) {
                zip.file('settings.json', JSON.stringify(settings));
            }
            
            if (includePlaylists) {
                zip.file('playlists.json', JSON.stringify(playlists));
                zip.file('playlistItems.json', JSON.stringify(playlistItems));
            }
            
            const content = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = `yume_backup_${new Date().toISOString().slice(0, 10)}.zip`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('导出成功');
        }

        async function importData(merge = false) {
            const input = document.getElementById('import-file-input');
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                selectedImportFile = file;
                importMergeMode = merge;
                const fileNameEl = document.getElementById('selected-file-name');
                fileNameEl.textContent = `已选择: ${file.name}`;
                fileNameEl.style.display = 'block';
                document.getElementById('import-dialog').classList.add('active');
            };
            input.click();
        }

        async function executeImport(options) {
            if (!selectedImportFile) {
                showToast('请先选择备份文件');
                return;
            }
            
            const { includeAlbums, includeDiscs, includeAudios, includeImages, includePlaylists, includeSettings } = options;
            showToast('正在导入...');
            
            try {
                const zip = await JSZip.loadAsync(selectedImportFile);
                
                if (!importMergeMode) {
                    if (includeAudios) await db.audios.clear();
                    if (includeDiscs) await db.discs.clear();
                    if (includeAlbums) await db.albums.clear();
                    if (includeSettings) await db.settings.clear();
                    if (includePlaylists) {
                        await db.playlists.clear();
                        await db.playlistItems.clear();
                    }
                }
                
                if (includeAlbums && zip.file('albums.json')) {
                    const albumsData = JSON.parse(await zip.file('albums.json').async('text'));
                    for (const album of albumsData) {
                        if (album.cover && includeImages) {
                            const file = zip.file(album.cover);
                            if (file) album.cover = await file.async('blob');
                        } else {
                            album.cover = null;
                        }
                        await db.albums.add(album);
                    }
                }
                
                if (includeDiscs && zip.file('discs.json')) {
                    const discsData = JSON.parse(await zip.file('discs.json').async('text'));
                    for (const disc of discsData) {
                        if (disc.cover && includeImages) {
                            const file = zip.file(disc.cover);
                            if (file) disc.cover = await file.async('blob');
                        } else {
                            disc.cover = null;
                        }
                        await db.discs.add(disc);
                    }
                }
                
                if (includeAudios && zip.file('audios.json')) {
                    const audiosData = JSON.parse(await zip.file('audios.json').async('text'));
                    for (const audio of audiosData) {
                        if (audio.audioFile) {
                            const file = zip.file(audio.audioFile);
                            if (file) audio.audioFile = await file.async('blob');
                        }
                        if (audio.imageFile && includeImages) {
                            const file = zip.file(audio.imageFile);
                            if (file) audio.imageFile = await file.async('blob');
                        } else {
                            audio.imageFile = null;
                        }
                        if (audio.backgroundImage && includeImages) {
                            const file = zip.file(audio.backgroundImage);
                            if (file) audio.backgroundImage = await file.async('blob');
                        } else {
                            audio.backgroundImage = null;
                        }
                        if (audio.artistImage && includeImages) {
                            const file = zip.file(audio.artistImage);
                            if (file) audio.artistImage = await file.async('blob');
                        } else {
                            audio.artistImage = null;
                        }
                        await db.audios.add(audio);
                    }
                }
                
                if (includeSettings && zip.file('settings.json')) {
                    const settingsData = JSON.parse(await zip.file('settings.json').async('text'));
                    for (const setting of settingsData) {
                        await db.settings.put(setting);
                    }
                }
                
                if (includePlaylists) {
                    let playlistsData = [];
                    let playlistItemsData = [];
                    try {
                        if (zip.file('playlists.json')) {
                            playlistsData = JSON.parse(await zip.file('playlists.json').async('text'));
                        }
                        if (zip.file('playlistItems.json')) {
                            playlistItemsData = JSON.parse(await zip.file('playlistItems.json').async('text'));
                        }
                    } catch (err) { }
                    for (const playlist of playlistsData) {
                        await db.playlists.add(playlist);
                    }
                    for (const item of playlistItemsData) {
                        await db.playlistItems.add(item);
                    }
                }
                
                showToast('导入成功');
                selectedImportFile = null;
                document.getElementById('selected-file-name').style.display = 'none';
                renderUI();
                renderAlbums();
            } catch (error) {
                console.error('导入失败:', error);
                showToast('导入失败: ' + error.message);
            }
        }

        function checkDirtyBeforeClose(originalData, currentData) {
            return JSON.stringify(originalData) !== JSON.stringify(currentData);
        }

        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                const appIcon = e.target.closest('.app-icon');
                const backBtn = e.target.closest('.back-btn');
                if (appIcon) {
                    e.preventDefault();
                    const target = appIcon.dataset.target;
                    if (target === 'player-view') {
                        const playerView = document.getElementById('player-view');
                        if (playerView.dataset.currentAudioId) {
                            playerPreviousView = 'desktop-view';
                            navigateTo('player-view');
                        } else {
                            showToast('请先从专辑列表选择音频播放');
                        }
                    } else {
                        navigateTo(target);
                        if (target === 'albums-view') renderAlbums();
                        else if (target === 'beautify-view') loadBeautifySettings();
                        else if (target === 'playlists-view') { renderPlaylists(); updateFavoritesCount(); }
                        else if (target === 'artists-view') renderArtists();
                        else if (target === 'video-albums-view') renderVideoAlbums();
                        else if (target === 'video-playlists-view') { renderVideoPlaylists(); updateVideoFavoritesCount(); }
                    }
                }
                if (backBtn) {
                    let target = backBtn.dataset.target;
                    if (backBtn.id === 'player-back-btn') {
                        target = playerPreviousView || 'desktop-view';
                    }
                    if (backBtn.id === 'video-player-back-btn') {
                        target = videoPlayerPreviousView || 'desktop-view';
                        const videoPlayer = document.getElementById('video-player');
                        if (videoPlayer) {
                            videoPlayer.pause();
                        }
                    }
                    if (backBtn.id === 'disc-back-btn') {
                        currentDiscId = null;
                        batchMode = false;
                        selectedAudios.clear();
                        updateBatchToolbar();
                        renderAlbums();
                    }
                    if (backBtn.id === 'video-disc-back-btn') {
                        currentVideoDiscId = null;
                        videoBatchMode = false;
                        selectedVideos.clear();
                        updateVideoBatchToolbar();
                        renderVideoAlbums();
                    }
                    if (target === 'disc-detail-view' && currentAlbumId) {
                        db.albums.get(currentAlbumId).then(album => {
                            if (album) {
                                renderDiscDetail(currentAlbumId, album.name);
                            } else {
                                navigateTo('albums-view');
                            }
                        });
                    } else if (target === 'video-disc-detail-view' && currentVideoAlbumId) {
                        db.videoAlbums.get(currentVideoAlbumId).then(album => {
                            if (album) {
                                renderVideoDiscDetail(currentVideoAlbumId, album.name);
                            } else {
                                navigateTo('video-albums-view');
                            }
                        });
                    } else {
                        navigateTo(target);
                    }
                }
            });

            document.getElementById('create-album-btn')?.addEventListener('click', openCreateAlbumDialog);
            document.getElementById('create-disc-btn')?.addEventListener('click', openCreateDiscDialog);
            document.getElementById('create-video-album-btn')?.addEventListener('click', openCreateVideoAlbumDialog);
            document.getElementById('create-video-disc-btn')?.addEventListener('click', openCreateVideoDiscDialog);
            document.getElementById('sleep-timer-close')?.addEventListener('click', () => {
                clearSleepTimer();
                showToast('已取消睡眠定时');
            });
            
            document.getElementById('favorites-section')?.addEventListener('click', () => {
                renderFavorites();
                navigateTo('favorites-view');
            });
            
            document.getElementById('video-favorites-section')?.addEventListener('click', () => {
                renderVideoFavorites();
                navigateTo('video-favorites-view');
            });
            
            document.getElementById('create-playlist-btn')?.addEventListener('click', createPlaylist);
            document.getElementById('create-video-playlist-btn')?.addEventListener('click', createVideoPlaylist);
            
            const globalSearchInput = document.getElementById('global-search-input');
            const searchResultsDropdown = document.getElementById('search-results-dropdown');
            
            let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            
            function saveSearchHistory(query) {
                if (!query || query.length < 1) return;
                searchHistory = searchHistory.filter(h => h !== query);
                searchHistory.unshift(query);
                searchHistory = searchHistory.slice(0, 10);
                localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            }
            
            function renderSearchHistory() {
                if (searchHistory.length === 0) {
                    searchResultsDropdown.innerHTML = '<div class="search-empty">输入关键词搜索</div>';
                } else {
                    searchResultsDropdown.innerHTML = `
                        <div class="search-history-header">
                            <span>搜索历史</span>
                            <button id="clear-search-history" class="clear-history-btn">清空</button>
                        </div>
                        ${searchHistory.map(h => `
                            <div class="search-history-item" data-query="${h}">
                                <span class="history-icon">🕐</span>
                                <span class="history-text">${h}</span>
                            </div>
                        `).join('')}
                    `;
                    
                    searchResultsDropdown.querySelectorAll('.search-history-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const query = item.dataset.query;
                            globalSearchInput.value = query;
                            performGlobalSearch(query);
                        });
                    });
                    
                    document.getElementById('clear-search-history')?.addEventListener('click', () => {
                        searchHistory = [];
                        localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
                        renderSearchHistory();
                    });
                }
                searchResultsDropdown.classList.add('visible');
            }
            
            async function performGlobalSearch(query) {
                if (!query || query.length < 1) {
                    renderSearchHistory();
                    return;
                }
                
                const q = query.toLowerCase();
                const results = [];
                
                const albums = await db.albums.toArray();
                albums.forEach(album => {
                    if (album.name && album.name.toLowerCase().includes(q)) {
                        results.push({ type: 'album', id: album.id, title: album.name, subtitle: '音频专辑', icon: '💿' });
                    }
                });
                
                const videoAlbums = await db.videoAlbums.toArray();
                videoAlbums.forEach(album => {
                    if (album.name && album.name.toLowerCase().includes(q)) {
                        results.push({ type: 'videoAlbum', id: album.id, title: album.name, subtitle: '视频专辑', icon: '📀' });
                    }
                });
                
                const audios = await db.audios.toArray();
                audios.forEach(audio => {
                    if ((audio.title && audio.title.toLowerCase().includes(q)) ||
                        (audio.artist && audio.artist.toLowerCase().includes(q))) {
                        results.push({ type: 'audio', id: audio.id, title: audio.title || '未知', subtitle: audio.artist || '未知艺术家', discId: audio.discId, icon: '🎵' });
                    }
                });
                
                const videos = await db.videos.toArray();
                videos.forEach(video => {
                    if ((video.title && video.title.toLowerCase().includes(q)) ||
                        (video.artist && video.artist.toLowerCase().includes(q))) {
                        results.push({ type: 'video', id: video.id, title: video.title || '未知', subtitle: video.artist || '未知艺术家', videoDiscId: video.videoDiscId, icon: '🎬' });
                    }
                });
                
                if (results.length === 0) {
                    searchResultsDropdown.innerHTML = '<div class="search-empty">未找到相关内容</div>';
                } else {
                    searchResultsDropdown.innerHTML = results.slice(0, 15).map(r => `
                        <div class="search-result-item" data-type="${r.type}" data-id="${r.id}" data-disc-id="${r.discId || ''}" data-video-disc-id="${r.videoDiscId || ''}">
                            <div class="result-icon">${r.icon}</div>
                            <div class="result-info">
                                <div class="result-title">${r.title}</div>
                                <div class="result-subtitle">${r.subtitle}</div>
                            </div>
                            <div class="result-type-badge">${r.type === 'album' ? '音频专辑' : r.type === 'videoAlbum' ? '视频专辑' : r.type === 'audio' ? '音频' : '视频'}</div>
                        </div>
                    `).join('');
                    
                    searchResultsDropdown.querySelectorAll('.search-result-item').forEach(item => {
                        item.addEventListener('click', async () => {
                            const type = item.dataset.type;
                            const id = parseInt(item.dataset.id);
                            
                            saveSearchHistory(globalSearchInput.value);
                            
                            if (type === 'album') {
                                navigateTo('albums-view');
                                renderAlbums();
                                setTimeout(() => {
                                    const albumEl = document.querySelector(`[data-album-id="${id}"]`);
                                    if (albumEl) albumEl.click();
                                }, 100);
                            } else if (type === 'videoAlbum') {
                                navigateTo('video-albums-view');
                                renderVideoAlbums();
                                setTimeout(() => {
                                    const albumEl = document.querySelector(`[data-video-album-id="${id}"]`);
                                    if (albumEl) albumEl.click();
                                }, 100);
                            } else if (type === 'audio') {
                                const discId = parseInt(item.dataset.discId);
                                if (discId) {
                                    currentDiscId = discId;
                                    await playAudio(id);
                                    navigateTo('player-view');
                                }
                            } else if (type === 'video') {
                                const videoDiscId = parseInt(item.dataset.videoDiscId);
                                if (videoDiscId) {
                                    currentVideoDiscId = videoDiscId;
                                    await playVideo(id);
                                    navigateTo('video-player-view');
                                }
                            }
                            
                            searchResultsDropdown.classList.remove('visible');
                            globalSearchInput.value = '';
                        });
                    });
                }
                
                searchResultsDropdown.classList.add('visible');
            }
            
            globalSearchInput?.addEventListener('input', (e) => {
                performGlobalSearch(e.target.value);
            });
            
            globalSearchInput?.addEventListener('focus', (e) => {
                if (e.target.value) {
                    performGlobalSearch(e.target.value);
                } else {
                    renderSearchHistory();
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.desktop-search-container')) {
                    searchResultsDropdown?.classList.remove('visible');
                }
            });
            
            document.getElementById('artist-search-input')?.addEventListener('input', (e) => {
                renderArtists(e.target.value);
            });
            
            document.getElementById('disc-mode-btn')?.addEventListener('click', () => {
                currentViewMode = 'disc';
                document.getElementById('disc-mode-btn').classList.add('active');
                document.getElementById('list-mode-btn').classList.remove('active');
                if (currentAlbumId) {
                    db.albums.get(currentAlbumId).then(album => {
                        if (album) renderDiscDetail(currentAlbumId, album.name);
                    });
                }
            });
            
            document.getElementById('list-mode-btn')?.addEventListener('click', () => {
                currentViewMode = 'list';
                document.getElementById('list-mode-btn').classList.add('active');
                document.getElementById('disc-mode-btn').classList.remove('active');
                if (currentAlbumId) {
                    db.albums.get(currentAlbumId).then(album => {
                        if (album) renderDiscDetail(currentAlbumId, album.name);
                    });
                }
            });
            
            document.getElementById('audio-sort-select')?.addEventListener('change', (e) => {
                currentSortBy = e.target.value;
                if (currentAlbumId) {
                    db.albums.get(currentAlbumId).then(album => {
                        if (album) renderDiscDetail(currentAlbumId, album.name);
                    });
                }
            });
            
            document.getElementById('sort-order-btn')?.addEventListener('click', () => {
                const btn = document.getElementById('sort-order-btn');
                if (currentSortOrder === 'asc') {
                    currentSortOrder = 'desc';
                    btn.classList.add('desc');
                    btn.title = '倒序';
                } else {
                    currentSortOrder = 'asc';
                    btn.classList.remove('desc');
                    btn.title = '正序';
                }
                if (currentAlbumId) {
                    db.albums.get(currentAlbumId).then(album => {
                        if (album) renderDiscDetail(currentAlbumId, album.name);
                    });
                }
            });
            
            document.getElementById('video-disc-mode-btn')?.addEventListener('click', () => {
                currentVideoViewMode = 'disc';
                document.getElementById('video-disc-mode-btn').classList.add('active');
                document.getElementById('video-list-mode-btn').classList.remove('active');
                if (currentVideoAlbumId) {
                    db.videoAlbums.get(currentVideoAlbumId).then(album => {
                        if (album) renderVideoDiscDetail(currentVideoAlbumId, album.name);
                    });
                }
            });
            
            document.getElementById('video-list-mode-btn')?.addEventListener('click', () => {
                currentVideoViewMode = 'list';
                document.getElementById('video-list-mode-btn').classList.add('active');
                document.getElementById('video-disc-mode-btn').classList.remove('active');
                if (currentVideoAlbumId) {
                    db.videoAlbums.get(currentVideoAlbumId).then(album => {
                        if (album) renderVideoDiscDetail(currentVideoAlbumId, album.name);
                    });
                }
            });
            
            document.getElementById('video-sort-select')?.addEventListener('change', (e) => {
                currentVideoSortBy = e.target.value;
                if (currentVideoAlbumId) {
                    db.videoAlbums.get(currentVideoAlbumId).then(album => {
                        if (album) renderVideoDiscDetail(currentVideoAlbumId, album.name);
                    });
                }
            });
            
            document.getElementById('video-sort-order-btn')?.addEventListener('click', () => {
                const btn = document.getElementById('video-sort-order-btn');
                if (currentVideoSortOrder === 'asc') {
                    currentVideoSortOrder = 'desc';
                    btn.classList.add('desc');
                    btn.title = '倒序';
                } else {
                    currentVideoSortOrder = 'asc';
                    btn.classList.remove('desc');
                    btn.title = '正序';
                }
                if (currentVideoAlbumId) {
                    db.videoAlbums.get(currentVideoAlbumId).then(album => {
                        if (album) renderVideoDiscDetail(currentVideoAlbumId, album.name);
                    });
                }
            });
            
            const videoPlayer = document.getElementById('video-player');
            
            let videoPlayMode = localStorage.getItem('videoPlayMode') || 'sequence';
            const videoPlayModes = ['sequence', 'loop', 'single', 'shuffle'];
            const videoPlayModeIcons = { sequence: '🔁', loop: '🔂', single: '🔂', shuffle: '🔀' };
            const videoPlayModeNames = { sequence: '顺序播放', loop: '列表循环', single: '单曲循环', shuffle: '随机播放' };
            
            function updateVideoPlayModeBtn() {
                const btn = document.getElementById('video-play-mode-btn');
                if (btn) {
                    btn.textContent = videoPlayModeIcons[videoPlayMode];
                    btn.title = videoPlayModeNames[videoPlayMode];
                }
            }
            updateVideoPlayModeBtn();
            
            document.getElementById('video-play-mode-btn')?.addEventListener('click', () => {
                const currentIndex = videoPlayModes.indexOf(videoPlayMode);
                videoPlayMode = videoPlayModes[(currentIndex + 1) % videoPlayModes.length];
                localStorage.setItem('videoPlayMode', videoPlayMode);
                updateVideoPlayModeBtn();
                showToast(videoPlayModeNames[videoPlayMode]);
            });
            
            document.getElementById('video-volume-slider')?.addEventListener('input', (e) => {
                const volume = e.target.value / 100;
                videoPlayer.volume = volume;
                localStorage.setItem('videoVolume', volume);
                const volumeBtn = document.getElementById('video-volume-btn');
                if (volumeBtn) {
                    volumeBtn.textContent = volume === 0 ? '🔇' : volume < 0.5 ? '🔉' : '🔊';
                }
            });
            
            document.getElementById('video-volume-btn')?.addEventListener('click', () => {
                const slider = document.getElementById('video-volume-slider');
                if (videoPlayer.volume > 0) {
                    localStorage.setItem('prevVideoVolume', videoPlayer.volume);
                    videoPlayer.volume = 0;
                    slider.value = 0;
                    document.getElementById('video-volume-btn').textContent = '🔇';
                } else {
                    const prevVol = parseFloat(localStorage.getItem('prevVideoVolume')) || 1;
                    videoPlayer.volume = prevVol;
                    slider.value = prevVol * 100;
                    document.getElementById('video-volume-btn').textContent = prevVol < 0.5 ? '🔉' : '🔊';
                }
            });
            
            const savedVideoVolume = parseFloat(localStorage.getItem('videoVolume'));
            if (savedVideoVolume !== null && !isNaN(savedVideoVolume)) {
                videoPlayer.volume = savedVideoVolume;
                const slider = document.getElementById('video-volume-slider');
                if (slider) slider.value = savedVideoVolume * 100;
                const volumeBtn = document.getElementById('video-volume-btn');
                if (volumeBtn) {
                    volumeBtn.textContent = savedVideoVolume === 0 ? '🔇' : savedVideoVolume < 0.5 ? '🔉' : '🔊';
                }
            }
            
            document.getElementById('video-play-pause-btn')?.addEventListener('click', () => {
                if (videoPlayer.paused) videoPlayer.play();
                else videoPlayer.pause();
            });
            
            document.getElementById('video-prev-btn')?.addEventListener('click', async () => {
                const currentId = parseInt(document.getElementById('video-player-view').dataset.currentVideoId);
                const prevId = await getSiblingVideoId(currentId, 'prev');
                if (prevId) playVideo(prevId);
            });
            
            document.getElementById('video-next-btn')?.addEventListener('click', async () => {
                const currentId = parseInt(document.getElementById('video-player-view').dataset.currentVideoId);
                const nextId = await getSiblingVideoId(currentId, 'next');
                if (nextId) playVideo(nextId);
            });
            
            videoPlayer?.addEventListener('play', () => { 
                document.getElementById('video-play-pause-btn').textContent = '❚❚'; 
            });
            
            videoPlayer?.addEventListener('pause', () => { 
                document.getElementById('video-play-pause-btn').textContent = '▶'; 
            });
            
            videoPlayer?.addEventListener('timeupdate', () => {
                if (!isNaN(videoPlayer.duration)) {
                    document.getElementById('video-current-time').textContent = formatTime(videoPlayer.currentTime);
                    document.getElementById('video-duration-time').textContent = formatTime(videoPlayer.duration);
                }
            });
            
            videoPlayer?.addEventListener('loadedmetadata', () => {
                if (!isNaN(videoPlayer.duration)) {
                    document.getElementById('video-duration-time').textContent = formatTime(videoPlayer.duration);
                    const videoPlayerView = document.getElementById('video-player-view');
                    const currentVideoId = parseInt(videoPlayerView?.dataset?.currentVideoId);
                    if (currentVideoId && videoPlayer.duration > 0) {
                        db.videos.update(currentVideoId, { duration: Math.floor(videoPlayer.duration) }).catch(err => {
                            console.warn('保存视频时长失败:', err);
                        });
                    }
                }
            });
            
            videoPlayer?.addEventListener('ended', async () => {
                const currentId = parseInt(document.getElementById('video-player-view').dataset.currentVideoId);
                
                if (videoPlayMode === 'single') {
                    videoPlayer.currentTime = 0;
                    videoPlayer.play();
                    return;
                }
                
                if (videoPlayMode === 'shuffle') {
                    const allVideos = await db.videos.where('videoDiscId').equals(currentVideoDiscId).toArray();
                    if (allVideos.length > 1) {
                        let randomId;
                        do {
                            randomId = allVideos[Math.floor(Math.random() * allVideos.length)].id;
                        } while (randomId === currentId);
                        playVideo(randomId);
                    }
                    return;
                }
                
                if (videoPlayMode === 'loop' || videoPlayMode === 'sequence') {
                    const nextId = await getSiblingVideoId(currentId, 'next');
                    if (nextId) {
                        playVideo(nextId);
                    } else if (videoPlayMode === 'loop') {
                        const allVideos = await db.videos.where('videoDiscId').equals(currentVideoDiscId).toArray();
                        if (allVideos.length > 0) {
                            playVideo(allVideos[0].id);
                        }
                    }
                }
            });
            
            document.getElementById('video-fullscreen-btn')?.addEventListener('click', () => {
                if (videoPlayer.requestFullscreen) {
                    videoPlayer.requestFullscreen();
                } else if (videoPlayer.webkitRequestFullscreen) {
                    videoPlayer.webkitRequestFullscreen();
                }
            });
            
            document.getElementById('video-settings-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('video-settings-menu').classList.toggle('visible');
            });
            
            document.getElementById('video-playback-speed')?.addEventListener('change', (e) => {
                videoPlayer.playbackRate = parseFloat(e.target.value);
            });
            
            document.querySelectorAll('input[name="video-dialog-source"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('video-dialog-file-group').style.display = e.target.value === 'file' ? 'block' : 'none';
                    document.getElementById('video-dialog-url-group').style.display = e.target.value === 'url' ? 'block' : 'none';
                });
            });
            
            document.getElementById('video-image-input')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    const preview = document.getElementById('video-image-preview');
                    preview.src = url;
                    preview.style.display = 'block';
                    document.getElementById('clear-video-image-btn').style.display = 'block';
                }
            });
            
            document.getElementById('clear-video-image-btn')?.addEventListener('click', () => {
                document.getElementById('video-image-input').value = '';
                document.getElementById('video-image-preview').style.display = 'none';
                document.getElementById('clear-video-image-btn').style.display = 'none';
                videoDialogOriginalImage = null;
            });
            
            document.getElementById('video-cancel-btn')?.addEventListener('click', () => {
                closeAllDialogs();
            });
            
            document.getElementById('video-confirm-btn')?.addEventListener('click', handleVideoConfirm);
            
            document.getElementById('video-batch-mode-btn')?.addEventListener('click', () => {
                videoBatchMode = !videoBatchMode;
                selectedVideos.clear();
                updateVideoBatchToolbar();
                renderVideos(currentVideoDiscId);
            });
            
            document.getElementById('entity-cancel-btn')?.addEventListener('click', async () => {
                const currentName = document.getElementById('entity-name-input').value;
                const hasChanges = currentName !== (dialogOriginalData?.name || '');
                if (hasChanges) {
                    const confirmed = await showConfirm('放弃更改', '有未保存的更改，确定要放弃吗？');
                    if (!confirmed) return;
                }
                closeAllDialogs();
            });
            
            document.getElementById('entity-confirm-btn')?.addEventListener('click', handleEntityConfirm);
            
            document.getElementById('audio-cancel-btn')?.addEventListener('click', async () => {
                const currentTitle = document.getElementById('audio-title-input').value;
                const currentLyric = document.getElementById('audio-lyric-input').value;
                const hasChanges = currentTitle !== (audioDialogOriginalData?.title || '') || 
                                   currentLyric !== (audioDialogOriginalData?.lyric || '');
                if (hasChanges) {
                    const confirmed = await showConfirm('放弃更改', '有未保存的更改，确定要放弃吗？');
                    if (!confirmed) return;
                }
                closeAllDialogs();
            });
            
            document.getElementById('audio-confirm-btn')?.addEventListener('click', handleAudioConfirm);

            document.getElementById('entity-name-input')?.addEventListener('input', () => { isDialogDirty = true; });
            document.getElementById('entity-cover-input')?.addEventListener('change', (e) => {
                isDialogDirty = true;
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    const preview = document.getElementById('entity-cover-preview');
                    preview.src = url;
                    preview.style.display = 'block';
                    document.getElementById('clear-entity-cover-btn').style.display = 'block';
                }
            });
            
            document.getElementById('clear-entity-cover-btn')?.addEventListener('click', () => {
                document.getElementById('entity-cover-input').value = '';
                document.getElementById('entity-cover-preview').style.display = 'none';
                document.getElementById('clear-entity-cover-btn').style.display = 'none';
                isDialogDirty = true;
                isCoverCleared = true;
            });

            document.querySelectorAll('input[name="audio-dialog-source"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('audio-dialog-file-group').style.display = e.target.value === 'file' ? 'block' : 'none';
                    document.getElementById('audio-dialog-url-group').style.display = e.target.value === 'url' ? 'block' : 'none';
                });
            });

            document.getElementById('audio-image-input')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    const preview = document.getElementById('audio-image-preview');
                    preview.src = url;
                    preview.style.display = 'block';
                    document.getElementById('clear-audio-image-btn').style.display = 'block';
                }
            });
            
            document.getElementById('clear-audio-image-btn')?.addEventListener('click', () => {
                document.getElementById('audio-image-input').value = '';
                document.getElementById('audio-image-preview').style.display = 'none';
                document.getElementById('clear-audio-image-btn').style.display = 'none';
                audioDialogOriginalImage = null;
            });
            
            document.getElementById('audio-artist-image-btn')?.addEventListener('click', () => {
                document.getElementById('audio-artist-image-input').click();
            });
            
            document.getElementById('audio-artist-image-input')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    const preview = document.getElementById('audio-artist-image-preview');
                    preview.src = url;
                    preview.style.display = 'block';
                }
            });

            document.getElementById('import-vtt-btn')?.addEventListener('click', () => {
                document.getElementById('vtt-dialog-input').click();
            });

            document.getElementById('vtt-dialog-input')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('audio-lyric-input').value = event.target.result;
                    };
                    reader.readAsText(file);
                }
            });

            const audioPlayer = document.getElementById('audio-player');
            
            let playMode = localStorage.getItem('playMode') || 'sequence';
            const playModes = ['sequence', 'loop', 'single', 'shuffle'];
            const playModeIcons = { sequence: '🔁', loop: '🔂', single: '🔂', shuffle: '🔀' };
            const playModeNames = { sequence: '顺序播放', loop: '列表循环', single: '单曲循环', shuffle: '随机播放' };
            
            function updatePlayModeBtn() {
                const btn = document.getElementById('play-mode-btn');
                if (btn) {
                    btn.textContent = playModeIcons[playMode];
                    btn.title = playModeNames[playMode];
                }
            }
            updatePlayModeBtn();
            
            document.getElementById('play-mode-btn')?.addEventListener('click', () => {
                const currentIndex = playModes.indexOf(playMode);
                playMode = playModes[(currentIndex + 1) % playModes.length];
                localStorage.setItem('playMode', playMode);
                updatePlayModeBtn();
                showToast(playModeNames[playMode]);
            });
            
            document.getElementById('volume-slider')?.addEventListener('input', (e) => {
                const volume = e.target.value / 100;
                audioPlayer.volume = volume;
                localStorage.setItem('volume', volume);
                const volumeBtn = document.getElementById('volume-btn');
                if (volumeBtn) {
                    volumeBtn.textContent = volume === 0 ? '🔇' : volume < 0.5 ? '🔉' : '🔊';
                }
            });
            
            document.getElementById('volume-btn')?.addEventListener('click', () => {
                const slider = document.getElementById('volume-slider');
                if (audioPlayer.volume > 0) {
                    localStorage.setItem('prevVolume', audioPlayer.volume);
                    audioPlayer.volume = 0;
                    slider.value = 0;
                    document.getElementById('volume-btn').textContent = '🔇';
                } else {
                    const prevVol = parseFloat(localStorage.getItem('prevVolume')) || 1;
                    audioPlayer.volume = prevVol;
                    slider.value = prevVol * 100;
                    document.getElementById('volume-btn').textContent = prevVol < 0.5 ? '🔉' : '🔊';
                }
            });
            
            const savedVolume = parseFloat(localStorage.getItem('volume'));
            if (savedVolume !== null && !isNaN(savedVolume)) {
                audioPlayer.volume = savedVolume;
                const slider = document.getElementById('volume-slider');
                if (slider) slider.value = savedVolume * 100;
                const volumeBtn = document.getElementById('volume-btn');
                if (volumeBtn) {
                    volumeBtn.textContent = savedVolume === 0 ? '🔇' : savedVolume < 0.5 ? '🔉' : '🔊';
                }
            }
            
            document.getElementById('play-pause-btn')?.addEventListener('click', () => {
                if (audioPlayer.paused) audioPlayer.play();
                else audioPlayer.pause();
            });
            document.getElementById('prev-btn')?.addEventListener('click', async () => {
                const currentId = parseInt(document.getElementById('player-view').dataset.currentAudioId);
                const prevId = await getSiblingAudioId(currentId, 'prev');
                if (prevId) playAudio(prevId);
            });
            document.getElementById('next-btn')?.addEventListener('click', async () => {
                const currentId = parseInt(document.getElementById('player-view').dataset.currentAudioId);
                const nextId = await getSiblingAudioId(currentId, 'next');
                if (nextId) playAudio(nextId);
            });
            document.getElementById('progress-bar')?.addEventListener('input', (e) => {
                audioPlayer.currentTime = parseFloat(e.target.value);
            });
            audioPlayer?.addEventListener('play', () => { document.getElementById('play-pause-btn').textContent = '❚❚'; });
            audioPlayer?.addEventListener('pause', () => { document.getElementById('play-pause-btn').textContent = '▶'; });
            audioPlayer?.addEventListener('ended', async () => {
                const currentId = parseInt(document.getElementById('player-view').dataset.currentAudioId);
                
                if (playMode === 'single') {
                    audioPlayer.currentTime = 0;
                    audioPlayer.play();
                    return;
                }
                
                if (playMode === 'shuffle') {
                    const allAudios = await db.audios.where('discId').equals(currentDiscId).toArray();
                    if (allAudios.length > 1) {
                        let randomId;
                        do {
                            randomId = allAudios[Math.floor(Math.random() * allAudios.length)].id;
                        } while (randomId === currentId);
                        playAudio(randomId);
                    }
                    return;
                }
                
                if (playMode === 'loop' || playMode === 'sequence' || isContinuousPlay) {
                    const nextId = await getSiblingAudioId(currentId, 'next');
                    if (nextId) {
                        playAudio(nextId);
                    } else if (playMode === 'loop') {
                        const allAudios = await db.audios.where('discId').equals(currentDiscId).toArray();
                        if (allAudios.length > 0) {
                            playAudio(allAudios[0].id);
                        }
                    }
                }
            });

            document.getElementById('style-switch-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllDropdowns();
                document.getElementById('style-switch-menu').classList.add('visible');
            });
            document.getElementById('style-switch-menu')?.addEventListener('click', (e) => {
                const link = e.target.closest('a[data-style]');
                if (link) {
                    applyPlayerStyle(link.dataset.style);
                    document.getElementById('style-switch-menu').classList.remove('visible');
                }
            });
            document.querySelectorAll('.style-settings-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const style = btn.dataset.style;
                    closeAllDropdowns();
                    document.getElementById(`${style}-display-settings`)?.classList.add('visible');
                    loadModeSettings(style);
                });
            });
            document.querySelectorAll('.close-settings-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.mode-display-settings').classList.remove('visible');
                });
            });
            function closeAllModeSettings() {
                document.querySelectorAll('.mode-display-settings').forEach(el => el.classList.remove('visible'));
            }
            
            function closeAllDropdowns() {
                document.getElementById('style-switch-menu')?.classList.remove('visible');
                document.getElementById('player-settings-menu')?.classList.remove('visible');
                document.getElementById('image-settings-menu')?.classList.remove('visible');
                document.getElementById('color-picker')?.classList.remove('visible');
                document.getElementById('video-settings-menu')?.classList.remove('visible');
                closeAllModeSettings();
            }
            
            document.getElementById('image-settings-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllDropdowns();
                document.getElementById('image-settings-menu').classList.add('visible');
            });
            document.getElementById('set-bg-option')?.addEventListener('click', () => {
                document.getElementById('song-bg-input').click();
                document.getElementById('image-settings-menu').classList.remove('visible');
            });
            document.getElementById('set-cover-option')?.addEventListener('click', () => {
                document.getElementById('cover-input').click();
                document.getElementById('image-settings-menu').classList.remove('visible');
            });
            document.getElementById('song-bg-input')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const playerView = document.getElementById('player-view');
                    const currentAudioId = parseInt(playerView?.dataset?.currentAudioId);
                    if (currentAudioId) {
                        await db.audios.update(currentAudioId, { backgroundImage: file });
                        const url = URL.createObjectURL(file);
                        playerView.style.backgroundImage = `url(${url})`;
                        showToast('背景已保存');
                    } else {
                        showToast('请先播放一首歌曲');
                    }
                }
            });
            document.getElementById('cover-input')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const playerView = document.getElementById('player-view');
                    const currentAudioId = parseInt(playerView?.dataset?.currentAudioId);
                    if (currentAudioId) {
                        await db.audios.update(currentAudioId, { imageFile: file });
                        const url = URL.createObjectURL(file);
                        customCoverUrl = url;
                        const albumArt = document.getElementById('album-art');
                        if (albumArt) albumArt.src = url;
                        showToast('封面已保存');
                    } else {
                        showToast('请先播放一首歌曲');
                    }
                }
            });
            function setupModeSlidersGlobal() {
                document.addEventListener('input', (e) => {
                    const target = e.target;
                    if (!target.matches('input[type="range"]')) return;
                    
                    const id = target.id;
                    
                    if (id === 'cloud-lyric-width-slider') {
                        const val = target.value;
                        document.getElementById('cloud-lyric-width-value').textContent = `${val}%`;
                        document.documentElement.style.setProperty('--cloud-lyric-width', `${val}%`);
                        localStorage.setItem('cloud_lyricBoxWidth', val);
                    } else if (id === 'cloud-lyric-height-slider') {
                        const val = target.value;
                        document.getElementById('cloud-lyric-height-value').textContent = `${val}%`;
                        document.documentElement.style.setProperty('--lyric-box-height', `${val}vh`);
                        localStorage.setItem('cloud_lyricBoxHeight', val);
                    } else if (id === 'cloud-glass-blur-slider') {
                        const val = target.value;
                        document.getElementById('cloud-glass-blur-value').textContent = `${val}px`;
                        document.documentElement.style.setProperty('--glass-blur-amount', `${val}px`);
                        localStorage.setItem('cloud_glassBlurAmount', val);
                    } else if (id === 'cloud-lyric-box-opacity-slider') {
                        const val = (target.value / 100).toFixed(2);
                        document.getElementById('cloud-lyric-box-opacity-value').textContent = val;
                        document.documentElement.style.setProperty('--cloud-lyric-box-bg', `rgba(255, 255, 255, ${val})`);
                        localStorage.setItem('cloud_lyricBoxOpacity', val);
                    } else if (id === 'simple-lyric-opacity-slider') {
                        const val = (target.value / 100).toFixed(1);
                        document.getElementById('simple-lyric-opacity-value').textContent = val;
                        document.documentElement.style.setProperty('--lyric-color-opacity', val);
                        localStorage.setItem('simple_lyricOpacity', val);
                    } else if (id === 'simple-lyric-width-slider') {
                        const val = target.value;
                        document.getElementById('simple-lyric-width-value').textContent = `${val}%`;
                        document.documentElement.style.setProperty('--simple-lyric-width', `${val}%`);
                        localStorage.setItem('simple_lyricBoxWidth', val);
                    } else if (id === 'simple-lyric-box-opacity-slider') {
                        const val = (target.value / 100).toFixed(2);
                        document.getElementById('simple-lyric-box-opacity-value').textContent = val;
                        document.documentElement.style.setProperty('--simple-lyric-box-bg', `rgba(255, 255, 255, ${val})`);
                        localStorage.setItem('simple_lyricBoxOpacity', val);
                    } else if (id === 'simple-glass-blur-slider') {
                        const val = target.value;
                        document.getElementById('simple-glass-blur-value').textContent = `${val}px`;
                        document.documentElement.style.setProperty('--glass-blur-amount', `${val}px`);
                        localStorage.setItem('simple_glassBlurAmount', val);
                    } else if (id === 'simple-lyric-font-size-slider') {
                        const val = target.value;
                        document.getElementById('simple-lyric-font-size-value').textContent = `${val}px`;
                        document.documentElement.style.setProperty('--simple-lyric-font-size', `${val}px`);
                        localStorage.setItem('simple_lyricFontSize', val);
                    } else if (id === 'simple-cover-size-slider') {
                        const val = target.value;
                        document.getElementById('simple-cover-size-value').textContent = `${val}px`;
                        document.documentElement.style.setProperty('--simple-cover-size', `${val}px`);
                        localStorage.setItem('simple_coverSize', val);
                    } else if (id === 'cloud-lyric-opacity-slider') {
                        const val = (target.value / 100).toFixed(1);
                        document.getElementById('cloud-lyric-opacity-value').textContent = val;
                        document.documentElement.style.setProperty('--lyric-color-opacity', val);
                        localStorage.setItem('cloud_lyricOpacity', val);
                    }
                });
            }
            
            setupModeSlidersGlobal();
            document.getElementById('toggle-color-picker-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllDropdowns();
                document.getElementById('color-picker').classList.add('visible');
            });
            const colorPicker = document.getElementById('color-picker');
            const colors = ['#ffffff', '#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3'];
            colors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.addEventListener('click', () => {
                    document.documentElement.style.setProperty('--lyric-color', color, 'important');
                    db.settings.put({ key: 'lyricColor', value: color });
                    showToast('歌词颜色已保存');
                });
                colorPicker.appendChild(swatch);
            });
            document.getElementById('player-settings-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllDropdowns();
                document.getElementById('player-settings-menu').classList.add('visible');
            });
            document.getElementById('playback-speed')?.addEventListener('change', (e) => {
                audioPlayer.playbackRate = parseFloat(e.target.value);
            });
            document.querySelectorAll('#player-settings-menu a[data-time]').forEach(a => {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    const time = parseInt(a.dataset.time);
                    if (time === -1) {
                        clearSleepTimer();
                        stopAtSongEnd = true;
                        showToast('将在当前歌曲播放完后停止');
                    } else if (time > 0) {
                        setSleepTimer(time);
                    } else {
                        clearSleepTimer();
                        showToast('睡眠定时器已关闭');
                    }
                    document.getElementById('player-settings-menu').classList.remove('visible');
                });
            });
            document.getElementById('toggle-continuous-play')?.addEventListener('click', (e) => {
                e.preventDefault();
                isContinuousPlay = !isContinuousPlay;
                e.target.textContent = `连续播放: ${isContinuousPlay ? '开启' : '关闭'}`;
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.right-controls')) {
                    closeAllDropdowns();
                }
            });

            document.querySelector('.close-lyrics-btn')?.addEventListener('click', () => {
                document.getElementById('full-lyrics-modal').classList.remove('active');
            });
            document.querySelector('.lyric-bubble')?.addEventListener('dblclick', () => {
                document.getElementById('full-lyrics-modal').classList.add('active');
                scrollToCurrentFullLyric();
            });

            document.getElementById('theme-switch')?.addEventListener('change', async (e) => {
                document.body.classList.toggle('light-mode', e.target.checked);
                await db.settings.put({ key: 'theme', value: e.target.checked ? 'light' : 'dark' });
                showToast('主题已保存');
            });
            document.getElementById('font-size-slider')?.addEventListener('input', async (e) => {
                document.documentElement.style.setProperty('--global-font-size', e.target.value + 'px');
                document.getElementById('font-size-value').textContent = e.target.value + 'px';
                await db.settings.put({ key: 'fontSize', value: e.target.value });
            });
            document.getElementById('save-font-btn')?.addEventListener('click', async () => {
                const url = document.getElementById('font-url-input').value;
                if (url) {
                    document.documentElement.style.setProperty('--global-font', `url(${url})`);
                    await db.settings.put({ key: 'fontUrl', value: url });
                    showToast('字体已保存');
                }
            });
            document.getElementById('bg-file-input')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    document.getElementById('desktop-view').style.backgroundImage = `url(${url})`;
                    document.body.style.backgroundImage = `url(${url})`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundAttachment = 'fixed';
                    await db.settings.put({ key: 'desktopBg', value: file });
                    showToast('桌面背景已保存');
                    if (smartColorSystem.enabled) {
                        setTimeout(() => smartColorSystem.extractAndApply(), 500);
                    }
                }
            });
            document.getElementById('player-bg-input')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    document.getElementById('player-view').style.backgroundImage = `url(${url})`;
                    await db.settings.put({ key: 'playerBg', value: file });
                    showToast('播放器背景已保存');
                    if (smartColorSystem.enabled) {
                        setTimeout(() => smartColorSystem.extractAndApply(), 500);
                    }
                }
            });
            document.getElementById('clear-desktop-bg-btn')?.addEventListener('click', async () => {
                document.getElementById('desktop-view').style.backgroundImage = 'none';
                document.body.style.backgroundImage = 'none';
                document.getElementById('bg-file-input').value = '';
                await db.settings.delete('desktopBg');
                
                const savedTheme = await db.settings.get('selectedTheme');
                const gradientBg = await db.settings.get('gradientBg');
                
                if (savedTheme?.value && themePresets[savedTheme.value]) {
                    const theme = themePresets[savedTheme.value];
                    document.body.style.cssText = `background: linear-gradient(${gradientBg?.value?.angle || 135}deg, ${gradientBg?.value?.start || theme.bg[0]}, ${gradientBg?.value?.end || theme.bg[1]}) !important; background-size: cover; background-position: center; background-attachment: fixed;`;
                    applyThemeColors(theme);
                } else if (gradientBg?.value) {
                    document.body.style.cssText = `background: linear-gradient(${gradientBg.value.angle || 135}deg, ${gradientBg.value.start}, ${gradientBg.value.end}) !important; background-size: cover; background-position: center; background-attachment: fixed;`;
                }
                
                showToast('桌面背景已清除');
            });
            document.getElementById('clear-player-bg-btn')?.addEventListener('click', async () => {
                document.getElementById('player-view').style.backgroundImage = 'none';
                document.getElementById('player-bg-input').value = '';
                await db.settings.delete('playerBg');
                showToast('播放器背景已清除');
            });
            document.getElementById('save-cover-size-btn')?.addEventListener('click', async () => {
                const width = document.getElementById('cover-width-input').value;
                const height = document.getElementById('cover-height-input').value;
                await db.settings.put({ key: 'coverWidth', value: width + 'px' });
                await db.settings.put({ key: 'coverHeight', value: height + 'px' });
                showToast('封面尺寸已保存');
            });
            document.getElementById('save-app-config-btn')?.addEventListener('click', saveAppConfig);

            document.getElementById('export-btn')?.addEventListener('click', () => {
                document.getElementById('export-dialog').classList.add('active');
            });
            document.getElementById('export-cancel-btn')?.addEventListener('click', () => {
                document.getElementById('export-dialog').classList.remove('active');
            });
            document.getElementById('export-confirm-btn')?.addEventListener('click', () => {
                const options = {
                    includeAlbums: document.getElementById('export-albums').checked,
                    includeDiscs: document.getElementById('export-discs').checked,
                    includeAudios: document.getElementById('export-audios').checked,
                    includeImages: document.getElementById('export-images').checked,
                    includePlaylists: document.getElementById('export-playlists').checked,
                    includeSettings: document.getElementById('export-settings').checked
                };
                document.getElementById('export-dialog').classList.remove('active');
                exportAllData(options);
            });
            document.getElementById('import-btn')?.addEventListener('click', () => importData(false));
            document.getElementById('import-merge-btn')?.addEventListener('click', () => importData(true));
            document.getElementById('select-backup-file-btn')?.addEventListener('click', () => {
                document.getElementById('import-select-file-input').click();
            });
            document.getElementById('import-select-file-input')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedImportFile = file;
                    const fileNameEl = document.getElementById('selected-file-name');
                    fileNameEl.textContent = `已选择: ${file.name}`;
                    fileNameEl.style.display = 'block';
                }
            });
            document.getElementById('import-cancel-btn')?.addEventListener('click', () => {
                document.getElementById('import-dialog').classList.remove('active');
                selectedImportFile = null;
                document.getElementById('selected-file-name').style.display = 'none';
            });
            document.getElementById('import-confirm-btn')?.addEventListener('click', () => {
                const options = {
                    includeAlbums: document.getElementById('import-albums').checked,
                    includeDiscs: document.getElementById('import-discs').checked,
                    includeAudios: document.getElementById('import-audios').checked,
                    includeImages: document.getElementById('import-images').checked,
                    includePlaylists: document.getElementById('import-playlists').checked,
                    includeSettings: document.getElementById('import-settings').checked
                };
                document.getElementById('import-dialog').classList.remove('active');
                executeImport(options);
            });
            document.getElementById('clear-data-btn')?.addEventListener('click', async () => {
                const confirmText = prompt('确定要清空所有数据吗？输入"确认清空"继续：');
                if (confirmText === '确认清空') {
                    await db.audios.clear();
                    await db.discs.clear();
                    await db.albums.clear();
                    await db.settings.clear();
                    await db.playlists.clear();
                    await db.playlistItems.clear();
                    showToast('所有数据已清空');
                    renderUI();
                    renderAlbums();
                }
            });
            document.getElementById('clean-cache-btn')?.addEventListener('click', () => {
                revokeURLs();
                if (caches) caches.keys().then(keys => keys.forEach(key => caches.delete(key)));
                showToast('缓存已清理');
            });

            document.getElementById('batch-mode-btn')?.addEventListener('click', toggleBatchMode);
            document.getElementById('batch-delete-btn')?.addEventListener('click', deleteSelectedAudios);
            document.getElementById('batch-add-playlist-btn')?.addEventListener('click', async () => {
                if (selectedAudios.size === 0) {
                    showToast('请先选择音频');
                    return;
                }
                const playlists = await db.playlists.toArray();
                if (playlists.length === 0) {
                    if (await showConfirm('创建播放列表', '还没有播放列表，是否创建一个新的？')) {
                        const name = prompt('请输入播放列表名称：');
                        if (name && name.trim()) {
                            const playlistId = await db.playlists.add({ name: name.trim(), createdAt: Date.now() });
                            for (const audioId of selectedAudios) {
                                await db.playlistItems.add({ playlistId, audioId, createdAt: Date.now() });
                            }
                            showToast(`已添加 ${selectedAudios.size} 首歌曲到播放列表`);
                            batchMode = false;
                            selectedAudios.clear();
                            updateBatchToolbar();
                            renderAudios(currentDiscId);
                        }
                    }
                    return;
                }
                const choice = prompt(`选择播放列表（输入序号）：\n${playlists.map((p, i) => `${i + 1}. ${p.name}`).join('\n')}`);
                if (choice) {
                    const index = parseInt(choice) - 1;
                    if (index >= 0 && index < playlists.length) {
                        let addedCount = 0;
                        for (const audioId of selectedAudios) {
                            const existing = await db.playlistItems.where({ playlistId: playlists[index].id, audioId }).first();
                            if (!existing) {
                                await db.playlistItems.add({ playlistId: playlists[index].id, audioId, createdAt: Date.now() });
                                addedCount++;
                            }
                        }
                        showToast(`已添加 ${addedCount} 首歌曲到"${playlists[index].name}"`);
                        batchMode = false;
                        selectedAudios.clear();
                        updateBatchToolbar();
                        renderAudios(currentDiscId);
                    }
                }
            });
            document.getElementById('batch-cancel-btn')?.addEventListener('click', () => {
                batchMode = false;
                selectedAudios.clear();
                updateBatchToolbar();
                renderAudios(currentDiscId);
            });
            document.getElementById('view-all-history-btn')?.addEventListener('click', () => {
                showToast('最近播放已显示在桌面上');
            });
            document.getElementById('sidebar-settings-btn')?.addEventListener('click', () => {
                document.getElementById('glass-settings-panel').classList.toggle('visible');
                closeSidebar();
            });
            
            document.getElementById('sidebar-toggle')?.addEventListener('click', () => {
                openSidebar();
            });
            
            document.getElementById('sidebar-close')?.addEventListener('click', () => {
                closeSidebar();
            });
            
            document.getElementById('sidebar-overlay')?.addEventListener('click', () => {
                closeSidebar();
            });
            
            document.getElementById('desktop-glass-settings-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('glass-settings-panel').classList.toggle('visible');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#glass-settings-panel') && !e.target.closest('#desktop-glass-settings-btn')) {
                    document.getElementById('glass-settings-panel')?.classList.remove('visible');
                }
            });
            const smoothOpacity = (value) => Math.pow(value / 100, 1.3) * 0.6;
            document.getElementById('bg-blur-slider')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('bg-blur-value').textContent = value + 'px';
                document.documentElement.style.setProperty('--bg-blur', value + 'px');
                localStorage.setItem('bgBlur', value);
            });
            document.getElementById('bg-opacity-slider')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('bg-opacity-value').textContent = value + '%';
                document.documentElement.style.setProperty('--bg-opacity', smoothOpacity(value));
                localStorage.setItem('bgOpacity', value);
            });
            document.getElementById('card-blur-slider')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('card-blur-value').textContent = value + 'px';
                document.documentElement.style.setProperty('--card-blur', value + 'px');
                localStorage.setItem('cardBlur', value);
            });
            document.getElementById('card-opacity-slider')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('card-opacity-value').textContent = value + '%';
                document.documentElement.style.setProperty('--card-opacity', smoothOpacity(value));
                localStorage.setItem('cardOpacity', value);
            });
            document.getElementById('btn-blur-slider')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('btn-blur-value').textContent = value + 'px';
                document.documentElement.style.setProperty('--btn-blur', value + 'px');
                localStorage.setItem('btnBlur', value);
            });
            document.getElementById('btn-opacity-slider')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('btn-opacity-value').textContent = value + '%';
                document.documentElement.style.setProperty('--btn-opacity', smoothOpacity(value));
                localStorage.setItem('btnOpacity', value);
            });
            document.getElementById('smart-color-switch')?.addEventListener('change', async (e) => {
                if (e.target.checked) {
                    await smartColorSystem.enable();
                } else {
                    smartColorSystem.disable();
                }
            });
            document.getElementById('extract-colors-btn')?.addEventListener('click', async () => {
                if (!smartColorSystem.enabled) {
                    smartColorSystem.enabled = true;
                    document.body.classList.add('smart-color-enabled');
                    document.getElementById('smart-color-switch').checked = true;
                    await db.settings.put({ key: 'smartColorEnabled', value: true });
                }
                await smartColorSystem.extractAndApply();
            });
            
            document.getElementById('manual-color-btn')?.addEventListener('click', () => {
                const panel = document.getElementById('manual-color-panel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            });
            
            document.getElementById('manual-color-input')?.addEventListener('input', (e) => {
                document.getElementById('manual-color-hex').textContent = e.target.value;
            });
            
            document.querySelectorAll('.manual-color-assign').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const use = btn.dataset.use;
                    const hex = document.getElementById('manual-color-input').value;
                    const r = parseInt(hex.slice(1, 3), 16);
                    const g = parseInt(hex.slice(3, 5), 16);
                    const b = parseInt(hex.slice(5, 7), 16);
                    
                    if (!smartColorSystem.enabled) {
                        smartColorSystem.enabled = true;
                        document.body.classList.add('smart-color-enabled');
                        document.getElementById('smart-color-switch').checked = true;
                        await db.settings.put({ key: 'smartColorEnabled', value: true });
                    }
                    
                    smartColorSystem.colorScheme[use] = [r, g, b];
                    smartColorSystem.applyColorScheme();
                    await db.settings.put({ key: 'colorScheme', value: smartColorSystem.colorScheme });
                    showToast(`已设置${use === 'background' ? '背景' : use === 'card' ? '卡片' : use === 'button' ? '按钮' : '字体'}颜色`);
                });
            });
            
            document.getElementById('close-manual-color')?.addEventListener('click', () => {
                document.getElementById('manual-color-panel').style.display = 'none';
            });
        }

        async function initApp() {
            await ThemeManager.init();
            
            const theme = await db.settings.get('theme');
            if (theme?.value === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('theme-switch').checked = true;
            }
            const fontSize = await db.settings.get('fontSize');
            if (fontSize?.value) {
                document.documentElement.style.setProperty('--global-font-size', fontSize.value + 'px');
            }
            const lyricColor = await db.settings.get('lyricColor');
            if (lyricColor?.value) {
                document.documentElement.style.setProperty('--lyric-color', lyricColor.value, 'important');
            }
            
            const savedTheme = await db.settings.get('selectedTheme');
            if (savedTheme?.value) {
                document.querySelectorAll('.theme-preset').forEach(p => {
                    p.classList.toggle('active', p.dataset.theme === savedTheme.value);
                });
            }
            
            const desktopBg = await db.settings.get('desktopBg');
            if (desktopBg?.value) {
                const url = URL.createObjectURL(desktopBg.value);
                document.getElementById('desktop-view').style.backgroundImage = `url(${url})`;
                document.body.style.backgroundImage = `url(${url})`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
                ThemeManager.removeGradientElements();
            }
            
            const playerBg = await db.settings.get('playerBg');
            if (playerBg?.value) {
                const url = URL.createObjectURL(playerBg.value);
                document.getElementById('player-view').style.backgroundImage = `url(${url})`;
            }
            const savedStyle = localStorage.getItem('playerStyle');
            if (savedStyle) {
                currentPlayerStyle = savedStyle;
            }
            loadModeSettings(currentPlayerStyle);
            applyDisplaySettings();
            
            updateClock();
            setInterval(updateClock, 1000);
            await renderUI();
            bottomPlayer.init();
            setupEventListeners();
            smartColorSystem.init();
            addRippleToAllButtons();
            document.querySelectorAll('.app-content').forEach(el => el.classList.add('smooth-scroll'));
            const smartColorEnabled = await db.settings.get('smartColorEnabled');
            if (smartColorEnabled?.value) {
                smartColorSystem.enabled = true;
                document.body.classList.add('smart-color-enabled');
                document.getElementById('smart-color-switch').checked = true;
                const savedPalette = await db.settings.get('extractedPalette');
                const savedScheme = await db.settings.get('colorScheme');
                if (savedPalette?.value && Array.isArray(savedPalette.value) && savedPalette.value.length > 0) {
                    smartColorSystem.palette = savedPalette.value;
                    if (savedScheme?.value) {
                        smartColorSystem.colorScheme = savedScheme.value;
                    } else {
                        smartColorSystem.autoAssignColors(savedPalette.value);
                    }
                    smartColorSystem.applyColorScheme();
                }
            }
            const lastAlbumId = localStorage.getItem('lastPlayedAlbumId');
            const lastDiscId = localStorage.getItem('lastPlayedDiscId');
            if (lastAlbumId) currentAlbumId = parseInt(lastAlbumId);
            if (lastDiscId) currentDiscId = parseInt(lastDiscId);
            const lastAudioId = localStorage.getItem('lastPlayedAudioId');
            if (lastAudioId) {
                const audio = await db.audios.get(parseInt(lastAudioId));
                if (audio) {
                    let coverUrl = defaultCover;
                    if (audio.imageFile) {
                        coverUrl = URL.createObjectURL(audio.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                    currentAudioCover = coverUrl;
                    currentAudioTitle = audio.title;
                    if (audio.lyrics) {
                        currentLyrics = parseLyrics(audio.lyrics);
                    }
                    const playerView = document.getElementById('player-view');
                    if (playerView) {
                        playerView.dataset.currentAudioId = lastAudioId;
                    }
                    applyPlayerStyle(currentPlayerStyle);
                    bottomPlayer.elements.title.textContent = audio.title;
                    bottomPlayer.elements.subtitle.textContent = '已暂停';
                    bottomPlayer.elements.art.src = coverUrl;
                    document.body.classList.remove('no-active-song');
                    const savedTime = parseFloat(localStorage.getItem('lastPlayedTime')) || 0;
                    bottomPlayer.elements.currentTimeEl.textContent = formatTime(savedTime);
                    bottomPlayer.elements.durationEl.textContent = audio.duration ? formatTime(audio.duration) : '00:00';
                }
            } else {
                applyPlayerStyle(currentPlayerStyle);
            }
            
            initPlayQueue();
            initMediaTabs();
            setupAudioKeyboardControls();
            setupDiscTouchDrag();
        }

        function initPlayQueue() {
            const queuePanel = document.getElementById('play-queue-panel');
            const queueOverlay = document.getElementById('queue-overlay');
            const closeBtn = document.getElementById('close-queue-btn');
            const clearBtn = document.getElementById('clear-queue-btn');
            const openBtn = document.getElementById('open-queue-btn');
            
            function openQueue() {
                queuePanel.classList.add('open');
                queueOverlay.classList.add('visible');
                renderPlayQueue();
            }
            
            function closeQueue() {
                queuePanel.classList.remove('open');
                queueOverlay.classList.remove('visible');
            }
            
            openBtn?.addEventListener('click', openQueue);
            closeBtn?.addEventListener('click', closeQueue);
            queueOverlay?.addEventListener('click', closeQueue);
            
            clearBtn?.addEventListener('click', async () => {
                if (await showConfirm('清空播放队列', '确定要清空播放队列吗？')) {
                    await mediaManager.clearQueue();
                    renderPlayQueue();
                    showToast('播放队列已清空');
                }
            });
            
            window.openPlayQueue = openQueue;
            window.closePlayQueue = closeQueue;
        }

        async function renderPlayQueue() {
            const queueList = document.getElementById('queue-list');
            const emptyTip = document.getElementById('queue-empty-tip');
            
            await mediaManager.loadQueue();
            
            if (mediaManager.playQueue.length === 0) {
                queueList.innerHTML = '';
                emptyTip.classList.add('visible');
                return;
            }
            
            emptyTip.classList.remove('visible');
            queueList.innerHTML = '';
            
            for (let i = 0; i < mediaManager.playQueue.length; i++) {
                const item = mediaManager.playQueue[i];
                let mediaData = null;
                let coverUrl = defaultCover;
                
                if (item.mediaType === 'audio') {
                    mediaData = await db.audios.get(item.mediaItemId);
                    if (mediaData?.imageFile) {
                        coverUrl = URL.createObjectURL(mediaData.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                } else if (item.mediaType === 'video') {
                    mediaData = await db.videos.get(item.mediaItemId);
                    if (mediaData?.imageFile) {
                        coverUrl = URL.createObjectURL(mediaData.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                }
                
                if (!mediaData) continue;
                
                const queueItem = document.createElement('div');
                queueItem.className = 'queue-item' + (i === mediaManager.currentIndex ? ' playing' : '');
                queueItem.innerHTML = `
                    <div class="queue-item-icon">${item.mediaType === 'audio' ? '🎵' : '🎬'}</div>
                    <div class="queue-item-info">
                        <div class="queue-item-title">${mediaData.title}</div>
                        <div class="queue-item-meta">${mediaData.artist || '未知艺术家'} · ${mediaData.duration ? formatTime(mediaData.duration) : '未知时长'}</div>
                    </div>
                    <button class="queue-item-remove" data-id="${item.id}" title="从队列移除">✕</button>
                `;
                
                queueItem.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('queue-item-remove')) {
                        e.stopPropagation();
                        await mediaManager.removeFromQueue(item.id);
                        renderPlayQueue();
                        showToast('已从队列移除');
                        return;
                    }
                    
                    mediaManager.currentIndex = i;
                    if (item.mediaType === 'audio') {
                        await playAudio(item.mediaItemId);
                    } else if (item.mediaType === 'video') {
                        await playVideo(item.mediaItemId);
                    }
                    renderPlayQueue();
                });
                
                queueList.appendChild(queueItem);
            }
        }

        async function addToPlayQueue(mediaId, mediaType) {
            await mediaManager.addToQueue(mediaId, mediaType);
            showToast(mediaType === 'audio' ? '已添加到播放队列' : '已添加到播放队列');
        }

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    if (currentMedia === 'audio' && audioPlayer) {
                        if (audioPlayer.paused) {
                            audioPlayer.play();
                        } else {
                            audioPlayer.pause();
                        }
                    } else if (currentMedia === 'video' && videoPlayer) {
                        if (videoPlayer.paused) {
                            videoPlayer.play();
                        } else {
                            videoPlayer.pause();
                        }
                    }
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if (currentMedia === 'audio' && audioPlayer) {
                        audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);
                    } else if (currentMedia === 'video' && videoPlayer) {
                        videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 10);
                    }
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    if (currentMedia === 'audio' && audioPlayer) {
                        audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 10);
                    } else if (currentMedia === 'video' && videoPlayer) {
                        videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 10);
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (currentMedia === 'audio' && audioPlayer) {
                        audioPlayer.volume = Math.min(1, audioPlayer.volume + 0.1);
                    } else if (currentMedia === 'video' && videoPlayer) {
                        videoPlayer.volume = Math.min(1, videoPlayer.volume + 0.1);
                    }
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    if (currentMedia === 'audio' && audioPlayer) {
                        audioPlayer.volume = Math.max(0, audioPlayer.volume - 0.1);
                    } else if (currentMedia === 'video' && videoPlayer) {
                        videoPlayer.volume = Math.max(0, videoPlayer.volume - 0.1);
                    }
                    break;
                case 'KeyM':
                    e.preventDefault();
                    if (currentMedia === 'audio' && audioPlayer) {
                        audioPlayer.muted = !audioPlayer.muted;
                    } else if (currentMedia === 'video' && videoPlayer) {
                        videoPlayer.muted = !videoPlayer.muted;
                    }
                    break;
                case 'KeyQ':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        openPlayQueue?.();
                    }
                    break;
                case 'Escape':
                    closePlayQueue?.();
                    break;
            }
        });

        document.addEventListener('DOMContentLoaded', initApp);
    })();
    </script>
</body>
</html>

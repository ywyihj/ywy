<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>yume播放器</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzg4OCIgc3Ryb2tlLXdpZHRoPSIyIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCI+PC9jaXJjbGU+PHBhdGggZD0ibTE2IDgtOCAzIDggMyB6IiAvPjwvc3ZnPg==">
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-secondary: linear-gradient(135deg, #1f1f2e 0%, #252540 100%);
            --bg-tertiary: rgba(40, 40, 60, 0.8);
            --bg-app: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: rgba(255, 255, 255, 0.15);
            --global-font: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            --lyric-color: #ffffff;
            --global-font-size: 16px;
            --glass-blur: 20px;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-bg-hover: rgba(255, 255, 255, 0.12);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --glass-blur-amount: 15px;
            --glass-opacity: 0.15;
            --bg-blur: 20px;
            --bg-opacity: 0.15;
            --card-blur: 15px;
            --card-opacity: 0.2;
            --btn-blur: 10px;
            --btn-opacity: 0.25;
            --bg-color-rgb: 30, 30, 50;
            --card-color-rgb: 60, 60, 80;
            --btn-color-rgb: 99, 102, 241;
            --text-color-rgb: 255, 255, 255;
            --primary-rgb: 99, 102, 241;
            --smart-button-bg: rgba(var(--primary-rgb), 0.15);
            --smart-button-border: rgba(var(--primary-rgb), 0.3);
            --smart-button-hover: rgba(var(--primary-rgb), 0.25);
            --smart-button-text: #ffffff;
            --smart-icon-bg: rgba(var(--primary-rgb), 0.12);
            --smart-card-bg: rgba(var(--primary-rgb), 0.08);
            --smart-bg-overlay: linear-gradient(135deg, rgba(var(--primary-rgb), 0.1), rgba(var(--primary-rgb), 0.05));
            --accent-color: #1DB954;
        }
        body.light-mode {
            --bg-primary: linear-gradient(135deg, #f5f5f5 0%, #e8e8f0 50%, #dddde8 100%);
            --bg-secondary: linear-gradient(135deg, #ffffff 0%, #f5f5fa 100%);
            --bg-tertiary: rgba(230, 230, 240, 0.9);
            --bg-app: rgba(0, 0, 0, 0.05);
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-bg-hover: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --smart-button-text: #333333;
            background-color: #f5f5f5;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: var(--global-font); color: var(--text-primary); background-color: #121212; background-size: cover; background-position: center; background-attachment: fixed; transition: background-color 0.3s, color 0.3s; font-size: var(--global-font-size); }
        button, input[type="file"], select { cursor: pointer; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-sizing: border-box; transition: opacity 0.4s ease, transform 0.4s ease; opacity: 0; transform: scale(1.05); pointer-events: none; background-color: var(--bg-primary); }
        .view.active { opacity: 1; transform: scale(1); pointer-events: auto; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)) saturate(180%); -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(180%); border: 1px solid var(--glass-border); border-radius: 16px; box-shadow: var(--glass-shadow); transition: all 0.3s ease; }
        .glass-card:hover { background: var(--glass-bg-hover); border-color: rgba(255, 255, 255, 0.3); transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4); }
        .glass-button { padding: 12px 24px; background: rgba(80, 80, 100, var(--btn-opacity)); backdrop-filter: blur(var(--btn-blur)); -webkit-backdrop-filter: blur(var(--btn-blur)); border: 1px solid var(--glass-border); border-radius: 12px; color: var(--text-primary); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
        .glass-button:hover { background: rgba(100, 100, 120, calc(var(--btn-opacity) * 1.3)); border-color: rgba(255, 255, 255, 0.4); transform: translateY(-1px); }
        .glass-button:active { transform: translateY(0); }
        .glass-button.primary { background: rgba(29, 185, 84, 0.3); border-color: rgba(29, 185, 84, 0.5); }
        .glass-button.danger { background: rgba(255, 0, 0, 0.2); border-color: rgba(255, 0, 0, 0.4); }
        .glass-modal { background: var(--bg-secondary); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
        #desktop-view { background-size: cover; background-position: center; display: flex; flex-direction: column; padding: 20px; }
        .desktop-header { text-align: center; text-shadow: 0 0 10px rgba(0,0,0,0.7); margin-top: 40px; }
        .desktop-time { font-size: 72px; font-weight: 600; }
        .desktop-date { font-size: 22px; opacity: 0.9; margin-top: 4px; }
        .desktop-main { display: flex; flex: 1; justify-content: center; align-items: center; gap: 30px; padding: 20px; }
        .app-dock { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-primary); width: 80px; cursor: pointer; }
        .app-icon .icon-bg { width: 60px; height: 60px; background: rgba(80, 80, 100, var(--btn-opacity)); backdrop-filter: blur(var(--btn-blur)); -webkit-backdrop-filter: blur(var(--btn-blur)); border: 1px solid var(--glass-border); border-radius: 16px; display: flex; justify-content: center; align-items: center; margin-bottom: 8px; transition: all 0.3s; background-size: cover; background-position: center; font-size: 28px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .app-icon:hover .icon-bg { transform: scale(1.1); background: rgba(100, 100, 120, calc(var(--btn-opacity) * 1.3)); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .app-icon span { font-size: 12px; text-shadow: 0 0 5px rgba(0,0,0,0.5); text-align: center; }
        #display-picture-container { width: 140px; height: 140px; background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 20px; cursor: pointer; background-size: cover; background-position: center; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #display-picture-container:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .app-page { background: rgba(30, 30, 40, var(--bg-opacity)); backdrop-filter: blur(var(--bg-blur)); -webkit-backdrop-filter: blur(var(--bg-blur)); display: flex; flex-direction: column; }
        body.light-mode .app-page { background: rgba(255, 255, 255, calc(var(--bg-opacity) * 1.5)); }
        body.light-mode .album-item { background: rgba(255, 255, 255, calc(var(--card-opacity) * 1.2)); }
        body.light-mode .album-item:hover { background: rgba(255, 255, 255, calc(var(--card-opacity) * 1.5)); }
        body.light-mode .disc-item { background: rgba(255, 255, 255, calc(var(--card-opacity) * 1.2)); }
        body.light-mode .audio-item { background: rgba(255, 255, 255, calc(var(--card-opacity) * 1.2)); }
        body.light-mode .beautify-section { background: rgba(255, 255, 255, calc(var(--card-opacity) * 1.2)); }
        body.light-mode .app-icon .icon-bg { background: rgba(255, 255, 255, var(--btn-opacity)); }
        .app-header { padding: 15px 20px; background: transparent; display: flex; align-items: center; z-index: 10; }
        .app-header .back-btn { font-size: 28px; background: none; border: none; margin-right: 15px; color: var(--text-primary); cursor: pointer; transition: transform 0.2s; }
        .app-header .back-btn:hover { transform: translateX(-3px); }
        .app-header h1 { font-size: calc(var(--global-font-size) + 4px); margin: 0; flex: 1; }
        .app-header .header-action { background: none; border: none; font-size: 24px; color: var(--text-primary); margin-left: 10px; cursor: pointer; }
        .app-content { padding: 20px; overflow-y: auto; flex-grow: 1; padding-bottom: 100px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 15px; background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 12px; font-size: inherit; transition: all 0.2s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--accent-color); background: var(--glass-bg-hover); }
        .action-button { width: 100%; padding: 15px; background: linear-gradient(135deg, rgba(29, 185, 84, 0.8), rgba(29, 185, 84, 0.6)); color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 10px; font-size: var(--global-font-size); transition: all 0.2s; backdrop-filter: blur(10px); }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(29, 185, 84, 0.4); }
        .action-button.danger { background: linear-gradient(135deg, rgba(244, 67, 54, 0.8), rgba(244, 67, 54, 0.6)); }
        .action-button.warning { background: linear-gradient(135deg, rgba(255, 152, 0, 0.8), rgba(255, 152, 0, 0.6)); }
        .album-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .album-item { background: rgba(60, 60, 80, var(--card-opacity)); backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur)); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px 15px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.3s; position: relative; min-height: 150px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .album-item:hover { background: rgba(80, 80, 100, calc(var(--card-opacity) * 1.2)); transform: translateY(-4px); box-shadow: 0 12px 35px rgba(0,0,0,0.3); }
        .album-item:active { transform: scale(0.98); }
        .album-icon { font-size: 48px; margin-bottom: 10px; width: 70px; height: 70px; background-size: cover; background-position: center; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .album-name { font-size: 14px; font-weight: 600; text-align: center; word-break: break-word; width: 100%; padding: 0 5px; }
        .album-count { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .album-actions { position: absolute; top: 8px; right: 8px; display: none; gap: 6px; }
        .album-item:hover .album-actions { display: flex; }
        .album-action-btn { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 50%; width: 30px; height: 30px; font-size: 14px; cursor: pointer; color: var(--text-primary); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .album-action-btn:hover { transform: scale(1.1); }
        .album-delete-btn { color: #ff4444; }
        .album-edit-btn { color: #2196F3; }
        .view-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .mode-switch { display: flex; gap: 5px; }
        .mode-btn { padding: 8px 16px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; color: var(--text-primary); font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .mode-btn:hover { background: var(--glass-bg-hover); }
        .mode-btn.active { background: var(--accent-color); border-color: var(--accent-color); color: white; }
        .sort-control { display: flex; align-items: center; gap: 8px; }
        .sort-control label { font-size: 13px; color: var(--text-secondary); }
        .sort-control select { padding: 6px 12px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); font-size: 13px; cursor: pointer; }
        .sort-order-btn { width: 32px; height: 32px; padding: 0; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); font-size: 16px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .sort-order-btn:hover { background: var(--glass-bg-hover); }
        .sort-order-btn.desc { transform: rotate(180deg); }
        .disc-list { display: flex; gap: 12px; overflow-x: auto; padding: 10px 0; margin-bottom: 20px; scrollbar-width: none; }
        .disc-list::-webkit-scrollbar { display: none; }
        .disc-item { flex-shrink: 0; background: rgba(60, 60, 80, var(--card-opacity)); backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur)); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.2s; min-width: 100px; position: relative; }
        .disc-item:hover { background: rgba(80, 80, 100, calc(var(--card-opacity) * 1.2)); }
        .disc-item.selected { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color); }
        .disc-item.dragging { opacity: 0.5; transform: scale(0.95); }
        .disc-item.drag-over { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.5); }
        .disc-icon { font-size: 36px; margin-bottom: 8px; width: 60px; height: 60px; background-size: cover; background-position: center; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .disc-name { font-size: 13px; font-weight: 600; text-align: center; }
        .disc-actions { position: absolute; top: 4px; right: 4px; display: none; gap: 4px; }
        .disc-item:hover .disc-actions { display: flex; }
        .audio-list { display: flex; flex-direction: column; gap: 10px; }
        .audio-item { display: flex; align-items: center; padding: 12px 15px; background: rgba(60, 60, 80, var(--card-opacity)); backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur)); border: 1px solid var(--glass-border); border-radius: 12px; transition: all 0.2s; }
        .audio-item:hover { background: rgba(80, 80, 100, calc(var(--card-opacity) * 1.2)); }
        .audio-item.selected { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color); }
        .audio-checkbox { width: 24px; height: 24px; margin-right: 12px; accent-color: var(--accent-color); }
        .audio-cover { width: 50px; height: 50px; border-radius: 8px; margin-right: 12px; object-fit: cover; background: var(--bg-tertiary); }
        .audio-info { flex: 1; min-width: 0; cursor: pointer; }
        .audio-title { font-weight: 600; color: var(--text-primary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .audio-meta { font-size: 12px; color: var(--text-secondary); }
        .audio-actions { display: flex; gap: 6px; }
        .audio-action-btn { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 50%; width: 32px; height: 32px; font-size: 14px; cursor: pointer; color: var(--text-primary); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .audio-action-btn:hover { transform: scale(1.1); }
        .audio-action-btn.favorite { color: #ff6b6b; }
        .audio-action-btn.favorite.active { color: #ff6b6b; }
        .audio-action-btn.play-btn { background: linear-gradient(135deg, rgba(29, 185, 84, 0.8), rgba(29, 185, 84, 0.6)); color: white; border-color: rgba(29, 185, 84, 0.5); }
        .batch-toolbar { display: none; position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 16px; padding: 12px 20px; gap: 15px; z-index: 100; box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
        .batch-toolbar.active { display: flex; }
        .batch-toolbar button { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .batch-toolbar .batch-delete { background: rgba(244, 67, 54, 0.8); color: white; }
        .batch-toolbar .batch-cancel { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .batch-toolbar .selected-count { color: var(--text-primary); font-weight: bold; }
        #player-view { background-color: #000; background-size: cover; background-position: center; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .player-top-bar { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .player-top-bar button { color: white; text-shadow: 0 0 5px black; background: none; border: none; font-size: 24px; }
        .player-top-bar .right-controls { display: flex; align-items: center; gap: 10px; position: relative; }
        .player-top-bar .right-controls button { background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 12px; width: 40px; height: 40px; font-size: 18px; display: flex; align-items: center; justify-content: center; text-shadow: none; color: #fff; transition: all 0.2s; }
        .player-top-bar .right-controls button:hover { background: var(--glass-bg-hover); transform: scale(1.05); }
        #player-content-wrapper { position: relative; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; transition: all 0.3s ease; }
        #player-view.style-simple #player-content-wrapper { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #player-view.style-simple .lyric-bubble { max-width: 320px; padding: 10px 15px; }
        #player-view.style-cloud { background-size: cover; background-position: center; background-repeat: no-repeat; }
        #player-view.style-cloud #player-content-wrapper { display: flex; flex-direction: row; justify-content: center; align-items: center; padding: 0 20px; gap: 30px; }
        #player-view.style-cloud .lyric-scroll-container { flex: 1; max-width: 500px; height: var(--lyric-box-height, 60vh); max-height: var(--lyric-box-height, 60vh); overflow-y: auto; padding: 20px; background: var(--lyric-box-bg, var(--glass-bg)); backdrop-filter: blur(var(--glass-blur-amount, 15px)); -webkit-backdrop-filter: blur(var(--glass-blur-amount, 15px)); border-radius: 12px; border: 1px solid var(--glass-border); }
        #player-view.style-cloud .lyric-scroll-line { padding: 10px 15px; margin: 5px 0; color: rgba(255,255,255,0.6); font-size: 16px; text-align: center; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        #player-view.style-cloud .lyric-scroll-line.active { color: #ffffff; font-size: 18px; font-weight: bold; background: var(--glass-bg-hover); transform: translateX(10px); }
        #player-view.style-wallpaper { background-size: cover; background-position: center; background-repeat: no-repeat; }
        #player-view.style-wallpaper #player-content-wrapper { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #player-view.style-wallpaper .wallpaper-lyric-container { width: 90%; max-width: 600px; max-height: 70vh; padding: 30px; background: var(--lyric-box-bg, var(--glass-bg)); backdrop-filter: blur(var(--glass-blur-amount, 15px)); -webkit-backdrop-filter: blur(var(--glass-blur-amount, 15px)); border-radius: 16px; border: 1px solid var(--glass-border); text-align: center; transition: all 0.3s ease; overflow-y: auto; }
        #player-view.style-wallpaper .wallpaper-lyric-line { padding: 12px 0; color: #ffffff; font-size: 18px; cursor: pointer; transition: all 0.3s ease; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        #player-view.style-wallpaper .wallpaper-lyric-line.active { font-size: 22px; font-weight: bold; color: #ffffff; text-shadow: 0 0 10px rgba(255,255,255,0.8); }
        #style-switch-menu, #player-settings-menu, #player-display-settings, #image-settings-menu { display: none; position: absolute; top: 110%; right: 0; background: var(--bg-tertiary); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); padding: 8px; min-width: 120px; z-index: 20; }
        #image-settings-menu { min-width: 100px; padding: 8px 0; }
        #style-switch-menu.visible, #player-settings-menu.visible, #player-display-settings.visible, #image-settings-menu.visible { display: block; }
        #style-switch-menu a, #player-settings-menu a, #image-settings-menu a { display: block; padding: 10px 15px; color: var(--text-primary); text-decoration: none; border-radius: 8px; transition: background-color 0.2s; cursor: pointer; }
        #style-switch-menu a:hover, #player-settings-menu a:hover, #image-settings-menu a:hover { background: var(--border-color); }
        #style-switch-menu a.active, #player-settings-menu a.active, #image-settings-menu a.active { background: var(--accent-color); color: white; }
        .menu-section { padding-top: 8px; margin-top: 8px; border-top: 1px solid var(--border-color); }
        .menu-section-title { font-size: 12px; color: var(--text-secondary); padding: 0 12px 4px; }
        .speed-control { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; }
        #playback-speed { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 5px 10px; }
        .slider-control { margin-bottom: 15px; }
        .slider-control:last-child { margin-bottom: 0; }
        .slider-control label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px; }
        .slider-control input[type="range"] { width: 100%; height: 5px; -webkit-appearance: none; appearance: none; background: var(--border-color); border-radius: 5px; outline: none; }
        .slider-control input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--accent-color); border-radius: 50%; cursor: pointer; }
        .slider-value { font-size: 12px; color: var(--text-primary); float: right; }
        #album-art { object-fit: cover; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.5); cursor: grab; touch-action: none; transition: transform 0.1s; }
        #album-art.dragging { cursor: grabbing; box-shadow: 0 12px 35px rgba(0,0,0,0.7); transition: none; }
        .lyric-bubble { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 90%; background: var(--lyric-box-bg, var(--glass-bg)); backdrop-filter: blur(var(--glass-blur-amount, 15px)); -webkit-backdrop-filter: blur(var(--glass-blur-amount, 15px)); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px 20px; cursor: grab; z-index: 10; touch-action: none; text-align: center; transition: transform 0.1s; }
        .lyric-bubble.dragging { cursor: grabbing; transition: none; }
        .lyric-bubble p { margin: 0; color: var(--lyric-color); font-size: calc(var(--global-font-size) + 2px); }
        #song-title-box { background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 8px; padding: 8px 15px; color: white; font-size: 14px; white-space: nowrap; overflow: hidden; }
        .simple-title-box { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); cursor: grab; z-index: 9; touch-action: none; transition: transform 0.1s; white-space: nowrap; }
        .simple-title-box.dragging { cursor: grabbing; transition: none; }
        .cloud-title-box { cursor: grab; touch-action: none; transition: transform 0.1s; display: inline-block; margin-bottom: 20px; white-space: nowrap; }
        .cloud-title-box.dragging { cursor: grabbing; transition: none; }
        .wallpaper-title-box { cursor: grab; touch-action: none; transition: transform 0.1s; margin-bottom: 20px; white-space: nowrap; }
        .wallpaper-title-box.dragging { cursor: grabbing; transition: none; }
        #player-view.style-simple #album-art { width: 220px; height: 220px; position: relative; }
        #player-view.style-cloud #album-art { width: 220px; height: 220px; flex-shrink: 0; position: relative; }
        #player-view.style-wallpaper #album-art { width: 180px; height: 180px; }
        .player-controls { width: 100%; padding: 15px 0; color: white; flex-shrink: 0; }
        .progress-bar-container { display: flex; align-items: center; gap: 10px; width: 100%; font-size: 12px; }
        #progress-bar { flex-grow: 1; -webkit-appearance: none; appearance: none; width: 100%; height: 5px; background: rgba(255,255,255,0.3); border-radius: 5px; outline: none; transition: opacity .2s; }
        #progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .main-controls { display: flex; justify-content: center; align-items: center; margin-top: 15px; gap: 25px; }
        .main-controls button { background: none; border: none; display: flex; align-items: center; justify-content: center; padding: 0; color: white; text-shadow: 0 0 5px rgba(0,0,0,0.5); transition: all 0.2s; }
        .main-controls button:hover { transform: scale(1.1); }
        #play-pause-btn { background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border); color: #fff; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-shadow: none; }
        #prev-btn, #next-btn { font-size: 32px; opacity: 0.9; }
        #color-picker { display: none; position: absolute; top: 60px; right: 20px; background: var(--bg-tertiary); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); padding: 12px; border-radius: 12px; grid-template-columns: repeat(4, 1fr); gap: 10px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); z-index: 20; border: 1px solid var(--border-color); }
        #color-picker.visible { display: grid; }
        .color-swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .color-swatch:hover { border-color: white; transform: scale(1.1); }
        .beautify-section { background: rgba(60, 60, 80, var(--card-opacity)); backdrop-filter: blur(var(--card-blur)); -webkit-backdrop-filter: blur(var(--card-blur)); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .beautify-section h2 { font-size: 16px; margin-bottom: 15px; color: var(--text-primary); }
        .color-swatch { width: 40px; height: 40px; border-radius: 8px; border: 2px solid var(--glass-border); cursor: pointer; transition: all 0.2s; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected { border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-color); }
        .smart-preview-btn { padding: 10px 20px; border-radius: 12px; border: 1px solid var(--smart-button-border); background: var(--smart-button-bg); color: var(--smart-button-text); font-size: 14px; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .smart-preview-btn:hover { background: var(--smart-button-hover); transform: translateY(-2px); }
        .extract-btn { padding: 14px 20px; border-radius: 12px; border: 1px solid rgba(var(--primary-rgb), 0.3); background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.2), rgba(var(--primary-rgb), 0.1)); color: var(--text-primary); font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .extract-btn:hover { background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.3), rgba(var(--primary-rgb), 0.2)); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(var(--primary-rgb), 0.3); }
        body.smart-color-enabled .app-page { background: rgba(var(--bg-color-rgb), var(--bg-opacity)) !important; }
        body.smart-color-enabled .album-item { background: rgba(var(--card-color-rgb), var(--card-opacity)) !important; border-color: rgba(var(--card-color-rgb), 0.3) !important; }
        body.smart-color-enabled .album-item:hover { background: rgba(var(--card-color-rgb), calc(var(--card-opacity) * 1.2)) !important; }
        body.smart-color-enabled .disc-item { background: rgba(var(--card-color-rgb), var(--card-opacity)) !important; border-color: rgba(var(--card-color-rgb), 0.3) !important; }
        body.smart-color-enabled .disc-item.selected { border-color: rgba(var(--btn-color-rgb), 0.4); box-shadow: 0 0 0 2px rgba(var(--btn-color-rgb), 0.3); }
        body.smart-color-enabled .audio-item { background: rgba(var(--card-color-rgb), var(--card-opacity)) !important; border-color: rgba(var(--card-color-rgb), 0.3) !important; }
        body.smart-color-enabled .audio-item:hover { background: rgba(var(--card-color-rgb), calc(var(--card-opacity) * 1.2)) !important; }
        body.smart-color-enabled .beautify-section { background: rgba(var(--card-color-rgb), var(--card-opacity)) !important; border-color: rgba(var(--card-color-rgb), 0.3) !important; }
        body.smart-color-enabled .app-icon .icon-bg { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border: 1px solid rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .app-icon .icon-bg:hover { background: rgba(var(--btn-color-rgb), calc(var(--btn-opacity) * 1.3)) !important; transform: scale(1.1); }
        body.smart-color-enabled .glass-button { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; color: var(--smart-button-text) !important; }
        body.smart-color-enabled .glass-button:hover { background: rgba(var(--btn-color-rgb), calc(var(--btn-opacity) * 1.3)) !important; }
        body.smart-color-enabled .bottom-control-btn { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .modal-confirm-btn { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .modal-cancel-btn { background: rgba(var(--card-color-rgb), var(--card-opacity)) !important; border-color: rgba(var(--card-color-rgb), 0.3) !important; }
        body.smart-color-enabled .action-button { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .batch-mode-btn { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .extract-btn { background: linear-gradient(135deg, rgba(var(--btn-color-rgb), 0.3), rgba(var(--btn-color-rgb), 0.15)) !important; border-color: rgba(var(--btn-color-rgb), 0.4) !important; }
        body.smart-color-enabled .album-action-btn { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .audio-action-btn { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border-color: rgba(var(--btn-color-rgb), 0.3) !important; }
        body.smart-color-enabled .header-action { background: rgba(var(--btn-color-rgb), var(--btn-opacity)) !important; border: 1px solid rgba(var(--btn-color-rgb), 0.3) !important; border-radius: 50%; }
        body.smart-color-enabled .back-btn { color: var(--btn-color-rgb) !important; }
        body.smart-color-enabled { --text-primary: rgb(var(--text-color-rgb)); --text-secondary: rgba(var(--text-color-rgb), 0.7); }
        body.smart-color-enabled .album-name,
        body.smart-color-enabled .disc-name,
        body.smart-color-enabled .audio-title,
        body.smart-color-enabled .audio-meta,
        body.smart-color-enabled .form-group label,
        body.smart-color-enabled .form-group input,
        body.smart-color-enabled .modal-content h3,
        body.smart-color-enabled .beautify-section h2,
        body.smart-color-enabled .app-icon span,
        body.smart-color-enabled .empty-tip,
        body.smart-color-enabled .glass-settings-title,
        body.smart-color-enabled .glass-section-title { color: rgb(var(--text-color-rgb)) !important; }
        body.smart-color-enabled #player-view,
        body.smart-color-enabled .lyric-bubble,
        body.smart-color-enabled .lyric-scroll-line,
        body.smart-color-enabled .wallpaper-lyric-line,
        body.smart-color-enabled .full-lyric-line { color: var(--lyric-color) !important; }
        .app-customize-row { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
        .app-customize-row .preview-icon { width: 50px; height: 50px; border-radius: 12px; object-fit: cover; background: var(--bg-tertiary); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .app-customize-row .app-name-input { flex-grow: 1; padding: 10px 12px; background: var(--glass-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; }
        .app-customize-row .select-file-btn { padding: 8px 12px; font-size: 13px; background: linear-gradient(135deg, rgba(3, 169, 244, 0.8), rgba(3, 169, 244, 0.6)); color: white; border: none; border-radius: 8px; cursor: pointer; }
        .input-with-button { display: flex; gap: 10px; }
        .input-with-button input { flex-grow: 1; }
        .input-with-button button { padding: 10px 15px; background: linear-gradient(135deg, rgba(29, 185, 84, 0.8), rgba(29, 185, 84, 0.6)); color: white; border: none; border-radius: 8px; }
        .font-size-control { display: flex; align-items: center; gap: 15px; }
        .font-size-control input[type="range"] { flex-grow: 1; }
        .font-size-control span { font-weight: bold; min-width: 40px; text-align: right; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--bg-secondary); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 25px; border-radius: 16px; max-width: 90%; width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid var(--border-color); }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; color: var(--text-primary); font-size: 18px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { flex: 1; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .modal-cancel-btn { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .modal-confirm-btn { background: linear-gradient(135deg, rgba(29, 185, 84, 0.8), rgba(29, 185, 84, 0.6)); color: white; border: none; }
        .modal-confirm-btn.danger { background: linear-gradient(135deg, rgba(244, 67, 54, 0.8), rgba(244, 67, 54, 0.6)); }
        .image-preview { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; margin-left: 10px; background-color: var(--bg-tertiary); }
        .hidden-input { display: none; }
        .source-switcher { display: flex; gap: 20px; margin-bottom: 10px; }
        .source-switcher label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .import-vtt-btn { margin-bottom: 5px; font-size: 12px; background: var(--glass-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 6px 12px; border-radius: 8px; cursor: pointer; }
        #full-lyrics-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 2000; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        #full-lyrics-modal.active { transform: translateY(0); }
        .full-lyrics-header { padding: 20px; display: flex; justify-content: flex-end; }
        .close-lyrics-btn { background: var(--glass-bg); border: 1px solid var(--glass-border); color: white; font-size: 24px; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .full-lyrics-container { flex-grow: 1; overflow-y: auto; padding: 20px; text-align: center; -webkit-mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent); mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent); }
        .full-lyric-line { padding: 12px 5px; color: #666; font-size: 18px; transition: all 0.3s; cursor: pointer; }
        .full-lyric-line.active { color: var(--lyric-color); font-size: 24px; font-weight: bold; text-shadow: 0 0 10px rgba(255,255,255,0.3); transform: scale(1.05); }
        #bottom-player { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--glass-bg); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-top: 1px solid var(--glass-border); box-shadow: 0 -8px 30px rgba(0,0,0,0.2); z-index: 1000; transform: translateY(0); transition: transform 0.3s ease; padding-bottom: env(safe-area-inset-bottom, 0px); }
        #bottom-player.hidden-player { transform: translateY(100%); }
        .bottom-player-content { display: flex; align-items: center; padding: 10px 15px; max-width: 768px; margin: 0 auto; gap: 12px; height: 70px; box-sizing: border-box; }
        .bottom-player-info { display: flex; align-items: center; gap: 10px; flex: 0 0 auto; min-width: 0; cursor: pointer; padding: 5px; border-radius: 10px; transition: background-color 0.2s; }
        .bottom-player-info:active { background: var(--glass-bg-hover); }
        #bottom-player-art { width: 48px; height: 48px; border-radius: 10px; object-fit: cover; background: var(--bg-tertiary); box-shadow: 0 2px 8px rgba(0,0,0,0.2); flex-shrink: 0; }
        .bottom-player-text { display: flex; flex-direction: column; justify-content: center; min-width: 0; max-width: 100px; }
        #bottom-player-title { font-size: 14px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
        #bottom-player-subtitle { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bottom-player-controls { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        .bottom-control-btn { background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-primary); font-size: 18px; cursor: pointer; padding: 8px; border-radius: 50%; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .bottom-control-btn:active { transform: scale(0.9); }
        .bottom-control-btn.play-btn { background: var(--text-primary); color: var(--bg-primary); font-size: 16px; }
        .bottom-player-progress-area { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 4px; min-width: 80px; }
        #bottom-progress { width: 100%; height: 4px; -webkit-appearance: none; appearance: none; background: var(--bg-tertiary); border-radius: 2px; outline: none; cursor: pointer; }
        #bottom-progress::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: var(--text-primary); border-radius: 50%; cursor: pointer; transition: transform 0.1s; }
        #bottom-progress::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .bottom-time { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-secondary); font-variant-numeric: tabular-nums; }
        .bottom-time span { min-width: 35px; }
        .bottom-time span:last-child { text-align: right; }
        .bottom-player-handle { position: absolute; top: 6px; left: 50%; transform: translateX(-50%); width: 36px; height: 4px; background: var(--border-color); border-radius: 2px; opacity: 0.5; }
        body.no-active-song #bottom-player { transform: translateY(calc(100% + 20px)); }
        #player-view.active ~ #bottom-player { transform: translateY(100%); transition-delay: 0.1s; }
        .empty-tip { text-align: center; color: var(--text-secondary); margin-top: 50px; padding: 40px 20px; }
        .empty-tip .empty-icon { font-size: 64px; margin-bottom: 15px; opacity: 0.5; }
        .empty-tip p { font-size: 14px; }
        .dialog-warning { color: #ff9800; font-size: 12px; margin-top: 5px; display: none; }
        .dialog-warning.visible { display: block; }
        .toast-with-undo { display: flex; align-items: center; gap: 15px; }
        .toast-undo-btn { background: var(--accent-color); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .batch-mode-btn { background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-primary); padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; margin-bottom: 15px; }
        .batch-mode-btn.active { background: var(--accent-color); color: white; }
        .glass-settings-btn { position: absolute; top: 20px; right: 20px; background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 50%; width: 40px; height: 40px; font-size: 18px; cursor: pointer; color: var(--text-primary); transition: all 0.3s; }
        .glass-settings-btn:hover { transform: scale(1.1); background: var(--glass-bg-hover); }
        .glass-settings-panel { position: absolute; top: 70px; right: 20px; background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 16px; padding: 15px; min-width: 200px; display: none; z-index: 100; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .glass-settings-panel.visible { display: block; }
        .glass-settings-title { font-size: 14px; font-weight: bold; margin-bottom: 12px; color: var(--text-primary); text-align: center; }
        .glass-settings-section { margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--glass-border); }
        .glass-settings-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .glass-section-title { font-size: 12px; color: var(--accent-color); margin-bottom: 8px; font-weight: bold; }
        .glass-setting-item { margin-bottom: 8px; }
        .glass-setting-item:last-child { margin-bottom: 0; }
        .glass-setting-item label { display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .glass-slider-row { display: flex; align-items: center; gap: 8px; }
        .glass-slider-row input[type="range"] { flex: 1; height: 4px; -webkit-appearance: none; appearance: none; background: var(--glass-border); border-radius: 2px; outline: none; }
        .glass-slider-row input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; background: var(--accent-color); border-radius: 50%; cursor: pointer; }
        .glass-slider-row span { font-size: 11px; color: var(--text-primary); min-width: 35px; text-align: right; }
        @media (max-width: 480px) {
            .album-grid { grid-template-columns: 1fr; }
            .desktop-time { font-size: 56px; }
            .desktop-date { font-size: 18px; }
            .app-dock { gap: 15px; }
            .bottom-player-text { max-width: 80px; }
        }
    </style>
</head>
<body>
    <div id="desktop-view" class="view active">
        <div class="desktop-header">
            <div id="desktop-time">12:00</div>
            <div id="desktop-date">1月1日</div>
            <button id="desktop-glass-settings-btn" class="glass-settings-btn" title="毛玻璃设置">⚙️</button>
        </div>
        <div id="glass-settings-panel" class="glass-settings-panel">
            <div class="glass-settings-title">毛玻璃设置</div>
            <div class="glass-settings-section">
                <div class="glass-section-title">背景</div>
                <div class="glass-setting-item">
                    <label>模糊强度</label>
                    <div class="glass-slider-row">
                        <input type="range" id="bg-blur-slider" min="0" max="30" value="20">
                        <span id="bg-blur-value">20px</span>
                    </div>
                </div>
                <div class="glass-setting-item">
                    <label>透明度</label>
                    <div class="glass-slider-row">
                        <input type="range" id="bg-opacity-slider" min="0" max="100" value="15">
                        <span id="bg-opacity-value">15%</span>
                    </div>
                </div>
            </div>
            <div class="glass-settings-section">
                <div class="glass-section-title">卡片</div>
                <div class="glass-setting-item">
                    <label>模糊强度</label>
                    <div class="glass-slider-row">
                        <input type="range" id="card-blur-slider" min="0" max="30" value="15">
                        <span id="card-blur-value">15px</span>
                    </div>
                </div>
                <div class="glass-setting-item">
                    <label>透明度</label>
                    <div class="glass-slider-row">
                        <input type="range" id="card-opacity-slider" min="0" max="100" value="20">
                        <span id="card-opacity-value">20%</span>
                    </div>
                </div>
            </div>
            <div class="glass-settings-section">
                <div class="glass-section-title">按钮</div>
                <div class="glass-setting-item">
                    <label>模糊强度</label>
                    <div class="glass-slider-row">
                        <input type="range" id="btn-blur-slider" min="0" max="30" value="10">
                        <span id="btn-blur-value">10px</span>
                    </div>
                </div>
                <div class="glass-setting-item">
                    <label>透明度</label>
                    <div class="glass-slider-row">
                        <input type="range" id="btn-opacity-slider" min="0" max="100" value="25">
                        <span id="btn-opacity-value">25%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="desktop-main">
            <div class="app-dock" id="app-dock"></div>
            <div id="display-picture-container"></div>
        </div>
    </div>

    <div id="albums-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="desktop-view">‹</button>
            <h1>我的专辑</h1>
            <button id="create-album-btn" class="header-action" title="创建新专辑">+</button>
        </div>
        <div class="app-content">
            <div id="albums-grid" class="album-grid"></div>
            <div id="album-empty-tip" class="empty-tip" style="display: none;">
                <div class="empty-icon">💿</div>
                <p>暂无专辑，点击右上角"+"创建</p>
            </div>
        </div>
    </div>

    <div id="disc-detail-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" id="disc-back-btn" data-target="albums-view">‹</button>
            <h1 id="disc-album-title">专辑详情</h1>
            <button id="create-disc-btn" class="header-action" title="添加Disc">+</button>
        </div>
        <div class="app-content" id="disc-content">
            <div id="disc-empty-tip" class="empty-tip" style="display: none;">
                <div class="empty-icon">📀</div>
                <p>此专辑暂无Disc，点击右上角"+"创建</p>
            </div>
            <div class="view-controls">
                <div class="mode-switch">
                    <button id="disc-mode-btn" class="mode-btn active" title="Disc模式">Disc模式</button>
                    <button id="list-mode-btn" class="mode-btn" title="列表模式">列表模式</button>
                </div>
                <div class="sort-control">
                    <label>排序：</label>
                    <select id="audio-sort-select">
                        <option value="default">默认顺序</option>
                        <option value="track">音轨号</option>
                        <option value="title">标题</option>
                        <option value="duration">时长</option>
                        <option value="artist">声优</option>
                        <option value="createdAt">添加时间</option>
                    </select>
                    <button id="sort-order-btn" class="sort-order-btn" title="正序">↑</button>
                </div>
            </div>
            <div id="disc-list" class="disc-list"></div>
            <button id="batch-mode-btn" class="batch-mode-btn" style="display: none;">批量管理</button>
            <div id="audio-list" class="audio-list"></div>
        </div>
    </div>

    <div id="player-view" class="view style-simple">
        <div class="player-top-bar">
            <button class="back-btn" id="player-back-btn" data-target="desktop-view">‹</button>
            <div class="right-controls">
                <button id="style-switch-btn" title="切换样式">🎭</button>
                <button id="image-settings-btn" title="图片设置">🖼️</button>
                <div id="image-settings-menu">
                    <a id="set-cover-option">修改封面</a>
                    <a id="set-bg-option">设置背景</a>
                </div>
                <button id="toggle-color-picker-btn" title="歌词颜色">🎨</button>
                <button id="player-display-btn" title="显示设置">⚙️</button>
                <button id="player-settings-btn" title="更多设置">⋮</button>
                <div id="player-settings-menu">
                    <a id="download-song-link" download>下载音频</a>
                    <div class="speed-control">
                        <span>速度:</span>
                        <select id="playback-speed">
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1.0x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2.0">2.0x</option>
                        </select>
                    </div>
                    <div class="menu-section">
                        <div class="menu-section-title">睡眠定时器</div>
                        <a href="#" data-time="0">关闭</a>
                        <a href="#" data-time="15">15 分钟后</a>
                        <a href="#" data-time="30">30 分钟后</a>
                        <a href="#" data-time="60">60 分钟后</a>
                        <a href="#" data-time="-1">当前歌曲播放完后</a>
                    </div>
                    <div class="menu-section">
                        <a href="#" id="toggle-continuous-play">连续播放: 关闭</a>
                    </div>
                </div>
                <div id="style-switch-menu">
                    <a href="#" data-style="simple" class="active">简约模式</a>
                    <a href="#" data-style="cloud">网易云模式</a>
                    <a href="#" data-style="wallpaper">壁纸模式</a>
                </div>
                <div id="player-display-settings">
                    <div class="slider-control">
                        <label>歌词框高度 <span class="slider-value" id="lyric-height-value">60%</span></label>
                        <input type="range" id="lyric-height-slider" min="30" max="100" value="60">
                    </div>
                    <div class="slider-control">
                        <label>毛玻璃程度 <span class="slider-value" id="glass-blur-value">15px</span></label>
                        <input type="range" id="glass-blur-slider" min="5" max="30" value="15">
                    </div>
                    <div class="slider-control">
                        <label>歌词框透明度 <span class="slider-value" id="lyric-box-opacity-value">0.1</span></label>
                        <input type="range" id="lyric-box-opacity-slider" min="0" max="50" value="10">
                    </div>
                    <div class="slider-control">
                        <label>歌词透明度 <span class="slider-value" id="lyric-opacity-value">1.0</span></label>
                        <input type="range" id="lyric-opacity-slider" min="30" max="100" value="100">
                    </div>
                </div>
            </div>
        </div>
        <div id="color-picker"></div>
        <div id="player-content-wrapper">
            <div id="song-title-box">Unknown Song</div>
            <img id="album-art" alt="Art">
            <div class="lyric-bubble">
                <p id="lyric-display">...</p>
            </div>
        </div>
        <div class="player-controls">
            <div class="progress-bar-container">
                <span id="current-time">00:00</span>
                <input type="range" id="progress-bar" value="0" step="1">
                <span id="duration-time">00:00</span>
            </div>
            <div class="main-controls">
                <button id="prev-btn">⏮</button>
                <button id="play-pause-btn">▶</button>
                <button id="next-btn">⏭</button>
            </div>
        </div>
        <audio id="audio-player" style="display: none;"></audio>
        <input type="file" id="song-bg-input" accept="image/*" style="display:none;">
        <input type="file" id="cover-input" accept="image/*" style="display:none;">
        <input type="file" id="vtt-import-input" accept=".vtt,.srt,.lrc" style="display:none;">
    </div>

    <div id="beautify-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="desktop-view">‹</button>
            <h1>美化</h1>
        </div>
        <div class="app-content">
            <div class="beautify-section">
                <h2>主题模式</h2>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span>夜间</span>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch">
                        <span class="slider"></span>
                    </label>
                    <span>日间</span>
                </div>
            </div>
            <div class="beautify-section">
                <h2>应用定制</h2>
                <div id="app-customize-container"></div>
                <button id="save-app-config-btn" class="glass-button primary" style="width:100%;margin-top:15px;">保存应用配置</button>
            </div>
            <div class="beautify-section">
                <h2>播放器界面</h2>
                <div class="form-group">
                    <label>全局背景</label>
                    <input type="file" id="player-bg-input" accept="image/*">
                </div>
                <div class="form-group">
                    <label>封面尺寸 (px)</label>
                    <div class="input-with-button">
                        <input type="number" id="cover-width-input" placeholder="宽度" value="300">
                        <input type="number" id="cover-height-input" placeholder="高度" value="300">
                        <button id="save-cover-size-btn">保存</button>
                    </div>
                </div>
            </div>
            <div class="beautify-section">
                <h2>桌面与字体</h2>
                <div class="form-group">
                    <label>桌面背景</label>
                    <input type="file" id="bg-file-input" accept="image/*">
                </div>
                <div class="form-group">
                    <label>展示区图片</label>
                    <input type="file" id="dp-file-input" accept="image/*">
                </div>
                <div class="form-group">
                    <label>字体URL</label>
                    <div class="input-with-button">
                        <input type="text" id="font-url-input" placeholder="https://.../font.woff">
                        <button id="save-font-btn">保存</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>全局字体大小</label>
                    <div class="font-size-control">
                        <input type="range" id="font-size-slider" min="12" max="22" step="1" value="16">
                        <span id="font-size-value">16px</span>
                    </div>
                </div>
            </div>
            <div class="beautify-section">
                <h2>智能色彩适配</h2>
                <p style="color:var(--text-secondary);font-size:13px;margin-bottom:15px;">从壁纸提取8个主色调，分别设置背景、卡片、按钮、字体颜色。点击颜色块选择用途。</p>
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
                    <span>关闭</span>
                    <label class="switch">
                        <input type="checkbox" id="smart-color-switch">
                        <span class="slider"></span>
                    </label>
                    <span>开启</span>
                </div>
                <div id="color-palette-preview" style="display:none;">
                    <div style="margin-bottom:10px;">
                        <span style="font-size:13px;color:var(--text-secondary);">提取的主色调（点击选择用途）：</span>
                    </div>
                    <div id="extracted-colors" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;"></div>
                    <div style="margin-bottom:10px;">
                        <span style="font-size:13px;color:var(--text-secondary);">按钮样式预览：</span>
                    </div>
                    <div id="button-preview-container" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;">
                        <button class="smart-preview-btn" id="preview-btn-1">普通按钮</button>
                        <button class="smart-preview-btn" id="preview-btn-2">悬停效果</button>
                        <button class="smart-preview-btn" id="preview-btn-3">毛玻璃按钮</button>
                    </div>
                </div>
                <button id="extract-colors-btn" class="extract-btn" style="width:100%;">
                    <span style="font-size:18px;margin-right:8px;">🎨</span>
                    手动提取壁纸颜色
                </button>
            </div>
        </div>
    </div>

    <div id="data-view" class="view app-page">
        <div class="app-header">
            <button class="back-btn" data-target="desktop-view">‹</button>
            <h1>数据管理</h1>
        </div>
        <div class="app-content">
            <p style="color: var(--text-secondary); line-height: 1.6; margin-top: 0; margin-bottom: 20px;">这里是您的数据中心。您可以导出/导入所有数据。</p>
            <div class="form-group">
                <label>导出</label>
                <button id="export-btn" class="action-button">导出全部数据</button>
            </div>
            <div class="form-group">
                <label>导入</label>
                <button id="import-btn" class="action-button danger">覆盖导入 (清空现有)</button>
                <button id="import-merge-btn" class="action-button" style="margin-top: 10px; background: linear-gradient(135deg, rgba(33, 150, 243, 0.8), rgba(33, 150, 243, 0.6));">追加导入 (保留现有)</button>
                <input type="file" id="import-file-input" accept=".zip" style="display:none;">
            </div>
            <div class="form-group">
                <label>数据管理</label>
                <button id="clear-data-btn" class="action-button danger">清空所有数据</button>
                <button id="clean-cache-btn" class="action-button warning" style="margin-top: 10px;">清理缓存</button>
            </div>
        </div>
    </div>

    <div id="full-lyrics-modal">
        <div class="full-lyrics-header">
            <button class="close-lyrics-btn">×</button>
        </div>
        <div class="full-lyrics-container" id="full-lyrics-list"></div>
    </div>

    <div id="entity-dialog" class="modal-overlay">
        <div class="modal-content" style="width: 90%; max-width: 450px; max-height: 80vh; overflow-y: auto;">
            <h3 id="dialog-title">创建专辑</h3>
            <div id="dialog-form">
                <div class="form-group">
                    <label>名称 <span style="color: #ff4444;">*</span></label>
                    <input type="text" id="entity-name-input" placeholder="输入名称">
                    <div id="name-warning" class="dialog-warning">名称不能为空</div>
                </div>
                <div class="form-group" id="entity-cover-group">
                    <label>封面（可选）</label>
                    <input type="file" id="entity-cover-input" accept="image/*">
                    <img id="entity-cover-preview" class="image-preview" style="display:none; margin-top: 10px; width: 100%; height: 100px; object-fit: cover; border-radius: 8px;">
                </div>
                <div class="form-group album-only-field">
                    <label>专辑编号</label>
                    <input type="text" id="entity-number-input" placeholder="如：ABC-001">
                </div>
                <div class="form-group album-only-field">
                    <label>艺术家/社团</label>
                    <input type="text" id="entity-artist-input" placeholder="输入艺术家或社团名称">
                </div>
                <div class="form-group album-only-field">
                    <label>发行日期</label>
                    <input type="date" id="entity-release-date-input">
                </div>
                <div class="form-group album-only-field">
                    <label>专辑描述</label>
                    <textarea id="entity-description-input" rows="2" placeholder="输入专辑描述"></textarea>
                </div>
                <div class="form-group disc-only-field" style="display:none;">
                    <label>Disc编号</label>
                    <input type="number" id="entity-disc-number-input" placeholder="如：1" min="1">
                </div>
                <div class="form-group disc-only-field" style="display:none;">
                    <label>Disc描述</label>
                    <textarea id="entity-disc-description-input" rows="2" placeholder="输入Disc描述"></textarea>
                </div>
            </div>
            <div id="dialog-warning" class="dialog-warning" style="margin-top: 10px;">有未保存的更改，确定要放弃吗？</div>
            <div class="modal-buttons">
                <button id="entity-cancel-btn" class="modal-cancel-btn">取消</button>
                <button id="entity-confirm-btn" class="modal-confirm-btn">创建</button>
            </div>
        </div>
    </div>

    <div id="audio-dialog" class="modal-overlay">
        <div class="modal-content" style="width: 90%; max-width: 450px; max-height: 80vh; overflow-y: auto;">
            <h3 id="audio-dialog-title">添加音频</h3>
            <div id="audio-form">
                <div class="form-group">
                    <label>音频标题 <span style="color: #ff4444;">*</span></label>
                    <input type="text" id="audio-title-input" placeholder="输入音频标题">
                    <div id="audio-title-warning" class="dialog-warning">标题不能为空</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>音轨号</label>
                        <input type="number" id="audio-track-input" placeholder="如：1" min="1">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>时长</label>
                        <input type="text" id="audio-duration-input" placeholder="自动获取" disabled>
                    </div>
                </div>
                <div class="form-group">
                    <label>声优/演唱者</label>
                    <input type="text" id="audio-artist-input" placeholder="输入声优或演唱者">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>作曲</label>
                        <input type="text" id="audio-composer-input" placeholder="输入作曲者">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>作词</label>
                        <input type="text" id="audio-lyricist-input" placeholder="输入作词者">
                    </div>
                </div>
                <div class="form-group">
                    <label>社团</label>
                    <input type="text" id="audio-circle-input" placeholder="输入社团名称">
                </div>
                <div class="form-group">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <label>字幕/歌词</label>
                        <button type="button" class="import-vtt-btn" id="import-vtt-btn">导入VTT/LRC</button>
                    </div>
                    <textarea id="audio-lyric-input" rows="3" placeholder="格式:&#10;00:00:01.000 --> 00:00:04.000&#10;歌词..."></textarea>
                    <input type="file" id="vtt-dialog-input" accept=".vtt,.srt,.lrc" style="display:none;">
                </div>
                <div class="form-group">
                    <label>音频来源</label>
                    <div class="source-switcher">
                        <label><input type="radio" name="audio-dialog-source" value="file" checked> 上传文件</label>
                        <label><input type="radio" name="audio-dialog-source" value="url"> 使用URL</label>
                    </div>
                    <div id="audio-dialog-file-group">
                        <input type="file" id="audio-dialog-file-input" accept=".mp3,.wav,.m4a,audio/*" style="width: 100%; margin-top: 8px;">
                    </div>
                    <div id="audio-dialog-url-group" class="hidden-input">
                        <input type="text" id="audio-dialog-url-input" placeholder="输入 .mp3 或 .wav 链接" style="width: 100%; margin-top: 8px;">
                    </div>
                </div>
                <div class="form-group">
                    <label>封面图片 (可选)</label>
                    <div style="display:flex;align-items:center">
                        <input type="file" id="audio-image-input" accept="image/*" style="flex-grow:1">
                        <img id="audio-image-preview" class="image-preview" style="display:none">
                    </div>
                </div>
            </div>
            <div id="audio-dialog-warning" class="dialog-warning" style="margin-top: 10px;">有未保存的更改，确定要放弃吗？</div>
            <div class="modal-buttons">
                <button id="audio-cancel-btn" class="modal-cancel-btn">取消</button>
                <button id="audio-confirm-btn" class="modal-confirm-btn">添加</button>
            </div>
        </div>
    </div>

    <div id="confirm-dialog" class="modal-overlay">
        <div class="modal-content" style="max-width: 350px;">
            <h3 id="confirm-title">确认</h3>
            <p id="confirm-message" style="color: var(--text-secondary); margin: 15px 0;"></p>
            <div class="modal-buttons">
                <button id="confirm-cancel-btn" class="modal-cancel-btn">取消</button>
                <button id="confirm-ok-btn" class="modal-confirm-btn danger">确认</button>
            </div>
        </div>
    </div>

    <div id="crop-modal-overlay" class="modal-overlay">
        <div class="modal-content" style="width: 90vw; max-width: 500px;">
            <div id="cropper-container" style="width: 100%; height: 60vh; max-height: 400px;">
                <img id="cropper-image">
            </div>
            <div class="modal-buttons" style="margin-top: 15px;">
                <button id="cancel-crop-btn" class="modal-cancel-btn">取消</button>
                <button id="confirm-crop-btn" class="modal-confirm-btn">裁剪</button>
            </div>
        </div>
    </div>

    <div id="bottom-player">
        <div class="bottom-player-content">
            <div class="bottom-player-info" id="bottom-player-info">
                <img id="bottom-player-art" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM4ODgiIHN0cm9rZS13aWR0aD0iMiI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiPjwvY2lyY2xlPjxwYXRoIGQ9Im0xNiA4LTggMyA4IDMgeiIgLz48L3N2Zz4=" alt="cover">
                <div class="bottom-player-text">
                    <div id="bottom-player-title">未在播放</div>
                    <div id="bottom-player-subtitle">选择一首歌曲</div>
                </div>
            </div>
            <div class="bottom-player-controls">
                <button id="bottom-prev-btn" class="bottom-control-btn">⏮</button>
                <button id="bottom-play-btn" class="bottom-control-btn play-btn">▶</button>
                <button id="bottom-next-btn" class="bottom-control-btn">⏭</button>
            </div>
            <div class="bottom-player-progress-area">
                <input type="range" id="bottom-progress" value="0" step="1" min="0" max="100">
                <div class="bottom-time">
                    <span id="bottom-current-time">00:00</span>
                    <span id="bottom-duration">00:00</span>
                </div>
            </div>
        </div>
        <div class="bottom-player-handle"></div>
    </div>

    <div id="batch-toolbar" class="batch-toolbar">
        <span class="selected-count">已选择 0 项</span>
        <button class="batch-delete" id="batch-delete-btn">删除选中</button>
        <button class="batch-cancel" id="batch-cancel-btn">取消</button>
    </div>

    <script>
    (function() {
        'use strict';

        const db = new Dexie('YumePlayerDB');
        db.version(3).stores({
            albums: '++id, name, createdAt',
            discs: '++id, albumId, name, createdAt',
            audios: '++id, discId, albumId, title, isFavorite, createdAt',
            settings: 'key'
        });

        db.albums.hook('deleting', async (primKey, album, transaction) => {
            const discs = await db.discs.where('albumId').equals(primKey).toArray();
            const discIds = discs.map(d => d.id);
            if (discIds.length > 0) {
                await db.audios.where('discId').anyOf(discIds).delete();
            }
            await db.discs.where('albumId').equals(primKey).delete();
        });

        db.discs.hook('deleting', async (primKey, disc, transaction) => {
            await db.audios.where('discId').equals(primKey).delete();
        });

        class EventBinder {
            constructor() { this.bindings = new Map(); }
            _getKey(element, event) {
                const id = element.id || element.tagName + '_' + Math.random().toString(36).substr(2, 9);
                if (!element.id) element.id = id;
                return `${element.id}_${event}`;
            }
            bind(element, event, handler) {
                const key = this._getKey(element, event);
                if (this.bindings.has(key)) this.unbind(element, event);
                element.addEventListener(event, handler);
                this.bindings.set(key, handler);
            }
            unbind(element, event) {
                const key = this._getKey(element, event);
                const handler = this.bindings.get(key);
                if (handler) {
                    element.removeEventListener(event, handler);
                    this.bindings.delete(key);
                }
            }
            unbindAll() {
                this.bindings.forEach((handler, key) => {
                    const [id, event] = key.split('_');
                    const element = document.getElementById(id);
                    if (element) element.removeEventListener(event, handler);
                });
                this.bindings.clear();
            }
        }

        const eventBinder = new EventBinder();
        const defaultCover = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzg4OCIgc3Ryb2tlLXdpZHRoPSIyIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCI+PC9jaXJjbGU+PHBhdGggZD0ibTE2IDgtOCAzIDggMyB6IiAvPjwvc3ZnPg==';

        let currentAlbumId = null;
        let currentDiscId = null;
        let currentLyrics = [];
        let currentPlayerStyle = 'simple';
        let playerPreviousView = 'desktop-view';
        let sleepTimerId = null;
        let stopAtSongEnd = false;
        let isContinuousPlay = false;
        let isSubmitting = false;
        let dialogOriginalData = null;
        let isDialogDirty = false;
        let currentDialogMode = 'create-album';
        let editingEntityId = null;
        let editingAudioId = null;
        let audioDialogOriginalData = null;
        let audioDialogDirty = false;
        let cropper = null;
        let croppedImageBlob = null;
        let tempObjectURLs = [];
        let batchMode = false;
        let selectedAudios = new Set();
        let undoStack = [];
        let audioDialogOriginalFile = null;
        let audioDialogOriginalImage = null;
        let customCoverUrl = null;
        let currentAudioCover = null;
        let currentAudioTitle = 'Unknown Song';
        let currentViewMode = 'disc';
        let currentSortBy = 'default';
        let currentSortOrder = 'asc';

        const defaultAppConfig = [
            { id: 'player', name: '播放器', icon: '▶️', target: 'player-view' },
            { id: 'albums', name: '我的专辑', icon: '💿', target: 'albums-view' },
            { id: 'beautify', name: '美化', icon: '🎨', target: 'beautify-view' },
            { id: 'data', name: '数据管理', icon: '💾', target: 'data-view' }
        ];

        function revokeURLs() {
            tempObjectURLs.forEach(url => URL.revokeObjectURL(url));
            tempObjectURLs = [];
        }

        function navigateTo(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.toggle('active', v.id === viewId));
            closeAllDialogs();
        }

        function closeAllDialogs() {
            document.getElementById('entity-dialog').classList.remove('active');
            document.getElementById('audio-dialog').classList.remove('active');
            document.getElementById('crop-modal-overlay').classList.remove('active');
            document.getElementById('confirm-dialog').classList.remove('active');
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || !isFinite(seconds)) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function showToast(message, duration = 2000) {
            const toast = document.createElement('div');
            toast.style.cssText = `position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--glass-bg);backdrop-filter:blur(15px);border:1px solid var(--glass-border);border-radius:12px;padding:12px 24px;color:var(--text-primary);z-index:9999;font-size:14px;animation:fadeIn 0.3s;`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, duration);
        }

        function showToastWithUndo(message, undoCallback, duration = 5000) {
            const toast = document.createElement('div');
            toast.style.cssText = `position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--glass-bg);backdrop-filter:blur(15px);border:1px solid var(--glass-border);border-radius:12px;padding:12px 24px;color:var(--text-primary);z-index:9999;font-size:14px;animation:fadeIn 0.3s;`;
            toast.innerHTML = `<span>${message}</span><button class="toast-undo-btn" style="margin-left:15px;">撤销</button>`;
            const undoBtn = toast.querySelector('.toast-undo-btn');
            undoBtn.addEventListener('click', () => {
                undoCallback();
                toast.remove();
            });
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, duration);
        }

        function showConfirm(title, message) {
            return new Promise((resolve) => {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                document.getElementById('confirm-dialog').classList.add('active');
                
                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                
                const handleOk = () => {
                    document.getElementById('confirm-dialog').classList.remove('active');
                    resolve(true);
                    cleanup();
                };
                
                const handleCancel = () => {
                    document.getElementById('confirm-dialog').classList.remove('active');
                    resolve(false);
                    cleanup();
                };
                
                const cleanup = () => {
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                };
                
                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('desktop-time').textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('desktop-date').textContent = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });
        }

        async function renderUI() {
            const appDock = document.getElementById('app-dock');
            appDock.innerHTML = '';
            let appConfig = await db.settings.get('appConfig');
            appConfig = appConfig?.value || defaultAppConfig;
            appConfig.forEach(app => {
                const icon = document.createElement('div');
                icon.className = 'app-icon';
                icon.dataset.target = app.target;
                const iconBg = document.createElement('div');
                iconBg.className = 'icon-bg';
                if (app.icon && app.icon.startsWith('data:')) {
                    iconBg.style.backgroundImage = `url(${app.icon})`;
                    iconBg.style.backgroundSize = 'cover';
                } else {
                    iconBg.textContent = app.icon || '📁';
                }
                const name = document.createElement('span');
                name.textContent = app.name;
                icon.appendChild(iconBg);
                icon.appendChild(name);
                appDock.appendChild(icon);
            });
        }

        async function renderAlbums() {
            const albumsGrid = document.getElementById('albums-grid');
            const emptyTip = document.getElementById('album-empty-tip');
            const albums = await db.albums.toArray();
            albumsGrid.innerHTML = '';
            if (albums.length === 0) {
                emptyTip.style.display = 'block';
                return;
            }
            emptyTip.style.display = 'none';
            for (const album of albums) {
                const discCount = await db.discs.where('albumId').equals(album.id).count();
                const item = document.createElement('div');
                item.className = 'album-item';
                item.dataset.id = album.id;
                let coverStyle = '';
                if (album.cover) {
                    const url = URL.createObjectURL(album.cover);
                    tempObjectURLs.push(url);
                    coverStyle = `background-image: url(${url});`;
                }
                item.innerHTML = `
                    <div class="album-actions">
                        <button class="album-action-btn album-edit-btn" data-action="edit" title="编辑">✏️</button>
                        <button class="album-action-btn album-delete-btn" data-action="delete" title="删除">🗑️</button>
                    </div>
                    <div class="album-icon" style="${coverStyle}">${album.cover ? '' : '💿'}</div>
                    <div class="album-name">${album.name}</div>
                    <div class="album-count">${discCount} 个Disc</div>
                `;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.album-actions')) {
                        const action = e.target.closest('.album-action-btn').dataset.action;
                        if (action === 'edit') openEditAlbumDialog(album);
                        else if (action === 'delete') deleteAlbum(album.id, album.name);
                    } else {
                        currentAlbumId = album.id;
                        renderDiscDetail(album.id, album.name);
                    }
                });
                albumsGrid.appendChild(item);
            }
        }

        async function renderDiscDetail(albumId, albumName) {
            document.getElementById('disc-album-title').textContent = albumName;
            const discList = document.getElementById('disc-list');
            const audioList = document.getElementById('audio-list');
            const emptyTip = document.getElementById('disc-empty-tip');
            const batchBtn = document.getElementById('batch-mode-btn');
            const viewControls = document.querySelector('.view-controls');
            const discs = (await db.discs.where('albumId').equals(albumId).toArray()).sort((a, b) => (a.order || 0) - (b.order || 0));
            discList.innerHTML = '';
            audioList.innerHTML = '';
            
            if (discs.length === 0) {
                emptyTip.style.display = 'block';
                viewControls.style.display = 'none';
                currentDiscId = null;
                batchBtn.style.display = 'none';
                audioList.innerHTML = `
                    <div style="text-align:center;color:var(--text-secondary);padding:40px 20px;">
                        <div style="font-size:48px;margin-bottom:15px;">📀</div>
                        <p>请先创建Disc后再添加音频</p>
                        <p style="font-size:12px;margin-top:10px;opacity:0.7;">点击右上角"+"按钮创建Disc</p>
                    </div>
                `;
                navigateTo('disc-detail-view');
                return;
            }
            
            emptyTip.style.display = 'none';
            viewControls.style.display = 'flex';
            batchBtn.style.display = currentViewMode === 'disc' ? 'block' : 'none';
            
            if (currentViewMode === 'disc') {
                discList.style.display = 'flex';
                if (!currentDiscId || !discs.find(d => d.id === currentDiscId)) {
                    currentDiscId = discs[0].id;
                }
            } else {
                discList.style.display = 'none';
            }
            
            for (const disc of discs) {
                const item = document.createElement('div');
                item.className = 'disc-item' + (disc.id === currentDiscId ? ' selected' : '');
                item.dataset.id = disc.id;
                item.draggable = true;
                let coverStyle = '';
                if (disc.cover) {
                    const url = URL.createObjectURL(disc.cover);
                    tempObjectURLs.push(url);
                    coverStyle = `background-image: url(${url}); background-size: cover;`;
                }
                item.innerHTML = `
                    <div class="disc-actions">
                        <button class="album-action-btn album-edit-btn" data-action="edit" title="编辑">✏️</button>
                        <button class="album-action-btn album-delete-btn" data-action="delete" title="删除">🗑️</button>
                    </div>
                    <div class="disc-icon" style="${coverStyle}">${disc.cover ? '' : '📀'}</div>
                    <div class="disc-name">${disc.name}</div>
                `;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.disc-actions')) {
                        const action = e.target.closest('.album-action-btn').dataset.action;
                        if (action === 'edit') openEditDiscDialog(disc);
                        else if (action === 'delete') deleteDisc(disc.id, disc.name);
                    } else {
                        currentDiscId = disc.id;
                        batchMode = false;
                        selectedAudios.clear();
                        updateBatchToolbar();
                        renderDiscDetail(albumId, albumName);
                    }
                });
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', disc.id);
                    e.dataTransfer.effectAllowed = 'move';
                });
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    document.querySelectorAll('.disc-item').forEach(el => el.classList.remove('drag-over'));
                });
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    item.classList.add('drag-over');
                });
                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                });
                item.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    const draggedId = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetId = disc.id;
                    if (draggedId !== targetId) {
                        const draggedIndex = discs.findIndex(d => d.id === draggedId);
                        const targetIndex = discs.findIndex(d => d.id === targetId);
                        const [removed] = discs.splice(draggedIndex, 1);
                        discs.splice(targetIndex, 0, removed);
                        for (let i = 0; i < discs.length; i++) {
                            await db.discs.update(discs[i].id, { order: i });
                        }
                        renderDiscDetail(albumId, albumName);
                    }
                });
                discList.appendChild(item);
            }
            
            if (currentViewMode === 'disc') {
                await renderAudios(currentDiscId);
            } else {
                await renderAllAudios(albumId, discs);
            }
            navigateTo('disc-detail-view');
        }

        async function renderAudios(discId) {
            const audioList = document.getElementById('audio-list');
            audioList.innerHTML = '';
            if (!discId) return;
            
            const audios = await db.audios.where('discId').equals(discId).toArray();
            
            if (audios.length === 0) {
                audioList.innerHTML = `
                    <div style="text-align:center;color:var(--text-secondary);padding:40px 20px;">
                        <div style="font-size:48px;margin-bottom:15px;">🎵</div>
                        <p>暂无音频</p>
                        <p style="font-size:12px;margin-top:10px;opacity:0.7;">点击下方按钮添加音频</p>
                    </div>
                `;
            } else {
                for (const audio of audios) {
                    const item = document.createElement('div');
                    item.className = 'audio-item' + (selectedAudios.has(audio.id) ? ' selected' : '');
                    item.dataset.id = audio.id;
                    let coverUrl = defaultCover;
                    if (audio.imageFile) {
                        coverUrl = URL.createObjectURL(audio.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                    
                    const checkboxHtml = batchMode ? `<input type="checkbox" class="audio-checkbox" ${selectedAudios.has(audio.id) ? 'checked' : ''}>` : '';
                    const trackInfo = audio.trackNumber ? `${audio.trackNumber}. ` : '';
                    const artistInfo = audio.artist ? ` - ${audio.artist}` : '';
                    
                    item.innerHTML = `
                        ${checkboxHtml}
                        <img class="audio-cover" src="${coverUrl}" alt="cover">
                        <div class="audio-info">
                            <div class="audio-title">${trackInfo}${audio.title}</div>
                            <div class="audio-meta">${audio.duration ? formatTime(audio.duration) : '未知时长'}${artistInfo}</div>
                        </div>
                        <div class="audio-actions">
                            <button class="audio-action-btn play-btn" data-action="play" title="播放">▶</button>
                            <button class="audio-action-btn favorite ${audio.isFavorite ? 'active' : ''}" data-action="favorite" title="收藏">❤️</button>
                            <button class="audio-action-btn" data-action="edit" title="编辑">✏️</button>
                            <button class="audio-action-btn" data-action="delete" title="删除" style="color:#ff4444;">🗑️</button>
                        </div>
                    `;
                    
                    if (batchMode) {
                        const checkbox = item.querySelector('.audio-checkbox');
                        checkbox.addEventListener('change', (e) => {
                            if (e.target.checked) {
                                selectedAudios.add(audio.id);
                            } else {
                                selectedAudios.delete(audio.id);
                            }
                            item.classList.toggle('selected', selectedAudios.has(audio.id));
                            updateBatchToolbar();
                        });
                        item.querySelector('.audio-info').addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (selectedAudios.has(audio.id)) {
                                selectedAudios.delete(audio.id);
                            } else {
                                selectedAudios.add(audio.id);
                            }
                            renderAudios(discId);
                            updateBatchToolbar();
                        });
                    } else {
                        item.querySelector('.audio-info').addEventListener('click', () => playAudio(audio.id));
                    }
                    
                    item.querySelectorAll('.audio-action-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const action = btn.dataset.action;
                            if (action === 'play') playAudio(audio.id);
                            else if (action === 'favorite') await toggleFavorite(audio.id);
                            else if (action === 'edit') openEditAudioDialog(audio);
                            else if (action === 'delete') deleteAudioWithUndo(audio.id, audio.title);
                        });
                    });
                    audioList.appendChild(item);
                }
            }
            
            const addBtn = document.createElement('button');
            addBtn.className = 'glass-button primary';
            addBtn.style.cssText = 'width:100%;margin-top:15px;';
            addBtn.textContent = '+ 添加音频';
            addBtn.addEventListener('click', () => openAddAudioDialog());
            audioList.appendChild(addBtn);
        }

        async function renderAllAudios(albumId, discs) {
            const audioList = document.getElementById('audio-list');
            audioList.innerHTML = '';
            
            let allAudios = [];
            for (const disc of discs) {
                const audios = await db.audios.where('discId').equals(disc.id).toArray();
                audios.forEach(a => a.discName = disc.name);
                allAudios = allAudios.concat(audios);
            }
            
            allAudios = sortAudios(allAudios);
            
            if (allAudios.length === 0) {
                audioList.innerHTML = `
                    <div style="text-align:center;color:var(--text-secondary);padding:40px 20px;">
                        <div style="font-size:48px;margin-bottom:15px;">🎵</div>
                        <p>暂无音频</p>
                    </div>
                `;
                return;
            }
            
            for (const audio of allAudios) {
                const item = document.createElement('div');
                item.className = 'audio-item';
                item.dataset.id = audio.id;
                let coverUrl = defaultCover;
                if (audio.imageFile) {
                    coverUrl = URL.createObjectURL(audio.imageFile);
                    tempObjectURLs.push(coverUrl);
                }
                
                const trackInfo = audio.trackNumber ? `${audio.trackNumber}. ` : '';
                const artistInfo = audio.artist ? ` - ${audio.artist}` : '';
                const discInfo = audio.discName ? `[${audio.discName}]` : '';
                
                item.innerHTML = `
                    <img class="audio-cover" src="${coverUrl}" alt="cover">
                    <div class="audio-info">
                        <div class="audio-title">${trackInfo}${audio.title}</div>
                        <div class="audio-meta">${discInfo} ${audio.duration ? formatTime(audio.duration) : '未知时长'}${artistInfo}</div>
                    </div>
                    <div class="audio-actions">
                        <button class="audio-action-btn play-btn" data-action="play" title="播放">▶</button>
                        <button class="audio-action-btn favorite ${audio.isFavorite ? 'active' : ''}" data-action="favorite" title="收藏">❤️</button>
                        <button class="audio-action-btn" data-action="edit" title="编辑">✏️</button>
                        <button class="audio-action-btn" data-action="delete" title="删除" style="color:#ff4444;">🗑️</button>
                    </div>
                `;
                
                item.querySelector('.audio-info').addEventListener('click', () => playAudio(audio.id));
                
                item.querySelectorAll('.audio-action-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const action = btn.dataset.action;
                        if (action === 'play') playAudio(audio.id);
                        else if (action === 'favorite') await toggleFavorite(audio.id);
                        else if (action === 'edit') openEditAudioDialog(audio);
                        else if (action === 'delete') deleteAudioWithUndo(audio.id, audio.title);
                    });
                });
                audioList.appendChild(item);
            }
        }

        function sortAudios(audios) {
            const sorted = [...audios];
            switch (currentSortBy) {
                case 'track':
                    sorted.sort((a, b) => (a.trackNumber || 999) - (b.trackNumber || 999));
                    break;
                case 'title':
                    sorted.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                    break;
                case 'duration':
                    sorted.sort((a, b) => (a.duration || 0) - (b.duration || 0));
                    break;
                case 'artist':
                    sorted.sort((a, b) => (a.artist || '').localeCompare(b.artist || ''));
                    break;
                case 'createdAt':
                    sorted.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                    break;
                default:
                    break;
            }
            if (currentSortOrder === 'desc') {
                sorted.reverse();
            }
            return sorted;
        }

        function updateBatchToolbar() {
            const toolbar = document.getElementById('batch-toolbar');
            const countSpan = toolbar.querySelector('.selected-count');
            const batchBtn = document.getElementById('batch-mode-btn');
            
            if (batchMode && selectedAudios.size > 0) {
                toolbar.classList.add('active');
                countSpan.textContent = `已选择 ${selectedAudios.size} 项`;
            } else {
                toolbar.classList.remove('active');
            }
            
            batchBtn.textContent = batchMode ? '退出批量' : '批量管理';
            batchBtn.classList.toggle('active', batchMode);
        }

        function toggleBatchMode() {
            batchMode = !batchMode;
            selectedAudios.clear();
            updateBatchToolbar();
            renderAudios(currentDiscId);
        }

        async function deleteSelectedAudios() {
            if (selectedAudios.size === 0) return;
            
            const confirmed = await showConfirm('批量删除', `确定删除选中的 ${selectedAudios.size} 个音频吗？`);
            if (!confirmed) return;
            
            const deletedAudios = [];
            for (const id of selectedAudios) {
                const audio = await db.audios.get(id);
                if (audio) deletedAudios.push(audio);
                await db.audios.delete(id);
            }
            
            showToastWithUndo(`已删除 ${deletedAudios.length} 个音频`, async () => {
                for (const audio of deletedAudios) {
                    await db.audios.add(audio);
                }
                renderAudios(currentDiscId);
                showToast('已恢复删除的音频');
            });
            
            selectedAudios.clear();
            batchMode = false;
            updateBatchToolbar();
            renderAudios(currentDiscId);
        }

        function openCreateAlbumDialog() {
            currentDialogMode = 'create-album';
            editingEntityId = null;
            document.getElementById('dialog-title').textContent = '创建专辑';
            document.getElementById('entity-name-input').value = '';
            document.getElementById('entity-cover-input').value = '';
            document.getElementById('entity-cover-preview').style.display = 'none';
            document.getElementById('entity-number-input').value = '';
            document.getElementById('entity-artist-input').value = '';
            document.getElementById('entity-release-date-input').value = '';
            document.getElementById('entity-description-input').value = '';
            document.querySelectorAll('.album-only-field').forEach(el => el.style.display = 'block');
            document.querySelectorAll('.disc-only-field').forEach(el => el.style.display = 'none');
            document.getElementById('entity-confirm-btn').textContent = '创建';
            document.getElementById('name-warning').classList.remove('visible');
            dialogOriginalData = { name: '', cover: null };
            isDialogDirty = false;
            document.getElementById('entity-dialog').classList.add('active');
        }

        function openEditAlbumDialog(album) {
            currentDialogMode = 'edit-album';
            editingEntityId = album.id;
            document.getElementById('dialog-title').textContent = '编辑专辑';
            document.getElementById('entity-name-input').value = album.name;
            document.getElementById('entity-cover-input').value = '';
            document.getElementById('entity-number-input').value = album.albumNumber || '';
            document.getElementById('entity-artist-input').value = album.artist || '';
            document.getElementById('entity-release-date-input').value = album.releaseDate || '';
            document.getElementById('entity-description-input').value = album.description || '';
            document.querySelectorAll('.album-only-field').forEach(el => el.style.display = 'block');
            document.querySelectorAll('.disc-only-field').forEach(el => el.style.display = 'none');
            const preview = document.getElementById('entity-cover-preview');
            if (album.cover) {
                const url = URL.createObjectURL(album.cover);
                preview.src = url;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
            document.getElementById('entity-confirm-btn').textContent = '保存';
            document.getElementById('name-warning').classList.remove('visible');
            dialogOriginalData = { name: album.name, cover: album.cover };
            isDialogDirty = false;
            document.getElementById('entity-dialog').classList.add('active');
        }

        function openCreateDiscDialog() {
            currentDialogMode = 'create-disc';
            editingEntityId = null;
            document.getElementById('dialog-title').textContent = '创建Disc';
            document.getElementById('entity-name-input').value = '';
            document.getElementById('entity-cover-input').value = '';
            document.getElementById('entity-cover-preview').style.display = 'none';
            document.getElementById('entity-disc-number-input').value = '';
            document.getElementById('entity-disc-description-input').value = '';
            document.querySelectorAll('.album-only-field').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.disc-only-field').forEach(el => el.style.display = 'block');
            document.getElementById('entity-confirm-btn').textContent = '创建';
            document.getElementById('name-warning').classList.remove('visible');
            dialogOriginalData = { name: '', cover: null };
            isDialogDirty = false;
            document.getElementById('entity-dialog').classList.add('active');
        }

        function openEditDiscDialog(disc) {
            currentDialogMode = 'edit-disc';
            editingEntityId = disc.id;
            document.getElementById('dialog-title').textContent = '编辑Disc';
            document.getElementById('entity-name-input').value = disc.name;
            document.getElementById('entity-cover-input').value = '';
            document.getElementById('entity-disc-number-input').value = disc.discNumber || '';
            document.getElementById('entity-disc-description-input').value = disc.description || '';
            document.querySelectorAll('.album-only-field').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.disc-only-field').forEach(el => el.style.display = 'block');
            const preview = document.getElementById('entity-cover-preview');
            if (disc.cover) {
                const url = URL.createObjectURL(disc.cover);
                preview.src = url;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
            document.getElementById('entity-confirm-btn').textContent = '保存';
            document.getElementById('name-warning').classList.remove('visible');
            dialogOriginalData = { name: disc.name, cover: disc.cover };
            isDialogDirty = false;
            document.getElementById('entity-dialog').classList.add('active');
        }

        async function handleEntityConfirm() {
            if (isSubmitting) return;
            const name = document.getElementById('entity-name-input').value.trim();
            if (!name) {
                document.getElementById('name-warning').classList.add('visible');
                return;
            }
            isSubmitting = true;
            const coverInput = document.getElementById('entity-cover-input');
            let coverBlob = null;
            if (coverInput.files[0]) {
                coverBlob = coverInput.files[0];
            }
            try {
                if (currentDialogMode === 'create-album') {
                    const albumNumber = document.getElementById('entity-number-input').value.trim();
                    const artist = document.getElementById('entity-artist-input').value.trim();
                    const releaseDate = document.getElementById('entity-release-date-input').value;
                    const description = document.getElementById('entity-description-input').value.trim();
                    await db.albums.add({ 
                        name, 
                        cover: coverBlob, 
                        albumNumber, 
                        artist, 
                        releaseDate, 
                        description,
                        createdAt: Date.now() 
                    });
                    showToast('专辑创建成功');
                } else if (currentDialogMode === 'edit-album') {
                    const albumNumber = document.getElementById('entity-number-input').value.trim();
                    const artist = document.getElementById('entity-artist-input').value.trim();
                    const releaseDate = document.getElementById('entity-release-date-input').value;
                    const description = document.getElementById('entity-description-input').value.trim();
                    const updateData = { name, albumNumber, artist, releaseDate, description, updatedAt: Date.now() };
                    if (coverBlob) updateData.cover = coverBlob;
                    await db.albums.update(editingEntityId, updateData);
                    showToast('专辑更新成功');
                } else if (currentDialogMode === 'create-disc') {
                    const discNumber = parseInt(document.getElementById('entity-disc-number-input').value) || null;
                    const discDescription = document.getElementById('entity-disc-description-input').value.trim();
                    await db.discs.add({ 
                        albumId: currentAlbumId, 
                        name, 
                        cover: coverBlob, 
                        discNumber,
                        description: discDescription,
                        createdAt: Date.now() 
                    });
                    showToast('Disc创建成功');
                } else if (currentDialogMode === 'edit-disc') {
                    const discNumber = parseInt(document.getElementById('entity-disc-number-input').value) || null;
                    const discDescription = document.getElementById('entity-disc-description-input').value.trim();
                    const updateData = { name, discNumber, description: discDescription, updatedAt: Date.now() };
                    if (coverBlob) updateData.cover = coverBlob;
                    await db.discs.update(editingEntityId, updateData);
                    showToast('Disc更新成功');
                }
                closeAllDialogs();
                if (currentDialogMode.includes('album')) renderAlbums();
                else {
                    const album = await db.albums.get(currentAlbumId);
                    renderDiscDetail(currentAlbumId, album.name);
                }
            } catch (error) {
                console.error('保存失败:', error);
                showToast('保存失败: ' + error.message);
            }
            isSubmitting = false;
        }

        async function deleteAlbum(id, name) {
            const confirmed = await showConfirm('删除专辑', `确定删除专辑"${name}"吗？\n这将同时删除所有Disc和音频文件！`);
            if (confirmed) {
                await db.albums.delete(id);
                showToast('专辑已删除');
                renderAlbums();
            }
        }

        async function deleteDisc(id, name) {
            const confirmed = await showConfirm('删除Disc', `确定删除Disc"${name}"吗？\n这将同时删除所有音频文件！`);
            if (confirmed) {
                await db.discs.delete(id);
                if (currentDiscId === id) currentDiscId = null;
                showToast('Disc已删除');
                const album = await db.albums.get(currentAlbumId);
                renderDiscDetail(currentAlbumId, album.name);
            }
        }

        function openAddAudioDialog() {
            if (!currentDiscId) {
                showToast('请先选择或创建一个Disc');
                return;
            }
            editingAudioId = null;
            document.getElementById('audio-dialog-title').textContent = '添加音频';
            document.getElementById('audio-title-input').value = '';
            document.getElementById('audio-track-input').value = '';
            document.getElementById('audio-duration-input').value = '';
            document.getElementById('audio-artist-input').value = '';
            document.getElementById('audio-composer-input').value = '';
            document.getElementById('audio-lyricist-input').value = '';
            document.getElementById('audio-circle-input').value = '';
            document.getElementById('audio-lyric-input').value = '';
            document.getElementById('audio-dialog-file-input').value = '';
            document.getElementById('audio-dialog-url-input').value = '';
            document.getElementById('audio-image-input').value = '';
            document.getElementById('audio-image-preview').style.display = 'none';
            document.getElementById('audio-confirm-btn').textContent = '添加';
            document.getElementById('audio-title-warning').classList.remove('visible');
            audioDialogOriginalData = { title: '', lyric: '', audioFile: null, imageFile: null };
            audioDialogOriginalFile = null;
            audioDialogOriginalImage = null;
            audioDialogDirty = false;
            document.getElementById('audio-dialog').classList.add('active');
        }

        function openEditAudioDialog(audio) {
            editingAudioId = audio.id;
            document.getElementById('audio-dialog-title').textContent = '编辑音频';
            document.getElementById('audio-title-input').value = audio.title;
            document.getElementById('audio-track-input').value = audio.trackNumber || '';
            document.getElementById('audio-duration-input').value = audio.duration ? formatTime(audio.duration) : '';
            document.getElementById('audio-artist-input').value = audio.artist || '';
            document.getElementById('audio-composer-input').value = audio.composer || '';
            document.getElementById('audio-lyricist-input').value = audio.lyricist || '';
            document.getElementById('audio-circle-input').value = audio.circle || '';
            document.getElementById('audio-lyric-input').value = audio.lyrics || '';
            document.getElementById('audio-dialog-file-input').value = '';
            document.getElementById('audio-dialog-url-input').value = audio.audioType === 'url' ? audio.audioSource : '';
            const preview = document.getElementById('audio-image-preview');
            if (audio.imageFile) {
                const url = URL.createObjectURL(audio.imageFile);
                preview.src = url;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
            document.getElementById('audio-confirm-btn').textContent = '保存';
            document.getElementById('audio-title-warning').classList.remove('visible');
            audioDialogOriginalData = { title: audio.title, lyric: audio.lyrics || '' };
            audioDialogOriginalFile = audio.audioFile || null;
            audioDialogOriginalImage = audio.imageFile || null;
            audioDialogDirty = false;
            document.getElementById('audio-dialog').classList.add('active');
        }

        async function handleAudioConfirm() {
            if (isSubmitting) return;
            const title = document.getElementById('audio-title-input').value.trim();
            if (!title) {
                document.getElementById('audio-title-warning').classList.add('visible');
                return;
            }
            isSubmitting = true;
            const lyrics = document.getElementById('audio-lyric-input').value;
            const trackNumber = parseInt(document.getElementById('audio-track-input').value) || null;
            const artist = document.getElementById('audio-artist-input').value.trim();
            const composer = document.getElementById('audio-composer-input').value.trim();
            const lyricist = document.getElementById('audio-lyricist-input').value.trim();
            const circle = document.getElementById('audio-circle-input').value.trim();
            const fileInput = document.getElementById('audio-dialog-file-input');
            const urlInput = document.getElementById('audio-dialog-url-input');
            const imageInput = document.getElementById('audio-image-input');
            const isUrlMode = document.querySelector('input[name="audio-dialog-source"]:checked').value === 'url';
            try {
                const audioData = {
                    title,
                    lyrics,
                    trackNumber,
                    artist,
                    composer,
                    lyricist,
                    circle,
                    discId: currentDiscId,
                    albumId: currentAlbumId,
                    isFavorite: false,
                    createdAt: Date.now()
                };
                if (isUrlMode && urlInput.value) {
                    audioData.audioType = 'url';
                    audioData.audioSource = urlInput.value;
                } else if (fileInput.files[0]) {
                    audioData.audioType = 'file';
                    audioData.audioFile = fileInput.files[0];
                } else if (editingAudioId && audioDialogOriginalFile) {
                    audioData.audioType = 'file';
                    audioData.audioFile = audioDialogOriginalFile;
                }
                if (imageInput.files[0]) {
                    audioData.imageFile = imageInput.files[0];
                } else if (editingAudioId && audioDialogOriginalImage) {
                    audioData.imageFile = audioDialogOriginalImage;
                }
                if (editingAudioId) {
                    const updateData = { title, lyrics, trackNumber, artist, composer, lyricist, circle, updatedAt: Date.now() };
                    if (audioData.audioFile) updateData.audioFile = audioData.audioFile;
                    if (audioData.audioSource) {
                        updateData.audioType = audioData.audioType;
                        updateData.audioSource = audioData.audioSource;
                    }
                    if (audioData.imageFile) updateData.imageFile = audioData.imageFile;
                    await db.audios.update(editingAudioId, updateData);
                    showToast('音频更新成功');
                } else {
                    await db.audios.add(audioData);
                    showToast('音频添加成功');
                }
                closeAllDialogs();
                renderAudios(currentDiscId);
            } catch (error) {
                console.error('保存失败:', error);
                showToast('保存失败: ' + error.message);
            }
            isSubmitting = false;
        }

        async function toggleFavorite(audioId) {
            const audio = await db.audios.get(audioId);
            await db.audios.update(audioId, { isFavorite: !audio.isFavorite });
            renderAudios(currentDiscId);
        }

        async function deleteAudioWithUndo(id, title) {
            const audio = await db.audios.get(id);
            if (!audio) return;
            
            await db.audios.delete(id);
            showToastWithUndo(`已删除"${title}"`, async () => {
                await db.audios.add(audio);
                renderAudios(currentDiscId);
                showToast('已恢复删除的音频');
            });
            renderAudios(currentDiscId);
        }

        async function playAudio(audioId, resumePlay = false) {
            try {
                const audio = await db.audios.get(audioId);
                if (!audio) {
                    showToast('音频不存在');
                    return;
                }
                const playerView = document.getElementById('player-view');
                const audioPlayer = document.getElementById('audio-player');
                playerView.dataset.currentAudioId = audioId;
                localStorage.setItem('lastPlayedAudioId', audioId);
                if (audio.albumId) localStorage.setItem('lastPlayedAlbumId', audio.albumId);
                if (audio.discId) localStorage.setItem('lastPlayedDiscId', audio.discId);
                if (audio.audioType === 'url' && audio.audioSource) {
                    audioPlayer.src = audio.audioSource;
                } else if (audio.audioFile) {
                    const url = URL.createObjectURL(audio.audioFile);
                    tempObjectURLs.push(url);
                    audioPlayer.src = url;
                } else {
                    showToast('音频源不存在');
                    return;
                }
                customCoverUrl = null;
                let coverUrl = defaultCover;
                if (audio.imageFile) {
                    coverUrl = URL.createObjectURL(audio.imageFile);
                    tempObjectURLs.push(coverUrl);
                }
                currentAudioCover = coverUrl;
                currentAudioTitle = audio.title;
                if (audio.backgroundImage) {
                    const bgUrl = URL.createObjectURL(audio.backgroundImage);
                    tempObjectURLs.push(bgUrl);
                    playerView.style.backgroundImage = `url(${bgUrl})`;
                } else {
                    playerView.style.backgroundImage = '';
                }
                if (audio.lyrics) {
                    currentLyrics = parseLyrics(audio.lyrics);
                } else {
                    currentLyrics = [];
                }
                const fullLyricsList = document.getElementById('full-lyrics-list');
                if (fullLyricsList && currentLyrics.length > 0) {
                    fullLyricsList.innerHTML = currentLyrics.map((line, i) => 
                        `<div class="full-lyric-line" data-index="${i}" data-start="${line.startTime}">${line.text}</div>`
                    ).join('');
                    fullLyricsList.querySelectorAll('.full-lyric-line').forEach(line => {
                        line.addEventListener('click', () => {
                            const start = parseFloat(line.dataset.start);
                            if (!isNaN(start)) {
                                document.getElementById('audio-player').currentTime = start;
                            }
                        });
                    });
                } else if (fullLyricsList) {
                    fullLyricsList.innerHTML = '<div class="full-lyric-line" style="color:#666;">暂无歌词</div>';
                }
                applyPlayerStyle(currentPlayerStyle);
                document.getElementById('song-title-box').textContent = audio.title;
                document.getElementById('album-art').src = coverUrl;
                // 启动歌曲标题滚动效果
                setTimeout(startTitleScroll, 500);
                playerPreviousView = 'disc-detail-view';
                navigateTo('player-view');
                bottomPlayer.updateSong(audio);
                if (resumePlay) {
                    const savedTime = parseFloat(localStorage.getItem('lastPlayedTime')) || 0;
                    audioPlayer.currentTime = savedTime;
                }
                await audioPlayer.play();
            } catch (err) {
                console.error('播放失败:', err);
                showToast('播放失败: ' + err.message);
            }
        }

        function parseLyrics(lyricText) {
            const lines = lyricText.trim().split('\n');
            const lyrics = [];
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                if (trimmed === 'WEBVTT' || trimmed.startsWith('NOTE') || /^\d+$/.test(trimmed)) continue;
                const vttMatch = trimmed.match(/(\d{2}):(\d{2}):(\d{2})\.(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2})\.(\d{3})/);
                if (vttMatch) {
                    const startH = parseInt(vttMatch[1]), startM = parseInt(vttMatch[2]), startS = parseInt(vttMatch[3]), startMs = parseInt(vttMatch[4]);
                    const endH = parseInt(vttMatch[5]), endM = parseInt(vttMatch[6]), endS = parseInt(vttMatch[7]), endMs = parseInt(vttMatch[8]);
                    lyrics.push({
                        startTime: startH * 3600 + startM * 60 + startS + startMs / 1000,
                        endTime: endH * 3600 + endM * 60 + endS + endMs / 1000,
                        text: ''
                    });
                    continue;
                }
                const lrcMatch = trimmed.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
                if (lrcMatch) {
                    const m = parseInt(lrcMatch[1]), s = parseInt(lrcMatch[2]), ms = parseInt(lrcMatch[3].padEnd(3, '0'));
                    lyrics.push({
                        startTime: m * 60 + s + ms / 1000,
                        text: lrcMatch[4].trim()
                    });
                    continue;
                }
                if (lyrics.length > 0 && !lyrics[lyrics.length - 1].text) {
                    lyrics[lyrics.length - 1].text = trimmed;
                }
            }
            lyrics.sort((a, b) => a.startTime - b.startTime);
            for (let i = 0; i < lyrics.length - 1; i++) {
                if (!lyrics[i].endTime) lyrics[i].endTime = lyrics[i + 1].startTime;
            }
            return lyrics;
        }

        function applyPlayerStyle(style) {
            const playerView = document.getElementById('player-view');
            const contentWrapper = document.getElementById('player-content-wrapper');
            playerView.classList.remove('style-simple', 'style-cloud', 'style-wallpaper');
            playerView.classList.add(`style-${style}`);
            currentPlayerStyle = style;
            localStorage.setItem('playerStyle', style);
            const currentTitle = currentAudioTitle || 'Unknown Song';
            const currentCover = customCoverUrl || currentAudioCover || defaultCover;
            contentWrapper.innerHTML = '';
            if (style === 'simple') {
                contentWrapper.innerHTML = `
                    <div class="simple-title-box"><div id="song-title-box">${currentTitle}</div></div>
                    <img id="album-art" alt="Art" src="${currentCover}">
                    <div class="lyric-bubble"><p id="lyric-display">...</p></div>
                `;
                setupDragAndDrop();
            } else if (style === 'cloud') {
                contentWrapper.innerHTML = `
                    <img id="album-art" alt="Art" src="${currentCover}">
                    <div class="lyric-scroll-container">
                        <div class="cloud-title-box"><div id="song-title-box">${currentTitle}</div></div>
                        <div id="lyric-scroll-content">
                            ${currentLyrics.map((line, i) => `<div class="lyric-scroll-line" data-index="${i}" data-start="${line.startTime}">${line.text}</div>`).join('')}
                        </div>
                    </div>
                `;
                setupDragAndDrop();
                bindLyricClicks();
            } else if (style === 'wallpaper') {
                contentWrapper.innerHTML = `
                    <div class="wallpaper-lyric-container">
                        <div class="wallpaper-title-box"><div id="song-title-box">${currentTitle}</div></div>
                        <img id="album-art" alt="Art" src="${currentCover}" style="width:180px;height:180px;margin:0 auto 20px;display:block;border-radius:12px;">
                        <div id="wallpaper-lyric-content">
                            ${currentLyrics.map((line, i) => `<div class="wallpaper-lyric-line" data-index="${i}" data-start="${line.startTime}">${line.text}</div>`).join('')}
                        </div>
                    </div>
                `;
                setupDragAndDrop();
                bindLyricClicks();
            }
            updateStyleMenuActive();
            applyDisplaySettings();
        }

        function applyDisplaySettings() {
            const height = localStorage.getItem('lyricBoxHeight') || '60';
            const blur = localStorage.getItem('glassBlurAmount') || '15';
            const boxOpacity = localStorage.getItem('lyricBoxOpacity') || '0.1';
            const lyricOpacity = localStorage.getItem('lyricOpacity') || '1.0';
            document.documentElement.style.setProperty('--lyric-box-height', `${height}vh`);
            document.documentElement.style.setProperty('--glass-blur-amount', `${blur}px`);
            document.documentElement.style.setProperty('--lyric-box-bg', `rgba(255, 255, 255, ${boxOpacity})`);
            document.documentElement.style.setProperty('--lyric-color-opacity', lyricOpacity);
        }

        function bindLyricClicks() {
            document.querySelectorAll('.lyric-scroll-line, .wallpaper-lyric-line').forEach(line => {
                line.addEventListener('click', () => {
                    const start = parseFloat(line.dataset.start);
                    if (!isNaN(start)) document.getElementById('audio-player').currentTime = start;
                });
            });
        }

        function updateStyleMenuActive() {
            document.querySelectorAll('#style-switch-menu a').forEach(a => {
                a.classList.toggle('active', a.dataset.style === currentPlayerStyle);
            });
        }

        // 歌曲标题滚动效果
        function startTitleScroll() {
            const titleBoxes = document.querySelectorAll('#song-title-box');
            titleBoxes.forEach(titleBox => {
                const titleText = titleBox.textContent;
                if (titleText && titleBox.scrollWidth > titleBox.clientWidth) {
                    let position = 0;
                    const scrollSpeed = 2;
                    const pauseDuration = 2000;
                    
                    function scroll() {
                        if (position >= titleBox.scrollWidth - titleBox.clientWidth) {
                            position = 0;
                            setTimeout(scroll, pauseDuration);
                        } else {
                            position += scrollSpeed;
                            titleBox.scrollLeft = position;
                            requestAnimationFrame(scroll);
                        }
                    }
                    
                    setTimeout(scroll, pauseDuration);
                }
            });
        }

        function setupDragAndDrop() {
            const albumArt = document.getElementById('album-art');
            const simpleTitleBox = document.querySelector('.simple-title-box');
            const cloudTitleBox = document.querySelector('.cloud-title-box');
            const wallpaperTitleBox = document.querySelector('.wallpaper-title-box');
            const lyricBubble = document.querySelector('.lyric-bubble');
            [albumArt, simpleTitleBox, cloudTitleBox, wallpaperTitleBox, lyricBubble].forEach(el => {
                if (!el) return;
                let isDragging = false, startX, startY, startLeft, startTop;
                el.addEventListener('mousedown', e => {
                    isDragging = true;
                    el.classList.add('dragging');
                    const rect = el.getBoundingClientRect();
                    startX = e.clientX;
                    startY = e.clientY;
                    startLeft = rect.left;
                    startTop = rect.top;
                    if (el.classList.contains('lyric-bubble')) {
                        el.style.bottom = 'auto';
                    }
                    e.preventDefault();
                });
                document.addEventListener('mousemove', e => {
                    if (!isDragging) return;
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    el.style.left = (startLeft + dx) + 'px';
                    el.style.top = (startTop + dy) + 'px';
                    el.style.transform = 'none';
                });
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    el.classList.remove('dragging');
                });
            });
        }

        const bottomPlayer = {
            elements: {},
            currentSong: null,
            isInitialized: false,

            init() {
                this.elements = {
                    container: document.getElementById('bottom-player'),
                    art: document.getElementById('bottom-player-art'),
                    title: document.getElementById('bottom-player-title'),
                    subtitle: document.getElementById('bottom-player-subtitle'),
                    playBtn: document.getElementById('bottom-play-btn'),
                    prevBtn: document.getElementById('bottom-prev-btn'),
                    nextBtn: document.getElementById('bottom-next-btn'),
                    progress: document.getElementById('bottom-progress'),
                    currentTimeEl: document.getElementById('bottom-current-time'),
                    durationEl: document.getElementById('bottom-duration'),
                    infoArea: document.getElementById('bottom-player-info')
                };
                this.setupEvents();
                this.isInitialized = true;
            },

            setupEvents() {
                const el = this.elements;
                el.playBtn?.addEventListener('click', () => this.handlePlayPause());
                el.prevBtn?.addEventListener('click', () => this.handlePrevNext('prev'));
                el.nextBtn?.addEventListener('click', () => this.handlePrevNext('next'));
                el.progress?.addEventListener('input', (e) => this.handleProgress(e));
                el.infoArea?.addEventListener('click', () => this.handleInfoClick());
                el.art?.addEventListener('click', () => this.handleArtClick());
                const audioPlayer = document.getElementById('audio-player');
                audioPlayer?.addEventListener('play', () => this.handleAudioPlay());
                audioPlayer?.addEventListener('pause', () => this.handleAudioPause());
                audioPlayer?.addEventListener('timeupdate', () => this.handleTimeUpdate());
                audioPlayer?.addEventListener('loadedmetadata', () => this.handleLoadedMetadata());
            },

            handlePlayPause() {
                const audioPlayer = document.getElementById('audio-player');
                if (!audioPlayer?.src) {
                    const lastAudioId = localStorage.getItem('lastPlayedAudioId');
                    if (lastAudioId) {
                        playAudio(parseInt(lastAudioId), true);
                    }
                    return;
                }
                if (audioPlayer.paused) audioPlayer.play();
                else audioPlayer.pause();
            },

            async handlePrevNext(direction) {
                const playerView = document.getElementById('player-view');
                const currentId = parseInt(playerView?.dataset?.currentAudioId);
                if (!currentId) return;
                const siblingId = await getSiblingAudioId(currentId, direction);
                if (siblingId) playAudio(siblingId);
            },

            handleProgress(e) {
                const audioPlayer = document.getElementById('audio-player');
                if (audioPlayer && !isNaN(audioPlayer.duration)) {
                    audioPlayer.currentTime = parseFloat(e.target.value);
                }
            },

            handleInfoClick() {
                const playerView = document.getElementById('player-view');
                if (playerView?.dataset?.currentAudioId) navigateTo('player-view');
            },

            handleArtClick() {
                const lyricsList = document.getElementById('full-lyrics-list');
                if (lyricsList && lyricsList.children.length > 0) {
                    document.getElementById('full-lyrics-modal').classList.add('active');
                } else {
                    navigateTo('player-view');
                }
            },

            handleAudioPlay() {
                this.elements.playBtn.textContent = '❚❚';
                document.body.classList.remove('no-active-song');
            },

            handleAudioPause() {
                this.elements.playBtn.textContent = '▶';
            },

            handleTimeUpdate() {
                const audioPlayer = document.getElementById('audio-player');
                if (!audioPlayer || isNaN(audioPlayer.duration)) return;
                this.elements.progress.value = audioPlayer.currentTime;
                this.elements.progress.max = audioPlayer.duration;
                this.elements.currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                const remaining = audioPlayer.duration - audioPlayer.currentTime;
                this.elements.durationEl.textContent = '-' + formatTime(remaining);
                const mainProgress = document.getElementById('progress-bar');
                const mainCurrentTime = document.getElementById('current-time');
                const mainDuration = document.getElementById('duration-time');
                if (mainProgress) { mainProgress.value = audioPlayer.currentTime; mainProgress.max = audioPlayer.duration; }
                if (mainCurrentTime) mainCurrentTime.textContent = formatTime(audioPlayer.currentTime);
                if (mainDuration) mainDuration.textContent = '-' + formatTime(remaining);
                this.updateLyricDisplay(audioPlayer.currentTime);
                if (Math.floor(audioPlayer.currentTime) % 5 === 0) {
                    localStorage.setItem('lastPlayedTime', audioPlayer.currentTime);
                }
            },

            handleLoadedMetadata() {
                const audioPlayer = document.getElementById('audio-player');
                if (!audioPlayer || isNaN(audioPlayer.duration)) return;
                this.elements.progress.max = audioPlayer.duration;
                this.elements.durationEl.textContent = formatTime(audioPlayer.duration);
                const mainProgress = document.getElementById('progress-bar');
                const mainDuration = document.getElementById('duration-time');
                if (mainProgress) mainProgress.max = audioPlayer.duration;
                if (mainDuration) mainDuration.textContent = formatTime(audioPlayer.duration);
                const playerView = document.getElementById('player-view');
                const currentAudioId = parseInt(playerView?.dataset?.currentAudioId);
                if (currentAudioId && audioPlayer.duration > 0) {
                    db.audios.update(currentAudioId, { duration: Math.floor(audioPlayer.duration) }).catch(err => {
                        console.warn('保存时长失败:', err);
                    });
                }
            },

            updateLyricDisplay(currentTime) {
                let activeLine = null;
                for (let i = currentLyrics.length - 1; i >= 0; i--) {
                    if (currentTime >= currentLyrics[i].startTime) {
                        activeLine = currentLyrics[i];
                        break;
                    }
                }
                const lyricDisplay = document.getElementById('lyric-display');
                if (lyricDisplay && activeLine) lyricDisplay.textContent = activeLine.text;
                document.querySelectorAll('.lyric-scroll-line, .wallpaper-lyric-line, .full-lyric-line').forEach((line, i) => {
                    line.classList.toggle('active', currentLyrics[i] && currentTime >= currentLyrics[i].startTime && (!currentLyrics[i].endTime || currentTime < currentLyrics[i].endTime));
                });
            },

            async updateSong(song) {
                if (!song) return;
                this.currentSong = song;
                if (!this.isInitialized) this.init();
                this.elements.title.textContent = song.title;
                this.elements.subtitle.textContent = '正在播放';
                let coverUrl = defaultCover;
                if (song.imageFile) {
                    coverUrl = URL.createObjectURL(song.imageFile);
                    tempObjectURLs.push(coverUrl);
                }
                this.elements.art.src = coverUrl;
                document.body.classList.remove('no-active-song');
            }
        };

        async function getSiblingAudioId(currentId, direction) {
            const audio = await db.audios.get(currentId);
            if (!audio) return null;
            const audios = await db.audios.where('discId').equals(audio.discId).toArray();
            const currentIndex = audios.findIndex(a => a.id === currentId);
            if (currentIndex === -1) return null;
            if (direction === 'next') return audios[(currentIndex + 1) % audios.length]?.id;
            else return audios[(currentIndex - 1 + audios.length) % audios.length]?.id;
        }

        async function loadBeautifySettings() {
            const theme = await db.settings.get('theme');
            document.getElementById('theme-switch').checked = theme?.value === 'light';
            const fontSize = await db.settings.get('fontSize');
            const size = fontSize?.value || '16';
            document.getElementById('font-size-slider').value = size;
            document.getElementById('font-size-value').textContent = size + 'px';
            const appConfig = await db.settings.get('appConfig');
            const config = appConfig?.value || defaultAppConfig;
            const container = document.getElementById('app-customize-container');
            container.innerHTML = '';
            config.forEach((app, i) => {
                const row = document.createElement('div');
                row.className = 'app-customize-row';
                let previewStyle = '';
                if (app.icon && app.icon.startsWith('data:')) previewStyle = `background-image:url(${app.icon});background-size:cover;`;
                row.innerHTML = `
                    <div class="preview-icon" style="${previewStyle}">${app.icon && !app.icon.startsWith('data:') ? app.icon : ''}</div>
                    <input type="text" class="app-name-input" value="${app.name}" data-index="${i}">
                    <input type="file" class="app-icon-input" accept="image/*" data-index="${i}" style="display:none;">
                    <button class="select-file-btn" data-index="${i}">换图标</button>
                `;
                container.appendChild(row);
            });
            container.querySelectorAll('.select-file-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    container.querySelector(`.app-icon-input[data-index="${btn.dataset.index}"]`).click();
                });
            });
            container.querySelectorAll('.app-icon-input').forEach(input => {
                input.addEventListener('change', async (e) => {
                    const idx = parseInt(input.dataset.index);
                    const file = e.target.files[0];
                    if (file) {
                        const url = URL.createObjectURL(file);
                        container.querySelectorAll('.preview-icon')[idx].style.backgroundImage = `url(${url})`;
                        container.querySelectorAll('.preview-icon')[idx].textContent = '';
                    }
                });
            });
        }

        const smartColorSystem = {
            enabled: false,
            colorThief: null,
            palette: [],
            colorScheme: {
                background: null,
                card: null,
                button: null,
                text: null
            },
            init() {
                if (typeof ColorThief !== 'undefined') {
                    this.colorThief = new ColorThief();
                }
            },
            async extractPaletteFromImage(imageSource) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    img.onload = () => {
                        try {
                            if (this.colorThief) {
                                const palette = this.colorThief.getPalette(img, 8);
                                resolve(palette);
                            } else {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                canvas.width = 100;
                                canvas.height = 100;
                                ctx.drawImage(img, 0, 0, 100, 100);
                                const data = ctx.getImageData(0, 0, 100, 100).data;
                                const colorMap = {};
                                for (let i = 0; i < data.length; i += 4) {
                                    const r = Math.round(data[i] / 51) * 51;
                                    const g = Math.round(data[i + 1] / 51) * 51;
                                    const b = Math.round(data[i + 2] / 51) * 51;
                                    const key = `${r},${g},${b}`;
                                    colorMap[key] = (colorMap[key] || 0) + 1;
                                }
                                const sorted = Object.entries(colorMap)
                                    .sort((a, b) => b[1] - a[1])
                                    .slice(0, 8)
                                    .map(([key]) => key.split(',').map(Number));
                                resolve(sorted);
                            }
                        } catch (e) {
                            reject(e);
                        }
                    };
                    img.onerror = () => reject(new Error('图片加载失败'));
                    if (imageSource instanceof Blob) {
                        img.src = URL.createObjectURL(imageSource);
                    } else {
                        img.src = imageSource;
                    }
                });
            },
            calculateBrightness(r, g, b) {
                return (r * 299 + g * 587 + b * 114) / 1000;
            },
            autoAssignColors(palette) {
                if (palette.length < 4) return;
                const sortedByBrightness = [...palette].sort((a, b) => 
                    this.calculateBrightness(...b) - this.calculateBrightness(...a)
                );
                this.colorScheme.background = sortedByBrightness[sortedByBrightness.length - 1] || palette[0];
                this.colorScheme.card = palette[Math.min(1, palette.length - 1)];
                this.colorScheme.button = palette[0];
                this.colorScheme.text = sortedByBrightness[0];
            },
            applyColorScheme() {
                const isLightMode = document.body.classList.contains('light-mode');
                const bgRgb = this.colorScheme.background || [30, 30, 50];
                const cardRgb = this.colorScheme.card || [60, 60, 80];
                const btnRgb = this.colorScheme.button || [99, 102, 241];
                let textRgb = this.colorScheme.text || [255, 255, 255];
                const bgBrightness = this.calculateBrightness(...bgRgb);
                if (!this.colorScheme.text) {
                    textRgb = bgBrightness > 128 ? [51, 51, 51] : [255, 255, 255];
                }
                document.documentElement.style.setProperty('--bg-color-rgb', `${bgRgb[0]}, ${bgRgb[1]}, ${bgRgb[2]}`);
                document.documentElement.style.setProperty('--card-color-rgb', `${cardRgb[0]}, ${cardRgb[1]}, ${cardRgb[2]}`);
                document.documentElement.style.setProperty('--btn-color-rgb', `${btnRgb[0]}, ${btnRgb[1]}, ${btnRgb[2]}`);
                document.documentElement.style.setProperty('--text-color-rgb', `${textRgb[0]}, ${textRgb[1]}, ${textRgb[2]}`);
                document.documentElement.style.setProperty('--primary-rgb', `${btnRgb[0]}, ${btnRgb[1]}, ${btnRgb[2]}`);
                const textColor = isLightMode ? '#333333' : '#ffffff';
                document.documentElement.style.setProperty('--smart-button-text', textColor);
                this.updateSchemePreview();
            },
            updateSchemePreview() {
                const paletteContainer = document.getElementById('extracted-colors');
                if (!paletteContainer) return;
                paletteContainer.innerHTML = '';
                const labels = { background: '背景', card: '卡片', button: '按钮', text: '字体' };
                this.palette.forEach((color, i) => {
                    const [r, g, b] = color;
                    const assigned = Object.entries(this.colorScheme).find(([key, val]) => 
                        val && val[0] === r && val[1] === g && val[2] === b
                    );
                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch';
                    swatch.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                    swatch.style.position = 'relative';
                    if (assigned) {
                        swatch.style.boxShadow = '0 0 0 3px var(--accent-color)';
                        const labelEl = document.createElement('span');
                        labelEl.textContent = labels[assigned[0]];
                        labelEl.style.cssText = `position:absolute;font-size:9px;color:${this.calculateBrightness(r,g,b) > 128 ? '#333' : '#fff'};font-weight:bold;`;
                        swatch.appendChild(labelEl);
                    }
                    swatch.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showColorMenu(color, swatch);
                    });
                    paletteContainer.appendChild(swatch);
                });
                const btnRgb = this.colorScheme.button || [99, 102, 241];
                const isLightMode = document.body.classList.contains('light-mode');
                const textColor = isLightMode ? '#333333' : '#ffffff';
                for (let i = 1; i <= 3; i++) {
                    const btn = document.getElementById(`preview-btn-${i}`);
                    if (btn) {
                        btn.style.background = `rgba(${btnRgb[0]}, ${btnRgb[1]}, ${btnRgb[2]}, 0.15)`;
                        btn.style.color = textColor;
                        btn.style.borderColor = `rgba(${btnRgb[0]}, ${btnRgb[1]}, ${btnRgb[2]}, 0.3)`;
                    }
                }
                const preview = document.getElementById('color-palette-preview');
                if (preview) preview.style.display = 'block';
            },
            showColorMenu(color, swatch) {
                const existingMenu = document.querySelector('.color-use-menu');
                if (existingMenu) existingMenu.remove();
                const menu = document.createElement('div');
                menu.className = 'color-use-menu';
                menu.innerHTML = `
                    <div class="color-menu-item" data-use="background">设为背景色</div>
                    <div class="color-menu-item" data-use="card">设为卡片色</div>
                    <div class="color-menu-item" data-use="button">设为按钮色</div>
                    <div class="color-menu-item" data-use="text">设为字体色</div>
                `;
                menu.style.cssText = `
                    position: fixed;
                    background: rgba(40, 40, 50, 0.95);
                    backdrop-filter: blur(15px);
                    -webkit-backdrop-filter: blur(15px);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 12px;
                    padding: 8px 0;
                    z-index: 10000;
                    min-width: 120px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
                `;
                const rect = swatch.getBoundingClientRect();
                menu.style.left = Math.min(rect.left, window.innerWidth - 140) + 'px';
                menu.style.top = Math.min(rect.bottom + 5, window.innerHeight - 180) + 'px';
                document.body.appendChild(menu);
                menu.querySelectorAll('.color-menu-item').forEach(item => {
                    item.style.cssText = `
                        padding: 10px 16px;
                        cursor: pointer;
                        font-size: 13px;
                        color: #fff;
                        transition: background 0.2s;
                    `;
                    item.addEventListener('mouseenter', () => {
                        item.style.background = 'rgba(255,255,255,0.1)';
                    });
                    item.addEventListener('mouseleave', () => {
                        item.style.background = 'transparent';
                    });
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const use = item.dataset.use;
                        this.colorScheme[use] = color;
                        this.applyColorScheme();
                        db.settings.put({ key: 'colorScheme', value: this.colorScheme });
                        menu.remove();
                    });
                });
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                setTimeout(() => document.addEventListener('click', closeMenu), 10);
            },
            async enable() {
                this.enabled = true;
                document.body.classList.add('smart-color-enabled');
                await db.settings.put({ key: 'smartColorEnabled', value: true });
                await this.extractAndApply();
            },
            disable() {
                this.enabled = false;
                document.body.classList.remove('smart-color-enabled');
                document.documentElement.style.setProperty('--primary-rgb', '99, 102, 241');
                document.documentElement.style.setProperty('--smart-button-text', '#ffffff');
                db.settings.put({ key: 'smartColorEnabled', value: false });
            },
            async extractAndApply() {
                const desktopBg = await db.settings.get('desktopBg');
                if (!desktopBg?.value) {
                    showToast('请先设置桌面壁纸');
                    return;
                }
                try {
                    const palette = await this.extractPaletteFromImage(desktopBg.value);
                    if (palette.length === 0) {
                        showToast('无法提取颜色');
                        return;
                    }
                    this.palette = palette;
                    this.autoAssignColors(palette);
                    this.applyColorScheme();
                    await db.settings.put({ key: 'extractedPalette', value: palette });
                    await db.settings.put({ key: 'colorScheme', value: this.colorScheme });
                    showToast(`成功提取 ${palette.length} 个主色调`);
                } catch (e) {
                    console.error('提取颜色失败:', e);
                    showToast('颜色提取失败');
                }
            }
        };

        async function saveAppConfig() {
            const container = document.getElementById('app-customize-container');
            const inputs = container.querySelectorAll('.app-name-input');
            const iconInputs = container.querySelectorAll('.app-icon-input');
            const config = [];
            for (let i = 0; i < inputs.length; i++) {
                const app = defaultAppConfig[i] ? { ...defaultAppConfig[i] } : { id: `custom_${i}`, icon: '📁', target: 'desktop-view' };
                app.name = inputs[i].value;
                const iconInput = iconInputs[i];
                if (iconInput.files[0]) {
                    app.icon = await fileToDataURL(iconInput.files[0]);
                }
                config.push(app);
            }
            await db.settings.put({ key: 'appConfig', value: config });
            showToast('应用配置已保存');
            renderUI();
        }

        function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function exportAllData() {
            showToast('正在导出...');
            const zip = new JSZip();
            const albums = await db.albums.toArray();
            const discs = await db.discs.toArray();
            const audios = await db.audios.toArray();
            const settings = await db.settings.toArray();
            zip.file('albums.json', JSON.stringify(albums.map(a => ({ ...a, cover: a.cover ? `albums/${a.id}_cover.jpg` : null }))));
            zip.file('discs.json', JSON.stringify(discs.map(d => ({ ...d, cover: d.cover ? `discs/${d.id}_cover.jpg` : null }))));
            zip.file('audios.json', JSON.stringify(audios.map(a => ({
                ...a,
                audioFile: a.audioFile ? `audios/${a.id}_audio.mp3` : null,
                imageFile: a.imageFile ? `audios/${a.id}_image.jpg` : null,
                backgroundImage: a.backgroundImage ? `audios/${a.id}_bg.jpg` : null
            }))));
            zip.file('settings.json', JSON.stringify(settings));
            for (const album of albums) {
                if (album.cover) zip.file(`albums/${album.id}_cover.jpg`, album.cover);
            }
            for (const disc of discs) {
                if (disc.cover) zip.file(`discs/${disc.id}_cover.jpg`, disc.cover);
            }
            for (const audio of audios) {
                if (audio.audioFile) zip.file(`audios/${audio.id}_audio.mp3`, audio.audioFile);
                if (audio.imageFile) zip.file(`audios/${audio.id}_image.jpg`, audio.imageFile);
                if (audio.backgroundImage) zip.file(`audios/${audio.id}_bg.jpg`, audio.backgroundImage);
            }
            const content = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = `yume_backup_${new Date().toISOString().slice(0, 10)}.zip`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('导出成功');
        }

        async function importData(merge = false) {
            const input = document.getElementById('import-file-input');
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                showToast('正在导入...');
                try {
                    const zip = await JSZip.loadAsync(file);
                    if (!merge) {
                        await db.audios.clear();
                        await db.discs.clear();
                        await db.albums.clear();
                        await db.settings.clear();
                    }
                    const albumsData = JSON.parse(await zip.file('albums.json').async('text'));
                    const discsData = JSON.parse(await zip.file('discs.json').async('text'));
                    const audiosData = JSON.parse(await zip.file('audios.json').async('text'));
                    const settingsData = JSON.parse(await zip.file('settings.json').async('text'));
                    for (const album of albumsData) {
                        if (album.cover) {
                            const file = zip.file(album.cover);
                            if (file) album.cover = await file.async('blob');
                        }
                        await db.albums.add(album);
                    }
                    for (const disc of discsData) {
                        if (disc.cover) {
                            const file = zip.file(disc.cover);
                            if (file) disc.cover = await file.async('blob');
                        }
                        await db.discs.add(disc);
                    }
                    for (const audio of audiosData) {
                        if (audio.audioFile) {
                            const file = zip.file(audio.audioFile);
                            if (file) audio.audioFile = await file.async('blob');
                        }
                        if (audio.imageFile) {
                            const file = zip.file(audio.imageFile);
                            if (file) audio.imageFile = await file.async('blob');
                        }
                        if (audio.backgroundImage) {
                            const file = zip.file(audio.backgroundImage);
                            if (file) audio.backgroundImage = await file.async('blob');
                        }
                        await db.audios.add(audio);
                    }
                    for (const setting of settingsData) {
                        await db.settings.put(setting);
                    }
                    showToast('导入成功');
                    renderUI();
                    renderAlbums();
                } catch (error) {
                    console.error('导入失败:', error);
                    showToast('导入失败: ' + error.message);
                }
            };
            input.click();
        }

        function checkDirtyBeforeClose(originalData, currentData) {
            return JSON.stringify(originalData) !== JSON.stringify(currentData);
        }

        function setupEventListeners() {
            document.body.addEventListener('click', (e) => {
                const appIcon = e.target.closest('.app-icon');
                const backBtn = e.target.closest('.back-btn');
                if (appIcon) {
                    e.preventDefault();
                    const target = appIcon.dataset.target;
                    if (target === 'player-view') {
                        const playerView = document.getElementById('player-view');
                        if (playerView.dataset.currentAudioId) {
                            playerPreviousView = 'desktop-view';
                            navigateTo('player-view');
                        } else {
                            showToast('请先从专辑列表选择音频播放');
                        }
                    } else {
                        navigateTo(target);
                        if (target === 'albums-view') renderAlbums();
                        else if (target === 'beautify-view') loadBeautifySettings();
                    }
                }
                if (backBtn) {
                    let target = backBtn.dataset.target;
                    if (backBtn.id === 'player-back-btn') {
                        target = playerPreviousView || 'desktop-view';
                    }
                    if (backBtn.id === 'disc-back-btn') {
                        currentDiscId = null;
                        batchMode = false;
                        selectedAudios.clear();
                        updateBatchToolbar();
                        renderAlbums();
                    }
                    if (target === 'disc-detail-view' && currentAlbumId) {
                        db.albums.get(currentAlbumId).then(album => {
                            if (album) {
                                renderDiscDetail(currentAlbumId, album.name);
                            } else {
                                navigateTo('albums-view');
                            }
                        });
                    } else {
                        navigateTo(target);
                    }
                }
            });

            document.getElementById('create-album-btn')?.addEventListener('click', openCreateAlbumDialog);
            document.getElementById('create-disc-btn')?.addEventListener('click', openCreateDiscDialog);
            
            document.getElementById('disc-mode-btn')?.addEventListener('click', () => {
                currentViewMode = 'disc';
                document.getElementById('disc-mode-btn').classList.add('active');
                document.getElementById('list-mode-btn').classList.remove('active');
                if (currentAlbumId) {
                    db.albums.get(currentAlbumId).then(album => {
                        if (album) renderDiscDetail(currentAlbumId, album.name);
                    });
                }
            });
            
            document.getElementById('list-mode-btn')?.addEventListener('click', () => {
                currentViewMode = 'list';
                document.getElementById('list-mode-btn').classList.add('active');
                document.getElementById('disc-mode-btn').classList.remove('active');
                if (currentAlbumId) {
                    db.albums.get(currentAlbumId).then(album => {
                        if (album) renderDiscDetail(currentAlbumId, album.name);
                    });
                }
            });
            
            document.getElementById('audio-sort-select')?.addEventListener('change', (e) => {
                currentSortBy = e.target.value;
                if (currentAlbumId) {
                    db.albums.get(currentAlbumId).then(album => {
                        if (album) renderDiscDetail(currentAlbumId, album.name);
                    });
                }
            });
            
            document.getElementById('sort-order-btn')?.addEventListener('click', () => {
                const btn = document.getElementById('sort-order-btn');
                if (currentSortOrder === 'asc') {
                    currentSortOrder = 'desc';
                    btn.classList.add('desc');
                    btn.title = '倒序';
                } else {
                    currentSortOrder = 'asc';
                    btn.classList.remove('desc');
                    btn.title = '正序';
                }
                if (currentAlbumId) {
                    db.albums.get(currentAlbumId).then(album => {
                        if (album) renderDiscDetail(currentAlbumId, album.name);
                    });
                }
            });
            
            document.getElementById('entity-cancel-btn')?.addEventListener('click', async () => {
                const currentName = document.getElementById('entity-name-input').value;
                const hasChanges = currentName !== (dialogOriginalData?.name || '');
                if (hasChanges) {
                    const confirmed = await showConfirm('放弃更改', '有未保存的更改，确定要放弃吗？');
                    if (!confirmed) return;
                }
                closeAllDialogs();
            });
            
            document.getElementById('entity-confirm-btn')?.addEventListener('click', handleEntityConfirm);
            
            document.getElementById('audio-cancel-btn')?.addEventListener('click', async () => {
                const currentTitle = document.getElementById('audio-title-input').value;
                const currentLyric = document.getElementById('audio-lyric-input').value;
                const hasChanges = currentTitle !== (audioDialogOriginalData?.title || '') || 
                                   currentLyric !== (audioDialogOriginalData?.lyric || '');
                if (hasChanges) {
                    const confirmed = await showConfirm('放弃更改', '有未保存的更改，确定要放弃吗？');
                    if (!confirmed) return;
                }
                closeAllDialogs();
            });
            
            document.getElementById('audio-confirm-btn')?.addEventListener('click', handleAudioConfirm);

            document.getElementById('entity-name-input')?.addEventListener('input', () => { isDialogDirty = true; });
            document.getElementById('entity-cover-input')?.addEventListener('change', (e) => {
                isDialogDirty = true;
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    const preview = document.getElementById('entity-cover-preview');
                    preview.src = url;
                    preview.style.display = 'block';
                }
            });

            document.querySelectorAll('input[name="audio-dialog-source"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('audio-dialog-file-group').style.display = e.target.value === 'file' ? 'block' : 'none';
                    document.getElementById('audio-dialog-url-group').style.display = e.target.value === 'url' ? 'block' : 'none';
                });
            });

            document.getElementById('audio-image-input')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    const preview = document.getElementById('audio-image-preview');
                    preview.src = url;
                    preview.style.display = 'block';
                }
            });

            document.getElementById('import-vtt-btn')?.addEventListener('click', () => {
                document.getElementById('vtt-dialog-input').click();
            });

            document.getElementById('vtt-dialog-input')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('audio-lyric-input').value = event.target.result;
                    };
                    reader.readAsText(file);
                }
            });

            const audioPlayer = document.getElementById('audio-player');
            document.getElementById('play-pause-btn')?.addEventListener('click', () => {
                if (audioPlayer.paused) audioPlayer.play();
                else audioPlayer.pause();
            });
            document.getElementById('prev-btn')?.addEventListener('click', async () => {
                const currentId = parseInt(document.getElementById('player-view').dataset.currentAudioId);
                const prevId = await getSiblingAudioId(currentId, 'prev');
                if (prevId) playAudio(prevId);
            });
            document.getElementById('next-btn')?.addEventListener('click', async () => {
                const currentId = parseInt(document.getElementById('player-view').dataset.currentAudioId);
                const nextId = await getSiblingAudioId(currentId, 'next');
                if (nextId) playAudio(nextId);
            });
            document.getElementById('progress-bar')?.addEventListener('input', (e) => {
                audioPlayer.currentTime = parseFloat(e.target.value);
            });
            audioPlayer?.addEventListener('play', () => { document.getElementById('play-pause-btn').textContent = '❚❚'; });
            audioPlayer?.addEventListener('pause', () => { document.getElementById('play-pause-btn').textContent = '▶'; });
            audioPlayer?.addEventListener('ended', async () => {
                if (isContinuousPlay) {
                    const currentId = parseInt(document.getElementById('player-view').dataset.currentAudioId);
                    const nextId = await getSiblingAudioId(currentId, 'next');
                    if (nextId) playAudio(nextId);
                }
            });

            document.getElementById('style-switch-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                const menu = document.getElementById('style-switch-menu');
                menu.classList.toggle('visible');
            });
            document.getElementById('style-switch-menu')?.addEventListener('click', (e) => {
                const link = e.target.closest('a[data-style]');
                if (link) {
                    applyPlayerStyle(link.dataset.style);
                    document.getElementById('style-switch-menu').classList.remove('visible');
                }
            });
            document.getElementById('image-settings-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('image-settings-menu').classList.toggle('visible');
            });
            document.getElementById('set-bg-option')?.addEventListener('click', () => {
                document.getElementById('song-bg-input').click();
                document.getElementById('image-settings-menu').classList.remove('visible');
            });
            document.getElementById('set-cover-option')?.addEventListener('click', () => {
                document.getElementById('cover-input').click();
                document.getElementById('image-settings-menu').classList.remove('visible');
            });
            document.getElementById('song-bg-input')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const playerView = document.getElementById('player-view');
                    const currentAudioId = parseInt(playerView?.dataset?.currentAudioId);
                    if (currentAudioId) {
                        await db.audios.update(currentAudioId, { backgroundImage: file });
                        const url = URL.createObjectURL(file);
                        playerView.style.backgroundImage = `url(${url})`;
                        showToast('背景已保存');
                    } else {
                        showToast('请先播放一首歌曲');
                    }
                }
            });
            document.getElementById('cover-input')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const playerView = document.getElementById('player-view');
                    const currentAudioId = parseInt(playerView?.dataset?.currentAudioId);
                    if (currentAudioId) {
                        await db.audios.update(currentAudioId, { imageFile: file });
                        const url = URL.createObjectURL(file);
                        customCoverUrl = url;
                        const albumArt = document.getElementById('album-art');
                        if (albumArt) albumArt.src = url;
                        showToast('封面已保存');
                    } else {
                        showToast('请先播放一首歌曲');
                    }
                }
            });
            document.getElementById('player-display-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('player-display-settings').classList.toggle('visible');
            });
            document.getElementById('lyric-height-slider')?.addEventListener('input', (e) => {
                const val = e.target.value;
                document.getElementById('lyric-height-value').textContent = `${val}%`;
                document.documentElement.style.setProperty('--lyric-box-height', `${val}vh`);
                localStorage.setItem('lyricBoxHeight', val);
            });
            document.getElementById('glass-blur-slider')?.addEventListener('input', (e) => {
                const val = e.target.value;
                document.getElementById('glass-blur-value').textContent = `${val}px`;
                document.documentElement.style.setProperty('--glass-blur-amount', `${val}px`);
                localStorage.setItem('glassBlurAmount', val);
            });
            document.getElementById('lyric-box-opacity-slider')?.addEventListener('input', (e) => {
                const val = (e.target.value / 100).toFixed(2);
                document.getElementById('lyric-box-opacity-value').textContent = val;
                document.documentElement.style.setProperty('--lyric-box-bg', `rgba(255, 255, 255, ${val})`);
                localStorage.setItem('lyricBoxOpacity', val);
            });
            document.getElementById('lyric-opacity-slider')?.addEventListener('input', (e) => {
                const val = (e.target.value / 100).toFixed(1);
                document.getElementById('lyric-opacity-value').textContent = val;
                document.documentElement.style.setProperty('--lyric-color-opacity', val);
                localStorage.setItem('lyricOpacity', val);
            });
            (function loadDisplaySettings() {
                const height = localStorage.getItem('lyricBoxHeight') || '60';
                const blur = localStorage.getItem('glassBlurAmount') || '15';
                const boxOpacity = localStorage.getItem('lyricBoxOpacity') || '0.1';
                const lyricOpacity = localStorage.getItem('lyricOpacity') || '1.0';
                document.getElementById('lyric-height-slider').value = height;
                document.getElementById('lyric-height-value').textContent = `${height}%`;
                document.getElementById('glass-blur-slider').value = blur;
                document.getElementById('glass-blur-value').textContent = `${blur}px`;
                document.getElementById('lyric-box-opacity-slider').value = parseFloat(boxOpacity) * 100;
                document.getElementById('lyric-box-opacity-value').textContent = boxOpacity;
                document.getElementById('lyric-opacity-slider').value = parseFloat(lyricOpacity) * 100;
                document.getElementById('lyric-opacity-value').textContent = lyricOpacity;
                applyDisplaySettings();
            })();
            document.getElementById('toggle-color-picker-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('color-picker').classList.toggle('visible');
            });
            const colorPicker = document.getElementById('color-picker');
            const colors = ['#ffffff', '#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3'];
            colors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.addEventListener('click', () => {
                    document.documentElement.style.setProperty('--lyric-color', color);
                    db.settings.put({ key: 'lyricColor', value: color });
                    showToast('歌词颜色已保存');
                });
                colorPicker.appendChild(swatch);
            });
            document.getElementById('player-settings-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('player-settings-menu').classList.toggle('visible');
            });
            document.getElementById('playback-speed')?.addEventListener('change', (e) => {
                audioPlayer.playbackRate = parseFloat(e.target.value);
            });
            document.querySelectorAll('#player-settings-menu a[data-time]').forEach(a => {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    const time = parseInt(a.dataset.time);
                    if (sleepTimerId) clearTimeout(sleepTimerId);
                    if (time === -1) {
                        stopAtSongEnd = true;
                        showToast('将在当前歌曲播放完后停止');
                    } else if (time > 0) {
                        sleepTimerId = setTimeout(() => { audioPlayer.pause(); }, time * 60 * 1000);
                        showToast(`将在${time}分钟后停止`);
                    } else {
                        stopAtSongEnd = false;
                        showToast('睡眠定时器已关闭');
                    }
                    document.getElementById('player-settings-menu').classList.remove('visible');
                });
            });
            document.getElementById('toggle-continuous-play')?.addEventListener('click', (e) => {
                e.preventDefault();
                isContinuousPlay = !isContinuousPlay;
                e.target.textContent = `连续播放: ${isContinuousPlay ? '开启' : '关闭'}`;
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.right-controls')) {
                    document.getElementById('style-switch-menu')?.classList.remove('visible');
                    document.getElementById('player-settings-menu')?.classList.remove('visible');
                    document.getElementById('player-display-settings')?.classList.remove('visible');
                    document.getElementById('image-settings-menu')?.classList.remove('visible');
                    document.getElementById('color-picker')?.classList.remove('visible');
                }
            });

            document.querySelector('.close-lyrics-btn')?.addEventListener('click', () => {
                document.getElementById('full-lyrics-modal').classList.remove('active');
            });
            document.querySelector('.lyric-bubble')?.addEventListener('dblclick', () => {
                document.getElementById('full-lyrics-modal').classList.add('active');
            });

            document.getElementById('theme-switch')?.addEventListener('change', async (e) => {
                document.body.classList.toggle('light-mode', e.target.checked);
                await db.settings.put({ key: 'theme', value: e.target.checked ? 'light' : 'dark' });
                showToast('主题已保存');
            });
            document.getElementById('font-size-slider')?.addEventListener('input', async (e) => {
                document.documentElement.style.setProperty('--global-font-size', e.target.value + 'px');
                document.getElementById('font-size-value').textContent = e.target.value + 'px';
                await db.settings.put({ key: 'fontSize', value: e.target.value });
            });
            document.getElementById('save-font-btn')?.addEventListener('click', async () => {
                const url = document.getElementById('font-url-input').value;
                if (url) {
                    document.documentElement.style.setProperty('--global-font', `url(${url})`);
                    await db.settings.put({ key: 'fontUrl', value: url });
                    showToast('字体已保存');
                }
            });
            document.getElementById('bg-file-input')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    document.getElementById('desktop-view').style.backgroundImage = `url(${url})`;
                    document.body.style.backgroundImage = `url(${url})`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundAttachment = 'fixed';
                    await db.settings.put({ key: 'desktopBg', value: file });
                    showToast('桌面背景已保存');
                    if (smartColorSystem.enabled) {
                        setTimeout(() => smartColorSystem.extractAndApply(), 500);
                    }
                }
            });
            document.getElementById('dp-file-input')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    document.getElementById('display-picture-container').style.backgroundImage = `url(${url})`;
                    await db.settings.put({ key: 'displayPicture', value: file });
                    showToast('展示图片已保存');
                }
            });
            document.getElementById('player-bg-input')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    document.getElementById('player-view').style.backgroundImage = `url(${url})`;
                    await db.settings.put({ key: 'playerBg', value: file });
                    showToast('播放器背景已保存');
                }
            });
            document.getElementById('save-cover-size-btn')?.addEventListener('click', async () => {
                const width = document.getElementById('cover-width-input').value;
                const height = document.getElementById('cover-height-input').value;
                await db.settings.put({ key: 'coverWidth', value: width + 'px' });
                await db.settings.put({ key: 'coverHeight', value: height + 'px' });
                showToast('封面尺寸已保存');
            });
            document.getElementById('save-app-config-btn')?.addEventListener('click', saveAppConfig);

            document.getElementById('export-btn')?.addEventListener('click', exportAllData);
            document.getElementById('import-btn')?.addEventListener('click', () => importData(false));
            document.getElementById('import-merge-btn')?.addEventListener('click', () => importData(true));
            document.getElementById('clear-data-btn')?.addEventListener('click', async () => {
                const confirmText = prompt('确定要清空所有数据吗？输入"确认清空"继续：');
                if (confirmText === '确认清空') {
                    await db.audios.clear();
                    await db.discs.clear();
                    await db.albums.clear();
                    await db.settings.clear();
                    showToast('所有数据已清空');
                    renderUI();
                    renderAlbums();
                }
            });
            document.getElementById('clean-cache-btn')?.addEventListener('click', () => {
                revokeURLs();
                if (caches) caches.keys().then(keys => keys.forEach(key => caches.delete(key)));
                showToast('缓存已清理');
            });

            document.getElementById('batch-mode-btn')?.addEventListener('click', toggleBatchMode);
            document.getElementById('batch-delete-btn')?.addEventListener('click', deleteSelectedAudios);
            document.getElementById('batch-cancel-btn')?.addEventListener('click', () => {
                batchMode = false;
                selectedAudios.clear();
                updateBatchToolbar();
                renderAudios(currentDiscId);
            });
            document.getElementById('desktop-glass-settings-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('glass-settings-panel').classList.toggle('visible');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#glass-settings-panel') && !e.target.closest('#desktop-glass-settings-btn')) {
                    document.getElementById('glass-settings-panel')?.classList.remove('visible');
                }
            });
            const smoothOpacity = (value) => Math.pow(value / 100, 1.3) * 0.6;
            document.getElementById('bg-blur-slider')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('bg-blur-value').textContent = value + 'px';
                document.documentElement.style.setProperty('--bg-blur', value + 'px');
                localStorage.setItem('bgBlur', value);
            });
            document.getElementById('bg-opacity-slider')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('bg-opacity-value').textContent = value + '%';
                document.documentElement.style.setProperty('--bg-opacity', smoothOpacity(value));
                localStorage.setItem('bgOpacity', value);
            });
            document.getElementById('card-blur-slider')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('card-blur-value').textContent = value + 'px';
                document.documentElement.style.setProperty('--card-blur', value + 'px');
                localStorage.setItem('cardBlur', value);
            });
            document.getElementById('card-opacity-slider')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('card-opacity-value').textContent = value + '%';
                document.documentElement.style.setProperty('--card-opacity', smoothOpacity(value));
                localStorage.setItem('cardOpacity', value);
            });
            document.getElementById('btn-blur-slider')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('btn-blur-value').textContent = value + 'px';
                document.documentElement.style.setProperty('--btn-blur', value + 'px');
                localStorage.setItem('btnBlur', value);
            });
            document.getElementById('btn-opacity-slider')?.addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('btn-opacity-value').textContent = value + '%';
                document.documentElement.style.setProperty('--btn-opacity', smoothOpacity(value));
                localStorage.setItem('btnOpacity', value);
            });
            document.getElementById('smart-color-switch')?.addEventListener('change', async (e) => {
                if (e.target.checked) {
                    await smartColorSystem.enable();
                } else {
                    smartColorSystem.disable();
                }
            });
            document.getElementById('extract-colors-btn')?.addEventListener('click', async () => {
                if (!smartColorSystem.enabled) {
                    smartColorSystem.enabled = true;
                    document.body.classList.add('smart-color-enabled');
                    document.getElementById('smart-color-switch').checked = true;
                    await db.settings.put({ key: 'smartColorEnabled', value: true });
                }
                await smartColorSystem.extractAndApply();
            });
        }

        async function initApp() {
            const theme = await db.settings.get('theme');
            if (theme?.value === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('theme-switch').checked = true;
            }
            const fontSize = await db.settings.get('fontSize');
            if (fontSize?.value) {
                document.documentElement.style.setProperty('--global-font-size', fontSize.value + 'px');
            }
            const lyricColor = await db.settings.get('lyricColor');
            if (lyricColor?.value) {
                document.documentElement.style.setProperty('--lyric-color', lyricColor.value);
            }
            const desktopBg = await db.settings.get('desktopBg');
            if (desktopBg?.value) {
                const url = URL.createObjectURL(desktopBg.value);
                document.getElementById('desktop-view').style.backgroundImage = `url(${url})`;
                document.body.style.backgroundImage = `url(${url})`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
            }
            const displayPicture = await db.settings.get('displayPicture');
            if (displayPicture?.value) {
                const url = URL.createObjectURL(displayPicture.value);
                document.getElementById('display-picture-container').style.backgroundImage = `url(${url})`;
            }
            const playerBg = await db.settings.get('playerBg');
            if (playerBg?.value) {
                const url = URL.createObjectURL(playerBg.value);
                document.getElementById('player-view').style.backgroundImage = `url(${url})`;
            }
            const savedStyle = localStorage.getItem('playerStyle');
            if (savedStyle) currentPlayerStyle = savedStyle;
            const smoothOpacity = (value) => Math.pow(value / 100, 1.3) * 0.6;
            const savedBgBlur = localStorage.getItem('bgBlur');
            if (savedBgBlur) {
                document.documentElement.style.setProperty('--bg-blur', savedBgBlur + 'px');
                document.getElementById('bg-blur-slider').value = savedBgBlur;
                document.getElementById('bg-blur-value').textContent = savedBgBlur + 'px';
            }
            const savedBgOpacity = localStorage.getItem('bgOpacity');
            if (savedBgOpacity) {
                document.documentElement.style.setProperty('--bg-opacity', smoothOpacity(savedBgOpacity));
                document.getElementById('bg-opacity-slider').value = savedBgOpacity;
                document.getElementById('bg-opacity-value').textContent = savedBgOpacity + '%';
            }
            const savedCardBlur = localStorage.getItem('cardBlur');
            if (savedCardBlur) {
                document.documentElement.style.setProperty('--card-blur', savedCardBlur + 'px');
                document.getElementById('card-blur-slider').value = savedCardBlur;
                document.getElementById('card-blur-value').textContent = savedCardBlur + 'px';
            }
            const savedCardOpacity = localStorage.getItem('cardOpacity');
            if (savedCardOpacity) {
                document.documentElement.style.setProperty('--card-opacity', smoothOpacity(savedCardOpacity));
                document.getElementById('card-opacity-slider').value = savedCardOpacity;
                document.getElementById('card-opacity-value').textContent = savedCardOpacity + '%';
            }
            const savedBtnBlur = localStorage.getItem('btnBlur');
            if (savedBtnBlur) {
                document.documentElement.style.setProperty('--btn-blur', savedBtnBlur + 'px');
                document.getElementById('btn-blur-slider').value = savedBtnBlur;
                document.getElementById('btn-blur-value').textContent = savedBtnBlur + 'px';
            }
            const savedBtnOpacity = localStorage.getItem('btnOpacity');
            if (savedBtnOpacity) {
                document.documentElement.style.setProperty('--btn-opacity', smoothOpacity(savedBtnOpacity));
                document.getElementById('btn-opacity-slider').value = savedBtnOpacity;
                document.getElementById('btn-opacity-value').textContent = savedBtnOpacity + '%';
            }
            updateClock();
            setInterval(updateClock, 1000);
            await renderUI();
            bottomPlayer.init();
            setupEventListeners();
            smartColorSystem.init();
            const smartColorEnabled = await db.settings.get('smartColorEnabled');
            if (smartColorEnabled?.value) {
                smartColorSystem.enabled = true;
                document.body.classList.add('smart-color-enabled');
                document.getElementById('smart-color-switch').checked = true;
                const savedPalette = await db.settings.get('extractedPalette');
                const savedScheme = await db.settings.get('colorScheme');
                if (savedPalette?.value && Array.isArray(savedPalette.value) && savedPalette.value.length > 0) {
                    smartColorSystem.palette = savedPalette.value;
                    if (savedScheme?.value) {
                        smartColorSystem.colorScheme = savedScheme.value;
                    } else {
                        smartColorSystem.autoAssignColors(savedPalette.value);
                    }
                    smartColorSystem.applyColorScheme();
                }
            }
            const lastAlbumId = localStorage.getItem('lastPlayedAlbumId');
            const lastDiscId = localStorage.getItem('lastPlayedDiscId');
            if (lastAlbumId) currentAlbumId = parseInt(lastAlbumId);
            if (lastDiscId) currentDiscId = parseInt(lastDiscId);
            const lastAudioId = localStorage.getItem('lastPlayedAudioId');
            if (lastAudioId) {
                const audio = await db.audios.get(parseInt(lastAudioId));
                if (audio) {
                    let coverUrl = defaultCover;
                    if (audio.imageFile) {
                        coverUrl = URL.createObjectURL(audio.imageFile);
                        tempObjectURLs.push(coverUrl);
                    }
                    currentAudioCover = coverUrl;
                    currentAudioTitle = audio.title;
                    if (audio.lyrics) {
                        currentLyrics = parseLyrics(audio.lyrics);
                    }
                    bottomPlayer.elements.title.textContent = audio.title;
                    bottomPlayer.elements.subtitle.textContent = '已暂停';
                    bottomPlayer.elements.art.src = coverUrl;
                    document.body.classList.remove('no-active-song');
                    const savedTime = parseFloat(localStorage.getItem('lastPlayedTime')) || 0;
                    bottomPlayer.elements.currentTimeEl.textContent = formatTime(savedTime);
                    bottomPlayer.elements.durationEl.textContent = audio.duration ? formatTime(audio.duration) : '00:00';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    })();
    </script>
</body>
</html>
